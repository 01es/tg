\chapter{Maven to Rule'em All or Project Comprehension with Maven}\label{ch00:01}

\myepigraph{One must learn by doing the thing; for though you think you know it, you have no certainty, until you try.}{Sophocles}                                                   

%\myepigraph{In our profession, precision and perfection are not a dispensable luxury, but a simple necessity.}{Niklaus Wirth}

\section{A Short Introduction to Apache Maven}
  
  Apache Maven is a software project management and comprehension tool. 
  It is based on the concept of a \emph{project object model} or simpy POM to understand the structure of the project. 
  Maven can manage a project's dependencies and build it from a central piece of information declared in its POM file.
  POM files are maintained by developers and changed as project demands.

  The major feature of Maven we would like to emphasise specifically is the dependency management.
  Every Java project relies on programming libraries that are provided as part of Java Runtime Environment (JRE) as well as the ones external to JRE.
  These external libraries, which could be inhouse or provided by 3rd parties, represent the dependencies projects depend upon.
  All Java libraries are packaged into jar files, which are effectively zip archives containing all library related resources such as compiled class files, image files and more.
  Thus, \emph{project dependency} is always a jar file.

  There are two main question about dependencies: 
  \begin{itemize}
    \item Where the dependency is located?
    \item What dependency version should be use?
  \end{itemize}

  In the old days all dependecies would be stored in a source version control systems together with the project's srouce.
  This way, any developer would always be able to get all project dependencies from one location.
  However, this approach has numerous issues.
  For example, several projects that depend on the same set or subset of libraries would keep duplicate copies in their respective version control repositories.

  As any project, programming libraries change over time and new versions may not neceserraly be backward compatible.
  This requires projects to know what dependency version should be used.
  So how should developers know what library version is used by their project and where to get, for example, the latest right version for a new project.

  These questions are amongst the main concerns addressed by Apache Maven.
  It is a very comprehensive tool that manges libraries, version resolution, localisation, and even handles transitive dependencies (i.e. libraries that depend on other libraries, which are not directly referenced by the project itself), which truly makes complex project possible.

  \subsection*{Repositories and Artifacts}
  All dependencies that are managed by Maven are identified by three parameters: group ID, artifact ID and version.
  Artifact ID and version information are encoded into the jar file names.
  For exaple, if the file name of some dependency is \texttt{platform-pojobl-\tikzinline{1.1}.jar} then the highlighted portion \texttt{\tikzinline{1.1}} indicates the version, and the preceeding part \texttt{platform-pojobl} is the artifact ID.
  The group ID corresponds to a directory structure of the repository where dependencies are stored.

  Maven repositories represent physical locations where dependencies are stored.
  Roughly speaking, there are two types of repositories -- local and remote.
  

  \paragraph*{Local Repository}
  The local repository is represented by a specially designated directory \texttt{$\sim$/.m2} on every development workstation where symbol \tikzinline{$\sim$} indicates a user home directory.
  Figure \ref{img:ch00:01:local_repository_strucutre} depicts a fragment of the local repository structure.
  The top level of the local repository (indicated as left most node \texttt{$\sim$/.m2}) consist of subdirectory \texttt{repository} and a configuraton file \texttt{.settings}, which is discussed in more details lated in this section.
  The \texttt{repository} directory consists of multiple subdirectories that represent group IDs of different dependencies.
  The next level corresponds to artifact IDs, which may contain multiple subdirectories indicating various versions of the same artifact.
  The lowest level of the directory tree corresponds to artifact files of a specific version.
  In this example, three files are presented:
  \begin{enumerate}
    \item \texttt{platform-pojo-bl-1.1.jar} -- the actual dependency with all the necessary resources such as compiled class files and images.
    \item \texttt{platform-pojo-bl-1.1-javadoc.jar} -- oprional Javadoc archive that contains API documentatino of the dependency, which is very useful during development process.
    \item \texttt{platform-pojo-bl-1.1.pom} -- POM of the dependency required to indentify all transitive dependecies.
  \end{enumerate}
  There could be some additional files associated with the dependency (indicated as elipses on the figure) that can be safely ignored at the moment.

  \begin{image}{A fragment of the local repository structure}{\label{img:ch00:01:local_repository_strucutre}}    
    \begin{tikzpicture}	[remember picture, scale=0.9,
			  edge from parent fork right,grow=right,rounded corners=1pt,
			  every node/.style={scale=0.6,fill=white!10,rounded corners, level distance = 40mm},
			  edge from parent/.style={black,thick,draw},			  
			  level 1/.style={level distance=20mm,nodes={fill=white!10}, minimum width=20mm, minimum height=5mm},
			  level 2/.style={level distance=20mm,nodes={fill=white!10}, minimum width=20mm, minimum height=5mm},
			  level 3/.style={level distance=25mm,sibling distance=10mm, nodes={fill=white!10}, minimum width=30mm, minimum height=5mm},
			  level 4/.style={level distance=25mm,sibling distance=10mm, nodes={fill=white!10}, minimum width=20mm, minimum height=5mm},
			  level 5/.style={level distance=40mm,sibling distance=10mm, nodes={fill=white!10}, minimum width=50mm, minimum height=5mm}
			  ]      
      \node{$\sim$/.m2}
	child {node[fill=codebgcolor!30] (settings) {.settings}}
	child {node[fill=highlight] {repository}
	  child {node {group ID $N_1$}}	  
	  child {node {\ldots}}	  
	  child {node[fill=highlight] {fielden}
	    child {node {artifact ID $N_2$}}	    
	    child {node {\ldots}}	    
	    child {node[fill=highlight] {platfrom-pojo-bl}
	      child {node {version $N_3$}}
	      child {node {\ldots}}	      
	      child {node[fill=highlight] {1.1}
		child {node {\ldots}}
		child {node[fill=highlight] {platform-pojo-bl-1.1.pom}}
		child {node[fill=highlight] {platform-pojo-bl-1.1-javadoc.jar}}		
		child {node[fill=highlight] {platform-pojo-bl-1.1.jar}}
	      }
	      child {node {version 1}}
	    }
	    child {node {artifact ID 1}}	    
	  }	 
	  child {node {group ID 1}}	  
	};    
    \end{tikzpicture}
    
    \tikznote{tree_a1}{settings}{6cm}{-0.2cm}{4cm}{Settings File}{Contains Maven specific settings, which are discussed in detailes later in this section.}
  \end{image}
  

  It is quite naturally to ask now how do all of those dependencies get into the local repository and whether it should all be managed by hand?
  The answer to the latter question is \emph{no}, there is no need to handle local repositories manually as Maven fully automates this process.
  As to the former question, \emph{all dependencies are downloaded into the local repository from remote repositories}\footnote{
    Dependencies can be added into the local repository manually by using special Maven commands. 
    This capability is useful in cases where a developer needs to experiment with some libraries localy without affecting any shared projects.
  }.
  Dependencies are downloaded into the local repository only if projects, which need to be manged on a local machine, specify those dependencies.
  This also includes transitive dependencies that the declared dependencies depend on.
  In a simplified form it works like this, when Maven is requested to build a project it reads the POM file to determine project dependencies.
  Reading dependecies one by one, Maven checks if they exist in the local repository.
  If they do it adds a corresponding local path to the project classpath.
  If some dependency cannot be resolved locally then Maven tries to find this dependency in remote repositories.
  Once found, such dependency is donloaded locally and a corresponding local path is added to the project classpath.
  In case where the dependency is not found, an error is reported about unresolved dependency.

  \paragraph*{Remote Repository}
  
  The \emph{remote repository} represents a dedicated server that is located either on LAN or Internet.
  The dafault Maven action is to utilise a number of publicly availalbe remote Maven repositories, which contain a plethora of open source Java libraries.
  However, some libraries may not be available in these repositories or only older versions are availalbe.
  For example, comercial libraries such as Oracle JDBC drives are not part of any of the public Maven repositories.
  In such cases it is more convenient or even required to establich an inhouse remote repository.
  The most promitent advantage of this approach if the ability to manage all dependencies be that open source, inhouse or comercial libraries in a uniform way.
  
  An inhouse repository stores libraries uploaded manually by maintainers\footnote{This is usually done via a web interface of a repository server.}, but also it acts as a mirror for any publicly availble remote repository.
  This way, there is no need to manually upload any publicly available libraries.
  Any publicly available dependency is firts downloaded to the inhouse repository and then downloaded to the local machine where the request to find that dependency was initiated.
  Subsequent requests for this dependency from other local machines would result in downloading the files from an inhouse repository directly\footnote{
  This approaches has an added value by reducing the Internet traffic otherwise requried to download dependencies off the public repositories onto all local machines.
  }.  
  Thus, the inhouse repository serves as a single interaction point for resolving all dependencies for any project.
  Figure \ref{img:ch00:01:maven_infrastructure} shows a schematic representation of the Maven local and remote repositories.

  \begin{image}{The role of the inhouse repository}{\label{img:ch00:01:maven_infrastructure}}    
    \begin{tikzpicture}	[remember picture]      
	\node [aspect=0.3, cylinder, shape border rotate=90, draw] at (1,0)  {B};
	
	\aboxl[2.0cm,1.5cm,1.6,a1,(0,0)] {
	    \begin{minipage}{1.5cm}
	      inhouse
	      repository
            \end{minipage}
	};
    \end{tikzpicture}
  \end{image}

  \subsection*{Download and Configure} 
  Maven can be downloaded from the official \href{http://maven.apache.org/download.html}{Apache Maven web site}\footnote{\url{http://maven.apache.org/download.html}}.
  The recommended at this time verion for TG-based applications is 2.2.1.
  Once downloaded please follow the \href{http://maven.apache.org/download.html#Installation}{installation instructions} also awailable on the official site\footnote{\url{http://maven.apache.org/download.html\#Installation}}.
  
  \begin{notebox}{JDK Version}{\label{mb:java}}
    It is important to note that Oracle JDK 6.x should be used for developing applications with TG, and it should be installed before downloading and installing Maven. 
  \end{notebox}
  
  One of the key 

  \lstset{language=XML,
	  escapechar=\%,
	  morekeywords={settings, encoding, mirrorOf, mirrors, mirror, id, profiles, profile, repositories, repository, url, releases, snapshots, version,
			pluginRepositories, pluginRepository, activeProfiles, activeProfile, servers, server, username, password, 
			directoryPermissions, filePermissions},
	  numbers=left, numberstyle=\tiny, basicstyle=\scriptsize\color{basiccolor}, stepnumber=1, numbersep=5pt, keywordstyle=\bfseries\color{codefgcolor}, stringstyle=\color{stringcolor}}
  \begin{code}{Maven Settings}{\label{lst:settings}}
    \begin{lstlisting}
      <?xml version="1.0" encoding="UTF-8"?>
      <settings>
	<mirrors>
	  <mirror>
	    <id>nexus</id>
	    <mirrorOf>*</mirrorOf>
	    <url>http://www.fielden.com.ua:8090/nexus/content/groups/public</url>
	  </mirror>
	</mirrors>
	<profiles>
	  <profile>
	    <id>nexus</id>
	    <repositories>
	      <repository>
		<id>central</id>
		<url>http://central</url>
		<releases><enabled>true</enabled></releases>
		<snapshots><enabled>true</enabled></snapshots>
	      </repository>
	    </repositories>
	    <pluginRepositories>
	      <pluginRepository>
		<id>central</id>
		<url>http://central</url>
		<releases><enabled>true</enabled></releases>
		<snapshots><enabled>true</enabled></snapshots>
	      </pluginRepository>
	    </pluginRepositories>
	  </profile>
	</profiles>

	<activeProfiles>
	  <activeProfile>nexus</activeProfile>
	</activeProfiles>

	<servers>
	  <server>
	    <id>nexus</id>
	    <username>your username</username>
	    <password>your password</password>
	    <directoryPermissions>0775</directoryPermissions>
	    <filePermissions>0664</filePermissions>
	  </server>
	  <server>
	    <id>Releases</id>
	    <username>your username</username>
	    <password>your password</password>
	    <directoryPermissions>0775</directoryPermissions>
	    <filePermissions>0664</filePermissions>
	  </server>
	  <server>
	    <id>Snapshots</id>
	    <username>your username</username>
	    <password>your password</password>
	    <directoryPermissions>0775</directoryPermissions>
	    <filePermissions>0664</filePermissions>
	  </server>
	</servers>
      </settings>
    \end{lstlisting}
  \end{code}


  \subsection*{POM Esseintials}  

  \hyperref[lst:pom]{Listing \ref{lst:pom}} illustrates an fragment of a POM file with relevant comments for each of the key tags relevant to the project.


  %\clearpage
  \lstset{language=XML,
	  escapechar=\%,
	  morekeywords={project, modelVersion, groupId, artifactId, packaging, packaging, version, encoding, name, description},
	  numbers=left, numberstyle=\tiny, basicstyle=\scriptsize\color{basiccolor}, stepnumber=1, numbersep=5pt, keywordstyle=\bfseries\color{codefgcolor}, stringstyle=\color{stringcolor}}
  \begin{code}{Project Object Model (POM)}{\label{lst:pom}}
    \begin{lstlisting}
    <?xml version="1.0" encoding="UTF-8"?>
    <project xmlns="..."
	  xsi:schemaLocation="...">
	  <modelVersion>4.0.0</modelVersion>
	  %\tikzref{lst_pom_n1}{-1ex}{2ex}%<groupId>fielden</groupId>%\tikzref{lst_pom_n2}{1ex}{-0.8ex}\tikzref{lst_pom_n2_1}{1ex}{0.5ex}%
	  %\tikzref{lst_pom_n3}{-1ex}{2ex}%<artifactId>platform-parent</artifactId>%\tikzref{lst_pom_n4}{1ex}{-0.8ex}\tikzref{lst_pom_n4_1}{1ex}{0.5ex}%
	  <packaging>pom</packaging>
	  <version>1.1-SNAPSHOT</version>
	  <name>Trident Genesis Platform Parent</name>
	  <description>
		  Trident Genesis is an application platform designed for
		  development of ERP type applications supporting Client/Server
		  and
		  RIA/ROA architectures.
		  Its main goal is to provide simple integrated solution for 
		  development of information system with domain oriented approach. 
	  </description>
    </project> 
    \end{lstlisting}

    \tikzhighlight{lst_pom_n1}{lst_pom_n2}  
    \tikznote{lst_pom_a1}{lst_pom_n2_1}{6cm}{0.5cm}{5cm}{Project Group}{This tag indicates project's group, which usually referes to the company or development group responsible for implementing the project.}

    \tikzhighlight{lst_pom_n3}{lst_pom_n4}
    \tikznote{lst_pom_a2}{lst_pom_n4_1}{4cm}{-0.5cm}{5cm}{Project Artifact}{There can be several notes for the same highlighted area.}
  \end{code}

