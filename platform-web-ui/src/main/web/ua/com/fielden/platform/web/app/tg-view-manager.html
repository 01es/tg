<link rel="import" href="/resources/polymer/polymer/polymer.html">
<link rel="import" href="/resources/components/postal-lib.html">

<polymer-element name="tg-view-manager" attributes="user" hidden>
    <script>
        (function () {
            var user,
                mastersById = {},
                //mastersByUuid = {},
                /////////////////////////////////////////////////// Centre Edit action listeners.///////////////////////////////////////////////////
                editListener = postal.subscribe({
                    channel: "centre",
                    topic: "edit.start",
                    callback: function (data, envelope) {
                        var fullTypeName = data.entity.type().notEnhancedFullClassName(),
                            simpleTypeName = data.entity.type()._notEnhancedSimpleClassName(),
                            master = {
                                componentUri: "/users/" + user + "/master/" + fullTypeName,
                                elementName: "tg-" + simpleTypeName + "-master",
                                attrs: {
                                    user: user,
                                    entityid: data.entity.id,
                                    entitytype: fullTypeName,
                                    currentState: 'VIEW',
                                    centreUuid: data.uuid
                                }
                            };
                        if (mastersById["" + data.entity.id]) {
                            postal.publish({
                                channel: "manager",
                                topic: "master.show",
                                data: {
                                    uuid: mastersById["" + data.entity.id],
                                    centreUuid: data.uuid
                                }
                            });
                        } else {
                            postal.publish({
                                channel: "manager",
                                topic: "master.edit.create",
                                data: master
                            });
                        }
                    }
                }),
                masterCreatedListener = postal.subscribe({
                    channel: "view",
                    topic: "master.edit.created",
                    callback: function (data, envelope) {
                        mastersById["" + data.entityid] = data.masterUuid;
                        postal.publish({
                            channel: "centre_" + data.centreUuid,
                            topic: "edit.finish.created",
                            data: {
                                uuid: data.masterUuid
                            }
                        });
                    }
                }),
                masterShownListener = postal.subscribe({
                    channel: "view",
                    topic: "master.shown",
                    callback: function (data, envelope) {
                        postal.publish({
                            channel: "centre_" + data.centreUuid,
                            topic: "edit.finish.shown",
                            data: {
                                uuid: data.masterUuid
                            }
                        });
                    }
                }),
                /////////////////////////////////////////////////// Centre New action listeners.///////////////////////////////////////////////////
                newListener = postal.subscribe({
                    channel: "centre",
                    topic: "new.start",
                    callback: function (data, envelope) {
                            master = {
                                componentUri: "/users/" + user + "/master/" + data.entityType,
                                elementName: "tg-" + data.simpleEntityType + "-master",
                                attrs: {
                                    user: user,
                                    entityid: "new",
                                    entitytype: data.entityType,
                                    currentState: 'VIEW',
                                    centreUuid: data.uuid
                                }
                            };
                        postal.publish({
                            channel: "manager",
                            topic: "master.new.create",
                            data: master
                        });
                    }
                }),
                masterNewListener = postal.subscribe({
                    channel: "view",
                    topic: "master.new.created",
                    callback: function (data, envelope) {
                        postal.publish({
                            channel: "centre_" + data.centreUuid,
                            topic: "new.finish",
                            data: {
                                uuid: data.masterUuid
                            }
                        });
                    }
                }),
                /////////////////////////////////////////////////Master Save Action.//////////////////////////////////////////////////////////
                saveListener = postal.subscribe({
                    channel: "master",
                    topic: "save.start",
                    callback: function(data, envelope) {
                        postal.publish({
                            channel: "manager",
                            topic: "master.saved",
                            data: data
                        });
                    }
                }),
                masterClosedListener = postal.subscribe({
                    channel: "view",
                    topic: "master.closed",
                    callback: function(data, envelope) {
                        delete mastersById["" + data.id];
                        postal.publish({
                            channel: "master_"  + data.masterUuid,
                            topic: "save.finish"
                        });
                    }
                });
            Polymer({
                userChanged: function (oldValue, newValue) {
                    user = newValue;
                }
            });
        })();
    </script>
</polymer-element>