<link rel="import" href="/resources/polymer/polymer/polymer.html">
<link rel="import" href="/resources/polymer/core-animated-pages/core-animated-pages.html">
<link rel="import" href="/resources/polymer/core-animated-pages/transitions/slide-up.html">
<link rel="import" href="/resources/polymer/core-animated-pages/transitions/slide-down.html">
<link rel="import" href="/resources/polymer/core-animated-pages/transitions/scale-up.html">
<link rel="import" href="/resources/views/tg-app-menu.html">
<link rel="import" href="/resources/views/tg-app-view.html">
<link rel="import" href="/resources/components/postal-lib.html">

<polymer-element name="tg-app" attributes="user" layout vertical>
    <template>
        <style>
            :host {
                overflow: hidden;
            }
        </style>
        <core-animated-pages id="pages" selected="{{selected}}" on-core-animated-pages-transition-end="{{transitionend}}" transitions="hero-transition cross-fade scale-up slide-up slide-down" flex>

            <tg-app-menu id="menu" name="menu" user="{{user}}" items="{{views.items}}" lastSelectedMenuItem="{{lastSelected}}" selectedMenuItem="{{selected}}" whenDesktop="{{views.whenDesktop}}" whenTablet="{{views.whenTablet}}" whenMobile="{{views.whenMobile}}" minCellHeight="{{views.minCellHeight}}" minCellWidth="{{views.minCellWidth}}" fit></tg-app-menu>

            <template repeat="{{view in views.items}}">
                <div fit name="{{view.name}}">
                    <tg-app-view item="{{view}}" hero-id="{{'hero_' + view.name}}" hero?="{{selected === view.name || lastSelected === view.name}}" fit></tg-app-view>
                </div>
            </template>

        </core-animated-pages>
    </template>
    <script>
        (function () {
            var pushState = function (state) {
                    if (state && Array.isArray(state) && state.length > 0) {
                        postal.publish({
                            channel: state[0],
                            topic: "state.push",
                            data: {
                                state: state
                            }
                        });
                    }
                },
                popState = function (state) {
                    if (state && Array.isArray(state) && state.length > 0) {
                        postal.publish({
                            channel: state[0],
                            topic: "state.pop",
                            data: {
                                state: state,
                            }
                        });
                    }
                };
            Polymer({
                eventDelegates: {
                    'main-menu': 'showMainMenu',
                    'menu-item-selected': 'showView'
                },
                showMainMenu: function (e) {
                    this.setSelected("menu");
                },
                showView: function (e) {
                    pushState([e.detail]);
                },
                setSelected: function (selected) {
                    this.lastSelected = this.selected;
                    this.selected = selected;
                },
                transitionend: function () {
                    if (this.lastSelected) {
                        this.lastSelected = null;
                    }
                },
                ready: function () {
                    var self = this;
                    this.views = {
                        whenDesktop: [
                            [[{
                                rowspan: 2,
                                colspan: 2
                            }], [], [], [{
                                colspan: 2
                            }]],
                            [[{
                                rowspan: 2,
                                colspan: 2
                            }], [], []],
                            [[], [], [], []]
                        ],
                        whenTablet: [
                            [[{
                                rowspan: 2,
                                colspan: 2
                            }], [], []],
                            [[{
                                rowspan: 2,
                                colspan: 2
                            }]],
                            [[], []],
                            [[{
                                rowspan: 2,
                                colspan: 2
                            }], [], []],
                            [[], []],
                        ],
                        whenMobile: [
                            [[], []],
                            [[], []],
                            [[], []],
                            [[], []],
                            [[], []],
                            [[]],
                        ],
                        minCellHeight: "100px",
                        minCellWidth: "100px",
                        items: [
                            {
                                name: "view 1",
                                icon: "/resources/images/test.svg",
                                theme: "#f4f4f4",
                                nameTheme: "#999999",
                                textTheme: "white"
                            },
                            {
                                name: "view 2",
                                icon: "/resources/images/test.svg",
                                theme: "#f4f4f4",
                                nameTheme: "#999999",
                                textTheme: "white",
                                menu: [
                                    {
                                        name: "view 1"
                                    },
                                    {
                                        name: "view 2",
                                        submenu: [
                                            {
                                                name: "view 1"
                                            },
                                            {
                                                name: "view 2"
                                            }
                                        ]
                                    }
                                ]
                            },
                            {
                                name: "view 3",
                                icon: "/resources/images/test.svg",
                                theme: "#f4f4f4",
                                nameTheme: "#999999",
                                textTheme: "white"
                            },
                            {
                                name: "view 4",
                                icon: "/resources/images/test.svg",
                                theme: "#f4f4f4",
                                nameTheme: "#999999",
                                textTheme: "white"
                            },
                            {
                                name: "view 5",
                                icon: "/resources/images/test.svg",
                                theme: "#f4f4f4",
                                nameTheme: "#999999",
                                textTheme: "white"
                            },
                            {
                                name: "view 6",
                                icon: "/resources/images/test.svg",
                                theme: "#f4f4f4",
                                nameTheme: "#999999",
                                textTheme: "white"
                            },
                            {
                                name: "view 7",
                                icon: "/resources/images/test.svg",
                                theme: "#f4f4f4",
                                nameTheme: "#999999",
                                textTheme: "white"
                            },
                            {
                                name: "view 8",
                                icon: "/resources/images/test.svg",
                                theme: "#f4f4f4",
                                nameTheme: "#999999",
                                textTheme: "white"
                            },
                            {
                                name: "view 9",
                                icon: "/resources/images/test.svg",
                                theme: "#f4f4f4",
                                nameTheme: "#999999",
                                textTheme: "white"
                            },
                            {
                                name: "view 10",
                                icon: "/resources/images/test.svg",
                                theme: "#f4f4f4",
                                nameTheme: "#999999",
                                textTheme: "white"
                            },
                            {
                                name: "view 11",
                                icon: "/resources/images/test.svg",
                                theme: "#f4f4f4",
                                nameTheme: "#999999",
                                textTheme: "white"
                            }
                        ]
                    };
                    postal.subscribe({
                        channel: "app",
                        topic: "state.pushed",
                        callback: function (data, envelope) {
                            self.setSelected(data.state[0]);
                        }
                    });
                    postal.subscribe({
                        channel: "app",
                        topic: "state.poped",
                        callback: function (data, envelope) {
                            self.setSelected(data.state[0]);
                        }
                    });
                    self.setSelected(self.views.items[0].name);
                    history.pushState([self.selected]);
                    window.onpopstate = function (e) {
                        console.log("poped state: ", e);
                        popState(e.state);
                    };
                }
            });
        })();
    </script>
</polymer-element>