<link rel="import" href="/resources/polymer/polymer/polymer.html">
<link rel="import" href="/resources/polymer/core-animated-pages/core-animated-pages.html">
<link rel="import" href="/resources/polymer/core-animated-pages/transitions/slide-up.html">
<link rel="import" href="/resources/polymer/core-animated-pages/transitions/slide-down.html">
<link rel="import" href="/resources/polymer/core-animated-pages/transitions/scale-up.html">
<link rel="import" href="/resources/views/tg-app-menu.html">
<link rel="import" href="/resources/views/tg-app-view.html">
<link rel="import" href="/resources/components/postal-lib.html">
<link rel="import" href="/resources/app/tg-view-manager.html">

<polymer-element name="tg-app" attributes="user" layout vertical>
    <template>
        <style>
            :host {
                overflow: hidden;
            }
        </style>
        <tg-view-manager user="{{user}}"></tg-view-manager>
        <core-animated-pages id="pages" selected="{{selected}}" on-core-animated-pages-transition-end="{{transitionend}}" transitions="hero-transition cross-fade scale-up slide-up slide-down" flex>

            <tg-app-menu id="menu" name="menu" user="{{user}}" items="{{views.items}}" lastSelectedMenuItem="{{lastSelected}}" selectedMenuItem="{{selected}}" whenDesktop="{{views.whenDesktop}}" whenTablet="{{views.whenTablet}}" whenMobile="{{views.whenMobile}}" minCellHeight="{{views.minCellHeight}}" minCellWidth="{{views.minCellWidth}}" fit></tg-app-menu>

            <template repeat="{{view, viewIndex in views.items}}">
                <div fit name="{{view.title}}">
                    <tg-app-view user="{{user}}" autoLoad?="{{viewIndex === 0}}" item="{{view}}" hero-id="{{'hero_' + view.title}}" hero?="{{selected === view.title || lastSelected === view.title}}" fit></tg-app-view>
                </div>
            </template>

        </core-animated-pages>
    </template>
    <script>
        (function () {
            var pushState = function (state) {
                    if (state && Array.isArray(state) && state.length > 0) {
                        postal.publish({
                            channel: state[0],
                            topic: "state.push",
                            data: {
                                state: state
                            }
                        });
                    }
                },
                popState = function (state) {
                    if (state && Array.isArray(state) && state.length > 0) {
                        postal.publish({
                            channel: state[0],
                            topic: "state.pop",
                            data: {
                                state: state,
                            }
                        });
                    }
                },
                updateHash = function(state) {
                    location.hash = state.join("/");
                };
            Polymer({
                eventDelegates: {
                    'main-menu': 'showMainMenu',
                    'menu-item-selected': 'showView'
                },
                showMainMenu: function (e) {
                    this.setSelected("menu");
                },
                showView: function (e) {
                    pushState([e.detail]);
                },
                setSelected: function (selected) {
                    this.lastSelected = this.selected;
                    this.selected = selected;
                },
                transitionend: function () {
                    if (this.lastSelected) {
                        this.lastSelected = null;
                    }
                },
                ready: function () {
                    var self = this;
                    this.views = @menuConfig;
                    postal.subscribe({
                        channel: "app",
                        topic: "state.pushed",
                        callback: function (data, envelope) {
                            self.setSelected(data.state[0]);
                            //updateHash(data.state);
                        }
                    });
                    postal.subscribe({
                        channel: "app",
                        topic: "state.poped",
                        callback: function (data, envelope) {
                            self.setSelected(data.state[0]);
                            //updateHash(data.state);
                        }
                    });
                    //Set up listener for history events
                    window.onpopstate = function (e) {
                        popState(e.state);
                    };
                    //Set up listener for hash change events
                    window.onhashchange = function(e) {
                        console.log(location.hash);
                    }
                    //Selectes the first view 
                    self.setSelected(self.views.items[0].title);
                    history.pushState([self.selected]);
                    //updateHash([self.selected]);
                }
            });
        })();
    </script>
</polymer-element>