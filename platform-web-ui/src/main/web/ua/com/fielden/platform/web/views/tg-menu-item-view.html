<link rel="import" href="/resources/polymer/polymer/polymer.html">
<link rel="import" href="/resources/element_loader/tg-element-loader.html">

<dom-module id="tg-menu-item-view">
    <style>
        .view {
            background-color: white;
        }
    </style>
    <template>
        <template is="dom-if" if="[[menuItem.view]]">
            <tg-element-loader id="elementToLoad" auto="[[autoLoad]]" import="[[menuItem.view.import]]" element-name="[[menuItem.view.elementName]]" attrs="[[_getMenuItemAttributes()]]" on-after-load="_afterLoadListener"></tg-element-loader>
        </template>
        <template is="dom-if" if="[[!menuItem.view]]">
            <div class="view">
                Please specify view for <span>[[menuItem.title]]</span>.
            </div>
        </template>
    </template>
</dom-modules>
<script>
    (function () {
        Polymer({

            is: "tg-menu-item-view",

            properties: {
                menuItem: Object,
                autoLoad: {
                    type: Boolean,
                    value: false,
                    reflectToAttribute: true
                },
                uuid: String,
                moduleId: String
            },

            hostAttributes: {
                "class": "layout vertical"
            },

            ready: function () {
                if (this.menuItem.view) {
                    this.menuItem.view.attrs.uuid = this.uuid;
                    this.menuItem.view.attrs.moduleId = this.moduleId;
                }
            },
            
            _getMenuItemAttributes: function() {
                return this.menuItem.view.attrs;
            },
            
            _afterLoadListener: function (e, detail, view) {
                var self = this;
                if (e.target === this.$.elementToLoad) {
                    if (this.menuItem.view.type === 'centre') {
                        detail.postRetrieved = function (entity, bindingEntity, customObject) {
                            self.fire("menu-item-view-loaded", self.menuItem);
                        };

                        detail.retrieve();
                    } else if (this.menuItem.view.type === 'master') {
                        detail.postRetrieved = function (entity, bindingEntity, customObject) {
                            if (entity.id === null) {
                                postal.publish({
                                    channel: "view",
                                    topic: "master.new.created",
                                    data: {
                                        centreUuid: detail.centreUuid,
                                        item: self.menuItem
                                    }
                                });
                            } else {
                                postal.publish({
                                    channel: "view",
                                    topic: "master.edit.created",
                                    data: {
                                        entityid: entity.id,
                                        centreUuid: detail.centreUuid,
                                        item: self.menuItem
                                    }
                                });
                            }
                            self.fire("menu-item-view-loaded", self.menuItem);
                        };
                        detail.postValidated = function (validatedEntity, bindingEntity, customObject) {};
                        detail.postSaved = function (potentiallySavedEntity, newBindingEntity) {
                            //Send postal message that save was completed if it was succefull
                            if (potentiallySavedEntity.isValid()) {
                                postal.publish({
                                    channel: "master",
                                    topic: "save.start",
                                    data: {
                                        centreUuid: detail.centreUuid,
                                        masterUuid: detail.uuid,
                                        moduleId: detail.moduleId,
                                        entity: potentiallySavedEntity,
                                        item: self.menuItem,
                                        selectedEntitiesInContext: [potentiallySavedEntity]
                                    }
                                });
                            }
                        };
                        detail.retrieve();
                    } else {
                        self.fire("menu-item-view-loaded", self.menuItem);
                    }
                }
            },
            load: function () {
                if (this.$.elementToLoad && !this.$.elementToLoad.wasLoaded) {
                    this.$.elementToLoad.load();
                }
            },
            wasLoaded: function () {
                if (this.$.elementToLoad) {
                    return this.$.elementToLoad.wasLoaded;
                }
                return true;
            }
        });
    })();
</script>