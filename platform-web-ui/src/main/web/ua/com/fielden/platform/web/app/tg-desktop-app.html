<link rel="import" href="/resources/polymer/polymer/polymer.html">
<link rel="import" href="/resources/polymer/neon-animation/neon-animated-pages.html">
<link rel="import" href="/resources/polymer/carbon-route/carbon-location.html">
<link rel="import" href="/resources/polymer/carbon-route/carbon-route.html">
<link rel="import" href="/resources/views/tg-app-menu.html">
<link rel="import" href="/resources/views/tg-app-view.html">
<link rel="import" href="/resources/components/postal-lib.html">
<link rel="import" href="/resources/app/tg-view-manager.html">

<dom-module id="tg-desktop-app">
    <style>
        :host {
            overflow: hidden;
        }
    </style>
    <template>
        <tg-view-manager></tg-view-manager>
        <carbon-location route="{{_route}}" url-space-regex="^/#/" use-hash-as-path></carbon-location>
        <carbon-route route="{{_route}}" pattern="/:moduleName" data="{{_routeData}}" tail="{{_subroute}}"></carbon-route>
        <neon-animated-pages id="pages" class="fit" attr-for-selected="name" animate-initial-selection>
            <tg-app-menu class="fit" name="menu" menu-config="[[menuConfig]]"></tg-app-menu>
            <template is="dom-repeat" items="[[menuConfig.items]]" on-dom-change="_modulesRendered">
                <tg-app-view class="fit hero-animatable" name$="[[item.title]]" menu-item="[[item]]" selected-module="[[_routeData.moduleName]]" submodule="{{_subroute}}"></tg-app-view>
            </template>
        </neon-animated-pages>
    </template>
</dom-module>

<script>
    (function () {
        Polymer({

            is: "tg-desktop-app",

            properties: {
                _route: {
                    type: Object,
                    observer: "_routeChanged"
                },

                _routeData: Object,
                _subroute: Object
            },

            listeners: {
                "main-menu": "_showMainMenu",
                "menu-item-selected": "_showView"
            },

            _routeChanged: function (newValue, oldValue) {
                this._routeData && this._setSelected(decodeURIComponent(this._routeData.moduleName));
            },

            _showMainMenu: function (e) {
                this._setSelected("menu");
            },

            _showView: function (e) {
                var route = "/" + encodeURIComponent(e.detail), 
                    elementToSelect = this.$$("[name='" + e.detail + "']"),
                    selectedSubPage = elementToSelect.getSelectedPage();
                if (selectedSubPage) {
                    route += "/" + encodeURIComponent(selectedSubPage);
                }
                this.set("_route.path", route);
            },

            _modulesRendered: function (e) {
                if (this.selectAfterRender) {
                    this.async(function(){
                        this._setSelected(this.selectAfterRender);
                        delete this.selectAfterRender;
                    });
                }
            },

            _setSelected: function (selected) {
                var currentlySelected = this.$.pages.selected,
                    currentlySelectedElement = currentlySelected && this.$$("[name='" + currentlySelected + "']"),
                    elementToSelect = selected && this.$$("[name='" + selected + "']");
                if (currentlySelectedElement) {
                    currentlySelectedElement.configureExitAnimation(selected);
                }
                if (elementToSelect) {
                    elementToSelect.configureEntryAnimation(currentlySelected);
                    this.$.pages.selected = selected;
                } else {
                    this.selectAfterRender = selected;
                }
            },

            attached: function () {
                var self = this;
                this.menuConfig = @menuConfig;

                this.async(function () {
                    if (!this._route.path) {
                        this.set("_route.path", "/menu")
                    }
                });
            }
        });
    })();
</script>