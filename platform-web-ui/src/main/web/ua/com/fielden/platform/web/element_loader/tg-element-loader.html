<link rel="import" href="/resources/polymer/polymer/polymer.html">

<dom-module id="tg-element-loader">
    <template>
        <content></content>
    </template>
</dom-module>
<script>
    (function () {
        var importedURLs = {},
            //Creates the element with specified elementName and attributes and inserts it into insertToElement element.
            insertElement = function (insertToElement, elementName, attributes) {
                if (elementName && elementName.toString().length > 0) {
                    var customElement = document.createElement(elementName);
                    if (attributes && typeof attributes === "object") {
                        for (attr in attributes) {
                            customElement[attr] = attributes[attr];
                        }
                        // removing node is faster than to empty innerHTML
                        var child = Polymer.dom(insertToElement).firstChild;
                        while (child) {
                            Polymer.dom(insertToElement).removeChild(child);
                            child = Polymer.dom(insertToElement).firstChild;
                        }
                        Polymer.dom(insertToElement).appendChild(customElement);
                        Polymer.dom.flush();
                    }
                    return customElement;
                }
            };
        Polymer({

            is: "tg-element-loader",

            properties: {
                auto: {
                    type: Boolean,
                    value: false,
                    reflectToAttribute: true
                },

                wasLoaded: {
                    type: Boolean,
                    value: false,
                    reflectToAttribute: true
                },

                import: {
                    type: String
                },

                elementName: {
                    type: String
                },

                attrs: {
                    type: String
                }
            },

            attached: function () {
                var self = this;
                this.async(function () {
                    if (self.auto) {
                        self.load();
                    }
                });
            },
            
            /** 
             * Loads a custom element and returns a Promise that could be used to porvide custom loginc upon successful (then) or unsuccessful (catch) result.
             * For backward compatibility reasons, an "after-load" event is fired in loading was successful.
             */ 
            load: function () {
                var self = this;
                var attributes = this.attrs || {};
                var elementName = this.elementName || (this.import && this.import.split('/').slice(-1)[0].replace('.html', ''));

                console.warn("loading");
                console.time("loading");
                console.warn("loading-all");
                console.time("loading-all");
                
                if (this.wasLoaded === true) {
                	// in case of already loaded an inserted element the only sensible thing to do is to 
                	// return a resolved Promise with the value of actually loaded element...
                	// however... there could potenitally be more that one instance of the element with the name of elementName
                	// so, let's return all of them
                	return Promise.resolve(Polymer.dom(self).querySelectorAll(elementName));
                } else {
                    if (self.import && (!importedURLs.hasOwnProperty(self.import) || importedURLs[self.import] !== "imported")) {
                        
                        var promise = new Promise(function (resolve, reject) {
                        	var href = self.import;
                        	// check if URI mutation is needed and mutate URI for repeated import if required
                        	if (importedURLs.hasOwnProperty(self.import)) {
                        		var mutation = importedURLs[self.import];
                        		href = href + '?' + mutation;
                        	}
                        	
                        	// proceed with import
                            var link = self.importHref(href,
                                // link.onload
                                function (e) {
                                    console.timeEnd("loading");
                                    importedURLs[self.import] = "imported";
                                    
                                    // insert the element
                                    var insertedElement = insertElement(self, elementName, attributes);
                                    self.wasLoaded = true;
                                    // resolve the pormise
                                    resolve(insertedElement);

                                    // fire event for backward compatibility
                                    self.fire('after-load', insertedElement);
                                }, 
                                // link.onerror
                                function (e) {
                                    console.timeEnd("loading");
                             
                                    // prepare mutation for the repeated invocation of import
                                    if (!importedURLs.hasOwnProperty(self.import)) {
                                    	importedURLs[self.import] = 1;
                                	} else {
                                		importedURLs[self.import] = importedURLs[self.import] + 1;
                                	}
                                    
                                    Polymer.dom(document.head).removeChild(link);
                                    Polymer.dom.flush();
                                    // reject the promise
                                    reject(new Error('Could not load element <tt>' + elementName + '</tt>.'));
                                    
                                    // TODO during 'import' method invocation the server error json can arrive instead of piece of DOM -- need to handle this somehow
                                    console.warn("error happened", e);
                                    // loading error
                                });
                        }); // end of promise 
                        
                        return promise;
                    } else {
                    	return new Promise(function (resolve, reject) {
                    		
                    		// insert the element
                    		var insertedElement = insertElement(self, elementName, attributes);
                    		self.wasLoaded = true;
                    		
                    		// resolve the promise
                    		resolve(insertedElement);
                    		
                    		self.fire('after-load', insertedElement);
                    	});
                    }
                    
                }
            },
            
            /** */
            reload: function () {
                this.wasLoaded = false;
                return this.load();
            }
        });
    })();
</script>