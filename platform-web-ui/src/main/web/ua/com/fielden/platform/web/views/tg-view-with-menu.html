<link rel="import" href="/resources/polymer/polymer/polymer.html">
<link rel="import" href="/resources/polymer/core-animated-pages/core-animated-pages.html">
<link rel="import" href="/resources/polymer/core-header-panel/core-header-panel.html">
<link rel="import" href="/resources/polymer/core-toolbar/core-toolbar.html">
<link rel="import" href="/resources/polymer/core-menu/core-menu.html">
<link rel="import" href="/resources/polymer/core-menu/core-submenu.html">
<link rel="import" href="/resources/polymer/core-icons/core-icons.html">
<link rel="import" href="/resources/polymer/core-icon-button/core-icon-button.html">
<link rel="import" href="/resources/polymer/core-item/core-item.html">
<link rel="import" href="/resources/polymer/core-drawer-panel/core-drawer-panel.html">
<link rel="import" href="/resources/polymer/paper-fab/paper-fab.html">
<link rel="import" href="/resources/components/postal-lib.html">
<link rel="import" href="/resources/views/tg-menu-item-view.html">
<link rel="import" href="/tg-web-app/tg-app-config.html">
<link rel="import" href="/resources/components/tg-scroll-container.html">

<polymer-element name="tg-view-with-menu" attributes="user item" layout vertical>
    <template>
        <style>
            core-toolbar {
                height: 100px;
                background-color: #0288D1;
                color: white;
                font-size: 18px;
                transition: top 100ms linear;
            }
            .toolbar-visible {
                top: 0;
            }
            .toolbar-hidden {
                top: -100px;
            }
            core-toolbar::shadow #topBar {
                height: 100px;
            }
            core-animated-pages {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                transition: top 100ms linear;
            }
            .pages-full {
                top: 0;
            }
            .pages-short {
                top: 100px;
            }
            paper-fab {
                z-index: 1;
                background-color: #fcfcfc;
                color: #666464;
            }
            core-menu > * {
                padding-left: 22px;
                font-size: 13px;
            }
            core-menu {
                color: #01579b;
                padding: 10px 0 0 0;
                margin: 0;
            }
            core-menu core-submenu::shadow core-item::shadow core-icon {
                order: 2;
            }
            core-menu core-submenu::shadow core-item::shadow #label {
                flex: 1;
            }
            core-menu > core-item,
            core-menu > core-submenu::shadow > core-item,
            core-menu > core-submenu > core-item {
                transition: all 300ms ease-in-out;
            }
            core-item,
            core-submenu {
                cursor: pointer !important;
            }
            #drawerPanel div[drawer] {
                background-color: white;
            }
            #drawerPanel:not([narrow]) #menuButton {
                display: none;
            }
            #drawerPanel:not([narrow]) core-menu {
                border-right: 1px solid #CBCDCE;
            }
            .item {
                background-color: white;
            }
            tg-scroll-container {
                overflow-x: hidden;
            }
        </style>

        <tg-app-config id="app_config"></tg-app-config>
        <core-drawer-panel id="drawerPanel" disableSwipe responsiveWidth="{{$.app_config.minDesktopWidth}}px">

            <div vertical layout drawer>

                <core-toolbar slide-down>{{item.title}}</core-toolbar>
                <core-menu selected="{{selected}}" slide-up flex>
                    <template repeat="{{menu in item.menu}}">
                        <template if="{{menu.submenu}}">
                            <core-submenu selected="{{subSelected}}" name="{{menu.title}}" label="{{menu.title}}" icon="icons:expand-more">
                                <template repeat="{{subMenu in menu.submenu}}">
                                    <core-item name="{{subMenu.title}}" label="{{subMenu.title}}"></core-item>
                                </template>
                            </core-submenu>
                        </template>
                        <template if="{{!menu.submenu}}">
                            <core-item name="{{menu.title}}" label="{{menu.title}}"></core-item>
                        </template>
                    </template>
                </core-menu>

            </div>

            <div main vertical layout>

                <core-toolbar slide-down class="{{ {'toolbar-visible' : !toolbarHidden, 'toolbar-hidden': toolbarHidden} | tokenList }}">
                    <core-icon-button id="menuButton" icon="menu" on-tap="{{togglePanel}}"></core-icon-button>
                    <div flex>{{selected === '__empty__' ? '' : (subSelected ? subSelected : selected)}}</div>
                    <paper-fab icon="apps" on-tap="{{onShowMenuTap}}" scale-up></paper-fab>
                </core-toolbar>

                <core-animated-pages class="{{ {'pages-full' : toolbarHidden, 'pages-short': !toolbarHidden} | tokenList }}" on-scroll-container="{{handleScroll}}" id="pages" transitions="cross-fade" selected="{{selected + (subSelected ? ('/' + subSelected) : '') }}" on-core-select="{{onPageSelected}}" on-core-animated-pages-transition-end="{{transitionend}}">
                    <div name="__empty__">
                        <div slide-up></div>
                    </div>

                    <template repeat="{{page in item.menu}}">
                        <div name="{{page.title}}">
                            <tg-scroll-container on-scroll-container="{{handleScroll}}" fit>
                                <tg-menu-item-view cross-fade item="{{page}}" uuid="{{item.title + '/' + page.title}}" moduleId="{{item.title}}"></tg-menu-item-view>
                            </tg-scroll-container>
                        </div>
                        <template if="{{page.submenu}}">
                            <template repeat="{{subPage in page.submenu}}">
                                <div name="{{page.title + '/' + subPage.title}}">
                                    <tg-scroll-container on-scroll-container="{{handleScroll}}" fit>
                                        <tg-menu-item-view slide-up item="{{subPage}}" uuid="{{item.title + '/' + page.title + '/' + subPage.title}}" moduleId="{{item.title}}"></tg-menu-item-view>
                                    </tg-scroll-container>
                                </div>
                            </template>
                        </template>
                    </template>
                </core-animated-pages>

            </div>


        </core-drawer-panel>

    </template>
    <script>
        (function () {
            var findMenuItem = function (menu, itemName) {
                var ind = 0;
                for (ind = 0; ind < menu.length; ind++) {
                    if (menu[ind].title === itemName) {
                        return menu[ind].submenu;
                    }
                }
            };
            Polymer({
                //Needed for transitioning the toolbar and container
                toolbarHidden: false,

                ready: function () {
                    var self = this,
                        masterCounter = 1;
                    self.startUp = true;
                    self.selected = "__empty__";
                    ////////////////// State related events ///////////////////////////
                    postal.subscribe({
                        channel: self.item.title,
                        topic: "state.push",
                        callback: function (data, envelope) {
                            var newState = data.state;
                            if (self.selected) {
                                newState.push(self.selected);
                            }
                            if (self.subSelected) {
                                newState.push(self.subSelected);
                            }
                            history.pushState(newState);
                            postal.publish({
                                channel: "app",
                                topic: "state.pushed",
                                data: {
                                    state: newState
                                }
                            });
                        }
                    });
                    postal.subscribe({
                        channel: self.item.title,
                        topic: "state.pop",
                        callback: function (data, envelope) {
                            if (data.state[1] === self.selected && ((data.state[2] && data.state[2] === self.subSelected) || (!data.state[2] && !self.subSelected))) {
                                postal.publish({
                                    channel: "app",
                                    topic: "state.poped",
                                    data: data
                                });
                            } else {
                                self.restoringState = true;
                                self.selected = data.state[1];
                                if (data.state[2]) {
                                    self.subSelected = data.state[2];
                                } else {
                                    self.subSelected = null;
                                }
                            }
                        }
                    });
                    postal.subscribe({
                        channel: self.item.title,
                        topic: "state.select",
                        callback: function (data, envelop) {
                            if (data.state[1] === self.selected && ((data.state[2] && data.state[2] === self.subSelected) || (!data.state[2] && !self.subSelected))) {
                                history.pushState(data.state);
                            } else {
                                self.selected = data.state[1];
                                if (data.state.length > 2) {
                                    self.subSelected = data.state[2];
                                } else {
                                    self.subSelected = null;
                                }
                            }
                            postal.publish({
                                channel: "app",
                                topic: "state.pushed",
                                data: data
                            });
                        }
                    });
                    //////////////////////////Edit actions//////////////////////////////////
                    postal.subscribe({
                        channel: "manager_" + self.item.title,
                        topic: "master.edit.create",
                        callback: function (data, envelope) {
                            var idArray = data.view.attrs.uuid.split('/');
                            self.selected = idArray[1];
                            if (idArray.length > 2) {
                                self.subSelected = idArray[2];
                                findMenuItem(self.item.menu, idArray[1]).push(data);
                            } else {
                                self.subSelected = null;
                                self.item.menu.push(data);
                            }
                        }
                    });

                    postal.subscribe({
                        channel: "manager_" + self.item.title,
                        topic: "master.show",
                        callback: function (data, envelope) {
                            var idArray = data.item.view.attrs.uuid.split('/');
                            if (idArray[0] !== self.item.title) {
                                postal.publish({
                                    channel: idArray[0],
                                    topic: "state.select",
                                    data: {
                                        state: idArray
                                    }
                                })
                            } else {
                                self.selected = idArray[1];
                                if (idArray.length > 2) {
                                    self.subSelected = idArray[2];
                                } else {
                                    self.subSelected = null;
                                }
                            }
                            postal.publish({
                                channel: "view",
                                topic: "master.shown",
                                data: data
                            });
                        }
                    });
                    /////////////////New Actions//////////////////////////////
                    postal.subscribe({
                        channel: "manager_" + self.item.title,
                        topic: "master.new.create",
                        callback: function (data, envelope) {
                            var centreUuid = data.view.attrs.centreUuid.split('/');
                            centreUuid[centreUuid.length - 1] = "New Master #" + masterCounter;
                            data.title = "New Master #" + masterCounter;
                            data.description = "New Master #" + masterCounter;
                            data.view.attrs.uuid = centreUuid.join('/');
                            masterCounter += 1;
                            self.selected = centreUuid[1];
                            if (centreUuid.length > 2) {
                                findMenuItem(self.item.menu, centreUuid[1]).push(data);
                                self.subSelected = centreUuid[2];
                            } else {
                                self.item.menu.push(data);
                                self.subSelected = null;
                            }
                        }
                    });
                    //////////////Master save acation////////////////////////////
                    postal.subscribe({
                        channel: "manager_" + self.item.title,
                        topic: "master.saved",
                        callback: function (data, envelope) {
                            var centreUuid = data.centreUuid.split('/');
                            postal.publish({
                                channel: "view",
                                topic: "master.saved",
                                data: data
                            });
                            self.selected = centreUuid[1];
                            if (centreUuid.length > 2) {
                                self.subSelected = centreUuid[2];
                            } else {
                                self.subSelected = null;
                            }
                        }
                    });
                },
                togglePanel: function () {
                    this.$.drawerPanel.togglePanel();
                },
                onShowMenuTap: function () {
                    this.fire("main-menu");
                },
                onPageSelected: function (e, detail, source) {
                    var state;
                    if (detail.isSelected && e.target === this.$.pages) {
                        state = [this.item.title, this.selected];
                        name = this.selected;
                        if (this.subSelected) {
                            state.push(this.subSelected);
                            name += '/' + this.subSelected;
                        }
                        if (this.startUp) {
                            this.startUp = false;
                        } else if (this.restoringState) {
                            this.restoringState = false;
                            postal.publish({
                                channel: "app",
                                topic: "state.poped",
                                data: {
                                    state: state
                                }
                            });
                        } else {
                            history.pushState(state);
                            this.$.drawerPanel.closeDrawer();
                        }
                    }
                },
                handleScroll: function (e) {
                    if (e.detail.scrollTop === 0) {
                        this.toolbarHidden = false;
                    } else if (!this.toolbarHidden) {
                        this.toolbarHidden = true;
                    }
                },
                transitionend: function (e, detail, source) {
                    var name, viewToLoad;
                    name = this.selected;
                    if (this.subSelected) {
                        name += '/' + this.subSelected;
                    }
                    if (this.selected != '__empty__') {
                        viewToLoad = this.$.pages.querySelector('div[name="' + name + '"] tg-menu-item-view');
                        if (viewToLoad && !viewToLoad.wasLoaded()) {
                            viewToLoad.load();
                        }
                    }
                }
            });
        })();
    </script>
</polymer-element>