<link rel="import" href="/resources/polymer/polymer/polymer.html">
<link rel="import" href="/resources/polymer/core-animated-pages/core-animated-pages.html">
<link rel="import" href="/resources/polymer/core-header-panel/core-header-panel.html">
<link rel="import" href="/resources/polymer/core-toolbar/core-toolbar.html">
<link rel="import" href="/resources/polymer/core-menu/core-menu.html">
<link rel="import" href="/resources/polymer/core-menu/core-submenu.html">
<link rel="import" href="/resources/polymer/core-icons/core-icons.html">
<link rel="import" href="/resources/polymer/core-icon-button/core-icon-button.html">
<link rel="import" href="/resources/polymer/core-item/core-item.html">
<link rel="import" href="/resources/polymer/core-drawer-panel/core-drawer-panel.html">
<link rel="import" href="/resources/polymer/paper-fab/paper-fab.html">
<link rel="import" href="/resources/components/postal-lib.html">
<link rel="import" href="/resources/views/tg-menu-item-view.html">
<link rel="import" href="/tg-reflector">
<link rel="import" href="/tg-web-app/tg-app-config.html">

<polymer-element name="tg-view-with-menu" attributes="user item" layout vertical>
    <template>
        <style>
            core-toolbar {
                height: 100px;
                background-color: #0288D1;
                color: white;
                font-size: 18px;
            }
            core-toolbar::shadow #topBar {
                height: 100px;
            }
            paper-fab {
                position: absolute;
                z-index: 1;
                bottom: -28px;
                right: 20px;
                background-color: #fcfcfc;
                color: #666464;
            }
            core-menu > * {
                padding-left: 22px;
                font-size: 13px;
            }
            core-menu {
                color: #01579b;
                padding: 10px 0 0 0;
                margin: 0;
            }
            core-menu core-submenu::shadow core-item::shadow core-icon {
                order: 2;
            }
            core-menu core-submenu::shadow core-item::shadow #label {
                flex: 1;
            }
            core-menu > core-item,
            core-menu > core-submenu::shadow > core-item,
            core-menu > core-submenu > core-item {
                transition: all 300ms ease-in-out;
            }
            core-item, core-submenu {
                cursor: pointer !important;
            }
            #drawerPanel [drawer] {
                background-color: white;
            }
            #drawerPanel:not([narrow]) #menuButton {
                display: none;
            }
            #drawerPanel:not([narrow]) core-menu {
                border-right: 1px solid #CBCDCE;
            }
            .item {
                background-color: white;
            }
            .scroller {
                overflow-y: auto;
                overflow-x: hidden;
            }
        </style>

        <tg-reflector id="reflector"></tg-reflector>
        <tg-app-config id="app_config"></tg-app-config>
        <core-drawer-panel id="drawerPanel" disableSwipe responsiveWidth="{{$.app_config.minDesktopWidth}}px">

            <div vertical layout drawer>

                <core-toolbar slide-down>{{item.title}}</core-toolbar>
                <core-menu selected="{{selected}}" slide-up flex>
                    <template repeat="{{menu in item.menu}}">
                        <template if="{{menu.submenu}}">
                            <core-submenu selected="{{subSelected}}" name="{{menu.title}}" label="{{menu.title}}" icon="icons:expand-more">
                                <template repeat="{{subMenu in menu.submenu}}">
                                    <core-item name="{{subMenu.title}}" label="{{subMenu.title}}"></core-item>
                                </template>
                            </core-submenu>
                        </template>
                        <template if="{{!menu.submenu}}">
                            <core-item name="{{menu.title}}" label="{{menu.title}}"></core-item>
                        </template>
                    </template>
                </core-menu>

            </div>

            <div main vertical layout>

                <core-toolbar slide-down>
                    <core-icon-button id="menuButton" icon="menu" on-tap="{{togglePanel}}"></core-icon-button>
                    <div flex>{{selected === '__empty__' ? '' : (subSelected ? subSelected : selected)}}</div>
                    <paper-fab icon="apps" on-tap="{{onShowMenuTap}}" scale-up></paper-fab>
                </core-toolbar>

                <core-animated-pages id="pages" transitions="cross-fade" selected="{{selected + (subSelected ? ('/' + subSelected) : '') }}" on-core-select="{{onPageSelected}}" on-core-animated-pages-transition-end="{{transitionend}}" flex>
                    <div name="__empty__">
                        <div slide-up></div>
                    </div>

                    <template repeat="{{page in item.menu}}">
                        <div name="{{page.title}}" class="scroller" onscroll="{{onscroll1}}">
                            <tg-menu-item-view cross-fade item="{{page}}"></tg-menu-item-view>
                        </div>
                        <template if="{{page.submenu}}">
                            <template repeat="{{subPage in page.submenu}}">
                                <div name="{{page.title + '/' + subPage.title}}" class="scroller" onscroll="{{onscroll1}}">
                                    <tg-menu-item-view slide-up item="{{subPage}}"></tg-menu-item-view>
                                </div>
                            </template>
                        </template>
                    </template>
                </core-animated-pages>

            </div>


        </core-drawer-panel>

    </template>
    <script>
        (function () {
            Polymer({
                ready: function () {
                    var self = this,
                        masterCounter = 1;
                    self.startUp = true;
                    self.selected = "__empty__";
                    ////////////////// State related events ///////////////////////////
                    postal.subscribe({
                        channel: self.item.title,
                        topic: "state.push",
                        callback: function (data, envelope) {
                            var newState = data.state;
                            if (self.selected) {
                                newState.push(self.selected);
                            }
                            if (self.subSelected) {
                                newState.push(self.subSelected);
                            }
                            history.pushState(newState);
                            postal.publish({
                                channel: "app",
                                topic: "state.pushed",
                                data: {
                                    state: newState
                                }
                            });
                        }
                    });
                    postal.subscribe({
                        channel: self.item.title,
                        topic: "state.pop",
                        callback: function (data, envelope) {
                            if (data.state[1] === self.selected && ((data.state[2] && data.state[2] === self.subSelected) || (!data.state[2] && !self.subSelected))) {
                                postal.publish({
                                    channel: "app",
                                    topic: "state.poped",
                                    data: data
                                });
                            } else {
                                self.restoringState = true;
                                self.selected = data.state[1];
                                if (data.state[2]) {
                                    self.subSelected = data.state[2];
                                } else {
                                    self.subSelected = null;
                                }
                            }
                        }
                    });
                    //////////////////////////Edit actions//////////////////////////////////
                    postal.subscribe({
                        channel: "manager",
                        topic: "master.edit.create",
                        callback: function (data, envelope) {
                            data.view.attrs.uuid = self.$.reflector.generateUUID();
                            self.item.menu.push(data);
                            self.selected = data.title;
                            self.subSelected = null;
                        }
                    });

                    postal.subscribe({
                        channel: "manager",
                        topic: "master.show",
                        callback: function (data, envelope) {
                            self.selected = data.item.title;
                            self.subSelected = null;
                            postal.publish({
                                channel: "view",
                                topic: "master.shown",
                                data: data
                            });
                        }
                    });
                    /////////////////New Actions//////////////////////////////
                    postal.subscribe({
                        channel: "manager",
                        topic: "master.new.create",
                        callback: function (data, envelope) {
                            var uuid = self.$.reflector.generateUUID();
                            data.title = "New Master #" + masterCounter;
                            data.description = "New Master #" + masterCounter;
                            data.view.attrs.uuid = uuid;
                            self.item.menu.push(data);
                            masterCounter += 1;
                            self.selected = data.title;
                            self.subSelected = null;
                        }
                    });
                    //////////////Master save acation////////////////////////////
                    postal.subscribe({
                        channel: "manager",
                        topic: "master.saved",
                        callback: function (data, envelope) {
                            postal.publish({
                                channel: "view",
                                topic: "master.saved",
                                data: data
                            });
                            self.selected = "Entity Centre";
                        }
                    });
                },
                togglePanel: function () {
                    this.$.drawerPanel.togglePanel();
                },
                onShowMenuTap: function () {
                    this.fire("main-menu");
                },
                onPageSelected: function (e, detail, source) {
                    var state;
                    if (detail.isSelected && e.target === this.$.pages) {
                        state = [this.item.title, this.selected];
                        name = this.selected;
                        if (this.subSelected) {
                            state.push(this.subSelected);
                            name += '/' + this.subSelected;
                        }
                        if (this.startUp) {
                            this.startUp = false;
                        } else if (this.restoringState) {
                            this.restoringState = false;
                            postal.publish({
                                channel: "app",
                                topic: "state.poped",
                                data: {
                                    state: state
                                }
                            });
                        } else {
                            history.pushState(state);
                            this.$.drawerPanel.closeDrawer();
                        }
                    }
                },
                onscroll1: function(e) {
                    console.log("-------------------scrolling-------------------------------");
                },
                transitionend: function (e, detail, source) {
                    var name, viewToLoad;
                    name = this.selected;
                    if (this.subSelected) {
                        name += '/' + this.subSelected;
                    }
                    if (this.selected != '__empty__') {
                        viewToLoad = this.$.pages.querySelector('div[name="' + name + '"] tg-menu-item-view');
                        if (viewToLoad && !viewToLoad.wasLoaded()) {
                            viewToLoad.load();
                        }
                    }
                }
            });
        })();
    </script>
</polymer-element>