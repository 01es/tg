<link rel="import" href="/resources/polymer/polymer/polymer.html">

<link rel="import" href="/resources/binding/tg-entity-binder.html">
<link rel="import" href="/resources/layout/tg-flex-layout.html">

<link rel="import" href="/resources/editors/tg-singleline-text-editor.html">
<link rel="import" href="/resources/editors/tg-integer-editor.html">
<link rel="import" href="/resources/editors/tg-decimal-editor.html">
<link rel="import" href="/resources/editors/tg-boolean-editor.html">
<link rel="import" href="/resources/editors/tg-datetime-picker.html">
<link rel="import" href="/resources/editors/tg-entity-editor.html">
<link rel="import" href="/resources/editors/tg-entity-search-criteria.html">

<link rel="import" href="/resources/polymer/core-ajax/core-ajax.html">
<link rel="import" href="/resources/centre/tg-criteria-validator.html">
<link rel="import" href="/resources/centre/criterion/tg-criterion.html">
<link rel="import" href="/resources/centre/criterion/tg-boolean-criterion.html">
<link rel="import" href="/resources/centre/criterion/tg-range-criterion.html">
<link rel="import" href="/resources/centre/criterion/tg-date-range-criterion.html">

<polymer-element name="tg-selection-criteria" extends="tg-entity-binder" attributes="mitype onRun onRunComplete">
    <template>
        <shadow></shadow>
        <tg-criteria-validator id="validator" user="{{user}}" mitype="{{mitype}}" onvalidated="{{onValidatedDefault}}"></tg-criteria-validator>
        <core-ajax id="ajaxRetriever" url="/users/{{user}}/criteria/{{mitype}}" method="GET" handleas="json"></core-ajax>
        <core-ajax id="ajaxRunner" url="/users/{{user}}/criteria/{{mitype}}" method="PUT" handleas="json"></core-ajax>

        <tg-flex-layout whenDesktop="{{whenDesktop}}" whenTablet="{{whenTablet}}" whenMobile="{{whenMobile}}">
            <tg-criterion orNull="{{propertyModel[''].orNull}}" not="{{propertyModel[''].not}}">
                <tg-entity-search-criteria entity="{{currBindingEntity}}" user="{{user}}" entityType="{{entitytype}}" propertyName="tgPersistentEntityWithProperties_" onAcceptedValueChanged="{{validate}}" propTitle="Key prop MULTI" propDesc="Key prop MULTI criteria editor" currentState="{{currentState}}" action="{{actions['SNATCH_BACK_VEHICLE']}}" externalRefreshCycle="{{refreshCycleMode}}" createModifiedPropertiesHolder="{{createModifiedPropertiesHolder}}"></tg-entity-search-criteria>
            </tg-criterion>

            <tg-criterion orNull="{{propertyModel['desc'].orNull}}" not="{{propertyModel['desc'].not}}">
                <tg-singleline-text-editor entity="{{currBindingEntity}}" propertyName="tgPersistentEntityWithProperties_desc" onAcceptedValueChanged="{{validate}}" propTitle="Desc MULTI" propDesc="Desc MULTI criteria editor" currentState="{{currentState}}" externalRefreshCycle="{{refreshCycleMode}}"></tg-singleline-text-editor>
            </tg-criterion>

            <tg-range-criterion orNull="{{propertyModel['integerProp'].orNull}}" not="{{propertyModel['integerProp'].not}}" exclusive="{{propertyModel['integerProp'].exclusive}}" exclusive2="{{propertyModel['integerProp'].exclusive2}}">
                <tg-integer-editor entity="{{currBindingEntity}}" propertyName="tgPersistentEntityWithProperties_integerProp_from" onAcceptedValueChanged="{{validate}}" propTitle="Integer prop FROM" propDesc="Integer prop FROM criteria editor" currentState="{{currentState}}" externalRefreshCycle="{{refreshCycleMode}}"></tg-integer-editor>
                <tg-integer-editor entity="{{currBindingEntity}}" propertyName="tgPersistentEntityWithProperties_integerProp_to" onAcceptedValueChanged="{{validate}}" propTitle="Integer prop TO" propDesc="Integer prop TO criteria editor" currentState="{{currentState}}" externalRefreshCycle="{{refreshCycleMode}}"></tg-integer-editor>
            </tg-range-criterion>

            <tg-criterion orNull="{{propertyModel['entityProp'].orNull}}" not="{{propertyModel['entityProp'].not}}">
                <tg-entity-search-criteria entity="{{currBindingEntity}}" user="{{user}}" entityType="{{entitytype}}" propertyName="tgPersistentEntityWithProperties_entityProp" onAcceptedValueChanged="{{validate}}" propTitle="Entity prop MULTI" propDesc="Entity prop MULTI criteria editor" currentState="{{currentState}}" action="{{actions['SNATCH_BACK_VEHICLE']}}" externalRefreshCycle="{{refreshCycleMode}}" createModifiedPropertiesHolder="{{createModifiedPropertiesHolder}}"></tg-entity-search-criteria>
            </tg-criterion>

            <tg-range-criterion orNull="{{propertyModel['bigDecimalProp'].orNull}}" not="{{propertyModel['bigDecimalProp'].not}}" exclusive="{{propertyModel['bigDecimalProp'].exclusive}}" exclusive2="{{propertyModel['bigDecimalProp'].exclusive2}}">
                <tg-decimal-editor entity="{{currBindingEntity}}" propertyName="tgPersistentEntityWithProperties_bigDecimalProp_from" onAcceptedValueChanged="{{validate}}" propTitle="BigDecimal prop FROM" propDesc="BigDecimal prop FROM criteria editor" currentState="{{currentState}}" externalRefreshCycle="{{refreshCycleMode}}"></tg-decimal-editor>
                <tg-decimal-editor entity="{{currBindingEntity}}" propertyName="tgPersistentEntityWithProperties_bigDecimalProp_to" onAcceptedValueChanged="{{validate}}" propTitle="BigDecimal prop TO" propDesc="BigDecimal prop TO criteria editor" currentState="{{currentState}}" externalRefreshCycle="{{refreshCycleMode}}"></tg-decimal-editor>
            </tg-range-criterion>

            <tg-boolean-criterion orNull="{{propertyModel['booleanProp'].orNull}}" not="{{propertyModel['booleanProp'].not}}">
                <tg-boolean-editor entity="{{currBindingEntity}}" propertyName="tgPersistentEntityWithProperties_booleanProp_is" onAcceptedValueChanged="{{validate}}" propTitle="Boolean prop IS" propDesc="Boolean prop IS criteria editor" currentState="{{currentState}}" externalRefreshCycle="{{refreshCycleMode}}"></tg-boolean-editor>
                <tg-boolean-editor entity="{{currBindingEntity}}" propertyName="tgPersistentEntityWithProperties_booleanProp_not" onAcceptedValueChanged="{{validate}}" propTitle="Boolean prop NOT" propDesc="Boolean prop NOT criteria editor" currentState="{{currentState}}" externalRefreshCycle="{{refreshCycleMode}}"></tg-boolean-editor>
            </tg-boolean-criterion>

            <tg-date-range-criterion orNull="{{propertyModel['dateProp'].orNull}}" not="{{propertyModel['dateProp'].not}}" exclusive="{{propertyModel['dateProp'].exclusive}}" exclusive2="{{propertyModel['dateProp'].exclusive2}}" datePrefix="{{propertyModel['dateProp'].datePrefix}}" dateMnemonic="{{propertyModel['dateProp'].dateMnemonic}}" andBefore="{{propertyModel['dateProp'].andBefore}}">
                <tg-datetime-picker entity="{{currBindingEntity}}" propertyName="tgPersistentEntityWithProperties_dateProp_from" onAcceptedValueChanged="{{validate}}" propTitle="Date prop FROM" propDesc="Date prop FROM criteria editor" currentState="{{currentState}}" externalRefreshCycle="{{refreshCycleMode}}"></tg-datetime-picker>
                <tg-datetime-picker entity="{{currBindingEntity}}" propertyName="tgPersistentEntityWithProperties_dateProp_to" onAcceptedValueChanged="{{validate}}" propTitle="Date prop TO" propDesc="Date prop TO criteria editor" currentState="{{currentState}}" externalRefreshCycle="{{refreshCycleMode}}"></tg-datetime-picker>
            </tg-date-range-criterion>

            <tg-criterion orNull="{{propertyModel['compositeProp'].orNull}}" not="{{propertyModel['compositeProp'].not}}">
                <tg-entity-search-criteria entity="{{currBindingEntity}}" user="{{user}}" entityType="{{entitytype}}" propertyName="tgPersistentEntityWithProperties_compositeProp" onAcceptedValueChanged="{{validate}}" propTitle="Composite prop MULTI" propDesc="Composite prop MULTI criteria editor" currentState="{{currentState}}" action="{{actions['SNATCH_BACK_VEHICLE']}}" externalRefreshCycle="{{refreshCycleMode}}" createModifiedPropertiesHolder="{{createModifiedPropertiesHolder}}"></tg-entity-search-criteria>
            </tg-criterion>

            <tg-criterion orNull="{{propertyModel['critOnlyEntityProp'].orNull}}" not="{{propertyModel['critOnlyEntityProp'].not}}">
                <tg-entity-editor entity="{{currBindingEntity}}" user="{{user}}" entityType="{{entitytype}}" propertyName="tgPersistentEntityWithProperties_critOnlyEntityProp" onAcceptedValueChanged="{{validate}}" propTitle="Crit-only entity prop SINGLE" propDesc="Crit-only entity prop SINGLE criteria editor" currentState="{{currentState}}" action="{{actions['SNATCH_BACK_VEHICLE']}}" externalRefreshCycle="{{refreshCycleMode}}" createModifiedPropertiesHolder="{{createModifiedPropertiesHolder}}"></tg-entity-editor>
            </tg-criterion>
            <div></div>
        </tg-flex-layout>
    </template>
    <script>
        var SimultaneousRunException = function () {
            Object.call(this);

            this.message = "Simultaneous run exception: the run process has been already started before and not ended. Please, block UI until the run action completes.";
        };
        SimultaneousRunException.prototype = Object.create(Object.prototype);
        SimultaneousRunException.prototype.constructor = SimultaneousRunException;

        /**
         * Overridden toString method to represent this exception more meaningfully than '[Object object]'.
         *
         */
        SimultaneousRunException.prototype.toString = function () {
            return this.message;
        }

        var mr = ["margin-right: 40px", "flex"],
            mrLast = ['flex'];
        Polymer('tg-selection-criteria', {
            entitytype: null,
            /**
             * The current number of pages after the firstPage has been retrieved. To update this please invoke run() action one more time.
             */
            pageCount: null,

            /**
             * The current page number.
             */
            pageNumber: null,
            /**
             * Currently immutable capacity of the page.
             */
            pageCapacity: 5,

            /**
             * The current modified properties holder to be used during pagination (it was "persisted" after run() action has been performed).
             */
            persistedModifiedPropertiesHolder: null,

            propertyModel: {
                "": {
                    orNull: true,
                    not: false
                },

                "desc": {
                    orNull: true,
                    not: false
                },

                "integerProp": {
                    orNull: true,
                    not: false,
                    exclusive: false,
                    exclusive2: true
                },

                "entityProp": {
                    orNull: true,
                    not: false
                },

                "bigDecimalProp": {
                    orNull: true,
                    not: false,
                    exclusive: false,
                    exclusive2: true
                },

                "booleanProp": {
                    orNull: true,
                    not: false
                },

                "dateProp": {
                    orNull: true,
                    not: false,
                    exclusive: false,
                    exclusive2: true,
                    datePrefix: "PREV",
                    dateMnemonic: "MONTH",
                    andBefore: "true"
                },

                "compositeProp": {
                    orNull: true,
                    not: false
                },

                "critOnlyEntityProp": {
                    orNull: true,
                    not: false
                }
            },

            whenDesktop: [['center-justified', mr, mr, mrLast],
                          ['center-justified', mr, mr, mrLast],
                          ['center-justified', mr, mr, mrLast]],
            whenTablet: [['center-justified', mr, mrLast],
                          ['center-justified', mr, mrLast],
                          ['center-justified', mr, mrLast],
                          ['center-justified', mr, mrLast],
                          ['center-justified', mr, mrLast]],
            whenMobile: [['center-justified', mrLast],
                          ['center-justified', mrLast],
                          ['center-justified', mrLast],
                          ['center-justified', mrLast],
                          ['center-justified', mrLast],
                          ['center-justified', mrLast],
                          ['center-justified', mrLast],
                          ['center-justified', mrLast],
                          ['center-justified', mrLast]],

            currentState: "EDIT",


            /**
             * Initialisation block. It has all children web components already initialised.
             */
            ready: function () {
                var self = this;
                self.super();
                console.log("child ready");

                self.onRunDefault = self.onRunDefault.bind(self);

                self.$.ajaxRunner.addEventListener('core-response', function (e) {
                    if (e.detail.xhr.status === 200) {
                        var critAndResult = self.$.serialiser.deserialise(e.detail.response).instance;
                        var criteriaEntity = critAndResult[0];
                        var resultEntities = critAndResult.slice(1, critAndResult.length - 1);
                        var pageCount = critAndResult[critAndResult.length - 1];
                        self.onRunDefault(criteriaEntity, resultEntities, pageCount);
                    }
                });

                self.$.ajaxRunner.addEventListener('core-complete', function (e) {
                    if (e.detail.xhr.status === 200) {
                        self.onRunComplete();
                    }
                });
            },

            /**
             * The core-ajax component for entity retrieval.
             */
            ajaxRetriever: function () {
                return this.$.ajaxRetriever;
            },

            /**
             * The tg-entity-validator component for entity validation.
             */
            validator: function () {
                return this.$.validator;
            },

            onRetrieved: function (entity, bindingEntity) {
                this.entitytype = entity.type().fullClassName();
                console.log("onRetrieved");
            },

            onValidated: function (validatedEntity, bindingEntity) {
                console.log("onValidated");
            },

            extractModifiedPropertiesHolder: function (bindingEntity, originalBindingEntity) {
                var modPropHolder = this.super([bindingEntity, originalBindingEntity]);
                if (this._isEntity(bindingEntity)) {
                    modPropHolder["@@criteriaType"] = bindingEntity.type().fullClassName();
                    modPropHolder["@@pageCapacity"] = this.pageCapacity;

                    // custom property objects that hold meta-values will be transferred with modifiedPropertiesHolder
                    for (var property in this.propertyModel) {
                        if (this.propertyModel.hasOwnProperty(property)) {
                            modPropHolder["@" + property] = this.propertyModel[property];
                        }
                    }
                }
                return modPropHolder;
            },

            /////////////////////////////// RUN ACTION ///////////////////////////////
            /**
             * Default implementation for onRunComplete callback.
             */
            onRunComplete: function () {},

            validatePageCount: function() {
                if (this.pageCount === null) {
                    throw "Do not execute methods firstPage(), nextPage() etc. before the method run().";
                }
            },

            /**
             * Starts the process of centre run.
             */
            nextPage: function () {
                this.validatePageCount();
                if (!this.canNext()) {
                    throw "The next page number [" + (this.pageNumber + 1) + "] is greater than the last number of the pages [" + (this.pageCount - 1) + "].";
                }
                this.pageNumber = this.pageNumber + 1;
                this._execute(false);
            },

            /**
             * Starts the process of centre run.
             */
            prevPage: function () {
                this.validatePageCount();
                if (!this.canPrev()) {
                    throw "The previous page number [" + (this.pageNumber - 1) + "] is less than the first number of the pages [" + 0 + "].";
                }
                this.pageNumber = this.pageNumber - 1;
                this._execute(false);
            },

            /**
             * Starts the process of centre run.
             */
            firstPage: function () {
                this.validatePageCount();
                if (!this.canFirst()) {
                    throw "Cannot retrieve first page (with number [" + 0 + "]) for empty count of the pages [" + this.pageCount + "].";
                }
                this.pageNumber = 0;
                this._execute(false);
            },

            /**
             * Starts the process of centre run.
             */
            lastPage: function () {
                this.validatePageCount();
                if (!this.canLast()) {
                    throw "Cannot retrieve last page (with number [" + (this.pageCount - 1) + "]) for empty count of the pages [" + this.pageCount + "].";
                }
                this.pageNumber = this.pageCount - 1;
                this._execute(false);
            },

            canPrev: function (pageNumber) {
                return !(pageNumber - 1 < 0);
            },
            canNext: function (pageNumber, pageCount) {
                return !(pageNumber + 1 > pageCount - 1);
            },
            canFirst: function (pageNumber) {
                return !(pageNumber === 0);
            },
            canLast: function (pageNumber, pageCount) {
                return !(pageNumber + 1 >= pageCount);
            },

            /**
             * Starts the process of centre run.
             */
            run: function () {
                this.pageNumber = 0;
                this.pageCount = null;
                this._execute(true);
            },

            /**
             * Starts the process of centre execution. It does not alter 
             */
            _execute: function(isRunAction) {
                var self = this;

                if (self._runningInProgress()) {
                    var SimultaneousRunException = this._getSimultaneousRunExceptionType();
                    throw new SimultaneousRunException();
                }

                self.startRefreshCycleModeForEditors();

                if (isRunAction) {
                    self.persistedModifiedPropertiesHolder = self.extractModifiedPropertiesHolder(self.currBindingEntity, self.originalBindingEntity);
                }

                if (this.pageCount !== null) {
                    self.persistedModifiedPropertiesHolder["@@pageNumber"] = this.pageNumber;
                    self.persistedModifiedPropertiesHolder["@@pageCount"] = this.pageCount;
                } else {
                    if (typeof self.persistedModifiedPropertiesHolder["@@pageNumber"] !== 'undefined') {
                        delete (self.persistedModifiedPropertiesHolder)["@@pageNumber"];
                    }
                    if (typeof self.persistedModifiedPropertiesHolder["@@pageCount"] !== 'undefined') {
                        delete (self.persistedModifiedPropertiesHolder)["@@pageCount"];
                    }
                }

                var holder = self.persistedModifiedPropertiesHolder;
                console.log("HOLDER:", holder);
                // cancel previous validation before starting saving process -- it includes validation process internally!
                self.$.validator.abortValidationIfAny();

                // IMPORTANT: at this stage no client side check is needed for hasModified(holder).
                //            This check will be done on server -- and appropriate onRunDefault callback will be triggered.
                self._runModifiedProperties(self._reset(holder));
                // if (self._hasModified(holder)) {
                //     self._saveModifiedProperties(self._reset(holder));
                // } else {
                //     self.$.validator.validate(self._reset(holder));
                // }
            },

            _runningInProgress: function () {
                return this.$.ajaxRunner.loading;
            },

            /**
             * Starts the process of centre run.
             *
             * @param modifiedPropertiesHolder -- the entity with modified properties
             */
            _runModifiedProperties: function (modifiedPropertiesHolder) {
                // console.log("save: modifiedPropertiesHolder", modifiedPropertiesHolder);
                var ser = this.$.serialiser.serialise(modifiedPropertiesHolder);
                // console.log("save: serialised modifiedPropertiesHolder", ser);
                this.$.ajaxRunner.body = JSON.stringify(ser);
                this.$.ajaxRunner.go();
            },

            //////////////////////////////////////// BINDING & UTILS ////////////////////////////////////////
            _getSimultaneousRunExceptionType: function () {
                return SimultaneousRunException;
            },

            /**
             * Default implementation for onRun callback.
             */
            onRunDefault: function (criteriaEntity, resultEntities, pageCount) {
                var msg = this.toastMsg("Running", criteriaEntity);
                this.openToast(criteriaEntity, msg, !criteriaEntity.isValid() || criteriaEntity.isValidWithWarning(), msg);

                // this.startRefreshCycleModeForEditors();
                var newBindingEntity = this.onEntityReceived(criteriaEntity);

                this.pageCount = pageCount; // at this stage -- update pageCount not only on run(), but also on firstPage(), nextPage() etc.
                // custom external action
                this.onRun(criteriaEntity, newBindingEntity, resultEntities, pageCount);
            }
        });
    </script>
</polymer-element>