<link rel="import" href="/resources/polymer/polymer/polymer.html">

<link rel="import" href="/resources/binding/tg-entity-binder.html">
<link rel="import" href="/resources/layout/tg-flex-layout.html">

<link rel="import" href="/resources/editors/tg-singleline-text-editor.html">
<link rel="import" href="/resources/editors/tg-integer-editor.html">
<link rel="import" href="/resources/editors/tg-decimal-editor.html">
<link rel="import" href="/resources/editors/tg-boolean-editor.html">
<link rel="import" href="/resources/editors/tg-datetime-picker.html">
<link rel="import" href="/resources/editors/tg-entity-editor.html">
<link rel="import" href="/resources/editors/tg-entity-search-criteria.html">

<link rel="import" href="/resources/polymer/core-ajax/core-ajax.html">
<link rel="import" href="/resources/centre/tg-criteria-validator.html">
<link rel="import" href="/resources/centre/criterion/tg-criterion.html">
<link rel="import" href="/resources/centre/criterion/tg-range-criterion.html">
<link rel="import" href="/resources/centre/criterion/tg-date-range-criterion.html">

<polymer-element name="tg-selection-criteria" extends="tg-entity-binder" attributes="mitype">
    <template>
        <shadow></shadow>
        <tg-criteria-validator id="validator" user="{{user}}" mitype="{{mitype}}" onvalidated="{{onValidatedDefault}}"></tg-criteria-validator>
        <core-ajax id="ajaxRetriever" url="/users/{{user}}/criteria/{{mitype}}" method="GET" handleas="json"></core-ajax>

        <tg-flex-layout whenDesktop="{{whenDesktop}}" whenTablet="{{whenTablet}}" whenMobile="{{whenMobile}}">
            <tg-criterion orNull="true" not="false">
                <tg-entity-search-criteria entity="{{currBindingEntity}}" user="{{user}}" entityType="{{entitytype}}" propertyName="tgPersistentEntityWithProperties_" onAcceptedValueChanged="{{validate}}" propTitle="Key prop MULTI" propDesc="Key prop MULTI criteria editor" currentState="{{currentState}}" action="{{actions['SNATCH_BACK_VEHICLE']}}" externalRefreshCycle="{{refreshCycleMode}}" createModifiedPropertiesHolder="{{createModifiedPropertiesHolder}}"></tg-entity-search-criteria>
            </tg-criterion>

            <tg-criterion orNull="true" not="false">
                <tg-singleline-text-editor entity="{{currBindingEntity}}" propertyName="tgPersistentEntityWithProperties_desc" onAcceptedValueChanged="{{validate}}" propTitle="Desc MULTI" propDesc="Desc MULTI criteria editor" currentState="{{currentState}}" externalRefreshCycle="{{refreshCycleMode}}"></tg-singleline-text-editor>
            </tg-criterion>

            <tg-range-criterion orNull="true" not="false" exclusive="false" exclusive2="true">
                <tg-integer-editor entity="{{currBindingEntity}}" propertyName="tgPersistentEntityWithProperties_integerProp_from" onAcceptedValueChanged="{{validate}}" propTitle="Integer prop FROM" propDesc="Integer prop FROM criteria editor" currentState="{{currentState}}" externalRefreshCycle="{{refreshCycleMode}}"></tg-integer-editor>
                <tg-integer-editor entity="{{currBindingEntity}}" propertyName="tgPersistentEntityWithProperties_integerProp_to" onAcceptedValueChanged="{{validate}}" propTitle="Integer prop TO" propDesc="Integer prop TO criteria editor" currentState="{{currentState}}" externalRefreshCycle="{{refreshCycleMode}}"></tg-integer-editor>
            </tg-range-criterion>

            <tg-criterion orNull="true" not="false">
                <tg-entity-search-criteria entity="{{currBindingEntity}}" user="{{user}}" entityType="{{entitytype}}" propertyName="tgPersistentEntityWithProperties_entityProp" onAcceptedValueChanged="{{validate}}" propTitle="Entity prop MULTI" propDesc="Entity prop MULTI criteria editor" currentState="{{currentState}}" action="{{actions['SNATCH_BACK_VEHICLE']}}" externalRefreshCycle="{{refreshCycleMode}}" createModifiedPropertiesHolder="{{createModifiedPropertiesHolder}}"></tg-entity-search-criteria>
            </tg-criterion>

            <tg-range-criterion orNull="true" not="false" exclusive="false" exclusive2="true">
                <tg-decimal-editor entity="{{currBindingEntity}}" propertyName="tgPersistentEntityWithProperties_bigDecimalProp_from" onAcceptedValueChanged="{{validate}}" propTitle="BigDecimal prop FROM" propDesc="BigDecimal prop FROM criteria editor" currentState="{{currentState}}" externalRefreshCycle="{{refreshCycleMode}}"></tg-decimal-editor>
                <tg-decimal-editor entity="{{currBindingEntity}}" propertyName="tgPersistentEntityWithProperties_bigDecimalProp_to" onAcceptedValueChanged="{{validate}}" propTitle="BigDecimal prop TO" propDesc="BigDecimal prop TO criteria editor" currentState="{{currentState}}" externalRefreshCycle="{{refreshCycleMode}}"></tg-decimal-editor>
            </tg-range-criterion>

            <tg-criterion orNull="true" not="false">
                <tg-boolean-editor entity="{{currBindingEntity}}" propertyName="tgPersistentEntityWithProperties_booleanProp_is" onAcceptedValueChanged="{{validate}}" propTitle="Boolean prop IS" propDesc="Boolean prop IS criteria editor" currentState="{{currentState}}" externalRefreshCycle="{{refreshCycleMode}}"></tg-boolean-editor>
                <tg-boolean-editor entity="{{currBindingEntity}}" propertyName="tgPersistentEntityWithProperties_booleanProp_not" onAcceptedValueChanged="{{validate}}" propTitle="Boolean prop NOT" propDesc="Boolean prop NOT criteria editor" currentState="{{currentState}}" externalRefreshCycle="{{refreshCycleMode}}"></tg-boolean-editor>
            </tg-criterion>

            <tg-date-range-criterion orNull="true" not="false" exclusive="false" exclusive2="true" datePrefix="PREV" dateMnemonic="MONTH" andBefore="true">
                <tg-datetime-picker entity="{{currBindingEntity}}" propertyName="tgPersistentEntityWithProperties_dateProp_from" onAcceptedValueChanged="{{validate}}" propTitle="Date prop FROM" propDesc="Date prop FROM criteria editor" currentState="{{currentState}}" externalRefreshCycle="{{refreshCycleMode}}"></tg-datetime-picker>
                <tg-datetime-picker entity="{{currBindingEntity}}" propertyName="tgPersistentEntityWithProperties_dateProp_to" onAcceptedValueChanged="{{validate}}" propTitle="Date prop TO" propDesc="Date prop TO criteria editor" currentState="{{currentState}}" externalRefreshCycle="{{refreshCycleMode}}"></tg-datetime-picker>
            </tg-date-range-criterion>

            <tg-criterion orNull="true" not="false">
                <tg-entity-search-criteria entity="{{currBindingEntity}}" user="{{user}}" entityType="{{entitytype}}" propertyName="tgPersistentEntityWithProperties_compositeProp" onAcceptedValueChanged="{{validate}}" propTitle="Composite prop MULTI" propDesc="Composite prop MULTI criteria editor" currentState="{{currentState}}" action="{{actions['SNATCH_BACK_VEHICLE']}}" externalRefreshCycle="{{refreshCycleMode}}" createModifiedPropertiesHolder="{{createModifiedPropertiesHolder}}"></tg-entity-search-criteria>
            </tg-criterion>

            <tg-criterion orNull="true" not="false">
                <tg-entity-editor entity="{{currBindingEntity}}" user="{{user}}" entityType="{{entitytype}}" propertyName="tgPersistentEntityWithProperties_critOnlyEntityProp" onAcceptedValueChanged="{{validate}}" propTitle="Crit-only entity prop SINGLE" propDesc="Crit-only entity prop SINGLE criteria editor" currentState="{{currentState}}" action="{{actions['SNATCH_BACK_VEHICLE']}}" externalRefreshCycle="{{refreshCycleMode}}" createModifiedPropertiesHolder="{{createModifiedPropertiesHolder}}"></tg-entity-editor>
            </tg-criterion>
        </tg-flex-layout>
    </template>
    <script>
        var mr = "margin-right: 40px";
        Polymer('tg-selection-criteria', {
            entitytype: null,

            whenDesktop: ['vertical',               ['horizontal', 'justified', [mr], [mr]], 
                                                   ['horizontal', 'justified', [mr], [mr]], 
                                                   ['horizontal', 'justified', [mr], [mr]], 
                                                   ['horizontal', 'justified', [mr], [mr]], 
                                                   ['horizontal', 'justified', [mr]] 
                                                   ],
            whenTablet: this.whenDesktop,
            whenMobile: this.whenDesktop,

            currentState: "EDIT",

            /**
             * The core-ajax component for entity retrieval. 
             */
            ajaxRetriever: function() {
                return this.$.ajaxRetriever;
            },

            /**
             * The tg-entity-validator component for entity validation. 
             */
            validator: function() {
                return this.$.validator;
            },

            onRetrieved: function(entity, bindingEntity) {
                this.entitytype = entity.type().fullClassName();
                console.log("onRetrieved");
            },

            onValidated: function(validatedEntity, bindingEntity) {
                console.log("onValidated");
            },

            extractModifiedPropertiesHolder: function (bindingEntity, originalBindingEntity, currBindingEntityCopy) {
                var modPropHolder = this.super([bindingEntity, originalBindingEntity, currBindingEntityCopy]);
                if (this._isEntity(bindingEntity)) {
                    modPropHolder["@criteriaType"] = bindingEntity.type().fullClassName();
                }
                return modPropHolder;
            }
        });
    </script>
</polymer-element>