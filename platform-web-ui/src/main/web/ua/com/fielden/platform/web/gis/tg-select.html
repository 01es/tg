<link rel="import" href="/resources/polymer/leaflet/leaflet-lib.html">

<script>
(function() {
	var Select = function(_map, _getLayerById, _markerFactory, tgMap) {
		var self = this;

		self._map = _map;
		self._getLayerById = _getLayerById;
		self._markerFactory = _markerFactory;

		self._featureToLeafletIds = {};
		self._prevId;
		self._tgMap = tgMap;
		
		self._retrievedEntitySelectionHandler = function (newRetrievedEntitySelection) {
		    if (newRetrievedEntitySelection.selected) {
		        self.selectById(newRetrievedEntitySelection.entity.properties.layerId, true);
		    } else {
		        self.deselectById(newRetrievedEntitySelection.entity.properties.layerId, true);
		    }
		};
		self._tgMap.retrievedEntitySelectionHandler = self._retrievedEntitySelectionHandler;
	};

	Select.prototype._deselectVisuallyWithoutEventFiring = function (layerId) {
		var layer = this._getLayerById(layerId);
		console.debug('_deselectVisuallyWithoutEventFiring: layerId =', layerId, 'layer =', layer);
		if (layer instanceof this._markerFactory.ArrowMarker || layer instanceof this._markerFactory.CircleMarker) {
			layer.setSelected(false);
		}
	}

	Select.prototype._selectVisuallyWithoutEventFiring = function (layerId) {
		var layer = this._getLayerById(layerId);
		console.debug('_selectVisuallyWithoutEventFiring: layerId =', layerId, 'layer =', layer);
		if (layer instanceof this._markerFactory.ArrowMarker || layer instanceof this._markerFactory.CircleMarker) {
			this._map.panTo(layer.getLatLng()); // centering of the marker (fitToBounds is not needed)	
			layer.setSelected(true);
		} else if (layer instanceof L.Polygon) {
			this._map.fitBounds(layer.getBounds());
			// map.panTo(layer.getBounds().getCenter()); // fitToBounds?
		}
	}

	Select.prototype._selectTabularlyWithoutEventFiring = function (layerId) {
		console.debug('_selectTabularlyWithoutEventFiring: layerId =', layerId);
		var layer = this._getLayerById(layerId);
		var feature = layer.feature;
		
		this._tgMap.retrievedEntitySelectionHandler = function () {};
		this._tgMap.retrievedEntitySelection = {entity: feature, selected: true};
		this._tgMap.retrievedEntitySelectionHandler = this._retrievedEntitySelectionHandler;
	}
	
	Select.prototype._deselectTabularlyWithoutEventFiring = function (layerId) {
		console.debug('_deselectTabularlyWithoutEventFiring: layerId =', layerId);
		// TODO !!! java._deselectTabularlyWithoutEventFiring(featureId);
	}

	Select.prototype.selectById = function (layerId, withoutTabularSelectionDeselection) {
	    console.debug("selectById(" + layerId + ");");
		if (this._prevId) { // at the moment of selecting the feature - there has been other previously selected feature (or, perhaps, the same) 
			this._deselectVisuallyWithoutEventFiring(this._prevId);
			this._deselectTabularlyWithoutEventFiring(this._prevId);
		}
		this._selectVisuallyWithoutEventFiring(layerId);
		if (!withoutTabularSelectionDeselection) {
		    this._selectTabularlyWithoutEventFiring(layerId);
		}
		this._prevId = layerId;
	}
	
	L.GIS = L.GIS || {};
	L.GIS.Select = Select;
})();
</script>