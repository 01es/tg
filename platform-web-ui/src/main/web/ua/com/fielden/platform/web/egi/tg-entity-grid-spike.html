<link rel="import" href="/resources/polymer/polymer/polymer.html">
<link rel="import" href="/tg-web-app/tg-app-config.html">
<link rel="import" href="/tg-reflector">
<link rel="import" href="/resources/layout/tg-flex-layout.html">
<link rel="import" href="/resources/egi/tg-custom-action-dialog.html">
<link rel="import" href="/resources/polymer/iron-media-query/iron-media-query.html">
<link rel="import" href="/resources/polymer/paper-checkbox/paper-checkbox.html">
<link rel="import" href="/resources/polymer/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/resources/polymer/paper-material/paper-material.html">
<link rel="import" href="/resources/polymer/iron-icon/iron-icon.html">
<link rel="import" href="/resources/polymer/iron-icons/iron-icons.html">
<link rel="import" href="/resources/polymer/iron-collapse/iron-collapse.html">
<link rel="import" href="/resources/polymer/neon-animation/neon-animations.html">
<link rel="import" href="/resources/polymer/paper-dialog/paper-dialog.html">
<link rel="import" href="/resources/polymer/paper-button/paper-button.html">

<dom-module id="tg-entity-grid-spike">
    <style>
        /*miscellanea styles*/
        .truncate {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /*Table related styles*/
        .data-table {
            background-color: white;
        }
        .table-header-row {
            font-size: 0.9rem;
            color: #757575;
            height: 3.5rem;
            cursor: default;
        }
        .table-data-row {
            font-size: 1rem;
            color: #212121;
            height: 3rem;
            border-top: 1px solid #e3e3e3;
            cursor: default;
        }
        .table-data-row[selected] {
            background-color: #F5F5F5;
        }
        .table-data-row:hover {
            background-color: #EEEEEE;
        }
        .table-cell,
        .table-data-cell {
            margin-right: 1.2rem;
        }
        .table-cell:first-child,
        .table-data-cell:first-child {
            margin-left: 1.2rem;
        }
        .table-data-cell {
            cursor: pointer;
        }
        .grid-toolbar {
            height: 4rem;
            margin: 0 0.6rem;
        }
        paper-checkbox.blue {
            --paper-checkbox-checked-color: #0288D1;
            --paper-checkbox-checked-ink-color: #0288D1;
        }
        paper-checkbox.header {
            --paper-checkbox-unchecked-color: #757575;
            --paper-checkbox-unchecked-ink-color: #757575;
        }
        paper-checkbox.body {
            --paper-checkbox-unchecked-color: #212121;
            --paper-checkbox-unchecked-ink-color: #212121;
        }
        /*Card related styles*/
        .card {
            margin: 20px 30px;
        }
        .card-toolbar {
            background-color: white;
            margin: 0 30px;
        }
        .card-header {
            padding: 10px;
            border-bottom: 1px solid #e5e5e5;
        }
        .card-header-background[selected] {
            background-color: #F5F5F5;
            opacity: none;
        }
        .card-header-background:not([selected]) {
            background-color: white;
            opacity: 0.7;
        }
        .data-entry {
            padding: 0.75rem 1.5rem;
        }
        .data-label {
            font-size: 0.75rem;
            background: transparent;
            color: #757575;
            cursor: default;
        }
        .data-value {
            height: 1.4rem;
            margin: 0.5rem 0 0.25rem;
            border-bottom: 1px solid black;
            cursor: pointer;
            color: #607D8B;
            cursor: pointer;
        }
        .expand-button {
            position: absolute;
            bottom: 0;
            left: calc(50% - 14px);
            padding: 0;
        }
    </style>
    <template>
        <content id="column_selector" select="tg-property-column" hidden></content>
        <content id="primary_action_selector" select=".primary-action" hidden></content>
        <content id="secondary_action_selector" select=".secondary-action" hidden></content>
        <tg-app-config id="appConfig"></tg-app-config>
        <tg-reflector id="reflector"></tg-reflector>
        <iron-media-query id="mobileQuery" query="[[_calcMobileQuery()]]" on-query-matches-changed="_mobileChanged"></iron-media-query>
        <iron-media-query id="tabletQuery" query="[[_calcTabletQuery()]]" on-query-matches-changed="_tabletChanged"></iron-media-query>
        <iron-media-query id="desktopQuery" query="[[_calcDesktopQuery()]]" on-query-matches-changed="_desktopChanged"></iron-media-query>

        <!-- The dialog for tg-ui-action -->
        <tg-custom-action-dialog id="actionDialog"></tg-custom-action-dialog>

        <!-- The dialog for summary when egi is in card layout -->
        <paper-dialog id="summaryDialog" modal entry-animation="slide-down-animation" exit-animation="slide-up-animation">
            <tg-flex-layout when-desktop="{{summaryLayout.desktop}}" when-tablet="{{summaryLayout.tablet}}" when-mobile="{{summaryLayout.mobile}}">
                <template is="dom-repeat" items="[[cardSummary]]">
                    <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(item)]]">
                        <div class="data-label truncate">[[item.columnTitle]]</div>
                        <div class="data-value relative">
                            <template is="dom-if" if="[[_isBooleanProp(totals, item)]]">
                                <iron-icon style="height:1.1em" icon="[[_getBooleanIcon(totals, item)]]"></iron-icon>
                            </template>
                            <template is="dom-if" if="[[_isNotBooleanProp(totals, item)]]">
                                <div class="truncate">[[_getValue(totals, item)]]</div>
                            </template>
                        </div>
                    </div>
                </template>
            </tg-flex-layout>
            <div class="buttons">
                <paper-button dialog-confirm autofocus>Close</paper-button>
            </div>
        </paper-dialog>

        <template is="dom-if" if="[[!cardLayout]]" restamp>
            <paper-material elevation="1" style="margin: 10px 30px;">
                <div class="layout vertical data-table">
                    <!--Table toolbar-->
                    <div class="grid-toolbar layout horizontal justified">
                        <div class="layout horizontal center">
                            <content select=".entity-specific-action"></content>
                        </div>
                        <div class="layout horizontal center">
                            <content select=".standart-action"></content>
                        </div>
                    </div>
                    <!-- Table header -->
                    <div class="layout horizontal table-header-row">
                        <div class="table-cell layout horizontal center">
                            <paper-checkbox class="blue header" checked="[[selectedAll]]" on-change="_allSelectionChanged"></paper-checkbox>
                        </div>
                        <template is="dom-if" if="[[primaryAction]]">
                            <div class="table-cell layout horizontal center">
                                <!--Primary action header goes here-->
                            </div>
                        </template>
                        <template is="dom-repeat" items="[[columns]]">
                            <div class="table-cell layout horizontal center" style$="[[_calcColumnHeaderStyle(item)]]">
                                <div class="truncate" style$="[[_calcColumnHeaderStyle(item)]]">[[item.columnTitle]]</div>
                            </div>
                        </template>
                        <template is="dom-if" if="[[_isSecondaryActionsPresent(secondaryActions)]]">
                            <div class="table-cell layout horizontal center">
                                <!--Secondary actions header goes here-->
                            </div>
                        </template>
                    </div>
                    <!-- Table body -->
                    <template is="dom-repeat" items="[[egiModel]]" as="egiEntity" index-as="entityIndex">
                        <div class="layout horizontal table-data-row" selected$="[[egiEntity.selected]]">
                            <div class="table-cell layout horizontal center">
                                <paper-checkbox class="blue body" checked="[[egiEntity.selected]]" on-change="_selectionChanged"></paper-checkbox>
                            </div>
                            <template is="dom-if" if="[[primaryAction]]">
                                <div class="table-cell layout horizontal center">
                                    <!--Primary actions goes here-->
                                </div>
                            </template>
                            <div class="table-data-cell relative layout horizontal center" style$="[[_calcRenderingHintsStyle(entityIndex, columns.0)]]" on-tap="_tapAction">
                                <div class="truncate" style="width:60px">[[_getValue(egiEntity.entity, columns.0)]]</div>
                            </div>
                            <div class="table-data-cell relative layout horizontal center" style$="[[_calcRenderingHintsStyle(entityIndex, columns.1)]]" on-tap="_tapAction">
                                <div class="truncate" style="width:200px">[[_getValue(egiEntity.entity, columns.1)]]</div>
                            </div>
                            <div class="table-data-cell relative layout horizontal center" style$="[[_calcRenderingHintsStyle(entityIndex, columns.2)]]" on-tap="_tapAction">
                                <div class="truncate" style="width:42px">[[_getValue(egiEntity.entity, columns.2)]]</div>
                            </div>
                            <div class="table-data-cell relative layout horizontal center" style$="[[_calcRenderingHintsStyle(entityIndex, columns.3)]]" on-tap="_tapAction">
                                <div class="truncate" style="width:42px">[[_getValue(egiEntity.entity, columns.3)]]</div>
                            </div>
                            <div class="table-data-cell relative layout horizontal center" style$="[[_calcRenderingHintsStyle(entityIndex, columns.4)]]" on-tap="_tapAction">
                                <div class="truncate" style="width:42px">[[_getValue(egiEntity.entity, columns.4)]]</div>
                            </div>
                            <div class="table-data-cell relative layout horizontal center" style$="[[_calcRenderingHintsStyle(entityIndex, columns.5)]]" on-tap="_tapAction">
                                <div class="truncate" style="width:42px">[[_getValue(egiEntity.entity, columns.5)]]</div>
                            </div>
                            <div class="table-data-cell relative layout horizontal center" style$="[[_calcRenderingHintsStyle(entityIndex, columns.6)]]" on-tap="_tapAction">
                                <div class="truncate" style="width:42px">[[_getValue(egiEntity.entity, columns.6)]]</div>
                            </div>
                            <div class="table-data-cell relative layout horizontal center" style$="[[_calcRenderingHintsStyle(entityIndex, columns.7)]]" on-tap="_tapAction">
                                <div class="truncate" style="width:42px">[[_getValue(egiEntity.entity, columns.7)]]</div>
                            </div>
                            <div class="table-data-cell relative layout horizontal center" style$="[[_calcRenderingHintsStyle(entityIndex, columns.8)]]" on-tap="_tapAction">
                                <div class="truncate" style="width:68px">[[_getValue(egiEntity.entity, columns.8)]]</div>
                            </div>
                            <div class="table-data-cell relative layout horizontal center" style$="[[_calcRenderingHintsStyle(entityIndex, columns.9)]]" on-tap="_tapAction">
                                <div class="truncate" style="width:42px">[[_getValue(egiEntity.entity, columns.9)]]</div>
                            </div>
                            <div class="table-data-cell relative layout horizontal center" style$="[[_calcRenderingHintsStyle(entityIndex, columns.10)]]" on-tap="_tapAction">
                                <div class="truncate" style="width:42px">[[_getValue(egiEntity.entity, columns.10)]]</div>
                            </div>
                            <div class="table-data-cell relative layout horizontal center" style$="[[_calcRenderingHintsStyle(entityIndex, columns.11)]]" on-tap="_tapAction">
                                <div class="truncate" style="width:68px">[[_getValue(egiEntity.entity, columns.11)]]</div>
                            </div>
                            <div class="table-data-cell relative layout horizontal center" style$="[[_calcRenderingHintsStyle(entityIndex, columns.12)]]" on-tap="_tapAction">
                                <div class="truncate" style="width:68px">[[_getValue(egiEntity.entity, columns.12)]]</div>
                            </div>
                            <div class="table-data-cell relative layout horizontal center" style$="[[_calcRenderingHintsStyle(entityIndex, columns.13)]]" on-tap="_tapAction">
                                <div class="truncate" style="width:50px">[[_getValue(egiEntity.entity, columns.13)]]</div>
                            </div>
                            <div class="table-data-cell relative layout horizontal center" style$="[[_calcRenderingHintsStyle(entityIndex, columns.14)]]" on-tap="_tapAction">
                                <div class="truncate" style="width:42px">[[_getValue(egiEntity.entity, columns.14)]]</div>
                            </div>
                            <!--<template is="dom-repeat" items="[[columns]]" as="column">
                                <div class="table-data-cell relative layout horizontal center" style$="[[_calcColumnStyle(column)]]" on-tap="_tapAction">
                                    <div class="fit" style$="[[_calcRenderingHintsStyle(entityIndex, column.property)]]">
                                    </div>
                                    <template is="dom-if" if="[[_isBooleanProp(egiEntity.entity, column)]]">
                                        <iron-icon icon="[[_getBooleanIcon(egiEntity.entity, column)]]"></iron-icon>
                                    </template>
                                    <template is="dom-if" if="[[_isNotBooleanProp(egiEntity.entity, column)]]">
                                        <div class="truncate" style$="[[_calcColumnStyle(column)]]">[[_getValue(egiEntity.entity, column)]]</div>
                                    </template>
                                </div>
                            </template>-->
                            <template is="dom-if" if="[[_isSecondaryActionsPresent(secondaryActions)]]">
                                <div class="table-cell">
                                    <!--Secondary actions goes here-->
                                </div>
                            </template>
                        </div>
                    </template>
                    <!-- Table footer -->
                    <template is="dom-if" if="[[totals]]">
                        <template is="dom-repeat" items="[[gridSummary]]" as="summaryRow" index-as="summaryRowIndex">
                            <template is="dom-if" if="[[primaryAction]]">
                                <div class="table-cell layout horizontal center">
                                    <!--Primary action header goes here-->
                                </div>
                            </template>
                            <template is="dom-repeat" items="[[summaryRow]]" as="summary" index-as="summaryIndex">
                                <template is="dom-if" if="[[summary]]">
                                    <div class="table-cell layout horizontal center" style$="[[_calcColumnStyle(summary)]]">
                                        <template is="dom-if" if="[[_isBooleanProp(totals, summary)]]">
                                            <iron-icon icon="[[_getBooleanIcon(totals, summary)]]"></iron-icon>
                                        </template>
                                        <template is="dom-if" if="[[_isNotBooleanProp(totals, summary)]]">
                                            <div class="truncate" style$="[[_calcColumnStyle(summary)]]">[[_getValue(totals, summary)]]</div>
                                        </template>
                                    </div>
                                </template>
                                <template is="dom-if" if="[[!summary]]">
                                    <div class="table-cell" style$="[[_calcEmptyTotalStyle(summaryIndex, columns)]]">
                                    </div>
                                </template>
                            </template>
                            <template is="dom-if" if="[[_isSecondaryActionsPresent(secondaryActions)]]">
                                <div class="table-cell">
                                    <!--Secondary actions header goes here-->
                                </div>
                            </template>
                        </template>
                    </template>
                </div>
            </paper-material>
        </template>
        <template is="dom-if" if="[[cardLayout]]" restamp>
            <div class="card-toolbar layout vertical">
                <div class="layout horizontal center">
                    <content select=".entity-specific-action"></content>
                </div>
                <div class="layout horizontal center">
                    <paper-checkbox style="margin-left:10px;" class="blue" checked="[[selectedAll]]" on-change="_allSelectionChanged"></paper-checkbox>
                    <paper-icon-button icon="editor:functions" on-tap="_showSummary" disabled$="[[!_isSummaryEnabled(egiModel, cardLayout)]]"></paper-icon-button>
                    <content select=".standart-action"></content>
                </div>
            </div>
            <template is="dom-repeat" items="[[egiModel]]" as="egiEntity" index-as="entityIndex">
                <paper-material elevation="1" class="card layout vertical">
                    <div class="card-header layout horizontal center justified relative">
                        <div selected$="[[egiEntity.selected]]" class="card-header-background fit"></div>
                        <div class="layout horizontal center relative">
                            <div>
                                <!-- this div might not be needed-->
                                <paper-checkbox class="blue" checked="[[egiEntity.selected]]" on-change="_selectionChanged"></paper-checkbox>
                            </div>
                            <template is="dom-if" if="[[primaryAction]]">
                                <!--Primary actions goes here-->
                            </template>
                        </div>
                        <div class="layout horizontal center relative">
                            <template is="dom-if" if="[[_isSecondaryActionsPresent(secondaryActions)]]">
                                <!--Secondary actions goes here-->
                            </template>
                        </div>
                    </div>
                    <div style$="[[_calcCardStyle(collapsePanelVisible)]]">
                        <tg-flex-layout when-desktop="[[shortLayout.desktop]]" when-tablet="[[shortLayout.tablet]]" when-mobile="[[shortLayout.mobile]]">
                            <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(columns.0)]]">
                                <div class="data-label truncate">[[columns.0.columnTitle]]</div>
                                <div class="data-value truncate" style$="[[_calcCardRenderingHintsStyle(entityIndex, columns.0.property)]]" on-tap="_tapAction">[[_getValue(egiEntity.entity, columns.0)]]</div>
                            </div>
                            <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(columns.1)]]">
                                <div class="data-label truncate">[[columns.1.columnTitle]]</div>
                                <div class="data-value truncate" style$="[[_calcCardRenderingHintsStyle(entityIndex, columns.1.property)]]" on-tap="_tapAction">[[_getValue(egiEntity.entity, columns.1)]]</div>
                            </div>
                            <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(columns.2)]]">
                                <div class="data-label truncate">[[columns.2.columnTitle]]</div>
                                <div class="data-value truncate" style$="[[_calcCardRenderingHintsStyle(entityIndex, columns.2.property)]]" on-tap="_tapAction">[[_getValue(egiEntity.entity, columns.2)]]</div>
                            </div>
                            <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(columns.3)]]">
                                <div class="data-label truncate">[[columns.3.columnTitle]]</div>
                                <div class="data-value truncate" style$="[[_calcCardRenderingHintsStyle(entityIndex, columns.3.property)]]" on-tap="_tapAction">[[_getValue(egiEntity.entity, columns.3)]]</div>
                            </div>
                            <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(columns.4)]]">
                                <div class="data-label truncate">[[columns.4.columnTitle]]</div>
                                <div class="data-value truncate" style$="[[_calcCardRenderingHintsStyle(entityIndex, columns.4.property)]]" on-tap="_tapAction">[[_getValue(egiEntity.entity, columns.4)]]</div>
                            </div>
                            <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(columns.5)]]">
                                <div class="data-label truncate">[[columns.5.columnTitle]]</div>
                                <div class="data-value truncate" style$="[[_calcCardRenderingHintsStyle(entityIndex, columns.5.property)]]" on-tap="_tapAction">[[_getValue(egiEntity.entity, columns.5)]]</div>
                            </div>
                            <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(columns.6)]]">
                                <div class="data-label truncate">[[columns.6.columnTitle]]</div>
                                <div class="data-value truncate" style$="[[_calcCardRenderingHintsStyle(entityIndex, columns.6.property)]]" on-tap="_tapAction">[[_getValue(egiEntity.entity, columns.6)]]</div>
                            </div>
                            <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(columns.7)]]">
                                <div class="data-label truncate">[[columns.7.columnTitle]]</div>
                                <div class="data-value truncate" style$="[[_calcCardRenderingHintsStyle(entityIndex, columns.7.property)]]" on-tap="_tapAction">[[_getValue(egiEntity.entity, columns.7)]]</div>
                            </div>
                            <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(columns.8)]]">
                                <div class="data-label truncate">[[columns.8.columnTitle]]</div>
                                <div class="data-value truncate" style$="[[_calcCardRenderingHintsStyle(entityIndex, columns.8.property)]]" on-tap="_tapAction">[[_getValue(egiEntity.entity, columns.8)]]</div>
                            </div>
                            <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(columns.9)]]">
                                <div class="data-label truncate">[[columns.9.columnTitle]]</div>
                                <div class="data-value truncate" style$="[[_calcCardRenderingHintsStyle(entityIndex, columns.9.property)]]" on-tap="_tapAction">[[_getValue(egiEntity.entity, columns.9)]]</div>
                            </div>
                            <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(columns.10)]]">
                                <div class="data-label truncate">[[columns.10.columnTitle]]</div>
                                <div class="data-value truncate" style$="[[_calcCardRenderingHintsStyle(entityIndex, columns.10.property)]]" on-tap="_tapAction">[[_getValue(egiEntity.entity, columns.10)]]</div>
                            </div>
                            <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(columns.11)]]">
                                <div class="data-label truncate">[[columns.11.columnTitle]]</div>
                                <div class="data-value truncate" style$="[[_calcCardRenderingHintsStyle(entityIndex, columns.11.property)]]" on-tap="_tapAction">[[_getValue(egiEntity.entity, columns.11)]]</div>
                            </div>
                            <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(columns.12)]]">
                                <div class="data-label truncate">[[columns.12.columnTitle]]</div>
                                <div class="data-value truncate" style$="[[_calcCardRenderingHintsStyle(entityIndex, columns.12.property)]]" on-tap="_tapAction">[[_getValue(egiEntity.entity, columns.12)]]</div>
                            </div>
                            <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(columns.13)]]">
                                <div class="data-label truncate">[[columns.13.columnTitle]]</div>
                                <div class="data-value truncate" style$="[[_calcCardRenderingHintsStyle(entityIndex, columns.13.property)]]" on-tap="_tapAction">[[_getValue(egiEntity.entity, columns.13)]]</div>
                            </div>
                            <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(columns.14)]]">
                                <div class="data-label truncate">[[columns.14.columnTitle]]</div>
                                <div class="data-value truncate" style$="[[_calcCardRenderingHintsStyle(entityIndex, columns.14.property)]]" on-tap="_tapAction">[[_getValue(egiEntity.entity, columns.14)]]</div>
                            </div>



                            <!--<template is="dom-repeat" items="[[columns]]" as="column">
                                <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(column)]]">
                                    <div class="data-label truncate">[[column.columnTitle]]</div>
                                    <div class="data-value relative" on-tap="_tapAction">
                                        <div style$="[[_calcRenderingHintsStyle(entityIndex, column.property)]]" class="fit">
                                        </div>
                                        <template is="dom-if" if="[[_isBooleanProp(egiEntity.entity, column)]]">
                                            <iron-icon style="height:1.1em" icon="[[_getBooleanIcon(egiEntity.entity, column)]]"></iron-icon>
                                        </template>
                                        <template is="dom-if" if="[[_isNotBooleanProp(egiEntity.entity, column)]]">
                                            <div class="truncate">[[_getValue(egiEntity.entity, column)]]</div>
                                        </template>
                                    </div>
                                </div>
                            </template>-->
                        </tg-flex-layout>
                        <!--Collapse panel that contains other components those weren't included into main view of card-->
                        <template is="dom-if" if="[[collapsePanelVisible]]">
                            <iron-collapse opened="[[egiEntity.opened]]">
                                <tg-flex-layout when-desktop="[[longLayout.desktop]]" when-tablet="[[longLayout.tablet]]" when-mobile="[[longLayout.mobile]]">
                                    <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(columns.0)]]">
                                        <div class="data-label truncate">[[columns.0.columnTitle]]</div>
                                        <div class="data-value truncate" style$="[[_calcCardRenderingHintsStyle(entityIndex, columns.0.property)]]" on-tap="_tapAction">[[_getValue(egiEntity.entity, columns.0)]]</div>
                                    </div>
                                    <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(columns.1)]]">
                                        <div class="data-label truncate">[[columns.1.columnTitle]]</div>
                                        <div class="data-value truncate" style$="[[_calcCardRenderingHintsStyle(entityIndex, columns.1.property)]]" on-tap="_tapAction">[[_getValue(egiEntity.entity, columns.1)]]</div>
                                    </div>
                                    <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(columns.2)]]">
                                        <div class="data-label truncate">[[columns.2.columnTitle]]</div>
                                        <div class="data-value truncate" style$="[[_calcCardRenderingHintsStyle(entityIndex, columns.2.property)]]" on-tap="_tapAction">[[_getValue(egiEntity.entity, columns.2)]]</div>
                                    </div>

                                    <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(columns.3)]]">
                                        <div class="data-label truncate">[[columns.3.columnTitle]]</div>
                                        <div class="data-value truncate" style$="[[_calcCardRenderingHintsStyle(entityIndex, columns.3.property)]]" on-tap="_tapAction">[[_getValue(egiEntity.entity, columns.3)]]</div>
                                    </div>
                                    <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(columns.4)]]">
                                        <div class="data-label truncate">[[columns.4.columnTitle]]</div>
                                        <div class="data-value truncate" style$="[[_calcCardRenderingHintsStyle(entityIndex, columns.4.property)]]" on-tap="_tapAction">[[_getValue(egiEntity.entity, columns.4)]]</div>
                                    </div>
                                    <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(columns.5)]]">
                                        <div class="data-label truncate">[[columns.5.columnTitle]]</div>
                                        <div class="data-value truncate" style$="[[_calcCardRenderingHintsStyle(entityIndex, columns.5.property)]]" on-tap="_tapAction">[[_getValue(egiEntity.entity, columns.5)]]</div>
                                    </div>
                                    <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(columns.6)]]">
                                        <div class="data-label truncate">[[columns.6.columnTitle]]</div>
                                        <div class="data-value truncate" style$="[[_calcCardRenderingHintsStyle(entityIndex, columns.6.property)]]" on-tap="_tapAction">[[_getValue(egiEntity.entity, columns.6)]]</div>
                                    </div>
                                    <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(columns.7)]]">
                                        <div class="data-label truncate">[[columns.7.columnTitle]]</div>
                                        <div class="data-value truncate" style$="[[_calcCardRenderingHintsStyle(entityIndex, columns.7.property)]]" on-tap="_tapAction">[[_getValue(egiEntity.entity, columns.7)]]</div>
                                    </div>
                                    <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(columns.8)]]">
                                        <div class="data-label truncate">[[columns.8.columnTitle]]</div>
                                        <div class="data-value truncate" style$="[[_calcCardRenderingHintsStyle(entityIndex, columns.8.property)]]" on-tap="_tapAction">[[_getValue(egiEntity.entity, columns.8)]]</div>
                                    </div>
                                    <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(columns.9)]]">
                                        <div class="data-label truncate">[[columns.9.columnTitle]]</div>
                                        <div class="data-value truncate" style$="[[_calcCardRenderingHintsStyle(entityIndex, columns.9.property)]]" on-tap="_tapAction">[[_getValue(egiEntity.entity, columns.9)]]</div>
                                    </div>
                                    <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(columns.10)]]">
                                        <div class="data-label truncate">[[columns.10.columnTitle]]</div>
                                        <div class="data-value truncate" style$="[[_calcCardRenderingHintsStyle(entityIndex, columns.10.property)]]" on-tap="_tapAction">[[_getValue(egiEntity.entity, columns.10)]]</div>
                                    </div>
                                    <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(columns.11)]]">
                                        <div class="data-label truncate">[[columns.11.columnTitle]]</div>
                                        <div class="data-value truncate" style$="[[_calcCardRenderingHintsStyle(entityIndex, columns.11.property)]]" on-tap="_tapAction">[[_getValue(egiEntity.entity, columns.11)]]</div>
                                    </div>
                                    <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(columns.12)]]">
                                        <div class="data-label truncate">[[columns.12.columnTitle]]</div>
                                        <div class="data-value truncate" style$="[[_calcCardRenderingHintsStyle(entityIndex, columns.12.property)]]" on-tap="_tapAction">[[_getValue(egiEntity.entity, columns.12)]]</div>
                                    </div>
                                    <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(columns.13)]]">
                                        <div class="data-label truncate">[[columns.13.columnTitle]]</div>
                                        <div class="data-value truncate" style$="[[_calcCardRenderingHintsStyle(entityIndex, columns.13.property)]]" on-tap="_tapAction">[[_getValue(egiEntity.entity, columns.13)]]</div>
                                    </div>
                                    <div class="data-entry layout vertical" property$="[[_calcPropertyToSelect(columns.14)]]">
                                        <div class="data-label truncate">[[columns.14.columnTitle]]</div>
                                        <div class="data-value truncate" style$="[[_calcCardRenderingHintsStyle(entityIndex, columns.14.property)]]" on-tap="_tapAction">[[_getValue(egiEntity.entity, columns.14)]]</div>
                                    </div>
                                </tg-flex-layout>
                            </iron-collapse>
                        </template>
                        <paper-icon-button hidden$="[[!collapsePanelVisible]]" class="expand-button" icon="[[_calcCollapseIcon(egiEntity.opened)]]" on-tap="_toggleCollapsePanel"></paper-icon-button>
                    </div>
                </paper-material>
            </template>
        </template>
    </template>
</dom-module>
<script>
    (function () {
        var _checkCollapsiblePanelVisibility = function (layout) {
                this.collapsePanelVisible = !!(this.cardLayout && layout);
            },
            _areEqual = function (a, b) {
                return a.id === b.id;
            },
            _hasEntity = function (entity, entities) {
                var i = 0;
                for (i = 0; i < entities.length; i += 1) {
                    if (_areEqual(entity, entities[i])) {
                        return true;
                    }
                }
                return false;
            },
            _findEntity = function (entity, entities) {
                var i = 0;
                for (i = 0; i < entities.length; i += 1) {
                    if (_areEqual(entity, entities[i])) {
                        return i;
                    }
                }
                return -1;
            },
            _processEntitySelection = function (selectedEntities, entity, select) {
                var selectedIndex = selectedEntities.indexOf(entity);
                if (select) {
                    if (selectedIndex < 0) {
                        selectedEntities.push(entity);
                    }
                } else {
                    if (selectedIndex >= 0) {
                        selectedEntities.splice(selectedIndex, 1);
                    }
                }
            };
            Polymer({
                is: "tg-entity-grid-spike",

                properties: {
                    entityType: String,
                    entities: {
                        type: Array,
                        observer: "_entitiesChanged"
                    },
                    totals: Object,
                    renderingHints: Array,
                    shortLayout: Object,
                    longLayout: Object,
                    summaryLayout: Object,
                    cardLayout: {
                        type: Boolean,
                        readOnly: true,
                        observer: "_cardLayoutChanged"
                    }
                },

                observers: [
                '_desktopShortLayoutChanged(shortLayout.desktop)',
                '_tabletShortLayoutChanged(shortLayout.tablet)',
                '_mobileShortLayoutChanged(shortLayout.mobile)',
                '_desktopLongLayoutChanged(longLayout.desktop)',
                '_tabletLongLayoutChanged(longLayout.tablet)',
                '_mobileLongLayoutChanged(longLayout.mobile)'
            ],
                /**
                 * Initialises selection model, primary action, secondary actions, property columns, card layout.
                 */
                ready: function () {
                    var summaryRowsCount, summaryRowCounter, totalsRow,
                        primaryActions = Polymer.dom(this.$.primary_action_selector).getDistributedNodes();

                    //Initialising entities.
                    this.entities = [];

                    //Initialising the egi model .
                    this.egiModel = [];

                    //initialising the arrays for selected entites and entities those were opened.
                    this.selectedAll = false;
                    this.selectedEntities = [];
                    this.openedEntities = [];

                    //Initialising columns (property column mappings)
                    this.columns = [];
                    summaryRowsCount = 0;
                    Array.prototype.forEach.call(Polymer.dom(this.$.column_selector).getDistributedNodes(), function (item) {
                        if (item.summary && item.summary.length > summaryRowsCount) {
                            summaryRowsCount = item.summary.length;
                        }
                        this.columns.push(item);
                    }.bind(this));

                    //Initialising totals.
                    if (summaryRowsCount > 0) {
                        this.gridSummary = [];
                        this.cardSummary = [];
                        for (summaryRowCounter = 0; summaryRowCounter < summaryRowsCount; summaryRowCounter += 1) {
                            totalsRow = [];
                            this.columns.forEach(function (item) {
                                if (item.summary && item.summary[propertyCounter]) {
                                    rowTotals.push(item.summary[propertyCounter]);
                                    this.cardSummary.push(item.summary[propertyCounter]);
                                } else {
                                    rowTotals.push(null);
                                }
                            }.bind(this));
                            this.gridSummary.push(rowTotals);
                        }
                    }

                    //Initialising the primary action.
                    this.primaryAction = null;
                    this.primaryAction = primaryActions > 0 ? primaryActions[0] : null;

                    //Initialising the secondary actions' list.
                    this.secondaryActions = [];
                    Array.prototype.forEach.call(Polymer.dom(this.$.secondary_action_selector).getDistributedNodes(), function (item) {
                        this.secondaryActions.push(item);
                    }.bind(this));
                },
                //The following nine functions determine whenther EGI is in card layout or grid and whether callapsible panel of card is visible or not.////////
                _mobileChanged: function (e, detail) {
                    if (detail.value) {
                        this._setCardLayout(!!(this.shortLayout && this.shortLayout.mobile));
                        this.collapsePanelVisible = !!(this.cardLayout && this.longLayout && this.longLayout.mobile);
                    }
                },
                _tabletChanged: function (e, detail) {
                    if (detail.value) {
                        this._setCardLayout(!!(this.shortLayout && this.shortLayout.tablet));
                        this.collapsePanelVisible = !!(this.cardLayout && this.longLayout && this.longLayout.tablet);
                    }
                },
                _desktopChanged: function (e, detail) {
                    if (detail.value) {
                        this._setCardLayout(!!(this.shortLayout && this.shortLayout.desktop));
                        this.collapsePanelVisible = !!(this.cardLayout && this.longLayout && this.longLayout.desktop);
                    }
                },
                _desktopShortLayoutChanged: function (layout) {
                    if (this.$.desktopQuery.queryMatches) {
                        this._setCardLayout(!!layout);
                        this.collapsePanelVisible = !!(this.cardLayout && this.longLayout && this.longLayout.desktop);
                    }
                },
                _tabletShortLayoutChanged: function (layout) {
                    if (this.$.tabletQuery.queryMatches) {
                        this._setCardLayout(!!layout);
                        this.collapsePanelVisible = !!(this.cardLayout && this.longLayout && this.longLayout.tablet);
                    }
                },
                _mobileShortLayoutChanged: function (layout) {
                    if (this.$.mobileQuery.queryMatches) {
                        this._setCardLayout(!!layout);
                        this.collapsePanelVisible = !!(this.cardLayout && this.longLayout && this.longLayout.mobile);
                    }
                },
                _desktopLongLayoutChanged: function (layout) {
                    _checkCollapsiblePanelVisibility.bind(this)(layout);
                },
                _tabletLongLayoutChanged: function (layout) {
                    _checkCollapsiblePanelVisibility.bind(this)(layout);
                },
                _mobileLongLayoutChanged: function (layout) {
                    _checkCollapsiblePanelVisibility.bind(this)(layout);
                },
                /**
                 * Listener for cardLayout.
                 */
                _cardLayoutChanged: function (newValue, oldValue) {
                    if (newValue) {
                        this.style.width = "100%";
                    } else {
                        this.style.removeProperty("width");
                    }
                },
                /**
                 * Observs the changes to entities property.
                 */
                _entitiesChanged: function (newValue, oldValue) {
                    var self = this;
                    newValue.forEach(function (newEntity) {
                        var selectEntInd = _findEntity(newEntity, self.selectedEntities),
                            openedEntInd = _findEntity(newEntity, self.openedEntities);
                        if (selectEntInd >= 0) {
                            self.selectedEntities[selectEntInd] = newEntity;
                        }
                        if (openedEntInd >= 0) {
                            self.openedEntities[openedEntInd] = newEntity;
                        }
                    });
                    self.egiModel = [];
                    newValue.forEach(function (newEntity) {
                        var egiEntity = {
                            selected: self.selectedEntities.indexOf(newEntity) > -1,
                            opened: self.openedEntities.indexOf(newEntity) > -1,
                            entity: newEntity
                        }
                        self.push('egiModel', egiEntity);
                    });
                },
                /**
                 * Event handler for select all checkbox
                 */
                _allSelectionChanged: function (e) {
                    var i;
                    if (this.egiModel) {
                        for (i = 0; i < this.egiModel.length; i += 1) {
                            this.set("egiModel." + i + ".selected", e.srcElement.checked);
                            _processEntitySelection(this.selectedEntities, this.entities[i], e.srcElement.checked);
                        }
                        this.selectedAll = e.srcElement.checked;
                        console.log("all ", this.getSelectedRows());
                    }
                },
                /**
                 * Event handler for selecting concrete entity
                 */
                _selectionChanged: function (e) {
                    var index;
                    if (this.egiModel) {
                        index = e.model.entityIndex;
                        this.set("egiModel." + index + ".selected", e.srcElement.checked);
                        _processEntitySelection(this.selectedEntities, this.entities[index], e.srcElement.checked);
                        if (this.selectedAll && !e.srcElement.checked) {
                            this.selectedAll = false;
                        }
                    }
                    console.log("single checkbox: " + index, this.getSelectedRows());
                },
                /**
                 * Toggles the card's collapse panel for the specified entity.
                 */
                _toggleCollapsePanel: function (e) {
                    var index = e.model.entityIndex,
                        opened = this.egiModel[index].opened;
                    this.set("egiModel." + index + ".opened", !opened);
                    _processEntitySelection(this.openedEntities, this.entities[index], !opened);
                },
                /**
                 * Determines whether secondary actions are present.
                 */
                _isSecondaryActionsPresent: function (secondaryActions) {
                    return secondaryActions && secondaryActions.length > 0;
                },
                /**
                 * Calculates the column's header style.
                 */
                _calcColumnHeaderStyle: function (item) {
                    return "width: " + item.width + ";";
                },
                /**
                 * Calculates the column's style.
                 */
                _calcColumnStyle: function (column) {
                    return "width: " + column.width + ";";
                },
                /**
                 * Calculates the style for cell that represents rendering hints.
                 */
                _calcRenderingHintsStyle: function (entityIndex, column) {
                    var style = "width: " + column.width + ";",
                        rendHints = (this.renderingHints && this.renderingHints[entityIndex][column.property]) || [];
                    for (var property in rendHints) {
                        if (rendHints.hasOwnProperty(property)) {
                            style += " " + property + ": " + rendHints[property] + ";";
                        }
                    }
                    return style;
                },
                /**
                 * Calculates the style for card cell that represents rendering hints.
                 */
                _calcCardRenderingHintsStyle: function (entityIndex, propertyName) {
                    var style = "",
                        rendHints = (this.renderingHints && this.renderingHints[entityIndex][propertyName]) || [];
                    for (var property in rendHints) {
                        if (rendHints.hasOwnProperty(property)) {
                            style += " " + property + ": " + rendHints[property] + ";";
                        }
                    }
                    return style;
                },
                /**
                 * Calculates the style of the card.
                 */
                _calcCardStyle: function (collapsePanelVisible) {
                    return "position: relative; background-color: white;" + (collapsePanelVisible ? " padding-bottom:24px;" : '');
                },
                /**
                 * Calculates the property name to select in card layout.
                 */
                _calcPropertyToSelect: function (column) {
                    return column.property === '' ? 'this' : column.property
                },
                /**
                 * Returns the icon name according to entityOpened parameter. If entityOpened is true then it returns icon that says that this card can be
                 * collapsed otherwise it can be expanded.
                 */
                _calcCollapseIcon: function (entityOpened) {
                    return entityOpened ? 'expand-less' : 'expand-more';
                },
                /**
                 * Calculates the style for empty total's cell.
                 */
                _calcEmptyTotalStyle: function (summaryIndex, columns) {
                    return "width: " + columns[summaryIndex].width + ";";
                },
                /**
                 * Determines whether totals button is enable or disabled (only in card layout mode).
                 */
                _isSummaryEnabled: function (entities, cardLayout) {
                    return !!this.totals;
                },
                /**
                 * Returns the property value of the specified entity.
                 */
                _get: function (entity, column) {
                    return entity && entity.get(column.property);
                },
                /**
                 * Returns the property value of the specified entity and converts it to string.
                 */
                _getValue: function (entity, column) {
                    if (!entity || !column || this._get(entity, column) === null) {
                        return "";
                    } else if (this.$.reflector.findTypeByName(column.type)) {
                        return this.$.reflector.convert(this._get(entity, column));
                    } else if (column.type === 'Date') {
                        return moment(entity.get(column.property)).format("L LT");
                    } else if (typeof entity.get(column.property) === 'number') {
                        return entity.get(column.property).toLocaleString(this.$.appConfig.locale);
                    } else {
                        return entity.get(column.property);
                    }
                },
                /**
                 * Replaces the entitiesThatShouldBeUpdated with the updated ones (and their rendering hints).
                 *
                 * Please note, that if some entity from entitiesThatShouldBeUpdated does not exists in updatedEntities list
                 *   -- it will be removed from result-set.
                 */
                replaceUpdatedEntities: function (updatedEntities, updatedRenderingHints, entitiesThatShouldBeUpdated) {
                    var newEntities = this.entities.slice(); // array copy (shallow)
                    var newRenderingHints = this.renderingHints.slice(); // array copy (shallow)
                    for (var i = 0; i < updatedEntities.length; i = i + 1) {
                        var updatedEntity = updatedEntities[i];
                        var updatedEntityRenderingHints = updatedRenderingHints[i];
                        // console.log("updated", updatedEntity, updatedEntityRenderingHints);
                        var entityIndex = findEntity(updatedEntity, newEntities);
                        if (entityIndex !== -1) {
                            newEntities[entityIndex] = updatedEntity; // replace old entity with updated one
                            newRenderingHints[entityIndex] = updatedEntityRenderingHints; // replace also its rendering hints
                        } else {
                            // this is the case when the updateEntity was not present in result-set, but should become present. Adds it into the beginning of the list
                            newEntities.unshift(updatedEntity);
                            newRenderingHints.unshift(updatedEntityRenderingHints);
                        }
                    }
                    // need to remove all entities that should be updated, but have not been returned in 'updatedEntities' list (it means they have dissapeared from result-set after modification)
                    for (var j = 0; j < entitiesThatShouldBeUpdated.length; j = j + 1) {
                        var entityThatShouldBeUpdated = entitiesThatShouldBeUpdated[j];
                        if (!hasEntity(entityThatShouldBeUpdated, updatedEntities)) {
                            var index = findEntity(entityThatShouldBeUpdated, newEntities);

                            newEntities.splice(index, 1); // remove the entity
                            newRenderingHints.splice(index, 1); // and its rendering hints
                        }
                    }
                    this.entities = newEntities;
                    this.renderingHints = newRenderingHints;
                },
                /**
                 * Determines whether property is boolean or not.
                 */
                _isBooleanProp: function (entity, column) {
                    return column.type === 'Boolean' && _get(entity, column) !== null
                },
                /**
                 * Determines whether property is not boolean property or is.
                 */
                _isNotBooleanProp: function (entity, column) {
                    return column.type !== 'Boolean';
                },
                /**
                 * Returns icon that represents the boolean value.
                 */
                _getBooleanIcon: function (entity, column) {
                    return "icons:" + (_get(entity, column) ? "check" : "clear");
                },
                /**
                 * Tap action on data column. TODO: implement this.
                 */
                _tapAction: function (e, detail) {
                    this.tap(this.entities[e.model.entityIndex], this.columns[e.model.index].property, this.columns[e.model.index]);
                },

                tap: function (entity, property, column) {
                    var value = entity.get(property);
                    if (this.$.reflector.isEntity(value)) {
                        column.runAction(value);
                    } else if (property.indexOf(".") > -1) {
                        this.tap(entity, property.substring(0, property.lastIndexOf(".")), column);
                    } else {
                        column.runAction(entity);
                    }
                },
                /**
                 * Shows the summary dialog if the EGI is in card layout and there were totals defined.
                 */
                _showSummary: function (e, detail, source) {
                    if (this.cardLayout && this.totals) {
                        this.$.summaryDialog.open();
                    }
                },
                ///////////////////Next three functions are responsible for calculating media queries expressions for mobile tablet and desktop screens/////////
                _calcMobileQuery: function () {
                    return "max-width: " + (this.$.appConfig.minTabletWidth - 1) + "px";
                },
                _calcTabletQuery: function () {
                    return "(min-width: " + this.$.appConfig.minTabletWidth + "px) and (max-width: " + (this.$.appConfig.minDesktopWidth - 1) + "px)";
                },
                _calcDesktopQuery: function () {
                    return "min-width: " + this.$.appConfig.minDesktopWidth + "px";
                },
                /**
                 * Returns the list entitles selected on the current page.
                 */
                getSelectedEntities: function () {
                    var currentSelectedEntities = [];
                    this.egiModel.forEach(function (elem) {
                        if (elem.selected) {
                            currentSelectedEntities.push(elem.entity);
                        }
                    }.bind(this));
                    return currentSelectedEntities;
                },
                /**
                 * Returns the list of all selected entites.
                 */
                getAllSelectedEntities: function () {
                    return this.selectedEntities;
                },
                /**
                 * Returns the indexes of entites selected on current page.
                 */
                getSelectedRows: function () {
                    var selectedRows = [];
                    this.egiModel.forEach(function (elem, elemIndex) {
                        if (elem.selected) {
                            selectedRows.push(elemIndex);
                        }
                    }.bind(this));
                    return selectedRows;
                },
                /**
                 * Clears selection.
                 */
                clearSelection: function () {
                    var i;
                    for (i = 0; i < egiModel.length; i++) {
                        this.set("egiModel." + i + ".selected", false);
                    }
                    this.selectedEntities = [];
                },
                /**
                 * Collapses all opened entities (has sens in card layout.)
                 */
                collapseAllCards: function () {
                    var i;
                    for (i = 0; i < egiModel.length; i++) {
                        this.set("egiModel." + i + ".opened", false);
                    }
                    this.openedEntities = [];
                },
            })
    })()
</script>