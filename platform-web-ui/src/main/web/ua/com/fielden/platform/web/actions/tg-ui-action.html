<link rel="import" href="/resources/polymer/polymer/polymer.html">

<link rel="import" href="/app/tg-reflector.html">
<link rel="import" href="/resources/serialisation/tg-serialiser.html">
<link rel="import" href="/resources/polymer/paper-icon-button/paper-icon-button.html">
<!-- <link rel="import" href="/resources/polymer/paper-button/paper-button.html">  -->
<link rel="import" href="/resources/components/postal-lib.html">

<dom-module id="tg-ui-action">
    <style>
        /* :host::shadow * /deep/ core-tooltip::shadow #tooltip {
            white-space: normal;
        }
        :host::shadow * /deep/ core-tooltip .span-tooltip {
            line-height: 15px;
        }
        :host::shadow core-tooltip.delayed:hover::shadow .core-tooltip,
        :host::shadow core-tooltip.delayed:focus::shadow .core-tooltip {
            opacity: 1;
            -webkit-transition-delay: 1s;
            transition-delay: 1s;
            transform: translate3d(0px, 0px, 0px);
        } */
    </style>
    <template>
        <tg-reflector id="reflector"></tg-reflector>
        <tg-serialiser id="serialiser"></tg-serialiser>
        <paper-icon-button id="actionButton" icon="[[icon]]" on-tap="_run"></paper-icon-button>
        <!-- disabled?="{{!isEnabled(enabledStates, currentState, enabled)}}" -->
    </template>
</polymer-element>

<script>
    Polymer({
    	is: 'tg-ui-action',
    	
        properties: {
        	/////////////////////////////////////////////////////////////////////////////////////////////////////////
        	////////////////////////////////////////// EXTERNAL PROPERTIES //////////////////////////////////////////
        	/////////////////////////////////////////////////////////////////////////////////////////////////////////
        	// These mandatory properties must be specified in attributes, when constructing descendant elements.  //
        	// No default values are allowed in this case.														   //
        	/////////////////////////////////////////////////////////////////////////////////////////////////////////
        	/* Indicates what entity property this action is associated with. */
        	chosenProperty: {
        	    type: String
        	},
            /**
             * Custom action to be invoked before 'tg-ui-action' will be run.
             */
            preAction: {
            	type: Function
            },
            /**
             * Custom action to be invoked after 'tg-ui-action' has retrieved its functional entity and bound it to the UI (in case of successful retrieval).
             */
            postActionSuccess: {
            	type: Function
            },
            /**
             * Custom action to be invoked after 'tg-ui-action' has unsuccessfully retrieved its functional entity.
             */
            postActionError: {
            	type: Function
            },

            /**
             * Determines whether the 'selection criteria entity' are required to be send inside the centre context.
             *
             * 'null' -- if not applicable, for e.g. this is a master's (not centre's) editor, or in Centre DSL end-app dev has not been marked 'selectionCrit' as relevant for context.
             */
            requireSelectionCriteria: {
            	type: String
            },
            /**
             * Determines whether the selected entities are required to be send inside the centre context.
             *
             * 'null' -- if not applicable, for e.g. this is a master's (not centre's) editor, or in Centre DSL end-app dev has not been marked 'selectedEntities' as relevant for context.
             */
            requireSelectedEntities: {
            	type: String
            },
            /**
             * Determines whether the master entity (main entity for dependent centre) are required to be send inside the centre context.
             *
             * 'null' -- if not applicable, for e.g. this is a master's (not centre's) editor, or in Centre DSL end-app dev has not been marked 'masterEntity' as relevant for context.
             */
            requireMasterEntity: {
            	type: String
            },

            /**
             * The name of the entity master element associated with this action.
             */
            elementName: {
            	type: String
            },
            /**
             * The functional entity master element gets cached in tg-custom-action-dialog, which is responsible for its loading and instantiation.
             * However, in cases where the same functional is used for different action (such as insertion points used for centres) there is a need 
             * for several instances for the same entity master element. In order to facilitate caching of such instances they need to be provided 
             * with different aliases.
             */
            elementAlias: {
            	type: String
            },
            attrs: {
            	type: Object
            },
            /**
             * The function that creates the context for this action. This function originates from the outside of this component.
             */
            createContextHolder: {
            	type: Function
            },

            /**
             * The URI of custom UI component to be loaded on run() action.
             */
            componentUri: {
            	type: String
            },

            // /**
            //  * A list of the states in which the action can be enabled.
            //  */
            // enabledStates: null,

            // /**
            //  * The state of the parent view.
            //  */
            // currentState: null,

            /**
             * Short description for the action (for e.g. it can be used as button title).
             */
            shortDesc: {
            	type: String
            },

            /**
             * Long description for the action.
             */
            longDesc: {
            	type: String
            },

            /**
             * The icon specificator (string id).
             */
            icon: {
            	type: String
            },
            
            /**
             * Shows the dialog relative to this 'tg-ui-action'.
             */
            showDialog: {
            	type: Function
            },
            
            additionalAction: {
            	type: Function
            },
            
            ////////////////////////////////////// SUBSECTION: NOT MANDATORY PROPERTIES //////////////////////////////////////
			/**
			 * The 'currentEntity' should contain the entity that was clicked (result-set actions)
			 * or the entity on which primary / secondary action was chosen. In case when no of the above cases
			 * is invoking (for e.g. as in topLevel actions) -- 'currentEntity' should be empty.
			*/
            currentEntity: {
            	type: Object
            },
            
        	/////////////////////////////////////////////////////////////////////////////////////////////////////////
        	//////////////////////////////////////////// INNER PROPERTIES ///////////////////////////////////////////
        	/////////////////////////////////////////////////////////////////////////////////////////////////////////
        	// These properties derive from other properties and are considered as 'private' -- need to have '_'   //
        	//   prefix and default values specified in 'value' specificator of the property definition (or,       //
        	//   alternatively, computing function needs to be specified). 									       //
        	/////////////////////////////////////////////////////////////////////////////////////////////////////////
            _masterComponent: {
            	type: Object,
            	value: null
            },
            
            /**
             * This inner state is triggered by the action itself after the action button has been pressed (enabled:=false) and after the action
             * has been executed (enabled:=true).
             */
            // enabled: true,
            
        	/////////////////////////////////////////////////////////////////////////////////////////////////////////
        	//////////////////////////////// INNER PROPERTIES, THAT GOVERN CHILDREN /////////////////////////////////
        	/////////////////////////////////////////////////////////////////////////////////////////////////////////
        	// These properties derive from other properties and are considered as 'private' -- need to have '_'   //
        	//   prefix. 																				           //
        	// Also, these properties are designed to be bound to children element properties -- it is necessary to//
        	//   populate their default values in ready callback (to have these values populated in children)!     //
        	/////////////////////////////////////////////////////////////////////////////////////////////////////////
            /**
             * Executes the action in context of 'currentEntity'. 
             *
             * Please override this method in descendands to implement specific execution logic.
             */
            _run: {
            	type: Function
            },
            
            /**
             * Analyzes and processes the result of executor response.
             */
            _onExecuted: {
            	type: Function
            }
        },
        
        /**
         * Initialisation block.
         */
        ready: function () {
            var self = this;
            
            self._run = (function () {
                // this.enabled = false;
                console.log(this.shortDesc + ": execute");

                if (this.preAction) {
                    if (this.preAction()) { // returns 'true' in case whether the action should proceed
                        this.showDialog(this);
                    }
                } else {
                	this.showDialog(this);
                }
            }).bind(self);
            
            self._onExecuted = (function (e, detail, source) {
                var self = this;
                // console.log("_onExecuted: e", e, "egi", e.srcElement);
                self._masterComponent = detail;

                detail.postRetrieved = function (entity, bindingEntity, customObject) {
                    console.log("postRetrieved");
                    if (self.postActionSuccess) {
                        self.postActionSuccess();
                    }
                    
                    console.log("postRetrieved: self._masterComponent.noUI ===", self._masterComponent.noUI);
                    if (self._masterComponent.noUI === true) {
                		// immediately save the functional entity in case when no UI exists
             			self._masterComponent.save();
                    }
                };

                detail.postValidated = function (validatedEntity, bindingEntity, customObject) {
                    console.log("postValidated");
                };
                
                // creates the context and
                var context = self.createContextHolder(self.requireSelectionCriteria, self.requireSelectedEntities, self.requireMasterEntity);
                // enhances it with the information of 'currentEntity' (primary / secondary actions) and
                if (self.currentEntity) {
                	self._enhanceContextWithCurrentEntity(context, self.currentEntity, self.requireSelectedEntities);
                }
                // enhances it with information of what 'property' was chosen (property result-set actions)
                if (self.chosenProperty) {
                	self._enhanceContextWithChosenProperty(context, self.chosenProperty);
                }
                // NOTE: the savingContext for 'tg-entity-master' at this stage is immutable, i.e. it will never change during lifecycle of action's master 
                detail.savingContext = context;

                detail.postSaved = function (potentiallySavedEntity, newBindingEntity) {
                    postal.publish({
                        channel: "centre_" + detail.centreUuid,
                        topic: "detail.saved",
                        data: {
                            entity: potentiallySavedEntity,
                            // send selectedEntitiesInContext further to be able to update only them on EGI
                            selectedEntitiesInContext: context.selectedEntities
                        }
                    });
                    
                    if (potentiallySavedEntity.isValid()) {
	                    var holder = detail._extractModifiedPropertiesHolder(detail._currBindingEntity, detail._originalBindingEntity);
    	                self.additionalAction(detail._createSavingInfoHolder(detail._reset(holder), potentiallySavedEntity));
                    }

                    console.log("postSaved");
                };

                detail.entityId = context.id === null ? "new" : (+(context.id));
                // context-dependent retrieval of entity (this is necessary for centre-related functional entities, which creation is dependent on centre context!)
                detail.retrieve(context);

                this._afterExecution();
                //                this.$.entityMaster.updateTargetDimensions();
            }).bind(self);
        },

        // /**
        //  * Returns whether the action is enabled in current moment.
        //  */
        // isEnabled: function (enabledStates, currentState, enabled) {
        //     if (enabledStates) {
        //         // console.log("isEnabled successful: enabledStates == ", enabledStates, "currentState == ", currentState, "enabled == ", enabled);
        //         return enabledStates.indexOf(currentState) >= 0 && enabled;
        //     } else {
        //         console.warn("isEnabled: enabledStates is not ready at this stage! enabledStates == ", enabledStates);
        //         return false;
        //     }
        // },

        /**
         * The function that is invoked after the action has completed (error or success).
         */
        _afterExecution: function () {
            console.log(this.shortDesc + ": after execution");
            // this.enabled = true;
        },
        
        _enhanceContextWithChosenProperty: function(context, chosenProperty) {
        	context["chosenProperty"] = chosenProperty;
        },
        
        _enhanceContextWithCurrentEntity: function(context, currentEntity, requireSelectedEntities) {
            if (requireSelectedEntities !== null) {
            	this.$.reflector.provideSelectedEntities(requireSelectedEntities, context, function() {
            		return [ currentEntity ];
            	});
            }
        }
    });
</script>