<link rel="import" href="/resources/polymer/polymer/polymer.html">

<link rel="import" href="/tg-reflector">
<link rel="import" href="/resources/serialisation/tg-serialiser.html">
<link rel="import" href="/resources/polymer/core-icon-button/core-icon-button.html">
<link rel="import" href="/resources/polymer/paper-dialog/paper-action-dialog.html">
<link rel="import" href="/resources/element_loader/load-element.html">
<link rel="import" href="/resources/polymer/paper-button/paper-button.html">

<polymer-element name="tg-ui-action" attributes="user elementName attrs shortDesc longDesc icon componentUri contextRetriever"> <!-- enabledStates currentState  -->
    <template>
        <style>
            :host::shadow * /deep/ core-tooltip::shadow #tooltip {
                white-space: normal;
            }
            
            :host::shadow * /deep/ core-tooltip .span-tooltip {
                line-height: 15px;
            }
            
            :host::shadow core-tooltip.delayed:hover::shadow .core-tooltip,
            :host::shadow core-tooltip.delayed:focus::shadow .core-tooltip {
                opacity: 1;
                -webkit-transition-delay: 1s;
                transition-delay: 1s;
                transform: translate3d(0px, 0px, 0px);
            }
        </style>
        <tg-reflector id="reflector"></tg-reflector>
        <tg-serialiser id="serialiser"></tg-serialiser>
        <core-icon-button id="actionButton" icon="{{icon}}" on-tap="{{run}}"></core-icon-button> <!-- disabled?="{{!isEnabled(enabledStates, currentState, enabled)}}" -->
        <paper-action-dialog id="entityMaster" backdrop autoCloseDisabled>
            <load-element id="loadMaster" import="{{componentUri}}" elementName="{{elementName}}" attrs="{{attrs}}" on-after-load="{{_onExecuted}}"></load-element>
            <paper-button affirmative autofocus>Ok</paper-button>
        </paper-action-dialog>
    </template>
    <script>
        Polymer('tg-ui-action', {
            publish: {
            	user: null,
            	elementName: null,
            	attrs: null,
            	/**
            	 * The function that returns the context for this action (in case of dit action on EGI the context is a selected entity.)
            	 */
            	contextRetriever: undefined,

            	/**
            	 * The URI of custom UI component to be loaded on run() action.
            	 */
            	componentUri: null,

                // /**
                //  * A list of the states in which the action can be enabled.
                //  */
                // enabledStates: null,

                // /**
                //  * The state of the parent view.
                //  */
                // currentState: null,

                /**
                 * Short description for the action (for e.g. it can be used as button title).
                 */
                shortDesc: null,

                /**
                 * Long description for the action.
                 */
                longDesc: null,

                /**
                 * The icon specificator (string id).
                 */
                icon: null
            },

            /**
             * This inner state is triggered by the action itself after the action button has been pressed (enabled:=false) and after the action
             * has been executed (enabled:=true).
             */
            // enabled: true,

            /**
             * Initialisation block.
             */
            ready: function () {
                var self = this;

                self.run = self.run.bind(self);
            },

            // /**
            //  * Returns whether the action is enabled in current moment.
            //  */
            // isEnabled: function (enabledStates, currentState, enabled) {
            //     if (enabledStates) {
            //         // console.log("isEnabled successful: enabledStates == ", enabledStates, "currentState == ", currentState, "enabled == ", enabled);
            //         return enabledStates.indexOf(currentState) >= 0 && enabled;
            //     } else {
            //         console.warn("isEnabled: enabledStates is not ready at this stage! enabledStates == ", enabledStates);
            //         return false;
            //     }
            // },

            /**
             * Executes the action.
             *
             * Please override this method in descendands to implement specific execution logic.
             */
            run: function () {
                // this.enabled = false;
                console.log(this.shortDesc + ": execute");

                // TODO var context = ...;
                // var ser = this.$.serialiser.serialise(context);
                // this.$.actionExecutor.body = JSON.stringify(ser);

                this.$.loadMaster.reload();
            },

            /**
             * The function that is invoked after the action has completed (error or success).
             */
            afterExecution: function () {
                console.log(this.shortDesc + ": after execution");
                // this.enabled = true;
            },

            /**
             * Analyzes and processes the result of executor response.
             */
            _onExecuted: function(e, detail, source) {
            	console.log("_onExecuted: e", e, "egi", e.srcElement);
            	this.$.entityMaster.open();

            	// detail.entityid = 15; // e.srcElement.$.egi.getSelectedEntities()[0].id;

            	// getSelectedEntities

            	detail.onRetrieved = function(entity, bindingEntity, customObject) {
                    console.log("onRetrieved");
                };

                detail.onValidated = function(validatedEntity, bindingEntity, customObject) {
                    console.log("onValidated");
                };

                detail.onSaved = function(potentiallySavedEntity, newBindingEntity) {
                    console.log("onSaved");
                };

                detail.entityid = this.contextRetriever().id;
            	detail.retrieve();
            	console.log('_onExecuted: uiComponent', detail);
            	// TODO insert into DOM uiComponent
	           	// TODO insert into DOM uiComponent
            	// TODO insert into DOM uiComponent
       	        // TODO insert into DOM uiComponent

                this.afterExecution();
//                this.$.entityMaster.updateTargetDimensions();
            },
        });
    </script>
</polymer-element>