<link rel="import" href="/resources/binding/tg-entity-binder-behavior.html">

<script>
    (function () {
        Polymer.TgBehaviors = Polymer.TgBehaviors || {};
    	Polymer.TgBehaviors.TgEntityCentreBehaviorImpl = {
            properties: {
            	/////////////////////////////////////////////////////////////////////////////////////////////////////////
            	////////////////////////////////////////// EXTERNAL PROPERTIES //////////////////////////////////////////
            	/////////////////////////////////////////////////////////////////////////////////////////////////////////
            	// These mandatory properties must be specified in attributes, when constructing the element instance. //
            	// No default values are allowed in this case.														   //
            	/////////////////////////////////////////////////////////////////////////////////////////////////////////
            	
                /**
                 * The entity type for which this entity centre is created.
                 */
                entityType: {
                	type: String
                },
                
                /**
                 * The menu item type, that identifies this entity centre.
                 */
                miType: {
                	type: String
                },
                
                /**
                 * Universal identifier of this element instance (used for pub / sub communication).
                 *
                 * Should be given from the outside of the element.
                 */
                uuid: {
                	type: String
                },
                
                /**
                 * The function to return 'master' entity (if this entity centre is dependent, i.e. the part of some compound master).
                 */
                getMasterEntity: {
                	type: Function
                },
                
                /**
                 * Custom callback that will be invoked after successfull retrieval of selection criteria entity.
                 *
                 * arguments: entity, bindingEntity, customObject
                 */
                postRetrieved: {
                	type: Function
                },
                
				/**
				 * The module where the centre is located.
				 *
				 * This parameter is populated during dynamic loading of the centre.
				 */
                moduleId: {
            		type: String
            	},
            	
            	/////////////////////////////////////////////////////////////////////////////////////////////////////////
            	//////////////////////////////////////////// INNER PROPERTIES ///////////////////////////////////////////
            	/////////////////////////////////////////////////////////////////////////////////////////////////////////
            	// These properties derive from other properties and are considered as 'private' -- need to have '_'   //
            	//   prefix and default values specified in 'value' specificator of the property definition (or,       //
            	//   alternatively, computing function needs to be specified). 									       //
            	/////////////////////////////////////////////////////////////////////////////////////////////////////////
            	
            	/**
            	 * The holder of EGI entities that 'should be updated'.
            	 */
                _entitiesThatShouldBeUpdated: {
                	type: Array,
                	value: null
                },
                
            	/////////////////////////////////////////////////////////////////////////////////////////////////////////
            	//////////////////////////////// INNER PROPERTIES, THAT GOVERN CHILDREN /////////////////////////////////
            	/////////////////////////////////////////////////////////////////////////////////////////////////////////
            	// These properties derive from other properties and are considered as 'private' -- need to have '_'   //
            	//   prefix. 																				           //
            	// Also, these properties are designed to be bound to children element properties -- it is necessary to//
            	//   populate their default values in ready callback (to have these values populated in children)!     //
            	/////////////////////////////////////////////////////////////////////////////////////////////////////////
            	
            	_saverDisabled: {
            		type: Boolean,
            		computed: '_computeSaverDisabled()' // TODO complete this property!
            	},
            	_discarderDisabled: {
            		type: Boolean,
            		computed: '_computeDiscarderDisabled()' // TODO complete this property!
            	},
            	
            	_url: {
             		type: String,
             		computed: '_computeUrl(miType)'
             	},
            	
            	/**
            	 * TODO provide documentation
            	 */
                _selectedView: {
                	type: Number
                },
                
            	/**
            	 * TODO provide documentation
            	 */
                _selectedPage: {
                	type: Number
                },
                
                /**
                 * The function that is invoked after 'Run' action has been completed.
                 */
                _postRun: {
                	type: Function
                },
                
                /**
                 * The action to be invoked on EGI's 'edit' button.
                 */
                _editAction: {
                	type: Function
                },
                
                /**
                 * The action to be invoked on EGI's 'new' button.
                 */
                _newAction: {
                	type: Function
                },
                
                /**
                 * The action to be bound to 'tg-primary-instance-action'.
                 */
                _showMaster: {
                	type: Function
                }
            },
            
            _computeSaverDisabled: function () {
            	return !this.canSave($.selection_criteria._isCentreChanged);
            },
            
            computeDiscarderDisabled: function () {
            	return !this.canDiscard($.selection_criteria._isCentreChanged);
            },
            
            /**
             * Initialisation block. It has all children web components already initialised.
             */
            ready: function () {
                var self = this;
                
                self._selectedView = 0;
                self._selectedPage = 0;

                self._postRun = (function (criteriaEntity, newBindingEntity, resultEntities, pageCount, renderingHints, isRefreshingConcreteEntities, summary) {
                    // console.log("postRun", criteriaEntity, newBindingEntity, resultEntities, pageCount, renderingHints, isRefreshingConcreteEntities);
                    if (criteriaEntity.isValid()) {
                        if (typeof summary !== 'undefined') {
                            this.$.egi.totals = summary;
                        }
                        if (isRefreshingConcreteEntities) {
                            this.$.egi.replaceUpdatedEntities(resultEntities, renderingHints, this._entitiesThatShouldBeUpdated);
                        } else {
                            this.$.egi.entities = resultEntities;
                            this.$.egi.renderingHints = renderingHints;
                            if (this._triggerRun && this._selectedView === 0) {
                                this.async(function () {
                                    this._selectedView = 1;
                                    this._selectedPage = 1;
                                }, null, 100);
                                this._triggerRun = false;
                            }
                        }
                    }
                }).bind(self);
                
                self._getSelectedEntities = (function () {
                    return this.$.egi.getSelectedEntities();
                }).bind(self);
                
                self._processSaverResponse = function (e) {
                	self.$.selection_criteria._processResponse(e, "save", function (okString) {
                        console.log("CENTRE SAVED", okString);

                        self.retrieve();
                    }, function (errorResult) {
                        // This function will be invoked after server-side error appear.
                        console.warn("SERVER ERROR: ", errorResult);
                    });
                };
                self._processSaverError = function (e) {
                	self.$.selection_criteria._processError(e, "save");
                };
                
                self._processDiscarderResponse = function (e) {
                	self.$.selection_criteria._processResponse(e, "discard", function (okString) {
                        console.log("CENTRE DISCARDED", okString);

                        self.retrieve();
                    }, function (errorResult) {
                        // This function will be invoked after server-side error appear.
                        console.warn("SERVER ERROR: ", errorResult);
                    });
                };
                self._processDiscarderError = function (e) {
                	self.$.selection_criteria._processError(e, "discard");
                };
                
                self._editAction = (function () {
                    var self = this;
                    postal.publish({
                        channel: "centre",
                        topic: "edit.start",
                        data: {
                            entity: self._getContext(),
                            uuid: self.$.selection_criteria.uuid,
                            moduleId: self.moduleId
                        }
                    });
                }).bind(self);
                
                self._newAction = (function () {
                    var self = this;
                    postal.publish({
                        channel: "centre",
                        topic: "new.start",
                        data: {
                            entityType: self.entityType,
                            simpleEntityType: self._simpleEntityType(),
                            uuid: self.$.selection_criteria.uuid,
                            moduleId: self.moduleId
                        }
                    });
                }).bind(self);
                
                self._showMaster = (function (entity) {
                    var self = this;
                    postal.publish({
                        channel: "centre",
                        topic: "edit.start",
                        data: {
                            entity: entity,
                            uuid: self.$.selection_criteria.uuid,
                            moduleId: self.moduleId
                        }
                    });
                }).bind(self);
                
                self._getContext = (function () {
                    if (this._getSelectedEntities().length > 0) {
                        return this._getSelectedEntities()[0];
                    }
                    return null;
                }).bind(self);
                
                self._postFunctionalEntitySaved = (function (potentiallySavedEntity, selectedEntitiesInContext) {
                    if (potentiallySavedEntity.isValid()) {
                        // old implementation was this.currentPage(); -- for now only selectedEntitiesInContext will be refreshed, not the whole current page
                        this.refreshEntities(selectedEntitiesInContext);
                    }
                }).bind(self);
                
                self._createContextHolder = (function (requireSelectionCriteria, requireSelectedEntities, requireMasterEntity) {
                    return this.$.selection_criteria.createContextHolder(requireSelectionCriteria, requireSelectedEntities, requireMasterEntity);
                }).bind(self);
            },

            _selectPage: function (e, detail, source) {
                this._selectedPage = this._selectedView;
            },

            attached: function () {
                var self = this;
                ///////////////////////Edit Listeners/////////////////////////////////////
                this.masterCreatedListener = postal.subscribe({
                    channel: "centre_" + self.$.selection_criteria.uuid,
                    topic: "edit.finish.created",
                    callback: function (data, envelope) {
                        console.log("-------- Masters Edit Created UUID: " + data.item.view.attrs.uuid + " ------------");
                    }
                });
                this.masterShowListener = postal.subscribe({
                    channel: "centre_" + self.$.selection_criteria.uuid,
                    topic: "edit.finish.shown",
                    callback: function (data, envelope) {
                        console.log("-------- Masters Edit Shown UUID: " + data.item.view.attrs.uuid + " ------------");
                    }
                });
                /////////////////////////New listener//////////////////////////////////////
                this.masterNewListener = postal.subscribe({
                    channel: "centre_" + self.$.selection_criteria.uuid,
                    topic: "new.finish",
                    callback: function (data, envelope) {
                        console.log("-------- Masters New UUID: " + data.item.view.attrs.uuid + " ------------");
                    }
                });

                ///////////////////////// Detail postSaved listener //////////////////////////////////////
                postal.subscribe({
                    channel: "centre_" + self.$.selection_criteria.uuid,
                    topic: "detail.saved",
                    callback: function (data, envelope) {
                        self._postFunctionalEntitySaved(data.entity, data.selectedEntitiesInContext);
                    }
                });
            },

            detached: function () {
                this.masterCreatedListener.unsubscribe();
                this.masterShowListener.unsubscribe();
                this.masterNewListener.unsubscribe();
            },

            deleteAction: function () {
                console.log("The selected entities must be deleted here!");
            },
            
            /**
             * Returns simple entity type name.
             */
            _simpleEntityType: function () {
                var ind = this.entityType.lastIndexOf(".") + 1;
                return this.entityType.substring(ind);
            },

            /**
             * Starts the process of criteria entity retrieval.
             */
            retrieve: function () {
                this.$.selection_criteria.retrieve();
            },

            /**
             * Starts the process of centre run.
             */
            run: function () {
                this.$.egi.clearSelection();
                this.$.egi.collapseAllCards();
                this.$.selection_criteria.run();
                this._triggerRun = true;
            },

            /**
             * Starts the process of refreshing the current page (only after run() has been already performed).
             */
            currentPage: function () {
                this.$.selection_criteria.currentPage();
            },

            /**
             * Starts the process of retrieving first page (only after run() has been already performed).
             */
            firstPage: function () {
                this.$.selection_criteria.firstPage();
            },

            /**
             * Starts the process of retrieving last page (only after run() has been already performed).
             */
            lastPage: function () {
                this.$.selection_criteria.lastPage();
            },

            /**
             * Starts the process of retrieving next page (only after run() has been already performed).
             */
            nextPage: function () {
                this.$.selection_criteria.nextPage();
            },

            /**
             * Starts the process of retrieving prev page (only after run() has been already performed).
             */
            prevPage: function () {
                this.$.selection_criteria.prevPage();
            },

            /**
             * Starts the process of refreshing the specified 'entities'.
             *
             * IMPORTANT: this method supports appropriately only refreshing of those entities, that are present in the current
             *     EGI grid (a subset of current page entities). It will later be replaced by refreshed instances (or removed
             *     from the result-set if they became unmatchable to the selection criteria after modification).
             */
            refreshEntities: function (entities) {
                if (entities !== null && entities.length > 0) {
                    this._entitiesThatShouldBeUpdated = entities;
                    this.$.selection_criteria.refreshEntities(this._entitiesThatShouldBeUpdated);
                } else { // refresh all page in case when no selected entities exist (it means that the action has been applied to all entities)
                    this.currentPage();
                }
            },

            canNotPrev: function (pageNumber) {
                return (typeof this.$ === 'undefined' || typeof this.$.selection_criteria === 'undefined') ? true : !this.$.selection_criteria.canPrev(pageNumber);
            },
            canNotNext: function (pageNumber, pageCount) {
                return (typeof this.$ === 'undefined' || typeof this.$.selection_criteria === 'undefined') ? true : !this.$.selection_criteria.canNext(pageNumber, pageCount);
            },
            canNotFirst: function (pageNumber, pageCount) {
                return (typeof this.$ === 'undefined' || typeof this.$.selection_criteria === 'undefined') ? true : !this.$.selection_criteria.canFirst(pageNumber, pageCount);
            },
            canNotLast: function (pageNumber, pageCount) {
                return (typeof this.$ === 'undefined' || typeof this.$.selection_criteria === 'undefined') ? true : !this.$.selection_criteria.canLast(pageNumber, pageCount);
            },
            canNotCurrent: function (pageNumber, pageCount) {
                return (typeof this.$ === 'undefined' || typeof this.$.selection_criteria === 'undefined') ? true : !this.$.selection_criteria.canCurrent(pageNumber, pageCount);
            },

            /**
             * Starts the process of centre saving.
             */
            save: function () {
                if (!this.canSave(this.$.selection_criteria._isCentreChanged)) {
                    throw "Cannot save the not modified centre.";
                }
                console.log("CENTRE SAVE");
                this.$.ajaxSaver.generateRequest();
            },
            canSave: function (isCentreChanged) {
                return this.canManageCentreConfig(isCentreChanged);
            },

            /**
             * Starts the process of centre discarding.
             */
            discard: function () {
                if (!this.canDiscard(this.$.selection_criteria._isCentreChanged)) {
                    throw "Cannot discard the not modified centre.";
                }
                console.log("CENTRE DISCARD");
                this.$.ajaxDiscarder.generateRequest();
            },
            canDiscard: function (isCentreChanged) {
                return this.canManageCentreConfig(isCentreChanged);
            },

            canManageCentreConfig: function (isCentreChanged) {
                return (typeof this.$ === 'undefined' || typeof this.$.selection_criteria === 'undefined') ? false : isCentreChanged === true;
            },

        	/**
        	 * Computes URL for 'ajaxSaver' and 'ajaxDiscarder'.
        	 */
        	_computeUrl: function (miType) {
        		return "/centre/" + miType;
        	}
        };
        
		Polymer.TgBehaviors.TgEntityCentreBehavior = [
			Polymer.TgBehaviors.TgEntityBinderBehavior,
			Polymer.TgBehaviors.TgEntityCentreBehaviorImpl
		];
		
    })();
</script>