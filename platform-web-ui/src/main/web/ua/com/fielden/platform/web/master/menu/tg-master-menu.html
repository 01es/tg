<link rel="import" href="/resources/polymer/iron-icons/iron-icons.html">
<link rel="import" href="/resources/polymer/iron-pages/iron-pages.html">
<link rel="import" href="/resources/polymer/iron-selector/iron-selector.html">
<!-- Paper elements -->
<link rel="import" href="/resources/polymer/paper-styles/color.html">
<link rel="import" href="/resources/polymer/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="/resources/polymer/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/resources/polymer/paper-item/paper-item.html">
<link rel="import" href="/resources/polymer/paper-material/paper-material.html">
<link rel="import" href="/resources/polymer/paper-menu/paper-menu.html">
<link rel="import" href="/resources/polymer/paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="/resources/polymer/paper-styles/paper-styles-classes.html">
<link rel="import" href="/resources/polymer/paper-toast/paper-toast.html">
<link rel="import" href="/resources/polymer/paper-toolbar/paper-toolbar.html">

<link rel="import" href="/app/tg-reflector.html">

<dom-module id="tg-master-menu">
    <style>
        :root {
            --dark-primary-color: var(--paper-blue-grey-700);
            --default-primary-color: var(--paper-blue-grey-500);
            --light-primary-color: var(--paper-blue-grey-200);
            --text-primary-color: #ffffff;
            /*text/icons*/
            --accent-color: var(--paper-pink-a200);
            --primary-background-color: #c5cae9;
            --primary-text-color: var(--paper-blue-grey-500);
            --secondary-text-color: #727272;
            --disabled-text-color: var(--paper-grey-400);
            --divider-color: #B6B6B6;
            /* Components */
            /* paper-drawer-panel */
            --drawer-menu-color: #ffffff;
            --drawer-border-color: 1px solid #ccc;
            --drawer-toolbar-border-color: 1px solid rgba(0, 0, 0, 0.22);
            /* paper-menu */
            --paper-menu-background-color: #fff;
            --menu-link-color: #111111;
        }
        
        :host {
            display: inline-block;
        }
        
        paper-scroll-header-panel {
            height: 100%;
        }
        
        paper-menu {
            padding: 0px;
        }
        
        paper-menu iron-icon {
            margin-right: 33px;
            opacity: 0.54;
        }
        
        .paper-menu > .iron-selected {
            color: var(--default-primary-color);
        }
        
        .tool-bar {
            padding: 0 16px;
            height: 44px;
            font-size: 18px;
        }
        
        paper-material {
            border-radius: 2px;
            height: 100%;
            margin: 16px auto;
            background: white;
            width: calc(98% - 46px);
            margin-bottom: 32px;
            padding-left: 30px;
            padding-right: 30px;
        }
        
        #drawer {
            border-right: 1px solid rgba(0, 0, 0, 0.14);
        }
        
        #drawerToolbar {
            color: var(--secondary-text-color);
            background-color: var(--drawer-menu-color);
            border-bottom: var(--drawer-toolbar-border-color);
        }
        
        iron-pages {
            padding: 8px 8px;
        }
    </style>
    <template>
		<tg-reflector id="reflector"></tg-reflector>
        <paper-drawer-panel id="paperDrawerPanel" disable-swipe>

            <!-- Drawer Scroll Header Panel -->
            <paper-scroll-header-panel drawer fixed id="drawer">

                <!-- Drawer Toolbar -->
                <paper-toolbar id="drawerToolbar" class="tool-bar">
                    <span style="font-size: 18px; height: 44px;">Vehicle Master</span>
                </paper-toolbar>

                <!-- Drawer Content -->
                <paper-menu attr-for-selected="data-route" selected="{{route}}">
	            	<content id="menuItems" select=".menu-item"></content>        
	            </paper-menu>
            </paper-scroll-header-panel>

            <!-- Main Area -->
            <paper-scroll-header-panel main fixed>

                <!-- Main Toolbar -->
                <paper-toolbar id="mainToolbar" style="height: 44px;">
                    <!-- Application name -->
                    <span style="font-size: 18px; height: 44px;">Vehicle Number: decription</span>
                </paper-toolbar>

                <!-- Main Content -->
                <div>
                    <iron-pages attr-for-selected="data-route" selected="{{route}}">
                        <content select=".menu-item-section"></content>
                    </iron-pages>
                </div>
            </paper-scroll-header-panel>
        </paper-drawer-panel>

    </template>
</dom-module>

<script>
    Polymer({
        is: 'tg-master-menu',

        properties: {
        	/* active menu item */
            route: {
                type: String,
                observer: '_routeChanged'
            },
            
            menuActions: {
            	type: Object
            },
            
            /* A menu route that should be activated when the master gets shoe*/
        	defaultRoute: {
        		type: String
        	},
        	
            /**
			 * A context holder creator that is used for tg-ui-action instances serving as menu items for compound masters.                
             */
            _createContextHolderForMenu: {
            	type: Function
            },
            
            /**
             * A function that return a master entity instance from the master where this menu is embedded into.
             */
            getMasterEntity: {
                type: Function,
                observer: '_masterEntityChanged'
            }

        },

        ready: function () {
        	var self = this;
            self._createContextHolderForMenu = (function () {
                var contextHolder = this.$.reflector.createContextHolder(
    				null, null, 'true',
    				null, null, this.getMasterEntity);
                return contextHolder;
            }).bind(self);
	
        }, // end of ready 
        
        attached: function () {
        	// Assign _createContextHolderForMenu to all tg-ui-action instances
        	var tgUiActions = Polymer.dom(this.$.menuItems).getDistributedNodes();
        	if (tgUiActions && tgUiActions.length > 0) {
        		for (var index = 0; index < tgUiActions.length; index++) {
        			tgUiActions[index].createContextHolder = this._createContextHolderForMenu;
        			tgUiActions[index].showDialog = this._showMenuItemView.bind(this);
        		}
        	}
        },

        _masterEntityChanged: function (newValue, oldValue) {
        	console.log('_masterEntityChanged', newValue);
        	if (this.route) {
        		this._routeChanged(this.route, this.route);
        	}
        	// TODO run default route
        },
        
        /**
         * A function for show-dialog attribute of tg-ui-action, which is used in case of master with menu to load and display a corresponding menu item view.
         */
        _showMenuItemView: function (action) {
        	this.route = action.getAttribute('data-route');
        },
        
        _routeChanged: function (newRoute, oldRoute) {
        	console.log("ROUTE HAS CHANGED TO", newRoute, oldRoute);
        	// TODO check and load menu item section if not loaded already
        	//      otherwise trigger validation... may not be applicable to all masters
        	var action = Polymer.dom(this).querySelector('tg-ui-action[data-route=' + newRoute + ']');
        	if (action) {
        		var section = Polymer.dom(this).querySelector('tg-master-menu-item-section[data-route=' + newRoute + ']');
        		section.activate(action);
        	}
        }
    });
</script>