<link rel="import" href="/resources/gis/tg-gis-component.html">
<link rel="import" href="/resources/gis/message/tg-message-marker-cluster.html">
<link rel="import" href="/resources/gis/message/tg-message-entity-styling.html">
<link rel="import" href="/resources/gis/message/tg-message-marker-factory.html">

<script src="/resources/gis/message/init/messageEntities.js"></script>
<script src="/resources/gis/message/init/messageEntityCentre.js"></script>
<script>
(function() {
	var MessageGisComponent = function(mapDiv, progressDiv, progressBarDiv) {
	    this._entitiesString = L.GIS.messageEntitiesString;
	    this._entityCentreString = L.GIS.messageEntityCentreString;

		L.GIS.GisComponent.call(this, mapDiv, progressDiv, progressBarDiv);
	};

	MessageGisComponent.prototype = Object.create(L.GIS.GisComponent.prototype);
	MessageGisComponent.prototype.constructor = MessageGisComponent;

	MessageGisComponent.prototype.createMarkerCluster = function(map, markerFactory, progressDiv, progressBarDiv) {
		return new L.GIS.MessageMarkerCluster(map, markerFactory, progressDiv, progressBarDiv);
	};

	MessageGisComponent.prototype.initialise = function() {
		// this._geoJsonOverlay.addData(new MessageInitialiser().geoJsonFeatures());
		this.promoteEntityCentreString(this._entityCentreString);
		console.debug(this._entityCentre);

		L.GIS.GisComponent.prototype.initialise.call(this);

		this.promoteEntitiesString(this._entitiesString);
		console.debug(this._entities);
	};

	MessageGisComponent.prototype.createEntityStyling = function() {
		return new L.GIS.MessageEntityStyling();
	};

	MessageGisComponent.prototype.createMarkerFactory = function() {
		return new L.GIS.MessageMarkerFactory();
	};

	MessageGisComponent.prototype.createGeometry = function (feature) {
		if (feature) {
		    var featureType = featureType(feature);
			if (featureType === 'Message' || featureType === 'Summary_Message') {
				return L.GIS.GisComponent.prototype.createGeometry.call(this, feature);
			} else {
				throw "MessageGisComponent.prototype.createGeometry: [" + featureType + "] has unknown type == [" + featureType + "]. Should be 'Message' or 'Summary_Message'.";
			}
		} else {
			throw "MessageGisComponent.prototype.createGeometry: [" + feature + "] is empty.";
		}
	}

	MessageGisComponent.prototype.createSummaryFeature = function (features) {
		if (features.length > 0) {
			var featureType = featureType(features[0]);
			if (featureType === 'Message') {
				return L.GIS.GisComponent.prototype.createSummaryFeature.call(this, features);
			}
		}
		return null;
	}

	MessageGisComponent.prototype.createPopupContent = function (feature) {
		if (feature) {
		    var featureType = featureType(feature);
			if (featureType === 'Message') {
				return L.GIS.GisComponent.prototype.createPopupContent.call(this, feature);
			} else if (featureType === 'Summary_Message') {
				return 'Машина: ' + this.valueToString(feature.properties._machine);
			} else {
				throw "MessageGisComponent.prototype.createPopupContent: [" + feature + "] has unknown type == [" + featureType + "]. Should be 'Message' or 'Summary_Message'.";
			}
		} else {
			throw "MessageGisComponent.prototype.createPopupContent: [" + feature + "] is empty.";
		}
	}

	L.GIS = L.GIS || {};
	L.GIS.MessageGisComponent = MessageGisComponent;
})();
</script>