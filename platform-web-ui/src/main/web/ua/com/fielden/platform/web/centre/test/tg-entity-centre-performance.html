<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <title>entity-centre basic tests</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    
    <script src="/resources/polymer/webcomponentsjs/webcomponents-lite.js"></script>
    <script src="/resources/polymer/web-component-tester/browser.js"></script>
    <script src="/resources/polymer/test-fixture/test-fixture-mocha.js"></script>
    <script src="/resources/polymer/iron-test-helpers/mock-interactions.js"></script>
    
    <link rel="import" href="/resources/polymer/test-fixture/test-fixture.html">
    
    <link rel="import" href="/app/tg-reflector.html">
    <link rel="import" href="/centre_ui/ua.com.fielden.platform.sample.domain.MiTgPersistentEntityWithProperties1">
</head>

<body>
    <tg-reflector id="reflector"></tg-reflector>
    <test-fixture id="CentreFixture">
        <template>
            <tg-MiTgPersistentEntityWithProperties1-centre id="centre" uuid="TEST_CENTRE"></tg-MiTgPersistentEntityWithProperties1-centre>
        </template>
    </test-fixture>
    
<script>
    suite('entity centre', function() {
        var centre, reflector, noOfIterations, _calcConfidenceInterval;
        
        setup(function() {
            centre = fixture('CentreFixture');
            reflector = document.querySelector('#reflector');
            noOfIterations = 100;
            _calcConfidenceInterval = function (data) {
                var n = data.length;
                var sum = 0;
                for (var index = 0; index < n; index++) {
                    sum += data[index];
                }
                var x_ = sum * 1.0 / n; // "mean"
                
                var sum = 0;
                for (var index = 0; index < n; index++) {
                    var diff = data[index] - x_;
                    sum += diff * diff;
                }
                sum = sum / n;
                var sigma = Math.sqrt(sum); // standard deviation
                
                // The value of z(alfa / 2) is taken from z-table for confidence level of 95%, for example from here (http://www.statisticshowto.com/tables/z-table/).
                // alfa = 0.95, alfa / 2 = 0.475, find that value inside the table and check intersections: 1.9 and 0.6 => z := 1.96
                var z = 1.96;
                var deltaX = z * (sigma / Math.sqrt(n));
                
                return [+((x_ - deltaX).toFixed(1)), +((x_ + deltaX).toFixed(1))];
            }
        });
        
        test('subsequent validations measuring', function (done) {
            var start;
            var count = 0;
            var data = [];
            
            var _leftEditor = function (name) {
                return centre.$.selection_criteria.$['editor_4_tgPersistentEntityWithProperties_' + name + '_is'];
            };
            
            centre.postRetrieved = function (entity, bindingEntity, customObject) {
                var editor = _leftEditor('booleanProp');
                console.log('_leftEditor(booleanProp) === ', editor);
                
                start = new Date().getTime();
                editor._editingValue = (editor._editingValue === 'true') ? 'false' : 'true';
                editor.commit();
            };
            
            centre.$.selection_criteria.postValidated = function (validatedEntity, bindingEntity, customObject) {
                count++;
                
                var time = new Date().getTime() - start;
                data.push(time);
                console.debug('Validated in ', time, ' millis (no ', count, ').');
                
                var editor = _leftEditor('booleanProp');
                console.log('_leftEditor(booleanProp) === ', editor);
                
                start = new Date().getTime();
                editor._editingValue = (editor._editingValue === 'true') ? 'false' : 'true';
                editor.commit();
                
                if (count >= noOfIterations) {
                    console.debug('[c1; c2] = ', _calcConfidenceInterval(data));
                    done();
                }
            };
            
            centre.retrieve();
        });
        
        
        /* test('run action works for custom fetch provider', function (done) {
            var old_postRun = centre._postRun;
            
            centre._postRun = function (criteriaEntity, newBindingEntity, resultEntities, pageCount, renderingHints, isRefreshingConcreteEntities) {
            	old_postRun(criteriaEntity, newBindingEntity, resultEntities, pageCount, renderingHints, isRefreshingConcreteEntities);
            	
            	var entity = resultEntities[0];
            	
                // value ok?
                assert.ok(entity.get("property"), "Property value should be initialised.");
                assert.ok(entity.get("additionalProperty"), "Property value should be initialised.");
            	
            	done();
            };
            
            centre.postRetrieved = function (entity, bindingEntity, customObject) {
				centre.run();
            };

 			centre.retrieve();
	    }); */
	});
</script>

</body>

</html>
