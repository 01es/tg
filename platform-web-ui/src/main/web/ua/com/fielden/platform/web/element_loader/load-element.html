<link rel="import" href="/resources/polymer/polymer/polymer.html">

<polymer-element name="load-element" attributes="auto import elementName attrs">
    <template>
        <content></content>
    </template>
    <script>
        (function () {
            var importedURLs = {},
                //Creates the element with specified elementName and attributes and inserts it into insertToElement element.
                insertElement = function (insertToElement, elementName, attributes) {
                    if (elementName && elementName.toString().length > 0) {
                        var customElement = document.createElement(elementName);
                        if (attributes && typeof attributes === "object") {
                            for (attr in attributes) {
                                customElement[attr] = attributes[attr];
                            }
                            insertToElement.innerHTML = "";
                            insertToElement.appendChild(customElement);
                        }
                        return customElement;
                    }
                };
            Polymer({
                publish: {
                    //Defines whether to load element automaticaly or not.
                    auto: {
                        value: false,
                        reflect: true
                    },
                    wasLoaded: {
                        value: false,
                        reflect: true
                    }
                },
                domReady: function () {
                    if (this.auto) {
                        this.load();
                    }
                },
                //Loads the custom element and fires after-load event with loaded element.
                load: function () {
                    if (!this.wasLoaded) {
                        var thisElement = this,
                            attributes = this.attrs || {},
                            elementName = this.elementName || (this.import && this.import.split('/').slice(-1)[0].replace('.html', ''));
                        if (this.import && !importedURLs.hasOwnProperty(this.import)) {
                            Polymer.import([this.import], function () { // TODO during 'import' method invocation the server error json can arrive instead of piece of DOM -- need to handle this somehow
                                thisElement.fire('after-load', insertElement(thisElement, elementName, attributes));
                            });
                        } else {
                            this.fire('after-load', insertElement(this, elementName, attributes));
                        }
                        this.wasLoaded=true;
                    }
                },
                reload: function() {
                    this.wasLoaded = false;
                    this.load();
                }
            });
        })();
    </script>
</polymer-element>