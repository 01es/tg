<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <title>entity-centre basic tests</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

    <script src="/resources/polymer/webcomponentsjs/webcomponents-lite.js"></script>
    <script src="/resources/polymer/web-component-tester/browser.js"></script>
    <script src="/resources/polymer/test-fixture/test-fixture-mocha.js"></script>
    <script src="/resources/polymer/iron-test-helpers/mock-interactions.js"></script>

    <link rel="import" href="/resources/polymer/test-fixture/test-fixture.html">

    <link rel="import" href="/app/tg-reflector.html">
    <link rel="import" href="/centre_ui/ua.com.fielden.platform.sample.domain.MiDeletionTestEntity">
</head>

<body>
    <tg-reflector id="reflector"></tg-reflector>
    <test-fixture id="CentreFixture">
        <template>
            <tg-MiDeletionTestEntity-centre id="centre"></tg-MiDeletionTestEntity-centre>
        </template>
    </test-fixture>

    <script>
        suite('entity centre refresh after delete', function () {
            var centre, reflector;

            setup(function () {
                centre = fixture('CentreFixture');
                reflector = document.querySelector('#reflector');
            });

            test('refresh after entity deleteion works', function (done) {
                var old_postRun = centre._postRun;
                var deleteAction, testingPhase;

                centre._postRun = function (criteriaEntity, newBindingEntity, resultEntities, pageCount, renderingHints, summary) {
                    old_postRun(criteriaEntity, newBindingEntity, resultEntities, pageCount, renderingHints, summary);

                    if (testingPhase === 'first') {
                        assert.strictEqual(resultEntities.length, 2, "The number of retrieved entities is incorrect should be 2 but wass: " + resultEntities.length + ".");
                        var entities = centre.$.egi.entities;
                        var selection = centre.$.egi.selectedEntities;
                        var index;
                        for (index = 0; index < entities.length; index++) {
                            selection.push(entities[index]);
                        }
                        testingPhase = 'finish';
                        deleteAction._run();
                    } else if (testingPhase === 'finish') {
                        assert.strictEqual(resultEntities.length, 0, "The number of refreshed entities is incorrect should be 0 but wass: " + resultEntities.length + ".");
                        centre._postRun = old_postRun;
                        done();
                    }
                };

                centre.postRetrieved = function (entity, bindingEntity, customObject) {
                    deleteAction = Polymer.dom(centre.$.egi.$$("#top_action_selctor")).getDistributedNodes()[0].children[0];
                    testingPhase = 'first';
                    centre.run();
                };
                centre.retrieve();
            });
        });
    </script>

</body>

</html>
