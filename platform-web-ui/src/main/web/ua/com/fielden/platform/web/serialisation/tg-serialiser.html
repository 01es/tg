<link rel="import" href="/resources/polymer/polymer/polymer.html">
<link rel="import" href="/tg-reflector">

<polymer-element name="tg-serialiser" hidden>
    <template>
        <tg-reflector id="typeInfo"></tg-reflector>
    </template>
    <script>
        (function () {
            var convertToType = function (value) {
                var v = Number(value);
                return !isNaN(v) ? v :
                    value === "undefined" ? undefined : value === "null" ? null : value === "true" ? true : value === "false" ? false : value;
            };
            Polymer({
                serialise: function (envelope) {
                    var entitiesByType = {}, // represents the array of serialised entities of concrete type (firstly serialised entities in the head of list)
                        getId = function(entity) {
                            var array = entitiesByType[entity._type];
                            return array ? array.indexOf(entity) : -1;
                        },
                        putId = function(entity) {
                            var array = entitiesByType[entity._type];
                            if (!array) {
                                array = [];
                                entitiesByType[entity._type] = array;
                            }
                            array.push(entity);
                            return array.length - 1;
                        },

                        serialise = function (obj) {
                            var serialisedObj,
                                property,
                                index;
                            // Determine the type of the obj to serilise.
                            if (Array.isArray(obj)) {
                                // If the type of obj is array then create new array and push into it each deserialised element.
                                serialisedObj = [];
                                obj.forEach(function (elem) {
                                    serialisedObj.push(serialise(elem));
                                });
                            } else if (obj && typeof obj === 'object') {
                                serialisedObj = {};
                                // If the type is an object and if it has _type property then it is an entity.
                                if (obj.hasOwnProperty("_type")) {
                                    // Find the index of the obj in 'array of serialised objects'. If the index equals -1 -- the object was not serialised yet
                                    index = getId(obj);
                                    if (index >= 0) {
                                        serialisedObj["@ref_id"] = obj["_type"].number + "#" + index; // use the current number
                                        return serialisedObj;
                                    } else {                                        
                                        // If obj wasn't found in object map then
                                        // create object and add property "@id" to that object, also add created object to object map with key "@id".
                                        // That object map contains entity references in order to use it later for initialising cross referenced objects. 
                                        serialisedObj["@id"] = obj["_type"].number + "#" + putId(obj); 
                                    }
                                }
                                // All object properties will be copied to new object. Just skip "_type" property.
                                for (property in obj) {
                                    if (property !== "_type") {
                                        serialisedObj[property] = serialise(obj[property]);
                                    }
                                }
                            } else {
                                // All other type of objects will be just copied.
                                serialisedObj = obj;
                            }
                            return serialisedObj;
                        };
                    return serialise(envelope);
                },
                deserialise: function (envelope) {
                    var objectMap = {},
                        self = this,
                        deserialise = function (obj) {
                            var deserialisedObject,
                                property;
                            // Determine the type of object to deserialise.
                            if (Array.isArray(obj)) {
                                // If it is an array then create new array and add deserialised eleemnts to that array.
                                deserialisedObject = [];
                                obj.forEach(function (elem) {
                                    deserialisedObject.push(deserialise(elem));
                                });
                            } else if (obj && typeof obj === 'object') {
                                deserialisedObject = {};
                                // If it is an object with "@ref_id" property then find it in object map and return.
                                // Object map contains previously deserialised objects. This map provides the support for cross reference.
                                if (obj.hasOwnProperty("@ref_id")) {
                                    return objectMap[obj["@ref_id"]];
                                } else if (obj.hasOwnProperty("@id")) {
                                    // If it is an object with "@id" property then create new object with "_id" and "_type" properties and add to the object map.
                                    deserialisedObject["_type"] = self.$.typeInfo.getType(obj["@id"].split("#")[0]);
                                    objectMap[obj["@id"]] = deserialisedObject;
                                }
                                // Copy all properties from obj to new deserialised object. Skip "@id" proeprty.
                                for (property in obj) {
                                    if (property !== "@id") {
                                        deserialisedObject[property] = deserialise(obj[property]);
                                    }
                                }
                            } else {
                                deserialisedObject = obj;
                            }
                            return deserialisedObject;
                        };
                    return deserialise(envelope);
                }

            });
        })();
    </script>
</polymer-element>