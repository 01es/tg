<link rel="import" href="/resources/polymer/polymer/polymer.html">
<link rel="import" href="/resources/editors/tg-editor-behavior.html">
<link rel="import" href="/resources/editors/tg-editor.html">

<link rel="import" href="/resources/colour_picker/tg-colour-picker.html">

<style>
	.color-box {
		position: relative;
		min-width: 40px;
		min-height: 40px;
	}
	
	.dummy-box {
		position: absolute;
		top: -3px;
		left: -3px;
		min-width: 40px;
		min-height: 40px;
		border: 3px solid white;
		background-color: none;
		box-shadow: 0px 2px 6px #ccc;
		z-index: 1;
		display: none;
		cursor: pointer;
	}
	
	.icon {
		min-width: 40px;
		min-height: 40px;
		color: #757575;
	}
	/*
	.small-icon {
		min-width: 14px;
		min-height: 14px;
		color: #757575;
		opacity: 1;
	}
*/
	
	.color-box:hover > .dummy-box {
		display: block;
	}
	/*
	.small-box {
		max-width: 14px;
		max-height: 14px;
		background-color: #FAFAFA;
		border: 2px solid #BDBDBD;
		border-radius: 2px;
		cursor: pointer;
	}
*/
	
	iron-dropdown {
		background-color: #FAFAFA;
		box-shadow: 0px 2px 6px #ccc;
		margin-top: 1em;
	}
</style>

<dom-module id="tg-colour-picker">
	<template>
		<tg-editor id="editorDom" prop-title="[[propTitle]]" _disabled="[[_disabled]]" _editing-value="{{_editingValue}}" action="[[action]]" _error="[[_error]]" _comm-value="[[_commValue]]" _accepted-value="[[_acceptedValue]]" debug="[[debug]]" _on-input="[[_onInput]]" _on-keydown="[[_onKeydown]]" _on-change="[[_onChange]]" current-state="[[currentState]]" _open-colour-picker="[[_openColourPicker]]">
		</tg-editor>
	</template>
</dom-module>

<script>
	Polymer({
		is: 'tg-colour-picker',
		behaviors: [Polymer.TgBehaviors.TgEditorBehavior],

		properties: {

			_isAcceptingColourFromPicker: {
				type: Boolean,
				value: false
			},

			_openColourPicker: {
				type: Function,
				value: function () {
					return (function (e) {
						if (!this.$.colourTemplate) {
							var mve = this._createDialog();
							Polymer.dom(this.root).appendChild(mve);
							Polymer.dom.flush();
						}
						this.$.colourTemplate.open();
					}).bind(this);
				}
			}
		},

		ready: function () {
			this.$.editorDom._editorKind = "COLOUR";
		},

		convertToString: function (value) {
			return "" + value;
		},

		convertFromString: function (strValue) {
			if (strValue.length !== 3 && strValue.length !== 6 && strValue !== "") {
				throw "The entered check value is incorrect [" + strValue + "].";
			}
			return strValue;
		},

		_createDialog: function () {
			var self = this,
				domBind = document.createElement('template', 'dom-bind');

			self.$.colourTemplate = domBind;

			domBind.colorSelected = function (e, detail) {
				this._acceptColourBind();
				self._editingValue = (rgbToHex(e.srcElement.style['background-color'])).substring(1);
				this.$.dropdown.close();
			}.bind(domBind);

			domBind.nonColorSelected = function () {
				this._acceptColourBind();
				self._editingValue = "";
				this.$.dropdown.close();

			}.bind(domBind);

			domBind._acceptColourBind = function () {
				self._isAcceptingColourFromPicker = true;
				self.decoratedInput().focus();
			}.bind(domBind);

			domBind.open = function () {
				var dropdown = this.$.dropdown;
				this.async(function () {
					dropdown.open();
				}.bind(this), 1);
			}.bind(domBind);

			var div = domBind.content.ownerDocument.createElement('div');
			div.innerHTML =
				'<iron-dropdown  id="dropdown">' +
				'<div class="dropdown-content">' +
				'<div class="layout vertical" style="margin:10px 10px 10px 10px;">' +
				'<div class="layout horizontal">' +
				'<div class="color-box" on-tap="nonColorSelected" style="background-color:#F5F5F5">' +
				'<div class="dummy-box" style="background-color:#F5F5F5">' +
				'<iron-icon class="icon" icon="icons:close"></iron-icon>' +
				'</div>' +
				'<iron-icon class="icon" icon="icons:close"></iron-icon>' +
				'</div>' +
				'<div class="color-box" on-tap="colorSelected" style="background-color:#F44336">' +
				'<div class="dummy-box" style="background-color:#F44336"></div>' +
				'</div>' +
				'<div class="color-box" on-tap="colorSelected" style="background-color:#FF9800">' +
				'<div class="dummy-box" style="background-color:#FF9800"></div>' +
				'</div>' +
				'<div class="color-box" on-tap="colorSelected" style="background-color:#FFEB3B">' +
				'<div class="dummy-box" style="background-color:#FFEB3B"></div>' +
				'</div>' +
				'<div class="color-box" on-tap="colorSelected" style="background-color:#4CAF50;">' +
				'<div class="dummy-box" style="background-color:#4CAF50;"></div>' +
				'</div>' +
				'<div class="color-box" on-tap="colorSelected" style="background-color:#009688">' +
				'<div class="dummy-box" style="background-color:#009688"></div>' +
				'</div>' +
				'<div class="color-box" on-tap="colorSelected" style="background-color:#00BCD4">' +
				'<div class="dummy-box" style="background-color:#00BCD4"></div>' +
				'</div>' +
				'<div class="color-box" on-tap="colorSelected" style="background-color:#3F51B5">' +
				'<div class="dummy-box" style="background-color:#3F51B5"></div>' +
				'</div>' +
				'<div class="color-box" on-tap="colorSelected" style="background-color:#9C27B0">' +
				'<div class="dummy-box" style="background-color:#9C27B0"></div>' +
				'</div>' +
				'</div>' +
				'<div class="layout horizontal">' +
				'<div class="color-box" on-tap="colorSelected" style="background-color:#D7CCC8">' +
				'<div class="dummy-box" style="background-color:#D7CCC8"></div>' +
				'</div>' +
				'<div class="color-box" on-tap="colorSelected" style="background-color:#EF9A9A">' +
				'<div class="dummy-box" style="background-color:#EF9A9A"></div>' +
				'</div>' +
				'<div class="color-box" on-tap="colorSelected" style="background-color:#FFCC80">' +
				'<div class="dummy-box" style="background-color:#FFCC80"></div>' +
				'</div>' +
				'<div class="color-box" on-tap="colorSelected" style="background-color:#FFF59D">' +
				'<div class="dummy-box" style="background-color:#FFF59D"></div>' +
				'</div>' +
				'<div class="color-box" on-tap="colorSelected" style="background-color:#A5D6A7;">' +
				'<div class="dummy-box" style="background-color:#A5D6A7;"></div>' +
				'</div>' +
				'<div class="color-box" on-tap="colorSelected" style="background-color:#80CBC4">' +
				'<div class="dummy-box" style="background-color:#80CBC4"></div>' +
				'</div>' +
				'<div class="color-box" on-tap="colorSelected" style="background-color:#80DEEA">' +
				'<div class="dummy-box" style="background-color:#80DEEA"></div>' +
				'</div>' +
				'<div class="color-box" on-tap="colorSelected" style="background-color:#9FA8DA">' +
				'<div class="dummy-box" style="background-color:#9FA8DA"></div>' +
				'</div>' +
				'<div class="color-box" on-tap="colorSelected" style="background-color:#CE93D8">' +
				'<div class="dummy-box" style="background-color:#CE93D8"></div>' +
				'</div>' +
				'</div>' +
				'</div>' +
				'</div>' +
				'</iron-dropdown>';

			domBind.content.appendChild(div);
			return domBind;

		},
		_editingValueChanged: function (newValue, oldValue) {
			Polymer.TgBehaviors.TgEditorBehavior._editingValueChanged.call(this, newValue, oldValue);
			if (this._isAcceptingColourFromPicker) {
				this._isAcceptingColourFromPicker = false;
				this.commit();
			}
		},

		rgbToHex: function (colorString) {
			if (colorString === null) {
				return colorString;
			}
			if (colorString.length === 3 || colorString.length === 6) {
				return colorString;
			}
			var nums = /(.*?)rgb\((\d+),\s*(\d+),\s*(\d+)\)/i.exec(colorString),
				r = parseInt(nums[2], 10).toString(16),
				g = parseInt(nums[3], 10).toString(16),
				b = parseInt(nums[4], 10).toString(16);
			return "#" + (
				(r.length == 1 ? "0" + r : r) +
				(g.length == 1 ? "0" + g : g) +
				(b.length == 1 ? "0" + b : b)
			);
		}

	});
</script>