<link rel="import" href="/resources/polymer/polymer/polymer.html">
<link rel="import" href="/resources/polymer/core-ajax/core-ajax.html">
<link rel="import" href="/resources/validation/tg-entity-validator.html">
<link rel="import" href="/resources/binding/tg-entity-binder.html">

<polymer-element name="tg-entity-master" extends="tg-entity-binder" attributes="entitytype entityid onSaved onSavedComplete currentState">
    <template>
        <shadow></shadow>
        <tg-entity-validator id="validator" user="{{user}}" entitytype="{{entitytype}}" onvalidated="{{onValidatedDefault}}"></tg-entity-validator>

        <core-ajax id="ajaxRetriever" url="/users/{{user}}/entity/{{entitytype}}/{{entityid}}" method="GET" handleas="json"></core-ajax>
        <core-ajax id="ajaxSaver" url="/users/{{user}}/entity/{{entitytype}}/{{entityid}}" method="POST" handleas="json"></core-ajax>
        <core-ajax id="ajaxSaverNew" url="/users/{{user}}/entity/{{entitytype}}/{{entityid}}" method="PUT" handleas="json"></core-ajax>
    </template>
    <script>
        (function () { // _bindingValue(currBindingEntity, 'stringProp')
            var SimultaneousSaveException = function () {
                Object.call(this);

                this.message = "Simultaneous save exception: the save process has been already started before and not ended. Please, block UI until the save action completes.";
            };
            SimultaneousSaveException.prototype = Object.create(Object.prototype);
            SimultaneousSaveException.prototype.constructor = SimultaneousSaveException;

            /**
             * Overridden toString method to represent this exception more meaningfully than '[Object object]'.
             *
             */
            SimultaneousSaveException.prototype.toString = function () {
                return this.message;
            }

            Polymer("tg-entity-master", {
                publish: {
                    // entityid, -- represents the id of the current entity (sets initially during tg-entity-master generation phase and then updates accordingly)
                },

                /**
                 * The map of actions by their name ids.
                 *
                 * Every action consists of three callbacks ('preAction', 'postActionSuccess', 'postActionError') and
                 * 'shortDesc', 'longDesc', 'icon' + 'enabledStates'.
                 * 
                 * 'EnabledStates' are the states in which the action is enabled.
                 */
                actions: null,

                /**
                 * Initialisation block (after 'ready'). It is designated to use for inner object / arrays initialisation.
                 */
                created: function() {
                    this.super();
                    this.actions = {};
                    // TODO ...
                    this.actions['NEW'] = {};
                },

                /**
                 * Initialisation block. It has all children web components already initialised.
                 */
                ready: function () {
                    var self = this;
                    self.super();
                    console.log("child ready");

                    // IMPORTANT: it is crucial to bind the functions, which will potentially be passed
                    //            into other contexts (for e.g. onValidatedDefault will be used in tg-entity-validator),
                    //            with its original context!
                    self.save = self.save.bind(self);
                    self.edit = self.edit.bind(self);
                    self.view = self.view.bind(self);
                    self.onSavedDefault = self.onSavedDefault.bind(self);
                    self._title = self._title.bind(self);
                    self._desc = self._desc.bind(self);

                    self.$.ajaxSaver.addEventListener('core-response', function (e) {
                        if (e.detail.xhr.status === 200) {
                            var potentiallySavedEntity = self.$.serialiser.deserialise(e.detail.response).instance;
                            self.onSavedDefault(potentiallySavedEntity);
                        }
                    });
                    self.$.ajaxSaverNew.addEventListener('core-response', function (e) {
                        if (e.detail.xhr.status === 200) {
                            var potentiallySavedEntity = self.$.serialiser.deserialise(e.detail.response).instance;
                            self.onSavedDefault(potentiallySavedEntity);
                        }
                    });
                    self.$.ajaxSaver.addEventListener('core-complete', function (e) {
                        if (e.detail.xhr.status === 200) {
                            self.onSavedComplete();
                        }
                    });
                    self.$.ajaxSaverNew.addEventListener('core-complete', function (e) {
                        if (e.detail.xhr.status === 200) {
                            self.onSavedComplete();
                        }
                    });

                    self.actions['REFRESH'] = {
                        shortDesc: 'REFRESH',
                        longDesc: 'REFRESH ACTION...',
                        enabledStates: ['EDIT', 'VIEW'],
                        action: function() {
                            self.retrieve();
                        }
                    };
                    self.actions['VALIDATE'] = {
                        shortDesc: 'VALIDATE',
                        longDesc: 'VALIDATE ACTION...',
                        enabledStates: ['EDIT'],
                        action: function() {
                            self.validate();
                        }
                    };
                    self.actions['SAVE'] = {
                        shortDesc: 'SAVE',
                        longDesc: 'SAVE ACTION...',
                        enabledStates: ['EDIT'],
                        action: function() {
                            self.save();
                        }
                    };

                    self.actions['EDIT'] = {
                        shortDesc: 'EDIT',
                        longDesc: 'EDIT ACTION...',
                        enabledStates: ['VIEW'],
                        action: function() {
                            self.edit();
                            this.onAction(null);
                        },
                        onAction: function(e) {                            
                        }
                    };
                    self.actions['VIEW'] = {
                        shortDesc: 'VIEW',
                        longDesc: 'VIEW ACTION...',
                        enabledStates: ['EDIT'],
                        action: function() {
                            self.view();
                            this.onAction(null);
                        },
                        onAction: function(e) {                            
                        }
                    };
                },

                /**
                 * The core-ajax component for entity retrieval. 
                 */
                ajaxRetriever: function() {
                    return this.$.ajaxRetriever;
                },

                /**
                 * The tg-entity-validator component for entity validation. 
                 */
                validator: function() {
                    return this.$.validator;
                },

                /** 
                 * The function for binding property title. The argument 'entity' will be changed in future. Polymer will listen to that change.
                 */
                _title: function (entity, property) {
                    if (typeof this.$ !== 'undefined') {
                        if (this._isEntity(entity)) {
                            // console.log("_title entity", entity);
                            // console.log("_title entity type", entity.type());
                            // console.log("_title entity type prop", entity.type().prop(property));
                            // console.log("_title entity type prop title", entity.type().prop(property).title());
                            return entity.type().prop(property).title();
                        } else {
                            return "Not yet initialised currEntity, from which to get title!";
                        }
                    } else {
                        return "Not yet initialised this.$!";
                    }
                },

                /** 
                 * The function for binding property desc. The argument 'entity' will be changed in future. Polymer will listen to that change.
                 */
                _desc: function (entity, property) {
                    if (typeof this.$ !== 'undefined') {
                        if (this._isEntity(entity)) {
                            return entity.type().prop(property).desc();
                        } else {
                            return "Not yet initialised currEntity, from which to get desc!";
                        }
                    } else {
                        return "Not yet initialised this.$!";
                    }
                },

                //////////////////////////////////////// RETRIEVAL ////////////////////////////////////////
                /**
                 * Default implementation for onSavedComplete callback.
                 */
                onSavedComplete: function () {},

                /**
                 * Changes the state to 'EDIT'.
                 */
                edit: function () {
                    if (this.currentState === 'EDIT') {
                        console.warn("The master is already in EDIT state. state == ", this.currentState);
                    } else {
                        this.currentState = 'EDIT';
                    }
                },

                /**
                 * Changes the state to 'VIEW'.
                 */
                view: function () {
                    if (this.currentState === 'VIEW') {
                        console.warn("The master is already in VIEW state. state == ", this.currentState);
                    } else {
                        this.currentState = 'VIEW';
                    }
                },

                //////////////////////////////////////// SAVING ////////////////////////////////////////
                /**
                 * Starts the process of entity saving (based on currBindingEntity).
                 */
                save: function () {
                    var self = this;

                    if (self._savingInProgress()) {
                        var SimultaneousSaveException = this._getSimultaneousSaveExceptionType();
                        throw new SimultaneousSaveException();
                    }

                    self.startRefreshCycleModeForEditors();

                    var holder = self.extractModifiedPropertiesHolder(self.currBindingEntity, self.originalBindingEntity);
                    // cancel previous validation before starting saving process -- it includes validation process internally!
                    self.$.validator.abortValidationIfAny();

                    // IMPORTANT: at this stage no client side check is needed for hasModified(holder).
                    //            This check will be done on server -- and appropriate onSavedDefault callback will be triggered.
                    self._saveModifiedProperties(self._reset(holder));
                    // if (self._hasModified(holder)) {
                    //     self._saveModifiedProperties(self._reset(holder));
                    // } else {
                    //     self.$.validator.validate(self._reset(holder));
                    // }
                },

                _savingInProgress: function () {
                    return this.$.ajaxSaverNew.loading || this.$.ajaxSaver.loading;
                },

                /**
                 * Starts the process of entity saving.
                 *
                 * @param modifiedPropertiesHolder -- the entity with modified properties
                 */
                _saveModifiedProperties: function (modifiedPropertiesHolder) {
                    // console.log("save: modifiedPropertiesHolder", modifiedPropertiesHolder);
                    var ser = this.$.serialiser.serialise(modifiedPropertiesHolder);
                    // console.log("save: serialised modifiedPropertiesHolder", ser);
                    if (this.entityid === "new") {
                        this.$.ajaxSaverNew.body = JSON.stringify(ser);
                        this.$.ajaxSaverNew.go();
                    } else {
                        this.$.ajaxSaver.body = JSON.stringify(ser);
                        this.$.ajaxSaver.go();
                    }
                },

                /**
                 * Returns 'true' if the entity has been modified from original, 'false' otherwise.
                 *
                 * NOTE: it is designed to be used once (after that hasModified() will not be working for the same instance of modPropsHolder).
                 *
                 * @param modifiedPropertiesHolder -- the entity with modified properties
                 */
                _hasModified: function (modifiedPropertiesHolder) {
                    return modifiedPropertiesHolder["@modified"];
                },

                /**
                 * Cancels any unfinished saving that was requested earlier (if any).
                 */
                _abortSavingIfAny: function () {
                    this.$.ajaxSaver.abort();
                    this.$.ajaxSaverNew.abort();
                },

                /**
                 * Default implementation for onSaved callback.
                 */
                onSavedDefault: function (potentiallySavedEntity) {
                    var wasStale = potentiallySavedEntity.version > this.currEntity.version;
                    // this.startRefreshCycleModeForEditors();
                    var newBindingEntity = this.onEntityReceived(potentiallySavedEntity, wasStale);
                    // custom external action
                    this.onSaved(potentiallySavedEntity, newBindingEntity);
                },

                //////////////////////////////////////// BINDING & UTILS ////////////////////////////////////////
                _getSimultaneousSaveExceptionType: function () {
                    return SimultaneousSaveException;
                }
            });
        })();
    </script>
</polymer-element>