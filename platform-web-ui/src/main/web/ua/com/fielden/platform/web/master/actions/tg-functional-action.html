<link rel="import" href="/resources/polymer/polymer/polymer.html">

<link rel="import" href="/resources/master/actions/tg-abstract-action.html">
<link rel="import" href="/resources/serialisation/tg-serialiser.html">
<link rel="import" href="/resources/polymer/core-ajax/core-ajax.html">

<polymer-element name="tg-functional-action" attributes="entitytype preAction postActionSuccess postActionError" extends="tg-abstract-action">
    <template>
        <shadow></shadow>
        <tg-serialiser id="serialiser"></tg-serialiser>
        <core-ajax id="actionExecutor" url="/entity/{{entitytype}}/new" method="POST" handleas="json"></core-ajax>
    </template>
    <script>
        Polymer('tg-functional-action', {
            publish: {
            	entitytype: null,

                /**
                 * The function to be invoked before the action starts execution (UI actions and FE creation).
                 *
                 * returns -- created functional entity instance.
                 */
                preAction: null,

                /**
                 * The function to be invoked after successful action execution (function(entity)).
                 */
                postActionSuccess: null,

                /**
                 * The function to be invoked after unsuccessful action execution (function(resultWithError)).
                 */
                postActionError: null,
            },

            /**
             * Initialisation block.
             */
            ready: function () {
                var self = this;
                self.super();

                self.$.actionExecutor.addEventListener('core-response', function (e) {
                    if (e.detail.xhr.status === 200) {
                        self._onExecuted(self.$.serialiser.deserialise(e.detail.response));
                    }
                });
            },            

            /**
             * Executes the action.
             */
            run: function() {
            	this.super();

                var functionalEntity = this.preAction();

                var ser = this.$.serialiser.serialise(functionalEntity);
                this.$.actionExecutor.body = JSON.stringify(ser);
                this.$.actionExecutor.generateRequest();
            },

            /**
             * Analyzes and processes the result of executor response.
             */
            _onExecuted: function(result) {
                var savedFunctionalEntity = result.instance;
                if (this.$.reflector.isError(result)) {
                  	this.postActionError(result);
                } else {
                  	this.postActionSuccess(savedFunctionalEntity);
                }

                this._afterExecution();
            },
        });
    </script>
</polymer-element>