<link rel="import" href="/resources/polymer/polymer/polymer.html">

<link rel="import" href="/tg-reflector">
<link rel="import" href="/resources/serialisation/tg-serialiser.html">
<link rel="import" href="/resources/polymer/core-icon-button/core-icon-button.html">
<link rel="import" href="/resources/polymer/paper-dialog/paper-action-dialog.html">
<link rel="import" href="/resources/element_loader/load-element.html">
<link rel="import" href="/resources/polymer/paper-button/paper-button.html">
<link rel="import" href="/resources/components/postal-lib.html">

<polymer-element name="tg-page-action" attributes="icon action"> <!-- enabledStates currentState  -->
    <template>
        <core-icon-button id="actionButton" icon="{{icon}}" on-tap="{{run}}"></core-icon-button> <!-- disabled?="{{!isEnabled(enabledStates, currentState, enabled)}}" -->
    </template>
    <script>
        Polymer({
            publish: {

            	// /**
                //  * A list of the states in which the action can be enabled.
                //  */
                // enabledStates: null,

                // /**
                //  * The state of the parent view.
                //  */
                // currentState: null,

                /**
                 * The icon specificator (string id).
                 */
                icon: null
            },

            /**
             * This inner state is triggered by the action itself after the action button has been pressed (enabled:=false) and after the action
             * has been executed (enabled:=true).
             */
            // enabled: true,

            /**
             * Initialisation block.
             */
            ready: function () {
                var self = this;

                self.run = self.run.bind(self);
            },

            // /**
            //  * Returns whether the action is enabled in current moment.
            //  */
            // isEnabled: function (enabledStates, currentState, enabled) {
            //     if (enabledStates) {
            //         // console.log("isEnabled successful: enabledStates == ", enabledStates, "currentState == ", currentState, "enabled == ", enabled);
            //         return enabledStates.indexOf(currentState) >= 0 && enabled;
            //     } else {
            //         console.warn("isEnabled: enabledStates is not ready at this stage! enabledStates == ", enabledStates);
            //         return false;
            //     }
            // },

            /**
             * Executes the action.
             *
             * Please override this method in descendands to implement specific execution logic.
             */
            run: function () {
                // this.enabled = false;
                console.log(this.shortDesc + ": execute");

                // TODO var context = ...;
                // var ser = this.$.serialiser.serialise(context);
                // this.$.actionExecutor.body = JSON.stringify(ser);
                this.action();
            },

            /**
             * The function that is invoked after the action has completed (error or success).
             */
            afterExecution: function () {
                console.log(this.shortDesc + ": after execution");
                // this.enabled = true;
            },

            /**
             * Analyzes and processes the result of executor response.
             */
            _onExecuted: function(e, detail, source) {
            	console.log("_onExecuted: e", e, "egi", e.srcElement);
            	this.$.entityMaster.open();

            	// detail.entityid = 15; // e.srcElement.$.egi.getSelectedEntities()[0].id;

            	// getSelectedEntities

            	detail.onRetrieved = function(entity, bindingEntity, customObject) {
                    console.log("onRetrieved");
                };

                detail.onValidated = function(validatedEntity, bindingEntity, customObject) {
                    console.log("onValidated");
                };

                detail.onSaved = function(potentiallySavedEntity, newBindingEntity) {
                    console.log("onSaved");
                };

                detail.entityid = this.contextRetriever().id;
            	detail.retrieve();
            	console.log('_onExecuted: uiComponent', detail);
            	// TODO insert into DOM uiComponent
	           	// TODO insert into DOM uiComponent
            	// TODO insert into DOM uiComponent
       	        // TODO insert into DOM uiComponent

                this.afterExecution();
//                this.$.entityMaster.updateTargetDimensions();
            },
        });
    </script>
</polymer-element>