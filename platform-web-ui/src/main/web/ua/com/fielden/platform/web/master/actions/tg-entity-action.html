<link rel="import" href="/resources/polymer/polymer/polymer.html">

<link rel="import" href="/tg-reflector">
<link rel="import" href="/resources/serialisation/tg-serialiser.html">
<link rel="import" href="/resources/polymer/core-ajax/core-ajax.html">
<link rel="import" href="/resources/polymer/paper-button/paper-button.html">

<polymer-element name="tg-entity-action" attributes="user entitytype preAction postActionSuccess postActionError enabledStates shortDesc longDesc icon">
    <template>
        <tg-reflector id="reflector"></tg-reflector>
        <tg-serialiser id="serialiser"></tg-serialiser>
        <core-ajax id="actionExecutor" url="/users/{{user}}/entity/{{entitytype}}/new" method="POST" handleas="json"></core-ajax>

        <paper-button id="actionButton" raised roll="button" on-tap="{{run}}" disabled?="{{!enabled}}">{{shortDesc}}</paper-button> 
    </template>
    <script>
        Polymer('tg-entity-action', {
            publish: {
            	user: null,
            	entitytype: null,
                /**
                 * The function to be invoked before the action starts execution (UI actions and FE creation).
                 *
                 * returns -- created functional entity instance.
                 */
                preAction: null,

                /**
                 * The function to be invoked after successful action execution (function(entity)).
                 */
                postActionSuccess: null,

                /**
                 * The function to be invoked after unsuccessful action execution (function(resultWithError)).
                 */
                postActionError: null,

                /**
                 * A list of the states in which the action can be enabled.
                 */
                enabledStates: null,

                /**
                 * Short description for the action (for instance can be used as button title).
                 */
                shortDesc: null,

                /**
                 * Long description for the action.
                 */
                longDesc: null,

                /**
                 * The icon specificator (string id).
                 */
                icon: null
            },

            /**
                 * TODO TODO TODO TODO TODO TODO TODO TODO TODO 
                 * TODO TODO TODO TODO TODO TODO TODO TODO TODO 
                 * TODO TODO TODO TODO TODO TODO TODO TODO TODO 
                 * TODO TODO TODO TODO TODO TODO TODO TODO TODO 
                 * TODO TODO TODO TODO TODO TODO TODO TODO TODO 
                 * TODO TODO TODO TODO TODO TODO TODO TODO TODO 
                 * TODO TODO TODO TODO TODO TODO TODO TODO TODO 
                 * TODO TODO TODO TODO TODO TODO TODO TODO TODO 
                 */
            enabled: true,

            /**
             * Executes the action.
             */
            run: function() {
            	this.enabled = false;
            	var functionalEntity = this.preAction();

                var ser = this.$.serialiser.serialise(functionalEntity);
	            this.$.actionExecutor.body = JSON.stringify(ser);
            	this.$.actionExecutor.go();
            },

            /**
             * Analyzes and processes the result of executor response.
             */
            _onExecuted: function(result) {
                var savedFunctionalEntity = result.instance;
                if (this.$.reflector.isError(result)) {
                	this.postActionError(result);
                } else {
                	this.postActionSuccess(savedFunctionalEntity);
                }
                this.enabled = true;
            },

            ready: function () {
                console.log("ready");
                var self = this;

                self.$.actionExecutor.addEventListener('core-response', function (e) {
                    if (e.detail.xhr.status === 200) {
                        self._onExecuted(self.$.serialiser.deserialise(e.detail.response));
                    }
                });
            }
        });
    </script>
</polymer-element>