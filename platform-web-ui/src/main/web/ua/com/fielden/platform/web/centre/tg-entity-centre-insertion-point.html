<link rel="import" href="/app/tg-element-loader.html">
<link rel="import" href="/resources/polymer/polymer/polymer.html">
<link rel="import" href="/resources/polymer/iron-icons/iron-icons.html">
<link rel="import" href="/resources/polymer/iron-resizable-behavior/iron-resizable-behavior.html">

<link rel="import" href="/resources/images/tg-icons.html">
<link rel="import" href="/resources/components/postal-lib.html">
<link rel="import" href="/resources/components/tg-toast.html">
<link rel="import" href="/resources/components/tg-tooltip-behavior.html">

<link rel="import" href="/resources/polymer/paper-styles/color.html">
<link rel="import" href="/resources/polymer/paper-styles/paper-styles-classes.html">
<link rel="import" href="/resources/polymer/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/resources/polymer/paper-material/paper-material.html">
<link rel="import" href="/resources/polymer/paper-dialog/paper-dialog.html">

<link rel="import" href="/resources/polymer/neon-animation/animations/fade-in-animation.html">
<link rel="import" href="/resources/polymer/neon-animation/animations/fade-out-animation.html">

<dom-module id="tg-entity-centre-insertion-point">
    <template>
        <style>
            .truncate {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .title-bar {
                padding: 0 16px;
                height: 44px;
                min-height: 44px;
                font-size: 18px;
                cursor: default;
                color: white;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                background-color: var(--paper-light-blue-600);
            }
            .title-text {
                pointer-events: none;
            }
            paper-icon-button {
                width: 22px;
                height: 22px;
                padding: 0px;
            }
            paper-icon-button.expand-colapse-button {
                stroke: var(--paper-grey-100);
                fill: var(--paper-grey-100);
                color: var(--paper-grey-100);
            }
            paper-icon-button.expand-colapse-button:hover {
                stroke: var(--paper-grey-300);
                fill: var(--paper-grey-300);
                color: var(--paper-grey-300);
            }
        </style>
        <paper-material id="pm" hidden$="[[detached]]" class="layout vertical" style="background: white; border-radius: 2px; margin: 10px;">
            <div id="insertionPointContent" class="layout vertical flex">
                <div class="title-bar layout horizontal justified center" hidden$="[[!hasTitleBar]]">
                    <span class="title-text truncate" tooltip-text$="[[longDesc]]">[[shortDesc]]</span>
                    <paper-icon-button class="expand-colapse-button" style="margin-left:10px" icon="[[_getButtonIcon(detached)]]" on-tap="_expandColapseTap"></paper-icon-button>
                </div>
                <div class="relative flex">
                    <tg-element-loader id="elementLoader"></tg-element-loader>
                </div>
            </div>
        </paper-material>
        <tg-toast id="toaster"></tg-toast>
    </template>
</dom-module>
<script>
    (function () {
        Polymer({

            is: "tg-entity-centre-insertion-point",

            behaviors: [Polymer.IronResizableBehavior, Polymer.TgBehaviors.TgTooltipBehavior],

            listeners: {
                'iron-resize': '_onIronResize'
            },

            properties: {
                activated: {
                    type: Boolean,
                    value: false
                },
                /**
                 * Determnes whether insertion point is in the detached mode or not.
                 */
                detached: {
                    type: Boolean,
                    value: false
                },
                /**
                 * Determines whether insertion point has title bar or not.
                 */
                hasTitleBar: {
                    type: Boolean,
                    value: false
                },
                /**
                 * The title for insertion point
                 */
                shortDesc: String,
                /**
                 * The explanation description for insertion point
                 */
                longDesc: String,
                /**
                 * The entities retrieved when running centre that has this insertion point
                 */
                retrievedEntities: {
                    type: Array,
                    observer: '_updateElementWithRetrievedEntities',
                    notify: true
                },
                /**
                 * Summary entity retrieved when running centre that has this insertion point.
                 */
                retrievedTotals: {
                    type: Object,
                    observer: '_updateElementWithRetrievedTotals',
                    notify: true
                },
                _element: {
                    type: Object,
                    value: null
                },
                /**
                 * The dialog for detached insertion point.
                 */
                _dialog: Object
            },

            /**
             * Creates dynamically the 'dom-bind' template, which hold the dialog for the calendar.
             */
            _createDialog: function () {
                var dialog = document.createElement('paper-dialog');
                dialog.addEventListener("iron-overlay-closed", this._dialogClosed.bind(this));
                dialog.autoFitOnAttach = true;
                dialog.entryAnimation = "fade-in-animation";
                dialog.exitAnimation = "fade-out-animation";
                return dialog;
            },

            _showDialog: function () {
                if (!this._dialog) {
                    this._dialog = this._createDialog();
                }
                if (!this._dialog.opened) {
                    this.detached = true;
                    Polymer.dom(document.body).appendChild(this._dialog);
                    Polymer.dom(this._dialog).appendChild(this.$.insertionPointContent);
                    Polymer.dom.flush();
                    this._dialog.open();
                }
            },

            _closeDialog: function () {},

            _dialogClosed: function (event) {
                Polymer.dom(document.body).removeChild(this._dialog);
                Polymer.dom(this.$.pm).appendChild(this.$.insertionPointContent);
                Polymer.dom.flush();
                this.detached = false;
            },

            _getElement: function (customAction) {
                var self = this;
                if (self._element) {
                    return Promise.resolve(self._element);
                } else {
                    self.$.elementLoader.import = customAction.componentUri;
                    self.$.elementLoader.elementName = customAction.elementName;
                    self.$.elementLoader.attrs = customAction.attrs;
                    return self.$.elementLoader.reload();
                }
            },

            _updateElementWithRetrievedEntities: function (newValue, oldValue) {
                if (this._element) {
                    this._element.retrievedEntities = newValue;
                }
            },

            _updateElementWithRetrievedTotals: function (newValue, oldValue) {
                if (this._element) {
                    this._element.retrievedTotals = newValue;
                }
            },

            /**
             * customAction -- an action that was actioned by user and may require showing a diglog (e.g. with master)
             */
            activate: function (customAction) {
                var self = this;
                if (this.activated === true) {
                    return self._getElement(customAction)
                        .then(function (element) {
                            return customAction._onExecuted(null, element, null).then(function () {
                                customAction.restoreActiveElement();
                            });
                        });
                } else { // else need to first load and create the element to be inserted
                    self._getElement(customAction)
                        .then(function (element) {
                            self.activated = true;
                            self._element = element;
                            self._element.addEventListener("retrieved-entities-changed", function (ev) {
                                self.retrievedEntities = this.retrievedEntities;
                            });
                            self._element.retrievedEntities = self.retrievedEntities;
                            self._element.addEventListener("retrieved-totals-changed", function (ev) {
                                self.retrievedTotals = this.retrievedTotals;
                            });
                            self._element.retrievedTotals = self.retrievedTotals;

                            var promise = customAction._onExecuted(null, element, null);
                            if (promise) {
                                return promise
                                    .then(function () {
                                        self._adjustView();
                                        customAction.restoreActiveElement();
                                    });
                            } else {
                                return Promise.resolve()
                                    .then(function () {
                                        self._adjustView();
                                        customAction.restoreActiveElement();
                                    });
                            }
                        })
                        .catch(function (error) {
                            self.$.toaster.text = 'There was an error displaying view ' + customAction.elementName;
                            self.$.toaster.hasMore = true;
                            self.$.toaster.msgText = 'There was an error displaying the view.<br><br> \
                                                      <b>Error cause:</b><br>' + error.message;
                            self.$.toaster.showProgress = false;
                            self.$.toaster.show();
                        });
                }
            },

            _adjustView: function () {
                var self = this;

                if (this.$.elementLoader.prefDim) {
                    var prefDim = this.$.elementLoader.prefDim;
                    this.$.pm.style.width = prefDim.width() + prefDim.widthUnit;
                    this.$.pm.style.height = "calc(" + prefDim.height() + prefDim.heightUnit + " + 44px)";
                } else {
                    this.$.pm.width = "auto";
                    this.$.pm.height = "auto";
                }
                this.updateStyles();
            },

            _onIronResize: function () {
                this._adjustView();
            },

            _getButtonIcon: function (detached) {
                if (detached) {
                    return "icons:cancel";
                }
                return "icons:open-in-new";
            },

            _expandColapseTap: function (event) {
                if (this.detached) {
                    this._createDialog();
                } else {
                    this._showDialog();
                }
            }
        });
    })();
</script>