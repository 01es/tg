<!doctype html>
<html>

<head>
    <title>entity-master</title>

    <script src="/resources/polymer/webcomponentsjs/webcomponents.js"></script>
    <link rel="import" href="/resources/polymer/polymer-test-tools/tools.html">
    <script src="/resources/polymer/polymer-test-tools/htmltest.js"></script>

    <link rel="import" href="/resources/master/tg-entity-master.html">
    <link rel="import" href="/tg-reflector">
</head>

<body unresolved>
    <tg-reflector id="reflector"></tg-reflector>
    <tg-entity-master id="master" user="SU" entitytype="ua.com.fielden.platform.sample.domain.TgPersistentEntityWithInteger" entityid="5"></tg-entity-master>

    <script>
        document.addEventListener('polymer-ready', function() {
            var master = document.querySelector('#master');
            var reflector = document.querySelector('#reflector');
            var findProp = function(entity, propName) {
                return entity.constructor.prototype.prop.call(entity, propName);
                // return entity.prop(propName); -- this is problem for this test because the field name 'prop' equals to prototype function 'prop'
            };
            var self = this;

            master.onValidated = function(validatedEntity, bindingEntity) {                
                console.log("validatedEntity", validatedEntity);
                // properties:
                assert.ok(validatedEntity.get("entityProp"), "The entity response property should be initialised.");                
                assert.instanceOf(validatedEntity.get("entityProp"), reflector.getEntityType(), "The entity response property should be entity instance.");

                assert.strictEqual(validatedEntity.get("entityProp").get("key"), "KEY1", "The entity response property should be entity instance with appropriate key.");
                assert.strictEqual(bindingEntity.get("entityProp"), "KEY1", "The bindingEntity property should be string entity representation.");

                // instance meta-properties
                assert.ok(findProp(validatedEntity, "entityProp"), "The entity response instance prop should be initialised.");
                assert.strictEqual(findProp(validatedEntity, "entityProp").isChangedFromOriginal(), true, "The entity response instance prop should be changedFromOriginal.");
                assert.strictEqual(findProp(validatedEntity, "entityProp").validationResult(), null, "The entity response instance prop should have empty (successful) validation result.");
                // assert.strictEqual(findProp(validatedEntity, "entityProp").isRequired(), false, "The entity response instance prop should be not required.");
                // assert.strictEqual(findProp(validatedEntity, "entityProp").isEditable(), true, "The entity response instance prop should be editable.");
                // assert.strictEqual(findProp(validatedEntity, "entityProp").isVisible(), true, "The entity response instance prop should be visible.");

                done();
            };

            master.onRetrieved = function(entity, bindingEntity) {
                assert.strictEqual(findProp(entity, "entityProp").isChangedFromOriginal(), false, "The entity instance prop should be not changedFromOriginal.");

                bindingEntity.set("entityProp", "KEY1");

                master.validate(); 
            };

            master.retrieve();
        });
    </script>

</body>

</html>
