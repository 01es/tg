<!doctype html>
<html>

<head>
    <title>TG Example</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="/resources/polymer/webcomponentsjs/webcomponents.js"></script>

    <link rel="import" href="/resources/polymer/core-toolbar/core-toolbar.html">
    <link rel="import" href="/resources/polymer/core-menu/core-menu.html">
    <link rel="import" href="/resources/polymer/core-scaffold/core-scaffold.html">
    <link rel="import" href="/resources/polymer/core-item/core-item.html">
    <link rel="import" href="/resources/polymer/paper-button/paper-button.html">
    <link rel="import" href="/resources/polymer/font-roboto/roboto.html">
    <link rel="import" href="/resources/centre/tg-entity-centre-for-TgPersistentEntityWithProperties.html">
    <link rel="import" href="/resources/polymer/flatiron-director/flatiron-director.html">
    <link rel="import" href="/resources/polymer/core-animated-pages/core-animated-pages.html">
    <link rel="import" href="/resources/polymer/core-animated-pages/transitions/slide-from-right.html">
    <link rel="import" href="/resources/app/tg-view-manager.html">
    <link rel="import" href="/resources/element_loader/load-element.html">
    <link rel="import" href="/resources/components/postal-lib.html">

    <style>
        body {
            font-family: "RobotoDraft";
            font-size: 10pt;
        }
        core-animated-pages {
            width: 100%;
            height: 100%;
            -webkit-user-select: none;
            overflow: hidden;
        }
        core-animated-pages > * {
            background-color: white;
        }
        core-toolbar {
            background-color: #0288D1;
            color: #fff;
        }
        ::shadow core-toolbar {
            background-color: #0288D1;
            color: #fff;
        }
    </style>

</head>

<body unresolved fullbleed>
    <template id="centre_example" is="auto-binding">
        <flatiron-director route="{{route}}" autohash></flatiron-director>
        <tg-reflector id="reflector"></tg-reflector>
        <tg-view-manager user="SU"></tg-view-manager>
        <core-scaffold id="scaffold" responsiveWidth="767px">

            <nav>
                <core-toolbar>
                    <span>TG Example</span>
                </core-toolbar>
                <core-menu selected="{{route}}" valueattr="hash" on-core-select="{{onMenuItemSelected}}">
                    <core-item hash="centre" label="Entity Centre"></core-item>
                    <template repeat="{{master in masters}}">
                        <core-item hash="{{master.hash}}" label="{{master.label}}"></core-item>
                    </template>
                </core-menu>
            </nav>

            <core-toolbar style="font-size: 20px;" tool>
                <div>{{route === 'centre' ? 'Entity Centre' : 'Entity master'}}</div>
            </core-toolbar>

            <div layout horizontal fit>
                <core-animated-pages selected="{{route}}" valueattr="hash" transitions="slide-from-right">
                    <div hash="centre">
                        <tg-entity-centre-for-TgPersistentEntityWithProperties id="centre" user="SU"></tg-entity-centre-for-TgPersistentEntityWithProperties>
                    </div>
                    <template repeat="{{master in masters}}">
                        <div hash="{{master.hash}}">
                            <load-element id="{{master.hash}}" import="{{master.componentUri}}" elementName="{{master.elementName}}" attrs="{{master.attrs}}" on-after-load="{{onMasterLoaded}}" auto></load-element>
                        </div>
                    </template>
                </core-animated-pages>
            </div>

        </core-scaffold>

    </template>



    <script>
        (function () {
            var centreExample = document.querySelector("#centre_example");

            centreExample.masters = [];


            //            centreExample.componentUri = "/users/{{user}}/master/ua.com.fielden.platform.sample.domain.TgPersistentEntityWithProperties";
            //            centreExample.elementName = "tg-TgPersistentEntityWithProperties-master";
            //            centreExample.attrs = {
            //                user: 'SU',
            //                entitytype: 'ua.com.fielden.platform.sample.domain.TgPersistentEntityWithProperties',
            //                currentState: 'VIEW'
            //            };

            centreExample.onMenuItemSelected = function (event, detail, source) {
                if (detail.isSelected) {
                    document.querySelector("#scaffold").closeDrawer();
                }
            }

            centreExample.onMasterLoaded = function (e, detail, source) {

                console.log("----------onMasterLoaded", e, detail, source);

                detail.onRetrieved = function (entity, bindingEntity, customObject) {
                    postal.publish({
                        channel: "view",
                        topic: "master.created",
                        data: {
                            entityid: entity.id,
                            centreUuid: detail.centreUuid,
                            masterUuid: detail.uuid
                        }
                    });

                    centreExample.route = source.getAttribute("id");
                };

                detail.onValidated = function (validatedEntity, bindingEntity, customObject) {

                };

                detail.onSaved = function (potentiallySavedEntity, newBindingEntity) {
                    //                    var self = this;
                    //                    postal.publish({
                    //                        channel: "master-" + self.uuid,
                    //                        topic: "save",
                    //                        data: {
                    //                            id: potentiallySavedEntity.id
                    //                        }
                    //                    });
                };

                detail.retrieve();
            };

            centreExample.addEventListener('template-bound', function (e) {
                centreExample.route = centreExample.route || "centre";
                document.querySelector("#centre").retrieve();
                document.querySelector("#scaffold").$.drawerPanel.forceNarrow = true;

                postal.subscribe({
                    channel: "manager",
                    topic: "master.create",
                    callback: function (data, envelope) {
                        var uuid = document.querySelector("#reflector").generateUUID();
                        data.hash = "master_" + uuid;
                        data.label = "Master for " + data.attrs.entityid;
                        data.attrs.uuid = uuid;
                        centreExample.masters.push(data);
                    }
                });
                
                 postal.subscribe({
                    channel: "manager",
                    topic: "master.show",
                    callback: function (data, envelope) {
                        centreExample.route = "master_" + data.uuid;
                        postal.publish({
                        channel: "view",
                        topic: "master.shown",
                        data: {
                            centreUuid: detail.centreUuid,
                            masterUuid: detail.uuid
                        }
                    });
                    }
                });

                //                postal.subscribe({
                //                    channel: "centre",
                //                    topic: "new",
                //                    callback: function (data, envelope) {
                //                        var masterLoader = document.querySelector("#master");
                //                        centreExample.attrs.entityid = "new";
                //                        masterLoader.reload();
                //                    }
                //                });
            });
        })();
    </script>

</body>

</html>
