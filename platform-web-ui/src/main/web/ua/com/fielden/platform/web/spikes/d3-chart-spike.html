<link rel="import" href="/resources/polymer/polymer/polymer.html">

<link rel="import" href="/resources/polymer/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="/resources/polymer/iron-resizable-behavior/iron-resizable-behavior.html">

<link rel="import" href="/resources/components/d3-lib.html">

<dom-module id="d3-chart-spike">

    <template>
        <style>
            :host {
                @apply(--layout-vertical);

            }
            svg {
                @apply(--layout-flex);

            }
            .bar {
                fill: steelblue;
            }
            .bar:hover {
                fill: brown;
            }
            .axis--x path {
                display: none;
            }
        </style>

        <!-- local DOM for your element -->

        <svg id="chart" class="bar-chart"></svg>
        <!-- data bindings in local DOM -->
    </template>

    <script>
        // element registration
        Polymer({
            is: "d3-chart-spike",

            // add properties and methods on the element's prototype

            properties: {
                // declare properties for the element's public API
                data: Array,

                _readyToDraw: Boolean
            },

            behaviors: [Polymer.IronResizableBehavior],

            observers: ["_drawChart(data, _readyToDraw)"],

            ready: function () {
                this.scopeSubtree(this.$.chart, true);
                this.addEventListener("iron-resize", this._resizeEventListener.bind(this));
            },

            attached: function () {
                this._waitForDimensions(0);
            },

            _waitForDimensions: function (time) {
                this.async(function () {
                    if (this.offsetWidth && this.offsetHeight) {
                        this._readyToDraw = true;
                    } else {
                        this._waitForDimensions(100);
                    }
                }, time);
            },

            _drawChart: function () {
                this.$.chart.innerHTML = "";
                var svg = d3.select(this.$.chart);
                var margin = {
                    top: 20,
                    right: 20,
                    bottom: 30,
                    left: 40
                };
                var width = this.offsetWidth - margin.left - margin.right;
                var height = this.offsetHeight - margin.top - margin.bottom;

                var x = d3.scaleBand()
                    .rangeRound([0, width])
                    .padding(0.1)
                    .domain(this.data.map(function (d) {
                        return d.name;
                    }.bind(this)));

                var y = d3.scaleLinear()
                    .range([height, 0])
                    .domain([0, d3.max(this.data, function (d) {
                        return d.value;
                    }.bind(this))]);

                var g = svg.append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                var yAxis = d3.axisLeft(y).ticks(10, "%");

                var chart = d3.select(this.$.chart);

                g.append("g")
                    .attr("class", "axis axis--x")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x));

                g.append("g")
                    .attr("class", "axis axis--y")
                    .call(d3.axisLeft(y).ticks(10, "%"))
                    .append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 6)
                    .attr("dy", ".71em")
                    .style("text-anchor", "end")
                    .text("Frequency");

                g.selectAll(".bar")
                    .data(this.data)
                    .enter().append("rect")
                    .attr("class", "bar")
                    .attr("x", function (d) {
                        return x(d.name);
                    }.bind(this))
                    .attr("y", function (d) {
                        return y(d.value);
                    }.bind(this))
                    .attr("height", function (d) {
                        return height - y(d.value);
                    }.bind(this))
                    .attr("width", x.bandwidth());
            },

            _resizeEventListener: function (event, details) {
                this._drawChart();
            }
        });
    </script>

</dom-module>