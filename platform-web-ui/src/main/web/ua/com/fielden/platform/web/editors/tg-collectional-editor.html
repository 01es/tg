<link rel="import" href="/resources/polymer/polymer/polymer.html">

<link rel="import" href="/resources/editors/tg-editor-behavior.html">
<link rel="import" href="/resources/editors/tg-editor.html">

<dom-module id="tg-collectional-editor">
    <style>
    </style>

    <template>
    	<tg-editor 
    		id="editorDom" 
    		prop-title="[[propTitle]]"
    		_disabled="[[_disabled]]" 
    		_editing-value="{{_editingValue}}" 
    		action="[[action]]" 
    		_error="[[_error]]" 
    		_comm-value="[[_commValue]]" 
    		_accepted-value="[[_acceptedValue]]" 
    		debug="[[debug]]" 
    		_on-change="[[_onChange]]"
    		_on-input="[[_onInput]]"
    		_on-keydown="[[_onKeydown]]"
        	current-state="[[currentState]]"
        	entities="[[_entities]]"
        	selected-entities="[[_selectedEntities]]">
        	<content class=".property-action"></content>
    	</tg-editor>
    </template>
</dom-module>

<script>
    Polymer({
    	is: 'tg-collectional-editor',
    	behaviors: [ Polymer.TgBehaviors.TgEditorBehavior ],
    	
    	properties: {
    	    /**
    	     * TODO docs
    	     */
    	    chosenIdsPropertyName: {
    	        type: String
    	    },
    	    /**
    	     * TODO docs
    	     */
    	    addedIdsPropertyName: {
    	        type: String
    	    },
    	    /**
    	     * TODO docs
    	     */
    	    removedIdsPropertyName: {
    	        type: String
    	    },
    	    
    	    _entities: Array,
    	    _selectedEntities: Array
    	},
    	
    	ready: function () {
    		this.$.editorDom._editorKind = "COLLECTIONAL";
    		
    		// this._entities = [ { key: 'KEY1' }, { key: 'KEY2' } ];
    		// this._selectedEntities = [ { key: 'KEY2' } ];
    	},
    	
        /**
         * This method promotes 'IRRELEVANT' into _editingValue which should not be a problem, since this 'editor' edits entity property (with name 'chosenNumbersPropertyName') directly.
         */
        convertToString: function (value) {
            this._entities = value;
            
            var selEntities = [];
            var chosenIds = this.entity.get(this.chosenIdsPropertyName);
            
            for (var index = 0; index < chosenIds.length; index++) {
                selEntities.push(this._find(this._entities, chosenIds[index]) );
            }
            
            console.log('SELECTED ENTITIES', selEntities);
            this._selectedEntities = selEntities;
            
            return 'IRRELEVANT';
        },
        
        _find: function (entities, id) {
            for (var i = 0; i < entities.length; i++) {
                if (id === entities[i].id) {
                    return entities[i];
                }
            }
            throw 'The entity with id ' + id + ' does not exist in entities list ' + entities;
        },

        /**
         * This method promotes 'IRRELEVANT' into _acceptedValue which should not be a problem, since this 'representor' is not editable at all.
         */
        convertFromString: function (strValue) {
            this.entity.set(this.chosenIdsPropertyName, [ 2 ] );
            this.entity.set(this.addedIdsPropertyName, [] );
            this.entity.set(this.removedIdsPropertyName, [ 2 ] );
            this.entity.set(this.propertyName, null);
            
            return 'IRRELEVANT';
        }
    });
</script>