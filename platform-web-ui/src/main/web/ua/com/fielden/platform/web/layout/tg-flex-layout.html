<link rel="import" href="/resources/polymer/polymer/polymer.html">
<link rel="import" href="/resources/polymer/core-media-query/core-media-query.html">
<link rel="import" href="/tg-web-app/tg-app-config.html">

<polymer-element name="tg-flex-layout" attributes="whenDesktop whenTablet whenMobile debug">
    <template>
        <content select=":not(text):not(template)" id="elements"></content>
        <tg-app-config id="appConfig"></tg-app-config>
        <core-media-query query="max-width: {{$.appConfig.minTabletWidth - 1}}px" querymatches="{{mobileScreen}}" on-core-media-change="{{handleMobileScreen}}"></core-media-query>
        <core-media-query query="(min-width: {{$.appConfig.minTabletWidth}}px) and (max-width: {{$.appConfig.minDesktopWidth - 1}}px)" querymatches="{{tabletScreen}}" on-core-media-change="{{handleTabletScreen}}"></core-media-query>
        <core-media-query query="min-width: {{$.appConfig.minDesktopWidth}}px" querymatches="{{desktopScreen}}" on-core-media-change="{{handleDesktopScreen}}"></core-media-query>
    </template>
    <script>
        (function () {
            'use strict'
            var setLayout = function (layout) {
                    var contentIndex = 0;
                    if (!Array.isArray(layout)) {
                        throw "The layout must be an array";
                    } 
                    if (this.container) {
                        while (this.container.firstChild) {
                            this.container.removeChild(this.container.firstChild);
                        }
                        removeStylesAndAttributes(this.container);
                        this.container.setAttribute("layout", "");
                        this.container.setAttribute("vertical", "");
                        if (this.debug) {
                            setDebugStyle(this.container);
                        } else {
                            removeDebugStyle(this.container);
                        }
                        layout.forEach((function (layoutElem) {
                            contentIndex = createFlexCell.bind(this)(this.container, layoutElem, contentIndex, true);
                        }).bind(this));
                        this.fire('layout-finished', layout);
                    }
                },
                setDebugStyle = function(element) {
                    element.style.border = "1px dashed red";
                },
                removeDebugStyle = function(element) {
                     element.style.removeProperty("border");
                },
                removeStylesAndAttributes = function (element) {
                    if (element.stylesToRemove) {
                        element.stylesToRemove.forEach(function (style) {
                            element.style.removeProperty(style);
                        });
                        delete element.stylesToRemove;
                    }
                    if (element.attributesToRemove) {
                        element.attributesToRemove.forEach(function (attribute) {
                            element.removeAttribute(attribute);
                        });
                        delete element.attributesToRemove;
                    }
                },
                createFlexCell = function (container, layoutElem, contentIndex, horizontal) {
                    var rowElement, styleValues, trimmedLayoutElement;
                    if (typeof layoutElem === "string") {
                        trimmedLayoutElement = layoutElem.trim();
                        if (layoutElem.indexOf(':') >= 0) {
                            styleValues = layoutElem.split(":");
                            container.style[styleValues[0].trim()] = styleValues[1].trim();
                            container.stylesToRemove = container.stylesToRemove || [];
                            container.stylesToRemove.push(styleValues[0].trim());
                        } else {
                            container.attributesToRemove = container.attributesToRemove || [];
                            container.attributesToRemove.push(trimmedLayoutElement);
                            if (trimmedLayoutElement === "horizontal" || trimmedLayoutElement === "vertical") {
                                container.removeAttribute(horizontal ? "vertical" : "horizontal");
                            }
                            container.setAttribute(trimmedLayoutElement, "");
                        }
                    } else if (Array.isArray(layoutElem)) {
                        if (!hasArray(layoutElem)) {
                            rowElement = this.componentsToLayout[contentIndex];
                            removeStylesAndAttributes(rowElement);
                            contentIndex += 1;
                        } else {
                            rowElement = document.createElement("div");
                            rowElement.setAttribute("layout", "");
                            if (layoutElem.indexOf("horizontal") < 0 && layoutElem.indexOf("vertical") < 0) {
                                rowElement.setAttribute(horizontal ? "horizontal" : "vertical", "");
                            }
                        }
                        if (this.debug) {
                            setDebugStyle(rowElement);
                        } else {
                            removeDebugStyle(rowElement);
                        }
                        layoutElem.forEach((function (columnLayout) {
                            contentIndex = createFlexCell.bind(this)(rowElement, columnLayout, contentIndex, !horizontal);
                        }).bind(this));
                        container.appendChild(rowElement);
                    }
                    return contentIndex;
                },
                hasArray = function (layoutElem) {
                    var elemIndex;
                    for (elemIndex = 0; elemIndex < layoutElem.length; elemIndex++) {
                        if (Array.isArray(layoutElem[elemIndex])) {
                            return true;
                        }
                    }
                    return false;
                };
            Polymer({
                publish: {
                    debug: {
                        value: false,
                        reflect: true
                    }
                },
                domReady: function () {
                    this.componentsToLayout = [];
                    Array.prototype.forEach.call(this.$.elements.getDistributedNodes(), function (item) {
                        this.componentsToLayout.push(item);
                    }.bind(this));
                    if (this.componentsToLayout.length > 0) {
                        this.container = this.componentsToLayout[0].parentElement;
                    }
                },
                handleMobileScreen: function (e) {
                    if (e.detail.matches && this.whenMobile) {
                        setLayout.bind(this)(this.whenMobile);
                    }
                },
                handleTabletScreen: function (e) {
                    if (e.detail.matches && this.whenTablet) {
                        setLayout.bind(this)(this.whenTablet);
                    }
                },
                handleDesktopScreen: function (e) {
                    if (e.detail.matches && this.whenDesktop) {
                        setLayout.bind(this)(this.whenDesktop);
                    }
                },
                whenMobileChanged: function (oldValue, newValue) {
                    if (this.mobileScreen && this.whenMobile) {
                        setLayout.bind(this)(this.whenMobile);
                    }
                },
                whenTabletChanged: function (oldValue, newValue) {
                    if (this.tabletScreen && this.whenTablet) {
                        setLayout.bind(this)(this.whenTablet);
                    }
                },
                whenDesktopChanged: function (oldValue, newValue) {
                    if (this.desktopScreen && this.whenDesktop) {
                        setLayout.bind(this)(this.whenDesktop);
                    }
                }
            });
        })();
    </script>
</polymer-element>