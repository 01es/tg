<!doctype html>
<html>

<head>
    <title>TG Example</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="/resources/polymer/webcomponentsjs/webcomponents.js"></script>

    <link rel="import" href="/resources/polymer/core-toolbar/core-toolbar.html">
    <link rel="import" href="/resources/polymer/core-menu/core-menu.html">
    <link rel="import" href="/resources/polymer/core-scaffold/core-scaffold.html">
    <link rel="import" href="/resources/polymer/paper-item/paper-item.html">
    <link rel="import" href="/resources/polymer/paper-button/paper-button.html">
    <link rel="import" href="/resources/polymer/font-roboto/roboto.html">
    <link rel="import" href="/resources/centre/tg-entity-centre-for-TgPersistentEntityWithProperties.html">
    <link rel="import" href="/resources/polymer/flatiron-director/flatiron-director.html">
    <link rel="import" href="/resources/polymer/core-animated-pages/core-animated-pages.html">
    <link rel="import" href="/resources/polymer/core-animated-pages/transitions/slide-from-right.html">
    <link rel="import" href="/resources/app/tg-view-manager.html">
    <link rel="import" href="/resources/element_loader/load-element.html">
    <link rel="import" href="/resources/components/postal-lib.html">

    <style>
        body {
            font-family: "RobotoDraft";
            font-size: 10pt;
        }
        core-animated-pages {
            width: 100%;
            height: 100%;
            -webkit-user-select: none;
            overflow: hidden;
        }
        core-animated-pages > * {
            background-color: white;
        }
        core-toolbar {
            background-color: #0288D1;
            color: #fff;
        }
        ::shadow core-toolbar {
            background-color: #0288D1;
            color: #fff;
        }
        core-menu {
            color: #01579b;
            margin: 10px 0 0 0;
        }
        core-menu > paper-item {
            transition: all 300ms ease-in-out;
        }
        paper-item a {
            text-decoration: none;
            color: currentcolor;
            margin-left: 5px;
        }
        core-menu > paper-item.core-selected {
            background: #e1f5fe;
        }
    </style>

</head>

<body unresolved fullbleed>
    <template id="centre_example" is="auto-binding">
        <flatiron-director route="{{route}}" autohash></flatiron-director>
        <tg-reflector id="reflector"></tg-reflector>
        <tg-view-manager></tg-view-manager>
        <core-scaffold id="scaffold" responsiveWidth="767px">

            <nav>
                <core-toolbar>
                    <span>TG Example</span>
                </core-toolbar>
                <core-menu selected="{{route}}" valueattr="hash" on-core-select="{{onMenuItemSelected}}" selectedModel="{{selectedItem}}">
                    <template repeat="{{item in centres}}">
                        <paper-item hash="{{'centre_' + item.attrs.uuid}}" noink>
                            <core-icon icon="label{{route != ('centre_' + item.attrs.uuid) ? '-outline' : ''}}"></core-icon>
                            <a href="#{{'centre_' + item.attrs.uuid}}">{{item.label}}</a>
                        </paper-item>
                    </template>
                    <template repeat="{{item in masters}}">
                        <paper-item hash="{{'master_' + item.attrs.uuid}}" noink>
                            <core-icon icon="label{{route != ('master_' + item.attrs.uuid) ? '-outline' : ''}}"></core-icon>
                            <a href="#{{'master_' + item.attrs.uuid}}">{{item.label}}</a>
                        </paper-item>

                    </template>
                </core-menu>
            </nav>

            <core-toolbar style="font-size: 20px;" tool>
                <div>{{selectedItem.item.label}}</div>
            </core-toolbar>

            <div layout horizontal fit>
                <core-animated-pages id="content" selected="{{route}}" valueattr="hash" transitions="slide-from-right">
                    <template repeat="{{centre in centres}}">
                        <div hash="{{'centre_' + centre.attrs.uuid}}">
                            <load-element id="{{'centre_' + centre.attrs.uuid}}" import="{{centre.componentUri}}" elementName="{{centre.elementName}}" attrs="{{centre.attrs}}" on-after-load="{{onCentreLoaded}}" auto></load-element>
                        </div>
                    </template>
                    <template repeat="{{master in masters}}">
                        <div hash="{{'master_' + master.attrs.uuid}}">
                            <load-element id="{{'master_' + master.attrs.uuid}}" import="{{master.componentUri}}" elementName="{{master.elementName}}" attrs="{{master.attrs}}" on-after-load="{{onMasterLoaded}}" auto></load-element>
                        </div>
                    </template>
                </core-animated-pages>
            </div>

        </core-scaffold>

    </template>



    <script>
        (function () {
                var centreExample = document.querySelector("#centre_example");

                centreExample.masters = [];
                centreExample.centres = [];

                centreExample.onMenuItemSelected = function (event, detail, source) {
                    if (detail.isSelected) {
                        document.querySelector("#scaffold").closeDrawer();
                    }
                }

                centreExample.onCentreLoaded = function (e, detail, source) {
                    detail.retrieve();
                }

                centreExample.onMasterLoaded = function (e, detail, source) {

                    detail.postRetrieved = function (entity, bindingEntity, customObject) {
                        if (entity.id === null) {
                            postal.publish({
                                channel: "view",
                                topic: "master.new.created",
                                data: {
                                    centreUuid: detail.centreUuid,
                                    masterUuid: detail.uuid
                                }
                            });
                        } else {
                            postal.publish({
                                channel: "view",
                                topic: "master.edit.created",
                                data: {
                                    entityid: entity.id,
                                    centreUuid: detail.centreUuid,
                                    masterUuid: detail.uuid
                                }
                            });
                        }
                        centreExample.route = source.getAttribute("id");
                    };

                    detail.postValidated = function (validatedEntity, bindingEntity, customObject) { 

                    };

                    detail.onSaved = function (potentiallySavedEntity, newBindingEntity) {

                    };

                    detail.retrieve();
                };

                centreExample.addEventListener('template-bound', function (e) {
                        var masterNumber = 1,
                            reflector = document.querySelector("#reflector");

                        document.querySelector("#scaffold").$.drawerPanel.forceNarrow = true;

                        //////////////////////Initialising centres and route///////////////////////////////
                        centreExample.centres.push({
                            componentUri: "/centre_ui/ua.com.fielden.platform.sample.domain.MiTgPersistentEntityWithProperties",
                            elementName: "tg-TgPersistentEntityWithProperties-centre",
                            label: "Entity Centre (Generated)",
                            attrs: {
                                uuid: reflector.generateUUID()
                            }
                        });
                        /* 	            centreExample.centres.push({
                    componentUri: "/resources/centre/tg-entity-centre-for-TgPersistentEntityWithProperties.html",
                    elementName: "tg-entity-centre-for-TgPersistentEntityWithProperties",
                    label: "Entity Centre",
                    attrs: {
                        uuid: reflector.generateUUID()
                    }
                }); */
                        centreExample.route = centreExample.route || "centre_" + centreExample.centres[0].attrs.uuid;

                        //////////////////////////Edit actions//////////////////////////////////
                        postal.subscribe({
                            channel: "manager",
                            topic: "master.edit.create",
                            callback: function (data, envelope) {
                                data.attrs.uuid = reflector.generateUUID();
                                centreExample.masters.push(data);
                            }
                        });

                        postal.subscribe({
                            channel: "manager",
                            topic: "master.show",
                            callback: function (data, envelope) {
                                centreExample.route = "master_" + data.uuid;
                                postal.publish({
                                    channel: "view",
                                    topic: "master.shown",
                                    data: {
                                        centreUuid: data.centreUuid,
                                        masterUuid: data.uuid
                                    }
                                });
                            }
                        });
                        /////////////////New Actions//////////////////////////////
                        postal.subscribe({
                            channel: "manager",
                            topic: "master.new.create",
                            callback: function (data, envelope) {
                                var uuid = reflector.generateUUID();
                                data.hash = "master_" + uuid;
                                data.label = "New Master #" + masterNumber;
                                data.attrs.uuid = uuid;
                                centreExample.masters.push(data);
                                masterNumber += 1;
                            }
                        });
                });
        })();
    </script>

</body>

</html>
