<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <title>Single page app using Polymer</title>
    <script src="/resources/polymer/webcomponentsjs/webcomponents.js"></script>
    <link rel="import" href="/resources/polymer/core-animated-pages/core-animated-pages.html">
    <link rel="import" href="/resources/polymer/core-animated-pages/transitions/slide-from-right.html">
    <link rel="import" href="/resources/polymer/core-toolbar/core-toolbar.html">
    <link rel="import" href="/resources/polymer/core-scaffold/core-scaffold.html">
    <link rel="import" href="/resources/polymer/core-icon-button/core-icon-button.html">
    <link rel="import" href="/resources/polymer/core-icon/core-icon.html">
    <link rel="import" href="/resources/polymer/core-menu/core-menu.html">
    <link rel="import" href="/resources/polymer/core-item/core-item.html">
    <link rel="import" href="/resources/polymer/flatiron-director/flatiron-director.html">
    <link rel="import" href="/resources/polymer/font-roboto/roboto.html">
    <link rel="import" href="/resources/centre/tg-entity-centre-for-TgPersistentEntityWithProperties.html">
    <link rel="import" href="/resources/element_loader/load-element.html">
    <link rel="import" href="/resources/components/postal-lib.html">

    <style>
        body {
            font-family: "RobotoDraft";
            font-size: 10pt;
        }
        core-animated-pages {
            width: 100%;
            height: 100%;
            -webkit-user-select: none;
            overflow: hidden;
        }
        core-animated-pages > * {
            background-color: white;
        }
        core-toolbar {
            background-color: #0288D1;
            color: #fff;
        }
        ::shadow core-toolbar {
            background-color: #0288D1;
            color: #fff;
        }
    </style>
</head>

<body unresolved fullbleed>

    <template is="auto-binding" id="centre_example">

        <!-- Route controller. -->
        <flatiron-director route="{{route}}" autoHash></flatiron-director>

        <core-scaffold id="scaffold">

            <nav>
                <core-toolbar>
                    <span>TG Example</span>
                </core-toolbar>
                <core-menu selected="{{route}}" valueattr="hash" on-core-select="{{menuItemSelected}}">
                    <core-item hash="centre" label="Entity Centre"></core-item>
                    <core-item hash="master" label="Entity Master"></core-item>
                </core-menu>
            </nav>

            <core-toolbar style="font-size: 20px;" tool>
                <div>{{route === 'centre' ? 'Entity Centre' : 'Entity Master'}}</div>
            </core-toolbar>

            <div layout horizontal fit>
                <core-animated-pages id="pages" selected="{{route}}" valueattr="hash" transitions="slide-from-right">
                    <div hash="centre">
                        <tg-entity-centre-for-TgPersistentEntityWithProperties id="centre" user="SU" entityType="ua.com.fielden.platform.sample.domain.TgPersistentEntityWithProperties"></tg-entity-centre-for-TgPersistentEntityWithProperties>
                    </div>
                    <div hash="master">
                        <load-element id="master" import="{{componentUri}}" elementName="{{elementName}}" attrs="{{attrs}}" on-after-load="{{onMasterLoaded}}">
                        </load-element>
                    </div>
                </core-animated-pages>
            </div>

        </core-scaffold>

    </template>

    <script>
        (function () {
            "use strict";

            var centreExample = document.querySelector('#centre_example');

            centreExample.componentUri = "/users/{{user}}/master/ua.com.fielden.platform.sample.domain.TgPersistentEntityWithProperties";
            centreExample.elementName = "tg-TgPersistentEntityWithProperties-master";
            centreExample.attrs = {
                user: 'SU',
                entitytype: 'ua.com.fielden.platform.sample.domain.TgPersistentEntityWithProperties',
                currentState: 'VIEW'
            };


            centreExample.addEventListener('template-bound', function (e) {
                centreExample.route = centreExample.route || 'centre'; // Select initial route.

                document.querySelector("#centre").retrieve();
                document.querySelector("#scaffold").$.drawerPanel.forceNarrow = true;

                postal.subscribe({
                    channel: "centre",
                    topic: "edit",
                    callback: function (data, envelope) {
                        var master = document.querySelector("#master");
                        centreExample.attrs.entityid = data.entity.id;
                        master.reload();
                    }
                });
                postal.subscribe({
                    channel: "centre",
                    topic: "new",
                    callback: function (data, envelope) {
                        var master = document.querySelector("#maste");
                        centreExample.attrs.entityid = "new";
                        master.reload();
                    }
                });
            });

            centreExample.menuItemSelected = function (e, detail, sender) {
                if (detail.isSelected) {
                    document.querySelector('#scaffold').closeDrawer();
                }
            };

            centreExample.onMasterLoaded = function (e, detail, source) {
                detail.onRetrieved = function (entity, bindingEntity, customObject) {
                    console.log("onRetrieved");
                    centreExample.route = "master";
                };

                detail.onValidated = function (validatedEntity, bindingEntity, customObject) {
                    console.log("onValidated");
                };

                detail.onSaved = function (potentiallySavedEntity, newBindingEntity) {
                    var self = this;
                    /*postal.publish({
                        channel: "master-" + self.uuid,
                        topic: "save",
                        data: {
                            id: potentiallySavedEntity.id
                        }
                    });*/
                };

                detail.retrieve();
            };

        })();
    </script>
</body>

</html>