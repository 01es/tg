<link rel="import" href="/resources/polymer/polymer/polymer.html">
<link rel="import" href="/resources/polymer/core-ajax/core-ajax.html">
<link rel="import" href="/resources/components/accordion-element.html">
<link rel="import" href="/resources/components/entity-grid-inspector.html">
<link rel="import" href="/resources/polymer/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="/resources/polymer/paper-button/paper-button.html">
<link rel="import" href="/resources/polymer/paper-item/paper-item.html">
<link rel="import" href="/resources/layout/tile-layout.html">
<link rel="import" href="/resources/components/criteria-editor.html">

<polymer-element name="entity-centre" attributes="centreName">
    <template>
        <style>
            .entity-center {
                width: 90%;
                height: 90%;
            }
            paper-button {
                border: 1px solid #ddd;
                border-radius: 6px;
            }
            .btn-group > .btn:not(:first-child):not(:last-child) {
                border-radius: 0;
                margin-left: 0;
                margin-right: 0;
            }
            .btn-group > .btn:not(:first-child) {
                border-left-width: 0;
            }
            .btn-group > .btn:first-child:not(:last-child) {
                margin-left: 0;
                margin-right: 0;
                border-top-right-radius: 0;
                border-bottom-right-radius: 0;
            }
            .btn-group > .btn:last-child:not(:first-child) {
                border-top-left-radius: 0;
                border-bottom-left-radius: 0;
                margin-left: 0;
            }
            tile-layout {
                margin: 5px;
                font: inherit;
            }
        </style>
        <core-ajax id="config_retriever" url="/users/SU/centre/{{centreName}}" handleas="json" on-core-response="{{onConfigLoadResponse}}" on-core-error="{{onConfigLoadError}}" auto></core-ajax>
        <core-ajax id="run" url="/users/SU/QueryRunner" method="POST" handleas="json" on-core-response="{{onResponse}}" on-core-error="{{onError}}"></core-ajax>
        <div layout vertical center center-justified fit>
            <div class="entity-center">
                <accordion-element heading="Selection Criteria">
                    <tile-layout fullbleed block relative whendesktop="{{whenDesktop}}" whentablet="{{whenTablet}}" whenmobile="{{whenMobile}}" mincellheight="4.5em">
                        <template repeat="{{criteria in config.centreConfig.criteria.criteriaProperties}}">
                            <criteria-editor class="tile" config="{{criteria}}" bindto="{{config.query.criteriaProperties[criteria.propertyName]}}"></criteria-editor>
                        </template>
                    </tile-layout>
                </accordion-element>
                <div layout horizontal justified center>
                    <div layout horizontal center>
                        <!--div class="btn-group" layout horizontal>
                            <paper-button class="btn" on-click="{{firstPage}}">Run</paper-button>
                            <paper-button class="btn" on-click="{{prevPage}}">Run</paper-button>
                            <paper-button class="btn" on-click="{{nextPage}}">Run</paper-button>
                            <paper-button class="btn" on-click="{{lastPage}}">Run</paper-button>
                        </div-->
                        <span>{{"page: " + (paginator.page.numberOfPages == 0 ? 0 : paginator.page.pageNo + 1) + " of " + paginator.page.numberOfPages}}</span>
                    </div>
                    <div layout horizontal center>
                        <!--paper-dropdown-menu selected="{{pageCapacity}}" valueattr="label">
                            <paper-item label="5"></paper-item>
                            <paper-item label="10"></paper-item>
                            <paper-item label="20"></paper-item>
                            <paper-item label="25"></paper-item>
                            <paper-item label="50"></paper-item>
                        </paper-dropdown-menu-->
                        <paper-button style="margin-right: 0px" on-click="{{runAction}}">Run</paper-button>
                    </div>
                </div>
                <entity-grid-inspector flex columns="{{config.centreConfig.resultProperties}}" data="{{paginator.page.results}}"></entity-grid-inspector>
            </div>
        </div>
    </template>
    <script>
        (function () {
            // Returns the layout configuration that has columnNumber number of columns. The number of rows is calculated by deviding editors number by columnNumber.
            var createCriteriaLayout = function (columnNumber, editorsNumber) {
                    var numberOfRows = Math.ceil(editorsNumber / columnNumber),
                        layout = [],
                        rowLayout,
                        rowIndex, columnIndex;
                    for (rowIndex = 0; rowIndex < numberOfRows; rowIndex += 1) {
                        rowLayout = [];
                        for (columnIndex = 0; columnIndex < columnNumber; columnIndex += 1) {
                            rowLayout.push([]);
                        }
                        layout.push(rowLayout);
                    }
                    return layout;
                },
                //Represents the empty data page.
                emptyPage = {
                    pageNo: 0,
                    numberOfPages: 0,
                    summary: {},
                    results: []
                };
            //Register the entity-centre component. With default page capacity equal to 5, and empty data page.
            Polymer({
                pageCapacity: "5",
                paginator: {
                    page: emptyPage
                },
                runAction: function () {
                    //Setting initial parameters for page.
                    this.paginator.query = JSON.parse(JSON.stringify(this.config.query));
                    this.paginator.pageCapacity = this.pageCapacity;
                    //Creating queryRunner instance as a body for post request to the server.
                    var queryRunner = {};
                    queryRunner.key = "QueryRunner";
                    queryRunner["@entityType"] = "ua.com.fielden.platform.entity.functional.centre.QueryRunner";
                    queryRunner.pageCapacity = this.paginator.pageCapacity;
                    queryRunner.query = this.paginator.query;
                    //running a query.
                    this.$.run.body = JSON.stringify(queryRunner);
                    this.$.run.go()
                },
                onResponse: function (e, detail, sender) {
                    this.paginator.page = detail.response.instance.page;
                },
                onError: function (e, detail, sender) {
                    alert("Error happened");
                },
                onConfigLoadResponse: function (e, detail, sender) {
                    var columnNumber, editorsNumber;
                    this.config = detail.response;
                    columnNumber = this.config.centreConfig.criteria.columns;
                    editorsNumber = this.config.centreConfig.criteria.criteriaProperties.length;
                    this.whenDesktop = createCriteriaLayout(columnNumber > 4 ? 4 : columnNumber, editorsNumber);
                    this.whenTablet = createCriteriaLayout(2, editorsNumber);
                    this.whenMobile = createCriteriaLayout(1, editorsNumber);
                },
                onConfigLoadError: function (e, detail, sender) {
                    alert("Error happened");
                }
            });
        })();
    </script>
</polymer-element>