<link rel="import" href="/resources/polymer/polymer/polymer.html">
<link rel="import" href="/tg-web-app/tg-app-config.html">
<link rel="import" href="/tg-reflector">
<link rel="import" href="/resources/polymer/iron-media-query/iron-media-query.html">
<link rel="import" href="/resources/polymer/paper-checkbox/paper-checkbox.html">
<link rel="import" href="/resources/polymer/paper-material/paper-material.html">
<link rel="import" href="/resources/polymer/iron-icon/iron-icon.html">
<link rel="import" href="/resources/polymer/iron-icons/iron-icons.html">
<link rel="import" href="/resources/polymer/paper-styles/paper-styles.html">

<dom-module id="tg-entity-grid-inspector">
    <style>
        .truncate {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .data-table {
            background-color: white;
        }
        .table-header-row {
            font-size: 0.9rem;
            color: #757575;
            height: 3.5rem;
            cursor: default;
        }
        .table-data-row {
            font-size: 1rem;
            color: #212121;
            height: 3rem;
            border-top: 1px solid #e3e3e3;
            cursor: default;
        }
        .table-data-row[selected] {
            background-color: #F5F5F5;
        }
        .table-data-row:hover {
            background-color: #EEEEEE;
        }
        .table-cell {
            margin-right: 1.2rem;
        }
        .table-cell:first-child {
            margin-left: 1.2rem;
        }
        paper-checkbox.blue {
            --paper-checkbox-checked-color: #0288D1;
            --paper-checkbox-checked-ink-color: #0288D1;
        }
        paper-checkbox.header {
            --paper-checkbox-unchecked-color: #757575;
            --paper-checkbox-unchecked-ink-color: #757575;
        }
        paper-checkbox.body {
            --paper-checkbox-unchecked-color: #212121;
            --paper-checkbox-unchecked-ink-color: #212121;
        }
    </style>
    <template>
        <content id="column_selector" select="tg-property-column" hidden></content>
        <content id="primary_action_selector" select=".primary-action" hidden></content>
        <content id="secondary_action_selector" select=".secondary-action" hidden></content>
        <tg-app-config id="appConfig"></tg-app-config>
        <tg-reflector id="reflector"></tg-reflector>
        <iron-media-query id="mobileQuery" query="[[_calcMobileQuery()]]" on-query-matches-changed="_mobileChanged"></iron-media-query>
        <iron-media-query id="tabletQuery" query="[[_calcTabletQuery()]]" on-query-matches-changed="_tabletChanged"></iron-media-query>
        <iron-media-query id="desktopQuery" query="[[_calcDesktopQuery()]]" on-query-matches-changed="_desktopChanged"></iron-media-query>

        <!-- The dialog for tg-ui-action -->
        <!-- The dialog for summary when egi is in card layout -->
        <!-- Toolbar template if it will be needed any longer-->

        <template is="dom-if" if="[[!cardLayout]]">
            <paper-material elevation="1">
                <div class="layout vertical data-table">
                    <!--Table toolbar-->
<!--
                    <div class="layout horizontal justified">
                        <div class="layout horizontal center">
                            <content select=".entity-specific-action"></content>
                        </div>
                        <div class="layout horizontal center">
                            <content select=".standart-action"></content>
                        </div>
                    </div>
-->
                    <!-- Table header -->
                    <div class="layout horizontal table-header-row">
                        <div class="table-cell layout horizontal center">
                            <paper-checkbox class="blue header" on-iron-change="_allSelectionChanged"></paper-checkbox>
                        </div>
                        <template is="dom-if" if="[[primaryAction]]">
                            <div class="table-cell layout horizontal center">
                                <!--Primary action header goes here-->
                            </div>
                        </template>
                        <template is="dom-repeat" items="[[columns]]">
                            <div class="table-cell layout horizontal center" style$="[[_calcColumnHeaderStyle(item)]]">
                                <div class="truncate" style$="[[_calcColumnHeaderStyle(item)]]">[[item.columnTitle]]</div>
                            </div>
                        </template>
                        <template is="dom-if" if="[[_isSecondaryActionsPresent(secondaryActions)]]">
                            <div class="table-cell layout horizontal center">
                                <!--Secondary actions header goes here-->
                            </div>
                        </template>
                    </div>
                    <!-- Table body -->
                    <template is="dom-repeat" items="[[egiModel]]" as="egiEntity" index-as="entityIndex">
                        <div class="layout horizontal table-data-row" selected$="[[egiEntity.selected]]">
                            <div class="table-cell layout horizontal center">
                                <paper-checkbox class="blue body" checked="{{egiEntity.selected}}" on-iron-change="_selectionChanged"></paper-checkbox>
                            </div>
                            <template is="dom-if" if="[[primaryAction]]">
                                <div class="table-cell layout horizontal center">
                                    <!--Primary action header goes here-->
                                </div>
                            </template>
                            <template is="dom-repeat" items="[[columns]]" as="column">
                                <div class="table-cell relative layout horizontal center" style$="[[_calcColumnStyle(column)]]" on-tap="_tapAction">
                                    <div class="fit" style$="[[_calcRenderingHintsStyle(entityIndex, column.property)]]"></div>
                                    <template is="dom-if" if="[[_isBooleanProp(egiEntity.entity, column)]]">
                                        <iron-icon icon="[[_getBooleanIcon(egiEntity.entity, column)]]"></iron-icon>
                                    </template>
                                    <template is="dom-if" if="[[_isNotBooleanProp(egiEntity.entity, column)]]">
                                        <div class="truncate" style$="[[_calcColumnStyle(column)]]">[[_getValue(egiEntity.entity, column)]]</div>
                                    </template>
                                </div>
                            </template>
                            <template is="dom-if" if="[[_isSecondaryActionsPresent(secondaryActions)]]">
                                <div class="table-cell">
                                    <!--Secondary actions header goes here-->
                                </div>
                            </template>
                        </div>
                    </template>
                    <!-- Table footer -->
                    <div class="layout vertical">
                        <!-- Totals go here -->
                    </div>
                </div>
            </paper-material>
        </template>

    </template>
</dom-module>
<script>
    (function () {
        var _checkCollapsiblePanelVisibility = function (layout) {
                this.collapsePanelVisible = this.cardLayout && layout;
            },
            _areEqual = function (a, b) {
                return a.id === b.id;
            },
            _hasEntity = function (entity, entities) {
                var i = 0;
                for (i = 0; i < entities.length; i += 1) {
                    if (areEqual(entity, entities[i])) {
                        return true;
                    }
                }
                return false;
            },
            _findEntity = function (entity, entities) {
                var i = 0;
                for (i = 0; i < entities.length; i += 1) {
                    if (areEqual(entity, entities[i])) {
                        return i;
                    }
                }
                return -1;
            };
        Polymer({
            is: "tg-entity-grid-inspector",

            properties: {
                entityType: String,
                entities: {
                    type: Array,
                    observer: "_entitiesChanged"
                },
                totals: Object,
                renderingHints: Array,
                shortLayout: Object,
                longLayout: Object,
                summaryLayout: Object
            },

            observers: [
                '_desktopShortLayoutChanged(shortLayout.desktop)',
                '_tabletShortLayoutChanged(shortLayout.tablet)',
                '_mobileShortLayoutChanged(shortLayout.mobile)',
                '_desktopLongLayoutChanged(longLayout.desktop)',
                '_tabletLongLayoutChanged(longLayout.tablet)',
                '_mobileLongLayoutChanged(longLayout.mobile)'
            ],
            /**
             * Initialises selection model, primary action, secondary actions, property columns, card layout.
             */
            ready: function () {
                var summaryRowsCount, summaryRowCounter, totalsRow,
                    primaryActions = Polymer.dom(this.$.primary_action_selector).getDistributedNodes();

                //Initialising entities.
                this.entities = [];

                //Initialising the egi model .
                this.egiModel = [];

                //initialising the arrays for selected entites and entities those were opened.
                this.selectedEntities = [];
                this.openedEntities = [];

                //Initialising columns (property column mappings)
                this.columns = [];
                summaryRowsCount = 0;
                Array.prototype.forEach.call(Polymer.dom(this.$.column_selector).getDistributedNodes(), function (item) {
                    if (item.summary && item.summary.length > summaryRowsCount) {
                        summaryRowsCount = item.summary.length;
                    }
                    this.columns.push(item);
                }.bind(this));

                //Initialising totals.
                if (summaryRowsCount > 0) {
                    this.gridSummary = [];
                    this.cardSummary = [];
                    for (summaryRowCounter = 0; summaryRowCounter < summaryRowsCount; summaryRowCounter += 1) {
                        totalsRow = [];
                        this.columns.forEach(function (item) {
                            if (item.summary && item.summary[propertyCounter]) {
                                rowTotals.push(item.summary[propertyCounter]);
                                this.cardSummary.push(item.summary[propertyCounter]);
                            } else {
                                rowTotals.push(null);
                            }
                        }.bind(this));
                        this.gridSummary.push(rowTotals);
                    }
                }

                //Initialising the primary action.
                this.primaryAction = null;
                this.primaryAction = primaryActions > 0 ? primaryActions[0] : null;

                //Initialising the secondary actions' list.
                this.secondaryActions = [];
                Array.prototype.forEach.call(Polymer.dom(this.$.secondary_action_selector).getDistributedNodes(), function (item) {
                    this.secondaryActions.push(item);
                }.bind(this));
            },
            //The following nine functions determine whenther EGI is in card layout or grid and whether callapsible panel of card is visible or not.////////
            _mobileChanged: function (e, detail) {
                if (detail.value) {
                    this.cardLayout = !!(this.shortLayout && this.shortLayout.mobile);
                    this.collapsePanelVisible = this.cardLayout && this.longLayout && this.longLayout.mobile;
                }
            },
            _tabletChanged: function (e, detail) {
                if (detail.value) {
                    this.cardLayout = !!(this.shortLayout && this.shortLayout.tablet);
                    this.collapsePanelVisible = this.cardLayout && this.longLayout && this.longLayout.tablet;
                }
            },
            _desktopChanged: function (e, detail) {
                if (detail.value) {
                    this.cardLayout = !!!!(this.shortLayout && this.shortLayout.desktop);
                    this.collapsePanelVisible = this.cardLayout && this.longLayout && this.longLayout.desktop;
                }
            },
            _desktopShortLayoutChanged: function (layout) {
                this.cardLayout = this.$.desktopQuery.queryMatches && layout;
                this.collapsePanelVisible = this.cardLayout && this.longLayout && this.longLayout.desktop;
            },
            _tabletShortLayoutChanged: function (layout) {
                this.cardLayout = this.$.tabletQuery.queryMatches && layout;
                this.collapsePanelVisible = this.cardLayout && this.longLayout && this.longLayout.tablet;
            },
            _mobileShortLayoutChanged: function (layout) {
                this.cardLayout = this.$.mobileQuery.queryMatches && layout;
                this.collapsePanelVisible = this.cardLayout && this.longLayout && this.longLayout.mobile;
            },
            _desktopLongLayoutChanged: function (layout) {
                _checkCollapsiblePanelVisibility.bind(this)(layout);
            },
            _tabletLongLayoutChanged: function (layout) {
                _checkCollapsiblePanelVisibility.bind(this)(layout);
            },
            _mobileLongLayoutChanged: function (layout) {
                _checkCollapsiblePanelVisibility.bind(this)(layout);
            },
            /**
             * Observs the changes to entities property.
             */
            _entitiesChanged: function (newValue, oldValue) {
                var egiEntity;
                newValue.forEach(function (entity) {
                    var selectEntInd = _findEntity(entity, this.selectedEntities),
                        openedEntInd = _findEntity(entity, this.openedEntities);
                    if (selectEntInd >= 0) {
                        this.selectedEntities[selectEntInd] = entity;
                    }
                    if (openedEntInd >= 0) {
                        this.openedEntities[openedEntInd] = entity;
                    }
                }.bind(this));
                this.egiModel = [];
                newValue.forEach(function (entity) {
                    egiEntity = {
                        selected: this.selectedEntities.indexOf(entity) > -1,
                        opened: this.openedEntities.indexOf(entity) > -1,
                        entity: entity
                    }
                    this.push('egiModel', egiEntity);
                }.bind(this));
            },
            /**
             * Event handler for select all checkbox
             */
            _allSelectionChanged: function (e) {
                var i;
                if (this.egiModel) {
                    for (i = 0; i < this.egiModel.length; i += 1) {
                        this.set("egiModel." + i + ".selected", e.srcElement.checked);
                    }
                }
            },
            /**
             * Event handler for selecting concrete entity
             */
            _selectionChanged: function (e) {
                var index;
                if (this.egiModel) {
                    index = e.model.entityIndex;
                    if (e.srcElement.checked) {
                        if (this.selectedEntities.indexOf(this.entities[index]) < 0) {
                            this.selectedEntities.push(this.entities[index]);
                        }
                    } else {
                        if (this.selectedEntities.indexOf(this.entities[index]) >= 0) {
                            this.selectedEntities.splice(this.selectedEntities.indexOf(this.entities[index]), 1);
                        }
                    }
                }
            },
            /**
             * Determines whether secondary actions are present.
             */
            _isSecondaryActionsPresent: function (secondaryActions) {
                return secondaryActions && secondaryActions.length > 0;
            },
            /**
             * Calculates the column's header style.
             */
            _calcColumnHeaderStyle: function (item) {
                return "width: " + item.width + ";";
            },
            /**
             * Calculates the column's style.
             */
            _calcColumnStyle: function (column) {
                return "width: " + column.width + ";";
            },
            /**
             * Calculates the style for cell that represents rendering hints.
             */
            _calcRenderingHintsStyle: function (entityIndex, property) {
                var style = "opacity: 0.3;",
                    rendHints = (this.renderingHints && this.renderingHints[entityIndex][property]) || [];
                for (var property in rendHints) {
                    if (rendHints.hasOwnProperty(property)) {
                        style += " " + property + ": " + rendHints[property] + ";";
                    }
                }
                return style;
            },
            /**
             * Returns the property value of the specified entity.
             */
            _get: function (entity, column) {
                return entity && entity.get(column.property);
            },
            /**
             * Returns the property value of the specified entity and converts it to string.
             */
            _getValue: function (entity, column) {
                if (!entity || !column || this._get(entity, column) === null) {
                    return "";
                } else if (this.$.reflector.findTypeByName(column.type)) {
                    return this.$.reflector.convert(this._get(entity, column));
                } else if (column.type === 'Date') {
                    return moment(entity.get(column.property)).format("L LT");
                } else if (typeof entity.get(column.property) === 'number') {
                    return entity.get(column.property).toLocaleString(this.$.appConfig.locale);
                } else {
                    return entity.get(column.property);
                }
            },
            /**
             * Determines whether property is boolean or not.
             */
            _isBooleanProp: function (entity, column) {
                return column.type === 'Boolean' && _get(entity, column) !== null
            },
            /**
             * Determines whether property is not boolean property or is.
             */
            _isNotBooleanProp: function (entity, column) {
                return column.type !== 'Boolean';
            },
            /**
             * Returns icon that represents the boolean value.
             */
            _getBooleanIcon: function (entity, column) {
                return "icons:" + (_get(entity, column) ? "check" : "clear");
            },
            /**
             * Tap action on data column. TODO: implement this.
             */
            _tapAction: function (e, detail, source) {
                console.log(e, detail, source);
            },
            ///////////////////Next three functions are responsible for calculating media queries expressions for mobile tablet and desktop screens/////////
            _calcMobileQuery: function () {
                return "max-width: " + (this.$.appConfig.minTabletWidth - 1) + "px";
            },
            _calcTabletQuery: function () {
                return "(min-width: " + this.$.appConfig.minTabletWidth + "px) and (max-width: " + (this.$.appConfig.minDesktopWidth - 1) + "px)";
            },
            _calcDesktopQuery: function () {
                return "min-width: " + this.$.appConfig.minDesktopWidth + "px";
            },
            /**
             * Returns the list entitles selected on the current page.
             */
            getSelectedEntities: function () {
                var currentSelectedEntities = [];
                this.egiModel.forEach(function (elem) {
                    if (elem.selected) {
                        currentSelectedEntities.push(elem.entity);
                    }
                }.bind(this));
                return currentSelectedEntities;
            },
            /**
             * Returns the list of all selected entites.
             */
            getAllSelectedEntities: function () {
                return this.selectedEntities;
            },
            /**
             * Returns the indexes of entites selected on current page.
             */
            getSelectedRows: function () {
                var selectedRows = [];
                this.egiModel.forEach(function (elem, elemIndex) {
                    if (elem.selected) {
                        selectedRows.push(elemIndex);
                    }
                }.bind(this));
                return selectedRows;
            },
            /**
             * Clears selection.
             */
            clearSelection: function () {
                this.egiModel.forEach(function (elem) {
                    elem.selected = false;
                }.bind(this));
                this.selectedEntities = [];
            }
        })
    })()
</script>