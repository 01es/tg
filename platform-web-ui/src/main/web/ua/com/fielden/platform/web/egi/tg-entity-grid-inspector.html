<link rel="import" href="/resources/polymer/polymer/polymer.html">
<link rel="import" href="/resources/polymer/core-media-query/core-media-query.html">
<link rel="import" href="/resources/polymer/paper-checkbox/paper-checkbox.html">
<link rel="import" href="/resources/polymer/paper-ripple/paper-ripple.html">
<link rel="import" href="/resources/polymer/paper-dropdown/paper-dropdown.html">
<link rel="import" href="/resources/polymer/core-tooltip/core-tooltip.html">
<link rel="import" href="/resources/polymer/core-icon-button/core-icon-button.html">
<link rel="import" href="/tg-web-app/tg-app-config.html">
<link rel="import" href="/tg-reflector">

<polymer-element name="tg-entity-grid-inspector" attributes="entityType entities" layout vertical>
    <template>
        <link rel="stylesheet" href="/resources/egi/tg-entity-grid-inspector.css">
        <content id="column_selector" select="tg-property-column" hidden></content>
        <content id="primary_action_selector" select="tg-primary-instance-action" hidden></content>
        <content id="secondary_action_selector" select="tg-secondary-instance-action" hidden></content>
        <tg-app-config id="appConfig"></tg-app-config>
        <tg-reflector id="reflector"></tg-reflector>
        <core-media-query query="max-width: {{$.appConfig.minTabletWidth - 1}}px" querymatches="{{mobileScreen}}"></core-media-query>
        <core-media-query query="(min-width: {{$.appConfig.minTabletWidth}}px) and (max-width: {{$.appConfig.minDesktopWidth - 1}}px)" querymatches="{{tabletScreen}}"></core-media-query>
        <core-media-query query="min-width: {{$.appConfig.minDesktopWidth}}px" querymatches="{{desktopScreen}}"></core-media-query>
        <!--<table>
            <tr>
                <template repeat="{{column in columns}}">
                    <td style="width: {{column.width}}">{{getTitle(column)}}</td>
                </template>
            </tr>
        </table>-->

        <paper-ripple id="ripple" class="circle recenteringTouch" style="pointer-events: none;" fit></paper-ripple>

        <!--<div class="table-container">-->
        <div layout horizontal justified>
            <div layout horizaontal>
                <content select=".entity-specific-action">
            </div>
            <div layout horizontal end-justified>
                <content select=".standart-action">
            </div>
        </div>
        <table>
            <thead>
                <tr class="header-color">
                    <th>
                        <core-tooltip position="bottom" class="delayed" style="width:100%">
                            <paper-checkbox checked="{{selectAll}}" on-core-change="{{onAllSelectionChanged}}"></paper-checkbox>
                            <span class="span-tooltip" tip>{{selectAll ? 'Unselect': 'Select'}} All entities</span>
                        </core-tooltip>
                    </th>
                    <template if="{{primaryAction}}">
                        <th></th>
                    </template>
                    <template repeat="{{column in columns}}">
                        <th style="width: {{column.width}}" align="left">
                            <core-tooltip position="bottom" class="delayed" style="width:100%">
                                {{column.columnTitle}}
                                <span class="span-tooltip" tip>{{column.columnDesc}}</span>
                            </core-tooltip>
                        </th>
                    </template>
                    <template if="{{secondaryActions.length > 0 }}">
                        <th></th>
                    </template>
                </tr>
            </thead>
            <tbody>
                <template repeat="{{entity, entityIndex in entities}}">
                    <tr class="{{entityIndex % 2 === 0 ? 'normal-color' : 'alternate-color'}}" selected?="{{selectionModel[entityIndex]}}">
                        <td>
                            <core-tooltip position="bottom" class="delayed" style="width:100%">
                                <paper-checkbox index="{{entityIndex}}" checked?="{{selectionModel[entityIndex]}}" on-core-change="{{onSelectionChanged}}"></paper-checkbox>
                                <span class="span-tooltip" tip>{{selectionModel[entityIndex] ? 'Unselect': 'Select'}} this entity</span>
                            </core-tooltip>
                        </td>
                        <template if="{{primaryAction}}">
                            <td class="action-column">
                                <core-tooltip position="bottom" class="delayed" style="width:100%">
                                    <core-icon-button icon="{{primaryAction.icon}}"></core-icon-button>
                                    <span class="span-tooltip" tip>{{primaryAction.actionDesc}}</span>
                                </core-tooltip>
                            </td>
                        </template>
                        <template repeat="{{column in columns}}">
                            <td style="position: relative; width: {{column.width}}" on-down="{{downAction}}" on-up="{{upAction}}">
                                <core-tooltip position="bottom" class="delayed" style="width:100%">
                                    {{getValue(entity, column)}}
                                    <span class="span-tooltip" tip>{{getTooltip(entity, column)}}</span>
                                </core-tooltip>
                            </td>
                        </template>
                        <template if="{{secondaryActions.length > 0 }}">
                            <td class="action-column">
                                <core-tooltip position="bottom" class="delayed" style="width:100%">
                                    <core-icon-button icon="today" on-tap="{{onSecondaryActionTap}}"></core-icon-button>
                                    <span class="span-tooltip" tip>{{secondaryActions.length > 1 ? 'Click to see associated actions' : secondaryActions[0].actionDesc}}</span>
                                </core-tooltip>
                            </td>
                        </template>
                    </tr>
                </template>
            </tbody>
        </table>
        <paper-dropdown id="action_dropdown" layout vertical>
            <template repeat="{{action in secondaryActions}}">
                <core-tooltip position="bottom" class="delayed" style="width:100%">
                    <core-icon-button icon="today"></core-icon-button>{{action.actionTitle}}
                    <span class="span-tooltip" tip>action.actionDesc</span>
                </core-tooltip>
            </template>
        </paper-dropdown>
        <!--</table>
</div>-->
        <!--<table>
            <tr>
                <template repeat="{{column in columns}}">
                    <td style="width: {{column.width}}">total</td>
                </template>
            </tr>
        </table>-->
    </template>
    <script>
        (function () {
            var areEqual = function (a, b) {
                    return a.id === b.id;
                },
                hasEntity = function (entity, entities) {
                    var i = 0;
                    for (i = 0; i < entities.length; i += 1) {
                        if (areEqual(entity, entities[i])) {
                            return true;
                        }
                    }
                    return false;
                };

            Polymer({
                ready: function () {
                    this.selectionModel = [];
                    this.selectedEntities = [];
                    this.columns = [];
                    this.primaryAction = null;
                    this.secondaryActions = [];
                    Array.prototype.forEach.call(this.$.column_selector.getDistributedNodes(), function (item) {
                        this.columns.push(item);
                    }.bind(this));
                    this.primaryAction = this.$.primary_action_selector.getDistributedNodes().length > 0 ? this.$.primary_action_selector.getDistributedNodes()[0] : null;
                    Array.prototype.forEach.call(this.$.secondary_action_selector.getDistributedNodes(), function (item) {
                        this.secondaryActions.push(item);
                    }.bind(this));
                },
                getTooltip: function (entity, column) {
                    if (this.$.reflector.findTypeByName(column.type)) {
                        return entity.get(!column.property ? "desc" : (column.property + ".desc"));
                    } else {
                        return entity.get(column.property);
                    }
                },
                getValue: function (entity, column) {
                    if (this.$.reflector.findTypeByName(column.type)) {
                        return entity.get(!column.property ? "key" : (column.property + ".key"));
                    } else {
                        return entity.get(column.property);
                    }
                },
                onAllSelectionChanged: function (e, detail, source) {
                    var i = 0;
                    for (i = 0; i < this.selectionModel.length; i += 1) {
                        this.selectionModel[i] = source.checked;
                    }
                },
                onSelectionChanged: function (e, detail, source) {
                    var index = +source.getAttribute("index");
                    if (source.checked) {
                        if (this.selectedEntities.indexOf(this.entities[index]) < 0) {
                            this.selectedEntities.push(this.entities[index]);
                            this.selectionModel[index] = true;
                        }
                    } else {
                        if (this.selectedEntities.indexOf(this.entities[index]) >= 0) {
                            this.selectedEntities.splice(this.selectedEntities.indexOf(this.entities[index]), 1);
                            this.selectionModel[index] = false;
                        }
                    }
                    console.log(this.getSelectedRows(), this.getSelectedEntities(), this.selectionModel);
                },
                onSecondaryActionTap: function (e, detail, source) {
                    console.log(source.style);
                    if (this.secondaryActions.length > 1) {
                        if (!this.$.action_dropdown.opened) {
                            this.$.action_dropdown.sizingTarget = source;
                            this.$.action_dropdown.opened = true;
                        } else {
                            this.$.action_dropdown.opened = false;
                        }
                    }
                },
                getSelectedEntities: function () {
                    return this.selectedEntities;
                },
                getSelectedRows: function () {
                    var selectedRows = [];
                    this.selectionModel.forEach(function (elem, elemIndex) {
                        if (elem) {
                            selectedRows.push(elemIndex);
                        }
                    }.bind(this));
                    return selectedRows;
                },
                entitiesChanged: function (oldValue, newValue) {
                    this.selectionModel = [];
                    newValue.forEach(function (entity) {
                        this.selectionModel.push(hasEntity(entity, this.getSelectedEntities))
                    }.bind(this));
                },
                clearSelection: function () {
                    this.selectionModel = [];
                    this.selectedEntities = [];
                },

                downAction: function (e) {
                    // find the TD on the clicked path
                    var index = 0;
                    var parent = null
                    while (index < e.path.length && parent === null) {
                        console.log(e.path[index].tagName);
                        if (e.path[index].tagName === "TD") {
                            parent = e.path[index];
                        }
                        index = index + 1;
                    }

                    // attach the ripple component to the found TD
                    parent.appendChild(this.$.ripple);
                    this.$.ripple.downAction(e);
                },

                upAction: function (e) {
                    this.$.ripple.upAction();
                }

            });
        })();
    </script>
</polymer-element>