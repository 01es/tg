<link rel="import" href="/resources/polymer/polymer/polymer.html">
<link rel="import" href="/resources/polymer/core-media-query/core-media-query.html">
<link rel="import" href="/resources/polymer/paper-checkbox/paper-checkbox.html">
<link rel="import" href="/resources/polymer/paper-ripple/paper-ripple.html">
<link rel="import" href="/resources/polymer/paper-dropdown/paper-dropdown.html">
<link rel="import" href="/resources/polymer/paper-shadow/paper-shadow.html">
<link rel="import" href="/resources/polymer/core-tooltip/core-tooltip.html">
<link rel="import" href="/resources/polymer/core-icon-button/core-icon-button.html">
<link rel="import" href="/tg-web-app/tg-app-config.html">
<link rel="import" href="/tg-reflector">
<link rel="import" href="/resources/components/moment-component.html">
<link rel="import" href="/resources/egi/tg-secondary-action-button.html">
<link rel="import" href="/resources/actions/tg-page-action.html">
<link rel="import" href="/resources/actions/tg-ui-action.html">
<link rel="import" href="/resources/polymer/paper-dialog/paper-action-dialog.html">
<link rel="import" href="/resources/element_loader/load-element.html">
<link rel="import" href="/resources/polymer/core-icons/editor-icons.html">
<link rel="import" href="/resources/layout/tg-flex-layout.html">

<polymer-element name="tg-entity-grid-inspector" attributes="entityType entities renderingHints desktopLayoutShort desktopLayoutLong tabletLayoutShort tabletLayoutLong mobileLayoutShort mobileLayoutLong">
    <template>
        <link rel="stylesheet" href="/resources/egi/tg-entity-grid-inspector.css">
        <content id="column_selector" select="tg-property-column" hidden></content>
        <content id="primary_action_selector" select=".primary-action" hidden></content>
        <content id="secondary_action_selector" select=".secondary-action" hidden></content>
        <tg-app-config id="appConfig"></tg-app-config>
        <tg-reflector id="reflector"></tg-reflector>
        <core-media-query query="max-width: {{$.appConfig.minTabletWidth - 1}}px" querymatches="{{mobileScreen}}"></core-media-query>
        <core-media-query query="(min-width: {{$.appConfig.minTabletWidth}}px) and (max-width: {{$.appConfig.minDesktopWidth - 1}}px)" querymatches="{{tabletScreen}}"></core-media-query>
        <core-media-query query="min-width: {{$.appConfig.minDesktopWidth}}px" querymatches="{{desktopScreen}}"></core-media-query>

        <paper-ripple id="ripple" class="circle recenteringTouch" style="pointer-events: none;" on-core-transitionend="{{onRippleFinished}}" fit></paper-ripple>


        <!--The template of dialog for tg-ui-action-->
        <paper-action-dialog id="entityMaster" on-core-overlay-open-completed="{{dialogOpened}}" backdrop autoCloseDisabled>
            <load-element id="loadMaster" on-after-load="{{afterMasterLoad}}"></load-element>
            <paper-button affirmative autofocus>Ok</paper-button>
        </paper-action-dialog>

        <!--The template for total's dialog.-->
        <paper-action-dialog id="totalsDialog" backdrop>
            Here should be a totals.
        </paper-action-dialog>

        <!--Toolbar template-->
        <div layout horizontal?="{{desktopScreen}}" vertical?="{{!desktopScreen}}" justified?="{{desktopScreen}}" start-justified?="{{!desktopScreen}}" style="{{!desktopScreen ? 'padding: 0 10px;' : ''}}">
            <div layout horizontal>
                <content select=".entity-specific-action"></content>
            </div>
            <div layout horizontal start-justified center>
                <div class="selection-column" hidden?="{{desktopScreen}}">
                    <core-tooltip position="bottom" class="delayed">
                        <paper-checkbox checked="{{selectAll}}" on-core-change="{{onAllSelectionChanged}}"></paper-checkbox>
                        <span class="span-tooltip" tip>{{selectAll ? 'Unselect': 'Select'}} all entities</span>
                    </core-tooltip>
                </div>
                <core-tooltip class="delayed" tabIndex="-1" hidden?="{{desktopScreen}}">
                    <tg-page-action icon="editor:functions" action="{{show}}"></tg-page-action>
                    <span class="span-tooltip" tip>Show totals</span>
                </core-tooltip>
                <content select=".standart-action"></content>
            </div>
        </div>

        <div hidden?="{{!desktopScreen}}">

            <table>
                <thead>
                    <tr class="header">
                        <th class="selection-column">
                            <core-tooltip position="bottom" class="delayed" style="width:100%">
                                <paper-checkbox checked="{{selectAll}}" on-core-change="{{onAllSelectionChanged}}"></paper-checkbox>
                                <span class="span-tooltip" tip>{{selectAll ? 'Unselect': 'Select'}} all entities</span>
                            </core-tooltip>
                        </th>
                        <template if="{{primaryAction}}">
                            <th class="action-column"></th>
                        </template>
                        <template repeat="{{column, columnIndex in columns}}">
                            <th class="data-column" style="{{columnIndex===0?'padding-left:10px;' : ''}}{{columnIndex===columns.length-1?'padding-right:10px;' : ''}}width: {{column.width}}" align="left">
                                <core-tooltip position="bottom" class="delayed" style="width:100%">
                                    {{column.columnTitle}}
                                    <span class="span-tooltip" tip>{{column.columnDesc}}</span>
                                </core-tooltip>
                            </th>
                        </template>
                        <template if="{{secondaryActions.length > 0 }}">
                            <th class="action-column"></th>
                        </template>
                    </tr>
                </thead>
                <tbody>
                    <template repeat="{{entity, entityIndex in entities}}">
                        <tr selected?="{{selectionModel[entityIndex]}}">

                            <td class="selection-column">
                                <core-tooltip position="bottom" class="delayed" style="width:100%">
                                    <paper-checkbox index="{{entityIndex}}" checked?="{{selectionModel[entityIndex]}}" on-core-change="{{onSelectionChanged}}"></paper-checkbox>
                                    <span class="span-tooltip" tip>{{selectionModel[entityIndex] ? 'Unselect': 'Select'}} this entity</span>
                                </core-tooltip>
                            </td>
                            <template if="{{primaryAction}}">
                                <td class="action-column">
                                    <tg-page-action icon="{{primaryAction.icon}}" action="{{primaryAction.action}}" context="{{entity}}" hidden?="{{!primaryAction.action}}"></tg-page-action>
                                    <tg-ui-action currentEntity="{{entity}}" hidden?="{{primaryAction.action}}" user="{{primaryAction.user}}" shortDesc="{{primaryAction.shortDesc}}" longDesc="{{primaryAction.longDesc}}" icon="{{primaryAction.icon}}" componentUri="{{primaryAction.componentUri}}" elementName="{{primaryAction.elementName}}" attrs="{{primaryAction.attrs}}" createContextHolder="{{primaryAction.createContextHolder}}" requireSelectionCriteria="{{primaryAction.requireSelectionCriteria}}" requireSelectedEntities="{{primaryAction.requireSelectedEntities}}" requireMasterEntity="{{primaryAction.requireMasterEntity}}" preAction="{{primaryAction.preAction}}" postActionSuccess="{{primaryAction.postActionSuccess}}" postActionError="{{primaryAction.postActionError}}"></tg-ui-action>
                                </td>
                            </template>
                            <template repeat="{{column, columnIndex in columns}}">
                                <td class="data-column" style="{{columnIndex===0?'padding-left:10px;' : ''}}{{columnIndex===columns.length-1?'padding-right:10px;' : ''}}width: {{column.width}}" entityInd="{{entityIndex}}" columnInd="{{columnIndex}}" on-tap="{{tapAction}}" relative>
                                    <div style="opacity: 0.3; {{renderingHints[entityIndex][column.property] | styleObject}}" fit>
                                    </div>
                                    <core-tooltip position="bottom" class="delayed" style="width:100%">
                                        <template if="{{column.type === 'Boolean' && get(entity, column) !== null}}">
                                            <core-icon icon="{{get(entity, column) ? 'check' : 'clear'}}"></core-icon>
                                        </template>
                                        <template if="{{column.type !== 'Boolean'}}">
                                            <div class="truncate" style="width: {{column.width}}">{{getValue(entity, column)}}</div>
                                        </template>
                                        <span class="span-tooltip" tip>{{getTooltip(entity, column)}}</span>
                                    </core-tooltip>
                                </td>
                            </template>
                            <template if="{{secondaryActions.length > 0}}">
                                <td class="action-column" style="position: relative">
                                    <template if="{{secondaryActions.length === 1}}">
                                        <tg-page-action icon="{{secondaryActions[0].icon}}" action="{{secondaryActions[0].action}}" context="{{entity}}" hidden?="{{!secondaryActions[0].action}}"></tg-page-action>
                                        <tg-ui-action hidden?="{{secondaryActions[0].action}}" currentEntity="{{entity}}" user="{{secondaryActions[0].user}}" shortDesc="{{secondaryActions[0].shortDesc}}" longDesc="{{secondaryActions[0].longDesc}}" icon="{{secondaryActions[0].icon}}" componentUri="{{secondaryActions[0].componentUri}}" elementName="{{secondaryActions[0].elementName}}" attrs="{{secondaryActions[0].attrs}}" createContextHolder="{{secondaryActions[0].createContextHolder}}" requireSelectionCriteria="{{secondaryActions[0].requireSelectionCriteria}}" requireSelectedEntities="{{secondaryActions[0].requireSelectedEntities}}" requireMasterEntity="{{secondaryActions[0].requireMasterEntity}}" preAction="{{secondaryActions[0].preAction}}" postActionSuccess="{{secondaryActions[0].postActionSuccess}}" postActionError="{{secondaryActions[0].postActionError}}"></tg-ui-action>
                                    </template>
                                    <template if="{{secondaryActions.length > 1}}">
                                        <tg-secondary-action-button currentEntity="{{entity}}" actions="{{secondaryActions}}"></tg-secondary-action-button>
                                    </template>
                                </td>
                            </template>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
        <div hidden?="{{desktopScreen}}">
            <template repeat="{{entity, entityIndex in entities}}">
                <paper-shadow z="1" class="card" layout vertical>
                    <div class="header" layout horizontal center>
                        <div class="selection-column">
                            <core-tooltip position="bottom" class="delayed" style="width:100%">
                                <paper-checkbox index="{{entityIndex}}" checked?="{{selectionModel[entityIndex]}}" on-core-change="{{onSelectionChanged}}"></paper-checkbox>
                                <span class="span-tooltip" tip>{{selectionModel[entityIndex] ? 'Unselect': 'Select'}} this entity</span>
                            </core-tooltip>
                        </div>
                        <div class="data-column truncate" style="padding-left:0">{{generateEntityTitle(entity, entityIndex)}}</div>
                    </div>
                    <div selected?="{{selectionModel[entityIndex]}}">
                        <tg-flex-layout whenTablet="{{narrowLayout}}" whenMobile="{{narrowLayout}}">
                            <template repeat="{{column, columnIndex in columns}}">
                                <div class="data-column" layout vertical>
                                    <core-tooltip position="bottom" class="delayed" style="width:100%">
                                        <div class="data-label truncate">{{column.columnTitle}}</div>
                                        <span class="span-tooltip" tip>{{column.columnDesc}}</span>
                                    </core-tooltip>
                                    <div class="data-value" relative entityInd="{{entityIndex}}" columnInd="{{columnIndex}}" on-tap="{{tapAction}}">
                                        <div style="opacity: 0.3; {{renderingHints[entityIndex][column.property] | styleObject}}" fit>
                                        </div>
                                        <core-tooltip position="bottom" class="delayed" style="width:100%">
                                            <div hidden?="{{column.type !== 'Boolean' || get(entity, column) === null}}">
                                                <core-icon icon="{{get(entity, column) ? 'check' : 'clear'}}"></core-icon>
                                            </div>
                                            <div hidden?="{{column.type === 'Boolean'}}">
                                                <div class="truncate">{{getValue(entity, column)}}</div>
                                            </div>
                                            <span class="span-tooltip" tip>{{getTooltip(entity, column)}}</span>
                                        </core-tooltip>
                                    </div>
                                </div>
                            </template>
                        </tg-flex-layout>
                    </div>
                    <div class="header" hidden?="{{!primaryAction && secondaryActions.length === 0}}" layout horizontal justified?="{{primaryAction}}" end-justified?="{{!primaryAction}}" center>
                        <div hidden?="{{!primaryAction}}">
                            <tg-page-action icon="{{primaryAction.icon}}" action="{{primaryAction.action}}" context="{{entity}}" hidden?="{{!primaryAction.action}}"></tg-page-action>
                            <tg-ui-action currentEntity="{{entity}}" hidden?="{{primaryAction.action}}" user="{{primaryAction.user}}" shortDesc="{{primaryAction.shortDesc}}" longDesc="{{primaryAction.longDesc}}" icon="{{primaryAction.icon}}" componentUri="{{primaryAction.componentUri}}" elementName="{{primaryAction.elementName}}" attrs="{{primaryAction.attrs}}" createContextHolder="{{primaryAction.createContextHolder}}" requireSelectionCriteria="{{primaryAction.requireSelectionCriteria}}" requireSelectedEntities="{{primaryAction.requireSelectedEntities}}" requireMasterEntity="{{primaryAction.requireMasterEntity}}" preAction="{{primaryAction.preAction}}" postActionSuccess="{{primaryAction.postActionSuccess}}" postActionError="{{primaryAction.postActionError}}"></tg-ui-action>
                        </div>
                        <div hidden?="{{secondaryActions.length === 0}}">
                            <div hidden?="{{secondaryActions.length > 1}}">
                                <tg-page-action icon="{{secondaryActions[0].icon}}" action="{{secondaryActions[0].action}}" context="{{entity}}" hidden?="{{!secondaryActions[0].action}}"></tg-page-action>
                                <tg-ui-action hidden?="{{secondaryActions[0].action}}" currentEntity="{{entity}}" user="{{secondaryActions[0].user}}" shortDesc="{{secondaryActions[0].shortDesc}}" longDesc="{{secondaryActions[0].longDesc}}" icon="{{secondaryActions[0].icon}}" componentUri="{{secondaryActions[0].componentUri}}" elementName="{{secondaryActions[0].elementName}}" attrs="{{secondaryActions[0].attrs}}" createContextHolder="{{secondaryActions[0].createContextHolder}}" requireSelectionCriteria="{{secondaryActions[0].requireSelectionCriteria}}" requireSelectedEntities="{{secondaryActions[0].requireSelectedEntities}}" requireMasterEntity="{{secondaryActions[0].requireMasterEntity}}" preAction="{{secondaryActions[0].preAction}}" postActionSuccess="{{secondaryActions[0].postActionSuccess}}" postActionError="{{secondaryActions[0].postActionError}}"></tg-ui-action>
                            </div>
                            <div hidden?="{{secondaryActions.length === 1}}">
                                <tg-secondary-action-button currentEntity="{{entity}}" actions="{{secondaryActions}}"></tg-secondary-action-button>
                            </div>
                        </div>
                    </div>
                </paper-shadow>
            </template>
        </div>
    </template>
    <script>
        (function () {
            var areEqual = function (a, b) {
                    return a.id === b.id;
                },
                hasEntity = function (entity, entities) {
                    var i = 0;
                    for (i = 0; i < entities.length; i += 1) {
                        if (areEqual(entity, entities[i])) {
                            return true;
                        }
                    }
                    return false;
                },
                findEntity = function (entity, entities) {
                    var i = 0;
                    for (i = 0; i < entities.length; i += 1) {
                        if (areEqual(entity, entities[i])) {
                            return i;
                        }
                    }
                    return -1;
                },
                getColumnsForLayout = function (layout, columns) {
                    var layoutElements = countElementsForLayout(layout);
                    if (layoutElements <= columns.length) {
                        return columns.slice(0, layoutElements);
                    } else {
                        throw "The layout has specified to many elements. Th layout has " + layoutElements + " elements. But the actula number of elements is " + columns.length;
                    }
                },
                countElementsForLayout = function (layout) {
                    var elementCount = 0;
                    if (Array.isArray(layout)) {
                        layout.forEach(function (element) {
                            elementCount += countElementsForLayout(element);
                        });
                        elementCount = elementCount === 0 ? 1 : elementCount;
                    }
                    return elementCount;
                };

            Polymer({
                eventDelegates: {
                    'load-dialog-view': 'loadDialog',
                    'layout-finished': 'showDialog'
                },
                ready: function () {
                    //Initialising the action runner
                    this.currentActionRunning = null;

                    //Initialising the selection model.
                    this.selectionModel = [];
                    this.selectedEntities = [];

                    //Initialising columns (property column mappings)
                    this.columns = [];
                    Array.prototype.forEach.call(this.$.column_selector.getDistributedNodes(), function (item) {
                        this.columns.push(item);
                    }.bind(this));

                    //Initialising the primary action.
                    this.primaryAction = null;
                    this.primaryAction = this.$.primary_action_selector.getDistributedNodes().length > 0 ? this.$.primary_action_selector.getDistributedNodes()[0] : null;

                    //Initialising the secondary actions' list.
                    this.secondaryActions = [];
                    Array.prototype.forEach.call(this.$.secondary_action_selector.getDistributedNodes(), function (item) {
                        this.secondaryActions.push(item);
                    }.bind(this));

                    //Initialising the layout for desktop view.
                    if (this.desktopLayoutShort) {
                        this.desktopShortColumns = getColumnsForLayout(this.desktopLayoutShort, this.columns);
                        if (this.desktopShortColumns.length < this.columns.length) {
                            this.desktopLongColumns = this.columns.slice(this.desktopShortColumns.length);
                        }
                    }

                    //Initialising the default layout for narrow layout.
                    this.narrowLayout = ['start-justified'];
                    this.columns.forEach(function (elem, index) {
                        var layoutElem;
                        if (index % 2 === 0) {
                            layoutElem = ['justified'];
                            if (index >= 4) {
                                layoutElem.push('hidden');
                            }
                            layoutElem.push(['flex'])
                            this.narrowLayout.push(layoutElem);
                        } else {
                            this.narrowLayout[Math.ceil(index / 2)].push(['flex']);
                        }
                    }.bind(this));
                },
                generateEntityTitle: function (entity) {
                    var keyString = "";
                    if (entity.type().isCompositeEntity() || entity.get("key") instanceof this.$.reflector.getEntityType()) {
                        if (entity.get("desc")) {
                            keyString = entity.get("desc");
                        }
                    } else {
                        keyString += (entity.get("key") ? entity.get("key") : "");
                        keyString += (keyString.length === 0 ? "" : " : ") + (entity.get("desc") ? entity.get("desc") : "");
                    }
                    return keyString.length === 0 ? (entity.type()._notEnhancedSimpleClassName() + " #" + (findEntity(entity, this.entities) + 1).toString()) : keyString;
                },
                getTooltip: function (entity, column) {
                    if (this.$.reflector.findTypeByName(column.type)) {
                        return entity.get(column.property === '' ? "desc" : (column.property + ".desc"));
                    } else {
                        return this.getValue(entity, column);
                    }
                },
                get: function (entity, column) {
                    return entity.get(column.property);
                },
                getValue: function (entity, column) {
                    if (this.get(entity, column) === null) {
                        return "";
                    } else if (this.$.reflector.findTypeByName(column.type)) {
                        return this.$.reflector.convert(this.get(entity, column));
                    } else if (column.type === 'Date') {
                        return moment(entity.get(column.property)).format("L LT");
                    } else if (typeof entity.get(column.property) === 'number') {
                        return entity.get(column.property).toLocaleString(this.$.appConfig.locale);
                    } else {
                        return entity.get(column.property);
                    }
                },
                onAllSelectionChanged: function (e, detail, source) {
                    var i = 0;
                    for (i = 0; i < this.selectionModel.length; i += 1) {
                        this.selectionModel[i] = source.checked;
                    }
                },
                onSelectionChanged: function (e, detail, source) {
                    var index = +source.getAttribute("index");
                    if (source.checked) {
                        if ( /*!hasEntity(this.entities[index], this.selectedEntities)*/ this.selectedEntities.indexOf(this.entities[index]) < 0) {
                            this.selectedEntities.push(this.entities[index]);
                            this.selectionModel[index] = true;
                        }
                    } else {
                        if ( /*hasEntity(this.entities[index], this.selectedEntities)*/ this.selectedEntities.indexOf(this.entities[index]) >= 0) {
                            this.selectedEntities.splice(this.selectedEntities.indexOf(this.entities[index]), 1);
                            this.selectionModel[index] = false;
                        }
                    }
                    console.log("onSelectionChanged: rows=", this.getSelectedRows(), "SelectedEntities=", this.getSelectedEntities(), "selectionModel=", this.selectionModel);
                },
                getSelectedEntities: function () {
                    var currentSelectedEntities = [];
                    this.selectionModel.forEach(function (elem, elemIndex) {
                        if (elem) {
                            currentSelectedEntities.push(this.entities[elemIndex]);
                        }
                    }.bind(this));
                    return currentSelectedEntities;
                },
                getAllSelectedEntities: function () {
                    return this.selectedEntities;
                },
                getSelectedRows: function () {
                    var selectedRows = [];
                    this.selectionModel.forEach(function (elem, elemIndex) {
                        if (elem) {
                            selectedRows.push(elemIndex);
                        }
                    }.bind(this));
                    return selectedRows;
                },
                entitiesChanged: function (oldValue, newValue) {
                    console.log("entities changed");
                    newValue.forEach(function (entity) {
                        var entInd = findEntity(entity, this.selectedEntities);
                        if (entInd > -1) {
                            this.selectedEntities[entInd] = entity;
                        }
                    }.bind(this));
                    this.selectionModel = [];
                    newValue.forEach(function (entity) {
                        this.selectionModel.push(this.selectedEntities.indexOf(entity) > -1);
                    }.bind(this));
                },
                clearSelection: function () {
                    this.selectionModel = [];
                    this.selectedEntities = [];
                },
                tapAction: function (e, detail, source) {
                    // attach the ripple component to the found TD
                    this.$.ripple.setAttribute("entityInd", source.getAttribute("entityInd"));
                    this.$.ripple.setAttribute("columnInd", source.getAttribute("columnInd"));
                    source.appendChild(this.$.ripple);

                    // initiate riple with an immediate upAction to make sure the ripple completes
                    this.$.ripple.downAction(e);
                    this.$.ripple.upAction();
                },

                onRippleFinished: function (e, detail, source) {
                    var columnIndex = +source.getAttribute("columnInd"),
                        entity = this.entities[+source.getAttribute("entityInd")],
                        dotNotatedName = this.columns[columnIndex].property;
                    this.tap(entity, dotNotatedName, this.columns[columnIndex]);
                },

                /**
                 * Determines whether the specified object represents the entity.
                 */
                _isEntity: function (obj) {
                    return obj !== null && (obj instanceof this.$.reflector.getEntityType());
                },

                tap: function (entity, property, column) {
                    var value = entity.get(property);
                    if (this._isEntity(value)) {
                        column.runAction(value);
                    } else if (property.indexOf(".") > -1) {
                        this.tap(entity, property.substring(0, property.lastIndexOf(".")), column);
                    } else {
                        column.runAction(entity);
                    }
                },

                /**
                 * Replaces the entitiesThatShouldBeUpdated with the updated ones (and their rendering hints).
                 *
                 * Please note, that if some entity from entitiesThatShouldBeUpdated does not exists in updatedEntities list
                 *   -- it will be removed from result-set.
                 */
                replaceUpdatedEntities: function (updatedEntities, updatedRenderingHints, entitiesThatShouldBeUpdated) {
                    var newEntities = this.entities.slice(); // array copy (shallow)
                    var newRenderingHints = this.renderingHints.slice(); // array copy (shallow)
                    for (var i = 0; i < updatedEntities.length; i = i + 1) {
                        var updatedEntity = updatedEntities[i];
                        var updatedEntityRenderingHints = updatedRenderingHints[i];
                        // console.log("updated", updatedEntity, updatedEntityRenderingHints);
                        var entityIndex = findEntity(updatedEntity, newEntities);
                        if (entityIndex !== -1) {
                            newEntities[entityIndex] = updatedEntity; // replace old entity with updated one
                            newRenderingHints[entityIndex] = updatedEntityRenderingHints; // replace also its rendering hints
                        } else {
                            // this is the case when the updateEntity was not present in result-set, but should become present. Adds it into the beginning of the list
                            newEntities.unshift(updatedEntity);
                            newRenderingHints.unshift(updatedEntityRenderingHints);
                        }
                    }
                    // need to remove all entities that should be updated, but have not been returned in 'updatedEntities' list (it means they have dissapeared from result-set after modification)
                    for (var j = 0; j < entitiesThatShouldBeUpdated.length; j = j + 1) {
                        var entityThatShouldBeUpdated = entitiesThatShouldBeUpdated[j];
                        if (!hasEntity(entityThatShouldBeUpdated, updatedEntities)) {
                            var index = findEntity(entityThatShouldBeUpdated, newEntities);

                            newEntities.splice(index, 1); // remove the entity
                            newRenderingHints.splice(index, 1); // and its rendering hints
                        }
                    }

                    this.entities = newEntities;
                    this.renderingHints = newRenderingHints;
                },

                loadDialog: function (e) {
                    if (!this.currentRunningAction) {
                        this.currentRunningAction = e.detail;
                        this.$.loadMaster.import = this.currentRunningAction.componentUri;
                        this.$.loadMaster.elementName = this.currentRunningAction.elementName;
                        this.$.loadMaster.attrs = this.currentRunningAction.attrs;
                        this.$.loadMaster.reload();
                    }

                },
                showDialog: function (e) {
                    if (this.currentRunningAction && this.currentRunningAction.masterComponent.noUI === false) {
                        this.$.entityMaster.open();
                    }
                },
                afterMasterLoad: function (e, detail, source) {
                    if (this.currentRunningAction) {
                        this.currentRunningAction._onExecuted(e, detail, source);
                        if (this.currentRunningAction.masterComponent.noUI === true) {
                            this.currentRunningAction = null;
                        }
                    }
                },
                dialogOpened: function (e, detail, source) {
                    this.currentRunningAction = null;
                }
            });
        })();
    </script>
</polymer-element>