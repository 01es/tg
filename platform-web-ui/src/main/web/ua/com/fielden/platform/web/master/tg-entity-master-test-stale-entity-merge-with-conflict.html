<!doctype html>
<html>

<head>
    <title>entity-master</title>

    <script src="/resources/polymer/webcomponentsjs/webcomponents.js"></script>
    <link rel="import" href="/resources/polymer/polymer-test-tools/tools.html">
    <script src="/resources/polymer/polymer-test-tools/htmltest.js"></script>

    <link rel="import" href="/resources/master/tg-entity-master.html">
</head>

<body unresolved>
    <tg-entity-master id="master" entitytype="ua.com.fielden.platform.sample.domain.TgPersistentEntityWithProperties" entityid="13"></tg-entity-master>

    <script>
        document.addEventListener('polymer-ready', function() {
            var master = document.querySelector('#master');
            var self = this;

            master.postValidated = function(validatedEntity, bindingEntity, customObject) {                
                assert.strictEqual(validatedEntity.version, 1, "Entity version should be increased.");

                ////////////////////////////////////////// CHECK CONFLICTING PROP //////////////////////////////////////////
                // value ok?
                assert.ok(validatedEntity.get("conflictingProp"), "Property value should be initialised.");                
                assert.strictEqual(validatedEntity.get("conflictingProp"), "persistently modified", "Property value should be correct.");

                // value is changed?
                assert.strictEqual(validatedEntity.prop("conflictingProp").isChangedFromOriginal(), false, "Instance meta-prop should be changedFromOriginal.");

                // value validationresult?
                assert.ok(validatedEntity.prop("conflictingProp").validationResult(), "Instance meta-prop should have non-empty (unsuccessful) validation result.");
                assert.strictEqual(validatedEntity.prop("conflictingProp").validationResult()["@resultType"], "ua.com.fielden.platform.error.Result");
                assert.strictEqual(validatedEntity.prop("conflictingProp").validationResult().message, "The property has been recently changed by other user. Please revert property value to resolve conflict.");

                // binding value ok?
                assert.ok(bindingEntity.get("conflictingProp"), "Binding property should be initialised.");                
                assert.strictEqual(bindingEntity.get("conflictingProp"), "modified", "Binding property should be correct number.");

                done();
            };

            master.onPreRetrieved = function(entity) {
                entity.version = 0;
                entity.set("conflictingProp", "initial");
                return entity;
            };

            master.onRetrieved = function(entity, bindingEntity, customObject) {
                assert.strictEqual(entity.version, 0, "Entity version should be original.");

                ////////////////////////////////////////// CHECK CONFLICTING PROP //////////////////////////////////////////
                // value ok?
                assert.ok(entity.get("conflictingProp"), "Property value should be initialised.");                
                assert.strictEqual(entity.get("conflictingProp"), "initial", "Property value should be correct.");

                // value is changed?
                assert.strictEqual(entity.prop("conflictingProp").isChangedFromOriginal(), false, "Instance meta-prop should be not changedFromOriginal.");

                // value validationresult?
                assert.strictEqual(entity.prop("conflictingProp").validationResult(), null, "Instance meta-prop should have empty (successful) validation result.");

                // binding value ok?
                assert.ok(bindingEntity.get("conflictingProp"), "Binding property should be initialised.");                
                assert.strictEqual(bindingEntity.get("conflictingProp"), "initial", "Binding property should be string entity representation.");
                
                // ACTUAL PROPERTY CHANGE                
                bindingEntity.set("conflictingProp", "modified");

                master.validate(); 
            };

            master.retrieve();
        });
    </script>

</body>

</html>
