<link rel="import" href="/resources/polymer/polymer/polymer.html">
<link rel="import" href="/resources/polymer/core-animated-pages/core-animated-pages.html">
<link rel="import" href="/resources/polymer/core-animated-pages/transitions/slide-from-right.html">
<link rel="import" href="/resources/centre/tg-selection-criteria.html">
<link rel="import" href="/resources/centre/tg-entity-centre.html">
<link rel="import" href="/resources/egi/tg-entity-grid-inspector.html">
<link rel="import" href="/resources/egi/tg-property-column.html">
<link rel="import" href="/resources/egi/tg-primary-instance-action.html">
<link rel="import" href="/resources/egi/tg-secondary-instance-action.html">
<link rel="import" href="/resources/polymer/core-icon-button/core-icon-button.html">
<link rel="import" href="/resources/polymer/core-tooltip/core-tooltip.html">
<link rel="import" href="/resources/polymer/core-icons/core-icons.html">
<link rel="import" href="/resources/polymer/core-icons/editor-icons.html">
<link rel="import" href="/resources/polymer/core-icons/hardware-icons.html">
<link rel="import" href="/resources/polymer/paper-button/paper-button.html">
<link rel="import" href="/resources/layout/tg-flex-layout.html">

<link rel="import" href="/resources/editors/tg-singleline-text-editor.html">
<link rel="import" href="/resources/editors/tg-integer-editor.html">
<link rel="import" href="/resources/editors/tg-decimal-editor.html">
<link rel="import" href="/resources/editors/tg-boolean-editor.html">
<link rel="import" href="/resources/editors/tg-datetime-picker.html">
<link rel="import" href="/resources/editors/tg-entity-editor.html">
<link rel="import" href="/resources/editors/tg-entity-search-criteria.html">

<link rel="import" href="/resources/centre/criterion/tg-criterion.html">
<link rel="import" href="/resources/centre/criterion/tg-boolean-criterion.html">
<link rel="import" href="/resources/centre/criterion/tg-range-criterion.html">
<link rel="import" href="/resources/centre/criterion/tg-date-range-criterion.html">

<link rel="import" href="/resources/actions/tg-page-action.html">

<polymer-element name="tg-selection-criteria-for-TgPersistentEntityWithProperties" extends="tg-selection-criteria">
    <template>
        <shadow></shadow>
        <tg-flex-layout whenDesktop="{{whenDesktop}}" whenTablet="{{whenTablet}}" whenMobile="{{whenMobile}}">
            <tg-criterion orNull="{{propertyModel[''].orNull}}" not="{{propertyModel[''].not}}" onAcceptedValueChanged="{{validate}}">
                <tg-entity-search-criteria entity="{{currBindingEntity}}" user="{{user}}" entityType="{{entitytype}}" propertyName="tgPersistentEntityWithProperties_" onAcceptedValueChanged="{{validate}}" propTitle="Key prop MULTI" propDesc="Key prop MULTI criteria editor" currentState="{{currentState}}" action="{{actions['SNATCH_BACK_VEHICLE']}}" externalRefreshCycle="{{refreshCycleMode}}" createModifiedPropertiesHolder="{{createModifiedPropertiesHolder}}"></tg-entity-search-criteria>
            </tg-criterion>

            <tg-criterion orNull="{{propertyModel['desc'].orNull}}" not="{{propertyModel['desc'].not}}" onAcceptedValueChanged="{{validate}}">
                <tg-singleline-text-editor entity="{{currBindingEntity}}" propertyName="tgPersistentEntityWithProperties_desc" onAcceptedValueChanged="{{validate}}" propTitle="Desc MULTI" propDesc="Desc MULTI criteria editor" currentState="{{currentState}}" externalRefreshCycle="{{refreshCycleMode}}"></tg-singleline-text-editor>
            </tg-criterion>

            <tg-range-criterion orNull="{{propertyModel['integerProp'].orNull}}" not="{{propertyModel['integerProp'].not}}" exclusive="{{propertyModel['integerProp'].exclusive}}" exclusive2="{{propertyModel['integerProp'].exclusive2}}" onAcceptedValueChanged="{{validate}}">
                <tg-integer-editor entity="{{currBindingEntity}}" propertyName="tgPersistentEntityWithProperties_integerProp_from" onAcceptedValueChanged="{{validate}}" propTitle="Integer prop FROM" propDesc="Integer prop FROM criteria editor" currentState="{{currentState}}" externalRefreshCycle="{{refreshCycleMode}}"></tg-integer-editor>
                <tg-integer-editor entity="{{currBindingEntity}}" propertyName="tgPersistentEntityWithProperties_integerProp_to" onAcceptedValueChanged="{{validate}}" propTitle="Integer prop TO" propDesc="Integer prop TO criteria editor" currentState="{{currentState}}" externalRefreshCycle="{{refreshCycleMode}}"></tg-integer-editor>
            </tg-range-criterion>

            <tg-criterion orNull="{{propertyModel['entityProp'].orNull}}" not="{{propertyModel['entityProp'].not}}" onAcceptedValueChanged="{{validate}}">
                <tg-entity-search-criteria entity="{{currBindingEntity}}" user="{{user}}" entityType="{{entitytype}}" propertyName="tgPersistentEntityWithProperties_entityProp" onAcceptedValueChanged="{{validate}}" propTitle="Entity prop MULTI" propDesc="Entity prop MULTI criteria editor" currentState="{{currentState}}" action="{{actions['SNATCH_BACK_VEHICLE']}}" externalRefreshCycle="{{refreshCycleMode}}" createModifiedPropertiesHolder="{{createModifiedPropertiesHolder}}"></tg-entity-search-criteria>
            </tg-criterion>

            <tg-range-criterion orNull="{{propertyModel['bigDecimalProp'].orNull}}" not="{{propertyModel['bigDecimalProp'].not}}" exclusive="{{propertyModel['bigDecimalProp'].exclusive}}" exclusive2="{{propertyModel['bigDecimalProp'].exclusive2}}" onAcceptedValueChanged="{{validate}}">
                <tg-decimal-editor entity="{{currBindingEntity}}" propertyName="tgPersistentEntityWithProperties_bigDecimalProp_from" onAcceptedValueChanged="{{validate}}" propTitle="BigDecimal prop FROM" propDesc="BigDecimal prop FROM criteria editor" currentState="{{currentState}}" externalRefreshCycle="{{refreshCycleMode}}"></tg-decimal-editor>
                <tg-decimal-editor entity="{{currBindingEntity}}" propertyName="tgPersistentEntityWithProperties_bigDecimalProp_to" onAcceptedValueChanged="{{validate}}" propTitle="BigDecimal prop TO" propDesc="BigDecimal prop TO criteria editor" currentState="{{currentState}}" externalRefreshCycle="{{refreshCycleMode}}"></tg-decimal-editor>
            </tg-range-criterion>

            <tg-boolean-criterion orNull="{{propertyModel['booleanProp'].orNull}}" not="{{propertyModel['booleanProp'].not}}" onAcceptedValueChanged="{{validate}}">
                <tg-boolean-editor entity="{{currBindingEntity}}" propertyName="tgPersistentEntityWithProperties_booleanProp_is" onAcceptedValueChanged="{{validate}}" propTitle="Boolean prop IS" propDesc="Boolean prop IS criteria editor" currentState="{{currentState}}" externalRefreshCycle="{{refreshCycleMode}}"></tg-boolean-editor>
                <tg-boolean-editor entity="{{currBindingEntity}}" propertyName="tgPersistentEntityWithProperties_booleanProp_not" onAcceptedValueChanged="{{validate}}" propTitle="Boolean prop NOT" propDesc="Boolean prop NOT criteria editor" currentState="{{currentState}}" externalRefreshCycle="{{refreshCycleMode}}"></tg-boolean-editor>
            </tg-boolean-criterion>

            <tg-date-range-criterion orNull="{{propertyModel['dateProp'].orNull}}" not="{{propertyModel['dateProp'].not}}" exclusive="{{propertyModel['dateProp'].exclusive}}" exclusive2="{{propertyModel['dateProp'].exclusive2}}" datePrefix="{{propertyModel['dateProp'].datePrefix}}" dateMnemonic="{{propertyModel['dateProp'].dateMnemonic}}" andBefore="{{propertyModel['dateProp'].andBefore}}" onAcceptedValueChanged="{{validate}}">
                <tg-datetime-picker entity="{{currBindingEntity}}" propertyName="tgPersistentEntityWithProperties_dateProp_from" onAcceptedValueChanged="{{validate}}" propTitle="Date prop FROM" propDesc="Date prop FROM criteria editor" currentState="{{currentState}}" externalRefreshCycle="{{refreshCycleMode}}"></tg-datetime-picker>
                <tg-datetime-picker entity="{{currBindingEntity}}" propertyName="tgPersistentEntityWithProperties_dateProp_to" onAcceptedValueChanged="{{validate}}" propTitle="Date prop TO" propDesc="Date prop TO criteria editor" currentState="{{currentState}}" externalRefreshCycle="{{refreshCycleMode}}"></tg-datetime-picker>
            </tg-date-range-criterion>

            <tg-criterion orNull="{{propertyModel['compositeProp'].orNull}}" not="{{propertyModel['compositeProp'].not}}" onAcceptedValueChanged="{{validate}}">
                <tg-entity-search-criteria entity="{{currBindingEntity}}" user="{{user}}" entityType="{{entitytype}}" propertyName="tgPersistentEntityWithProperties_compositeProp" onAcceptedValueChanged="{{validate}}" propTitle="Composite prop MULTI" propDesc="Composite prop MULTI criteria editor" currentState="{{currentState}}" action="{{actions['SNATCH_BACK_VEHICLE']}}" externalRefreshCycle="{{refreshCycleMode}}" createModifiedPropertiesHolder="{{createModifiedPropertiesHolder}}"></tg-entity-search-criteria>
            </tg-criterion>

            <tg-criterion orNull="{{propertyModel['critOnlyEntityProp'].orNull}}" not="{{propertyModel['critOnlyEntityProp'].not}}" onAcceptedValueChanged="{{validate}}">
                <tg-entity-editor entity="{{currBindingEntity}}" user="{{user}}" entityType="{{entitytype}}" propertyName="tgPersistentEntityWithProperties_critOnlyEntityProp" onAcceptedValueChanged="{{validate}}" propTitle="Crit-only entity prop SINGLE" propDesc="Crit-only entity prop SINGLE criteria editor" currentState="{{currentState}}" action="{{actions['SNATCH_BACK_VEHICLE']}}" externalRefreshCycle="{{refreshCycleMode}}" createModifiedPropertiesHolder="{{createModifiedPropertiesHolder}}"></tg-entity-editor>
            </tg-criterion>
            <div></div>
        </tg-flex-layout>
    </template>
    <script>
        (function () {
            var mr = ["margin-right: 40px", "flex"],
                mrLast = ['flex'];
            Polymer({
                whenDesktop: [['center-justified', mr, mr, mrLast],
                           ['center-justified', mr, mr, mrLast],
                           ['center-justified', mr, mr, mrLast]],
                whenTablet: [['center-justified', mr, mrLast],
                           ['center-justified', mr, mrLast],
                           ['center-justified', mr, mrLast],
                           ['center-justified', mr, mrLast],
                           ['center-justified', mr, mrLast]],
                whenMobile: [['center-justified', mrLast],
                           ['center-justified', mrLast],
                           ['center-justified', mrLast],
                           ['center-justified', mrLast],
                           ['center-justified', mrLast],
                           ['center-justified', mrLast],
                           ['center-justified', mrLast],
                           ['center-justified', mrLast],
                           ['center-justified', mrLast]],
            });
        })();
    </script>
</polymer-element>

<polymer-element name="tg-entity-centre-for-TgPersistentEntityWithProperties" extends="tg-entity-centre">
    <template>
        <shadow></shadow>
        <style>
            * /deep/ core-tooltip::shadow #tooltip {
                white-space: normal;
            }
            * /deep/ core-tooltip .span-tooltip {
                line-height: 15px;
            }
            core-icon-button.revers::shadow core-icon {
                transform: scale(-1, 1);
            }
            core-tooltip.delayed:hover::shadow .core-tooltip,
            core-tooltip.delayed:focus::shadow .core-tooltip {
                opacity: 1;
                -webkit-transition-delay: 1s;
                transition-delay: 1s;
                transform: translate3d(0px, 0px, 0px);
            }
        </style>
        <core-animated-pages selected="{{selectedView}}" transitions="slide-from-right">
            <div>
                <div layout vertical style="margin: 40px;">
                    <tg-selection-criteria-for-TgPersistentEntityWithProperties id="selection_criteria" user="{{user}}" mitype="ua.com.fielden.platform.sample.domain.MiTgPersistentEntityWithProperties" onRun="{{onRun}}"></tg-selection-criteria-for-TgPersistentEntityWithProperties>
                    <div layout horizontal justified style="margin-top:40px;">
                        <div layout horizontal>
                            <paper-button id="configurator" raised roll="button" on-tap="{{configure}}" style="margin-left: 0px;">Configure</paper-button>
                            <paper-button id="saver" raised roll="button" on-tap="{{save}}" disabled?="{{!canSave($.selection_criteria._isCentreChanged)}}">Save</paper-button>
                            <paper-button id="discarder" raised roll="button" on-tap="{{discard}}" disabled?="{{!canDiscard($.selection_criteria._isCentreChanged)}}">Discard</paper-button>
                        </div>
                        <paper-button id="runner" raised roll="button" on-tap="{{run}}" style="margin-right: 0px;">Run</paper-button>
                    </div>
                </div>
            </div>
            <div>
                <div layout vertical center>
                    <tg-entity-grid-inspector id="egi" entityType="ua.com.fielden.platform.sample.domain.TgPersistentEntityWithProperties">
                        <tg-property-column property="" width="80px" type="ua.com.fielden.platform.sample.domain.TgPersistentEntityWithProperties" columnTitle="Key" columnDesc="Key tooltip"></tg-property-column>
                        <tg-property-column property="desc" width="200px" type="String" columnTitle="Description" columnDesc="Description tooltip"></tg-property-column>
                        <tg-property-column property="integerProp" width="60px" type="Integer" columnTitle="Integer property" columnDesc="Integer property tooltip"></tg-property-column>
                        <tg-property-column property="bigDecimalProp" width="60px" type="BigDecimal" columnTitle="Big decimal property" columnDesc="Big decimal property tooltip"></tg-property-column>
                        <tg-property-column property="entityProp" width="100px" type="ua.com.fielden.platform.sample.domain.TgPersistentEntityWithProperties" columnTitle="Entity prop" columnDesc="Entity prop tooltip"></tg-property-column>
                        <tg-property-column property="booleanProp" width="50px" type="Boolean" columnTitle="Boolean prop" columnDesc="Boolean prop tooltip"></tg-property-column>
                        <tg-property-column property="dateProp" width="100px" type="Date" columnTitle="Date prop" columnDesc="Date prop tooltip"></tg-property-column>
                        <tg-property-column property="compositeProp" width="100px" type="ua.com.fielden.platform.sample.domain.TgPersistentCompositeEntity" columnTitle="Composite prop" columnDesc="Composite prop tooltip"></tg-property-column>
                        <tg-property-column property="stringProp" width="50px" type="String" columnTitle="String property" columnDesc="String property tooltip"></tg-property-column>

                        <core-tooltip class="delayed entity-specific-action" tabIndex="-1">
                            <!--<core-icon-button icon="add-circle-outline"></core-icon-button>-->
                            <tg-page-action icon="add-circle-outline" action="{{newAction}}"></tg-page-action>
                            <span class="span-tooltip" tip>Create new entity</span>
                        </core-tooltip>
                        <core-tooltip class="delayed entity-specific-action" tabIndex="-1">
                            <!--<tg-ui-action user="{{user}}" shortDesc="Edit" longDesc="Edit selected entity" icon="editor:mode-edit" componentUri="/users/{{user}}/master/ua.com.fielden.platform.sample.domain.TgPersistentEntityWithProperties" elementName="tg-TgPersistentEntityWithProperties-master" attrs="{{ {user:user, entitytype:'ua.com.fielden.platform.sample.domain.TgPersistentEntityWithProperties', currentState:'VIEW'} }}" contextRetriever="{{getContext}}">
                            </tg-ui-action>-->
                            <tg-page-action icon="editor:mode-edit" action="{{editAction}}"></tg-page-action>
                            <span class="span-tooltip" tip>Edit selected entity</span>
                        </core-tooltip>
                        <!-- <core-tooltip class="delayed entity-specific-action" tabIndex="-1">
                            <core-icon-button icon="editor:mode-edit"></core-icon-button>
                            <span class="span-tooltip" tip>Edit selected entity</span>
                        </core-tooltip> -->
                        <core-tooltip class="delayed entity-specific-action" tabIndex="-1">
                            <core-icon-button icon="remove-circle-outline"></core-icon-button>
                            <span class="span-tooltip" tip>Delete selected entity</span>
                        </core-tooltip>
                        <core-tooltip class="delayed standart-action" tabIndex="-1">
                            <core-icon-button icon="file-download"></core-icon-button>
                            <span class="span-tooltip" tip>Export to Excel</span>
                        </core-tooltip>
                        <core-tooltip class="delayed standart-action" tabIndex="-1">
                            <core-icon-button class="revers" icon="hardware:keyboard-tab" on-tap="{{firstPage}}" disabled?="{{canNotFirst($.selection_criteria.pageNumber, $.selection_criteria.pageCount)}}"></core-icon-button>
                            <span class="span-tooltip" tip>First page</span>
                        </core-tooltip>
                        <core-tooltip class="delayed standart-action" tabIndex="-1">
                            <core-icon-button icon="hardware:keyboard-backspace" on-tap="{{prevPage}}" disabled?="{{canNotPrev($.selection_criteria.pageNumber)}}"></core-icon-button>
                            <span class="span-tooltip" tip>Previous page</span>
                        </core-tooltip>
                        <span class="standart-action">page {{$.selection_criteria.pageNumber !== null ? ($.selection_criteria.pageNumber + 1) : 0}} of {{$.selection_criteria.pageCount !== null ? $.selection_criteria.pageCount : 0}}</span>
                        <core-tooltip class="delayed standart-action" tabIndex="-1">
                            <core-icon-button class="revers" icon="hardware:keyboard-backspace" on-tap="{{nextPage}}" disabled?="{{canNotNext($.selection_criteria.pageNumber, $.selection_criteria.pageCount)}}"></core-icon-button>
                            <span class="span-tooltip" tip>Next page</span>
                        </core-tooltip>
                        <core-tooltip class="delayed standart-action" tabIndex="-1">
                            <core-icon-button icon="hardware:keyboard-tab" on-tap="{{lastPage}}" disabled?="{{canNotLast($.selection_criteria.pageNumber, $.selection_criteria.pageCount)}}"></core-icon-button>
                            <span class="span-tooltip" tip>Last page</span>
                        </core-tooltip>
                        <core-tooltip class="delayed standart-action" tabIndex="-1">
                            <core-icon-button icon="refresh" on-tap="{{run}}"></core-icon-button>
                            <span class="span-tooltip" tip>Refresh</span>
                        </core-tooltip>
                        <tg-primary-instance-action actionDesc="action description" icon="editor:mode-edit"></tg-primary-instance-action>
                        <tg-secondary-instance-action actionDesc="action description"></tg-secondary-instance-action>
                    </tg-entity-grid-inspector>
                </div>
            </div>
        </core-animated-pages>
    </template>
    <script>
        (function () {
            Polymer({
                ready: function () {
                    var self = this;
                    
                    self.super();
                    self.editAction = self.editAction.bind(self);
                    
                    postal.subscribe({
                        channel: "centre_" + self.$.selection_criteria.uuid,
                        topic: "edit.finish.created",
                        callback: function(data, envelope) {
                            console.log("-------- Masters UUID: " + data.uuid + " ------------");
                        }
                    });
                    postal.subscribe({
                        channel: "centre_" + self.$.selection_criteria.uuid,
                        topic: "edit.finish.shown",
                        callback: function(data, envelope) {
                            console.log("-------- Masters UUID: " + data.uuid + " ------------");
                        }
                    });
                    
                },
                newAction : function () {
                    var self = this;
                    postal.publish({
                        channel: "centre",
                        topic: "new"
                    });
                },
                editAction: function () {
                    var self = this;
                    postal.publish({
                        channel: "centre",
                        topic: "edit.start",
                        data: {
                            entity: self.getContext(),
                            uuid: self.$.selection_criteria.uuid
                        }
                    });
                },
                getContext: function () {
                    if (this.$.egi.getSelectedEntities().length > 0) {
                        return this.$.egi.getSelectedEntities()[0];
                    }
                    return null;
                }
            });
        })();
    </script>
</polymer-element>