<link rel="import" href="/resources/polymer/polymer/polymer.html">

<link rel="import" href="/tg-reflector">
<link rel="import" href="/resources/layout/tg-flex-layout.html">
<link rel="import" href="/resources/components/tg-accordion.html">
<link rel="import" href="/resources/components/tg-accordion-group.html">
<link rel="import" href="/resources/polymer/core-icon-button/core-icon-button.html">
<link rel="import" href="/resources/polymer/paper-dialog/paper-action-dialog.html">
<link rel="import" href="/resources/polymer/paper-checkbox/paper-checkbox.html">
<link rel="import" href="/resources/polymer/paper-radio-button/paper-radio-button.html">
<link rel="stylesheet" href="/resources/centre/criterion/tg-criterion.css">

<polymer-element name="tg-criterion" attributes="orNull not onAcceptedValueChanged" layout horizontal end>
    <template>
        <tg-reflector id="reflector"></tg-reflector>
        <content select=":not(text)" id="components">
        </content>
        <core-icon-button on-click="{{showMetaValuesEditor}}" icon="more-vert"></core-icon-buton>
        <paper-action-dialog class="meta-value-editor" id="metaValueEditor" backdrop autoCloseDisabled>
            <div layout vertical>
                <template if="{{!_single}}">
	                <paper-checkbox label="Missing value" checked="{{_orNull}}"></paper-checkbox>
    	            <paper-checkbox label="Not" checked="{{_not}}"></paper-checkbox>
                </template>              
                <template if="{{_range}}">
                    <paper-checkbox label="Exclusive Left" checked="{{_exclusive}}"></paper-checkbox>
                    <paper-checkbox label="Exclusive Right" checked="{{_exclusive2}}"></paper-checkbox>
                </template>              
                <template if="{{_dateRange}}">
                    <tg-accordion-group singleOpen>
                        <template repeat="{{prefix, pIndex in datePrefixes}}">
                            <tg-accordion opened?="{{(_datePrefix===null && pIndex===0) || _datePrefix===prefix}}" heading="{{prefixTitles[pIndex]}}">
                                <div layout horizontal>
                                    <template repeat="{{before, bIndex in andBefores}}">
                                        <div layout vertical>
                                            <template repeat="{{mnemonic, mIndex in dateMnemonics}}">
                                                <paper-radio-button prefix="{{prefix}}" mnemonic="{{mnemonic}}" andbefore="{{before}}" toggles label="{{mnemonicTitles[mIndex] + andBeforeTitles[bIndex]}}" on-change="{{dateMetaValueChanged}}" checked?="{{_datePrefix===prefix && _dateMnemonic===mnemonic && ((_andBefore===null && before==='THIS')||(_andBefore===true && before==='BEFORE')||(_andBefore===false && before==='AFTER'))}}"></paper-radio-button> 
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </tg-accordion>
                        </template>
                    </tg-accordion-group>
                </template>   
            </div>
            <paper-button affirmative on-tap="{{cancelMetaValues}}">Cancel</paper-button>
            <paper-button affirmative autofocus on-tap="{{acceptMetaValues}}">Ok</paper-button>
        </paper-action-dialog>
    </template>
    <script>
        Polymer('tg-criterion', {
            publish: {
                /**
                 * This published property specifies whether 'missing value' will be also considered in search queries.
                 */
                orNull: false,

                /**
                 * This published property specifies whether the criterion should be negated.
                 */
                not: false,

                /**
                 * This callback should be used for custom action after the 'acceptedValue' has been changed (for e.g. validation).
                 */
                onAcceptedValueChanged: null
            },

            _orNull: false,
            _not: false,
            _range: false,
            _single: false,
            _dateRange: false, 

            ready: function() {
                var flexElement = document.createElement('tg-flex-layout');
                flexElement.whenDesktop = this.whenDesktop;
                flexElement.whenTablet = this.whenDesktop;
                flexElement.whenMobile = this.whenDesktop;

                Array.prototype.forEach.call(this.$.components.getDistributedNodes(), function (item) {
                    flexElement.appendChild(item);
                }.bind(this));
                this.appendChild(flexElement);
            },

            whenDesktop: ['horizontal', 'justified', 'flex', ['flex']],
            whenTablet: this.whenDesktop,
            whenMobile: this.whenDesktop,

            showMetaValuesEditor: function (e) {
                this.$.metaValueEditor.open();
            },
            acceptMetaValues: function() {
                this.orNull = this._orNull;
                this.not = this._not;

                this.onAcceptedValueChanged();
            },
            cancelMetaValues: function() {
                this._orNull = this.orNull;
                this._not = this.not;
            },
            orNullChanged: function(oldValue, newValue) {
                this._orNull = newValue;
            },
            notChanged: function(oldValue, newValue) {
                this._not = newValue;   
            }
        });
    </script>
</polymer-element>