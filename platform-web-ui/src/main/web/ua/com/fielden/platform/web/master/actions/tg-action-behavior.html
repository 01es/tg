<link rel="import" href="/resources/polymer/polymer/polymer.html">

<script>
	Polymer.TgBehaviors = Polymer.TgBehaviors || {};
	Polymer.TgBehaviors.TgActionBehaviorImpl = {
        properties: {
        	/////////////////////////////////////////////////////////////////////////////////////////////////////////
        	////////////////////////////////////////// EXTERNAL PROPERTIES //////////////////////////////////////////
        	/////////////////////////////////////////////////////////////////////////////////////////////////////////
        	// These mandatory properties must be specified in attributes, when constructing <tg-*-editor>s.       //
        	// No default values are allowed in this case.														   //
        	/////////////////////////////////////////////////////////////////////////////////////////////////////////
        	
            /**
             * Custom function to be invoked during run() of this action.
             */
            action: {
            	type: Function
            },
            
            /**
             * Custom function to be invoked after run() of this action has been executed.
             */
            postAction: {
            	type: Function,
            	observer: '_postActionChanged'
            },
            
            /**
             * Custom function to be invoked after run() of this action has been executed with error.
             */
            postActionError: {
            	type: Function,
            	observer: '_postActionErrorChanged'
            },
            
        	/////////////////////////////////////////////////////////////////////////////////////////////////////////
        	//////////////////////////////////////////// INNER PROPERTIES ///////////////////////////////////////////
        	/////////////////////////////////////////////////////////////////////////////////////////////////////////
        	// These properties derive from other properties and are considered as 'private' -- need to have '_'   //
        	//   prefix and default values specified in 'value' specificator of the property definition (or,       //
        	//   alternatively, computing function needs to be specified). 									       //
        	/////////////////////////////////////////////////////////////////////////////////////////////////////////
        	
            _postActionUpgraded: {
            	type: Boolean,
            	value: false
            },
            
            _postActionErrorUpgraded: {
            	type: Boolean,
            	value: false
            },
            
            /* Timer to prevent spinner from activating for quick actions. */
            _startSpinnerTimer: {
            	type: Object,
            	value: null
            },
            
        	/////////////////////////////////////////////////////////////////////////////////////////////////////////
        	//////////////////////////////// INNER PROPERTIES, THAT GOVERN CHILDREN /////////////////////////////////
        	/////////////////////////////////////////////////////////////////////////////////////////////////////////
        	// These properties derive from other properties and are considered as 'private' -- need to have '_'   //
        	//   prefix. 																				           //
        	// Also, these properties are designed to be bound to children element properties -- it is necessary to//
        	//   populate their default values in ready callback (to have these values populated in children)!     //
        	/////////////////////////////////////////////////////////////////////////////////////////////////////////
            
            /* Indicates wheather the action is in progress. */
            _isWorking: {
            	type: Boolean
            },
            
	        /**
	         * Executes the action.
	         */
	        run: {
            	type: Function,
            	value: function () {
            		return (function () {
            		    var parentFunction = Polymer.TgBehaviors.TgAbstractActionBehavior.properties.run.value.call(this);
            		    parentFunction.call(this);

                        if (this._startSpinnerTimer) {
                            clearTimeout(this._startSpinnerTimer);
                        }
                        this._startSpinnerTimer = setTimeout(this._startSpinnerCallback.bind(this), 700);

                        // start the action
                        this._isWorking = true;
                        this.action();
                    }).bind(this);
            	}
            }
        },

        ready: function () {
			this._isWorking = false;     	
        }

        /* Timer callback that performs spinner activation. */
        _startSpinnerCallback: function () {
            // Position and make spinner visible
            this.$.spinner.style.left = (this.$.actionButton.offsetWidth / 2 - this.$.spinner.offsetWidth / 2) + 'px';
            this.$.spinner.style.top = (this.$.actionButton.offsetHeight / 2 - this.$.spinner.offsetHeight / 2) + 'px';
            this.$.spinner.style.visibility = 'visible';
        },

        _postActionChanged: function (newValue, oldValue) {
            var self = this;
            // console.log("postAction changed, old = ", oldValue, newValue);
            if (newValue && !self._postActionUpgraded) {
                self.postAction = function (smth) {
                    newValue(smth);
                    self._afterExecution();
                };
                self._postActionUpgraded = true;
            }
        },
        
        _postActionErrorChanged: function (newValue, oldValue) {
            var self = this;
            // console.log("postActionError changed, old = ", oldValue, newValue);
            if (newValue && !self._postActionErrorUpgraded) {
                self.postActionError = function (smth) {
                    newValue(smth);
                    self._afterExecution();
                };
                self._postActionErrorUpgraded = true;
            }
        },

        _afterExecution: function () {
            this._isWorking = false;
            // prevent not yet activated spinner from activating if any
            if (this._startSpinnerTimer) {
                clearTimeout(this._startSpinnerTimer);
            }

            // do the super stuff
            Polymer.TgBehaviors.TgAbstractActionBehavior._afterExecution.call(this);

            // Make spinner invisible
            this.$.spinner.style.visibility = 'hidden';
        }
    };
	
	Polymer.TgBehaviors.TgActionBehavior = [
		Polymer.TgBehaviors.TgAbstractActionBehavior,
		Polymer.TgBehaviors.TgActionBehaviorImpl
	];
</script>