<link rel="import" href="/resources/polymer/polymer/polymer.html">

<link rel="import" href="/tg-reflector">
<link rel="import" href="/resources/serialisation/tg-serialiser.html">
<link rel="import" href="/resources/polymer/core-ajax/core-ajax.html">

<polymer-element name="tg-action" attributes="user entitytype preAction postActionSuccess postActionError enabledStates currentState action onAction">
    <template>
        <tg-reflector id="reflector"></tg-reflector>
        <tg-serialiser id="serialiser"></tg-serialiser>
        <core-ajax id="actionExecutor" url="/users/{{user}}/entity/{{entitytype}}/new" method="POST" handleas="json"></core-ajax>
    </template>
    <script>
        Polymer('tg-action', {
            publish: {
            	user: null,
            	entitytype: null,
                /**
                 * The function to be invoked before the action starts execution (UI actions and FE creation).
                 *
                 * returns -- created functional entity instance.
                 */
                preAction: null,

                /**
                 * The function to be invoked after successful action execution (function(entity)).
                 */
                postActionSuccess: null,

                /**
                 * The function to be invoked after unsuccessful action execution (function(resultWithError)).
                 */
                postActionError: null,

                /**
                 * A list of the states in which the action can be enabled.
                 */
                enabledStates: null,

                /**
                 * The state of the parent view.
                 */
                currentState: null
            },

            /**
             * This inner state is triggered by the action itself after the action button has been pressed (enabled:=false) and after the action
             * has been executed (enabled:=true).
             */
            enabled: true,
            onActionUpgraded: false,

            /**
             * Initialisation block.
             */
            ready: function () {
                var self = this;

                self.run = self.run.bind(self);

                self.$.actionExecutor.addEventListener('core-response', function (e) {
                    if (e.detail.xhr.status === 200) {
                        self._onExecuted(self.$.serialiser.deserialise(e.detail.response));
                    }
                });
            },            

            /**
             * Returns whether the action is enabled in current moment.
             */
            isEnabled: function(enabledStates, currentState, enabled) {
                if (enabledStates) {
                    // console.log("isEnabled successful: enabledStates == ", enabledStates, "currentState == ", currentState, "enabled == ", enabled);
                    return enabledStates.indexOf(currentState) >= 0 && enabled;
                } else {
                    console.warn("isEnabled: enabledStates is not ready at this stage! enabledStates == ", enabledStates);
                    return false;
                }
            },            

            /**
             * Executes the action.
             */
            run: function() {
            	this.enabled = false;

                if (this.action) {
                    this.action();
                } else {
                    var functionalEntity = this.preAction();

                    var ser = this.$.serialiser.serialise(functionalEntity);
                    this.$.actionExecutor.body = JSON.stringify(ser);
                    this.$.actionExecutor.go();
                }
            },

            /**
             * Analyzes and processes the result of executor response.
             */
            _onExecuted: function(result) {
                var savedFunctionalEntity = result.instance;
                if (this.$.reflector.isError(result)) {
                  	this.postActionError(result);
                } else {
                  	this.postActionSuccess(savedFunctionalEntity);
                }

                this._afterExecution();
            },

            _afterExecution: function() {
                console.log(this.shortDesc + ": after execution");
                this.enabled = true;
            },

            onActionChanged: function(oldValue, newValue) {
                var self = this;
                console.log("onAction changed, old = ", oldValue, newValue);
                if (newValue && !self.onActionUpgraded) {
                    self.onAction = function(smth) {
                        newValue(smth);
                        self._afterExecution();
                    };
                    self.onActionUpgraded = true;
                }
            }
        });
    </script>
</polymer-element>