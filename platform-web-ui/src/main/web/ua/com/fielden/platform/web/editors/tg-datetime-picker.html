<link rel="import" href="/resources/polymer/polymer/polymer.html">
<link rel="import" href="/resources/polymer/core-dropdown/core-dropdown.html">
<link rel="import" href="/resources/polymer/core-input/core-input.html">
<link rel="import" href="/resources/polymer/paper-input/paper-input-decorator.html">
<link rel="import" href="/resources/polymer/core-icon-button/core-icon-button.html">
<link rel="import" href="/resources/polymer/core-style/core-style.html">
<link rel="import" href="/resources/polymer/core-media-query/core-media-query.html">
<link rel="import" href="/resources/polymer/paper-dialog/paper-action-dialog.html">
<link rel="import" href="/resources/components/tg-calendar.html">
<link rel="import" href="/resources/components/moment-component.html">
<link rel="import" href="/resources/editors/tg-editor.html">
<link rel="stylesheet" href="/resources/editors/tg-datetime-picker.css">
<link rel="import" href="/resources/master/actions/tg-property-action.html">
<link rel="import" href="/resources/polymer/core-tooltip/core-tooltip.html">

<core-style id="datetime-icon-decorator">

    core-icon-button /deep/ core-icon[role="img"] {fill: {{g.paperInput.labelColor}};}
    <!---->
    #decorator:not(.invalid) core-icon-button:hover /deep/ core-icon, #decorator[focused]:not(.invalid) core-icon-button /deep/ core-icon {fill: {{g.paperInput.focusedColor}};}
    <!---->
    #decorator.invalid core-icon-button /deep/ core-icon { fill : {{g.paperInput.invalidColor}}; }
    <!---->
</core-style>

<polymer-element name="tg-datetime-picker" extends="tg-editor" attributes="bindTo label">
    <template>
        <core-style ref="datetime-icon-decorator"></core-style>
        <style>
            core-icon-button /deep/ core-icon[role="img"] {
                height: 1.1em;
                width: 1.1em;
                padding: 0px;
                margin: 0px;
                vertical-align: top;
            }
            
            core-icon-button {
                padding: 0px;
                margin: 0px;
                height: 1.1em;
                width: 1.1em;
                font: inherit;
            }
        </style>
        <paper-input-decorator id="decorator" label="{{propTitle}}" floatingLabel value="{{editingValue}}" disabled?="{{_isDisabled(currentState, entity, propertyName)}}">
            <div layout horizontal>
                <div id="input-container" flex>
                    <core-tooltip position="bottom" tabIndex="-1" class="delayed" style="width:100%" disabled="{{!tooltip(propDesc)}}">
                        <input id="input" is="core-input" value="{{editingValue}}" committedValue="{{commValue}}" disabled?="{{_isDisabled(currentState, entity, propertyName)}}">
                        <span class="span-tooltip" tip>
                            {{tooltip(propDesc)}}
                        </span>
                    </core-tooltip>
                </div>
                <div id="icon">
                    <core-icon-button on-click="{{showCalendar}}" icon="today" disabled?="{{_isDisabled(currentState, entity, propertyName)}}"></core-icon-buton>
                </div>
                <div id="action_icon" hidden?="{{!action}}">
                    <tg-property-action user="{{action.user}}" entitytype="{{action.entitytype}}" preAction="{{action.preAction}}" postActionSuccess="{{action.postActionSuccess}}" postActionError="{{action.postActionError}}" enabledStates="{{action.enabledStates}}" longDesc="{{action.longDesc}}" shortDesc="{{action.shortDesc}}" icon="{{action.icon}}" currentState="{{currentState}}"></tg-property-action>
                </div>
            </div>
        </paper-input-decorator>
        <paper-action-dialog class="date-time-picker" backdrop autoCloseDisabled opened="{{calendarVisible}}">
            <tg-calendar id="datePicker" auto-vertical pickTime></tg-calendar>
            <paper-button affirmative on-tap="{{cancelDate}}">Cancel</paper-button>
            <paper-button affirmative autofocus on-tap="{{acceptDate}}">Ok</paper-button>
        </paper-action-dialog>
        <shadow></shadow>
        <!-- p>$.input.committedValue: {{$.input.committedValue}}</p -->
    </template>
    <script>
        (function () {
            Polymer({
                isAcceptingDateFromPicker: false,

                /**
                 * Converts the value from string representation (which is used in editing / comm values) into concrete type of this editor component (Number).
                 */
                convertFromString: function (strValue) {
                    // console.log(moment.localeData().longDateFormat("LT").toLowerCase().indexOf("a"));
                    if (strValue) {
                        var acceptedMoment = moment(strValue.trim(), "L LT", true);
                        if (acceptedMoment.isValid()) {
                            return acceptedMoment.valueOf();
                        } else {
                            throw "The entered date is incorrect."
                        }
                    } else {
                        return null;
                    }
                },

                /**
                 * Converts the value into string representation (which is used in editing / comm values).
                 */
                convertToString: function (value) {
                    if (value === null) {
                        return "";
                    } else {
                        return moment(value).format("L LT");
                    }
                },

                showCalendar: function (e) {
                    var selectedMoment;
                    this.calendarVisible = !this.calendarVisible;
                    if (this.editingValue) {
                        selectedMoment = moment(this.editingValue.trim(), "L LT", true);
                        if (selectedMoment.isValid()) {
                            this.$.datePicker.selectedDate = selectedMoment.valueOf();
                            this.$.datePicker.selectedHour = selectedMoment.hour();
                            this.$.datePicker.selectedMinute = selectedMoment.minute();
                            return;
                        }
                    }
                    this.$.datePicker.selectedDate = null;
                    this.$.datePicker.selectedHour = 0;
                    this.$.datePicker.selectedMinute = 0;
                },
                acceptDate: function () {
                    this.isAcceptingDateFromPicker = true;
                    this.editingValue = moment(this.$.datePicker.selectedDate)
                        .hour(this.$.datePicker.selectedHour)
                        .minute(this.$.datePicker.selectedMinute)
                        .format("L LT");
                    this.$.input.focus();
                },

                editingValueChanged: function (oldValue, newValue) {
                    this.super([oldValue, newValue]);
                    if (this.isAcceptingDateFromPicker) {
                        this.isAcceptingDateFromPicker = false;

                        this.commit();
                    }
                },

                cancelDate: function () {
                    this.$.input.focus();
                }
            });
        })();
    </script>
</polymer-element>