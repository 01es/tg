<link rel="import" href="/resources/polymer/polymer/polymer.html">

<link rel="import" href="/resources/components/moment-component.html">
<link rel="import" href="/resources/components/tg-calendar.html">

<link rel="import" href="/resources/editors/tg-editor-behavior.html">
<link rel="import" href="/resources/editors/tg-editor.html">

<link rel="import" href="/resources/polymer/iron-icons/iron-icons.html">
<link rel="import" href="/resources/polymer/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="/resources/polymer/paper-icon-button/paper-icon-button.html">

<link rel="import" href="/resources/polymer/paper-button/paper-button.html">
<link rel="import" href="/resources/polymer/paper-dialog/paper-dialog.html">

<link rel="import" href="/resources/polymer/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="/resources/polymer/neon-animation/animations/fade-out-animation.html">

<style is="custom-style">
    .date-picker paper-button {
        color: var(--paper-light-blue-500);
        --paper-button-flat-focus-color: var(--paper-light-blue-50);
    }
    .date-picker paper-button:hover {
        background: var(--paper-light-blue-50);
    }
    .date-picker > tg-calendar {
        margin: 0;
        padding: 0;
    }

    .date-picker {
        line-height: normal;
    }
</style>
<dom-module id="tg-datetime-picker">
    <style>
        .picker-button {
            align-self: flex-end;
            --iron-icon-height: 24px;
            --iron-icon-width: 24px;
            width: 24px;
            height: 24px;
            padding: 0;
        }
        .picker-button::shadow #ink {
            width:54px;
            height: 54px;
            top: -15px;
            left: -15px;
        }
        /*
        .date-picker paper-button {
            color: var(--paper-light-blue-500);
            --paper-button-flat-focus-color: var(--paper-light-blue-50);
        }
        .date-picker paper-button:hover {
            background: var(--paper-light-blue-50);
        }
        .date-picker > tg-calendar {
            margin: 0;
            padding: 0;
        }
        .date-picker {
            line-height: normal;
        }
*/
    }
    </style>

    <template>
        <tg-editor id="editorDom" prop-title="[[propTitle]]" _disabled="[[_disabled]]" _editing-value="{{_editingValue}}" action="[[action]]" _error="[[_error]]" _comm-value="[[_commValue]]" _accepted-value="[[_acceptedValue]]" debug="[[debug]]" _on-change="[[_onChange]]" _on-input="[[_onInput]]" _on-keydown="[[_onKeydown]]" current-state="[[currentState]]">
            <paper-icon-button class="custom-icon-buttons picker-button" on-tap="_showCalendar" icon="today" disabled$="[[_disabled]]"></paper-icon-buton>
        </tg-editor>
        <paper-dialog id="dateDialog" class="date-picker layout vertical" modal entry-animation="scale-up-animation" exit-animation="fade-out-animation" on-iron-overlay-closed="_dateDialogClosed">
            <!--on-iron-overlay-opened="_fixDialog"-->
            <tg-calendar id="datePicker" pick-time></tg-calendar>
            <div class="buttons">
                <paper-button dialog-dismiss affirmative on-tap="_cancelDate">Cancel</paper-button>
                <paper-button dialog-confirm affirmative autofocus on-tap="_acceptDate">Ok</paper-button>
            </div>
        </paper-dialog>
    </template>
</dom-module>

<script>
    (function () {
        Polymer({
            is: 'tg-datetime-picker',
            behaviors: [Polymer.TgBehaviors.TgEditorBehavior, Polymer.IronResizableBehavior],

            ready: function () {
                this.$.editorDom._editorKind = 'DATE';
            },

            properties: {
                /////////////////////////////////////////////////////////////////////////////////////////////////////////
                //////////////////////////////////////////// INNER PROPERTIES ///////////////////////////////////////////
                /////////////////////////////////////////////////////////////////////////////////////////////////////////
                // These properties derive from other properties and are considered as 'private' -- need to have '_'   //
                //   prefix and default values specified in 'value' specificator of the property definition (or,       //
                //   alternatively, computing function needs to be specified). 									       //
                /////////////////////////////////////////////////////////////////////////////////////////////////////////
                _isAcceptingDateFromPicker: {
                    type: Boolean,
                    value: false
                },

                /////////////////////////////////////////////////////////////////////////////////////////////////////////
                //////////////////////////////// INNER PROPERTIES, THAT GOVERN CHILDREN /////////////////////////////////
                /////////////////////////////////////////////////////////////////////////////////////////////////////////
                // These properties derive from other properties and are considered as 'private' -- need to have '_'   //
                //   prefix. 																				           //
                // Also, these properties are designed to be bound to children element properties -- it is necessary to//
                //   populate their default values in ready callback (to have these values populated in children)!     //
                /////////////////////////////////////////////////////////////////////////////////////////////////////////
            },

            listeners: {
                'iron-resize': '_fixDialog'
            },

            /**
             * Converts the value from string representation (which is used in editing / comm values) into concrete type of this editor component (Number).
             */
            convertFromString: function (strValue) {
                // console.log(moment.localeData().longDateFormat("LT").toLowerCase().indexOf("a"));
                if (strValue) {
                    var acceptedMoment = moment(strValue.trim(), "L LT", true);
                    if (acceptedMoment.isValid()) {
                        return acceptedMoment.valueOf();
                    } else {
                        throw "The entered date is incorrect."
                    }
                } else {
                    return null;
                }
            },

            /**
             * Converts the value into string representation (which is used in editing / comm values).
             */
            convertToString: function (value) {
                if (value === null) {
                    return "";
                } else {
                    return moment(value).format("L LT");
                }
            },

            _showCalendar: function (e) {
                var dateDialog = this.$.dateDialog,
                    datePicker = this.$.datePicker;
                //Openening dialog
                Polymer.dom(Polymer.dom(dateDialog).parentNode).removeChild(dateDialog);
                Polymer.dom(document.body).appendChild(dateDialog);
                Polymer.dom.flush();
                
                // let's open the dialog with magical async...
                // this ensures that the dialog is opened after its relocation to body
                this.async(function () {
                    dateDialog.open();
                }.bind(this), 1);
                
                //this.async(dateDialog.notifyResize, 1);
                if (this._editingValue) { // TODO should this be "this._editingValue === ''"?
                    var selectedMoment = moment(this._editingValue.trim(), "L LT", true);
                    if (selectedMoment.isValid()) {
                        datePicker.selectedDate = selectedMoment.valueOf();
                        datePicker.selectedHour = selectedMoment.hour();
                        datePicker.selectedMinute = selectedMoment.minute();
                        return;
                    }
                }
                datePicker.selectedDate = null;
                datePicker.selectedHour = 0;
                datePicker.selectedMinute = 0;
            },

            _acceptDate: function () {
                this._isAcceptingDateFromPicker = true;
                this._editingValue = moment(this.$.datePicker.selectedDate)
                    .hour(this.$.datePicker.selectedHour)
                    .minute(this.$.datePicker.selectedMinute)
                    .format("L LT");
                this.decoratedInput().focus();
            },

            _editingValueChanged: function (newValue, oldValue) {
                Polymer.TgBehaviors.TgEditorBehavior._editingValueChanged.call(this, newValue, oldValue);

                if (this._isAcceptingDateFromPicker) {
                    this._isAcceptingDateFromPicker = false;

                    this.commit();
                }
            },

            _cancelDate: function () {
                this.decoratedInput().focus();
            },

            /**
             * listener for resize event of dialog
             */
            _fixDialog: function () {
                if (this.$.dateDialog.opened) {
                    this.$.dateDialog.fit();
                }
            },

            /**
             * listens the event when dialog closes.
             */
            _dateDialogClosed: function () {
                Polymer.dom(document.body).removeChild(this.$.dateDialog);
                Polymer.dom.flush();
            }
        });
    })();
</script>