<!-- <link rel="import" href="/resources/polymer/polymer/polymer.html">
<link rel="import" href="/resources/polymer/core-dropdown/core-dropdown.html">
<link rel="import" href="/resources/polymer/core-input/core-input.html">
<link rel="import" href="/resources/polymer/paper-input/paper-input-decorator.html">
<link rel="import" href="/resources/polymer/core-icon-button/core-icon-button.html">
<link rel="import" href="/resources/polymer/core-style/core-style.html">
<link rel="import" href="/resources/polymer/core-media-query/core-media-query.html">
<link rel="import" href="/resources/polymer/paper-dialog/paper-action-dialog.html">
<link rel="import" href="/resources/components/tg-calendar.html">
<link rel="import" href="/resources/components/moment-component.html">
<link rel="import" href="/resources/editors/tg-editor.html">
<link rel="stylesheet" href="/resources/editors/tg-datetime-picker.css">
<link rel="import" href="/resources/master/actions/tg-property-action.html">
<link rel="import" href="/resources/polymer/core-tooltip/core-tooltip.html"> -->

<link rel="import" href="/resources/polymer/polymer/polymer.html">

<link rel="import" href="/resources/components/moment-component.html">

<link rel="import" href="/resources/editors/tg-editor-behavior.html">
<link rel="import" href="/resources/editors/tg-editor.html">

<link rel="import" href="/resources/polymer/iron-icons/iron-icons.html">
<link rel="import" href="/resources/polymer/paper-icon-button/paper-icon-button.html">

<link rel="import" href="/resources/polymer/paper-button/paper-button.html">
<link rel="import" href="/resources/polymer/paper-dialog/paper-dialog.html">

<link rel="import" href="/resources/polymer/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="/resources/polymer/neon-animation/animations/fade-out-animation.html">

<!-- <core-style id="datetime-icon-decorator">

    core-icon-button /deep/ core-icon[role="img"] {fill: {{g.paperInput.labelColor}};}
   
    #decorator:not(.invalid) core-icon-button:hover /deep/ core-icon, #decorator[focused]:not(.invalid) core-icon-button /deep/ core-icon {fill: {{g.paperInput.focusedColor}};}
   
    #decorator.invalid core-icon-button /deep/ core-icon { fill : {{g.paperInput.invalidColor}}; }
   
</core-style> -->

<dom-module id="tg-datetime-picker">
    <style>
    		/* <core-style ref="datetime-icon-decorator"></core-style>
            core-icon-button /deep/ core-icon[role="img"] {
                height: 1.1em;
                width: 1.1em;
                padding: 0px;
                margin: 0px;
                vertical-align: top;
            }
            
            core-icon-button {
                padding: 0px;
                margin: 0px;
                height: 1.1em;
                width: 1.1em;
                font: inherit;
            } */
    </style>

    <template>
    	<tg-editor 
    		id="editorDom" 
    		_disabled="[[_disabled]]" 
    		_editing-value="{{_editingValue}}" 
    		action="[[action]]" 
    		_error="[[_error]]" 
    		_comm-value="[[_commValue]]" 
    		_accepted-value="[[_acceptedValue]]" 
    		debug="[[debug]]" 
    		_bound-on-change="[[_boundOnChange]]" 
    		_bound-on-keypress="[[_boundOnKeypress]]"
    		>
   		    <div id="icon" class="custom-icon-buttons">
                <paper-icon-button on-tap="showCalendar" icon="today" disabled$="[[_disabled]]"></paper-icon-buton>
            </div>
    	</tg-editor>
        <paper-dialog 
        	class="date-time-picker" 
        	with-backdrop 
        	no-cancel-on-outside-click 
        	opened="[[_calendarVisible]]" 
        	entry-animation="scale-up-animation"
        	exit-animation="fade-out-animation">
        	
        	<p>TEST</p>
            <!-- <tg-calendar id="datePicker" auto-vertical pick-time></tg-calendar> -->
            <paper-button dialog-dismiss affirmative on-tap="_cancelDate">Cancel</paper-button>
            <paper-button dialog-confirm affirmative autofocus on-tap="_acceptDate">Ok</paper-button>
        </paper-dialog>
    </template>
</dom-module>

    <script>
        (function () {
            Polymer({
            	is: 'tg-datetime-picker',
            	behaviors: [ Polymer.TgBehaviors.TgEditorBehavior ],
            	
            	ready: function () {
            		Polymer.TgBehaviors.TgEditorBehavior.ready.call(this);
            		
            		this._calendarVisible = false;
            		this.$.editorDom._editorKind = "DATE";
            	},

            	properties: {
                	/////////////////////////////////////////////////////////////////////////////////////////////////////////
                	//////////////////////////////////////////// INNER PROPERTIES ///////////////////////////////////////////
                	/////////////////////////////////////////////////////////////////////////////////////////////////////////
                	// These properties derive from other properties and are considered as 'private' -- need to have '_'   //
                	//   prefix and default values specified in 'value' specificator of the property definition (or,       //
                	//   alternatively, computing function needs to be specified). 									       //
                	/////////////////////////////////////////////////////////////////////////////////////////////////////////
	                _isAcceptingDateFromPicker: {
	                	type: Boolean,
	                	value: false
	                },
	                
	            	/////////////////////////////////////////////////////////////////////////////////////////////////////////
	            	//////////////////////////////// INNER PROPERTIES, THAT GOVERN CHILDREN /////////////////////////////////
	            	/////////////////////////////////////////////////////////////////////////////////////////////////////////
	            	// These properties derive from other properties and are considered as 'private' -- need to have '_'   //
	            	//   prefix. 																				           //
	            	// Also, these properties are designed to be bound to children element properties -- it is necessary to//
	            	//   populate their default values in ready callback (to have these values populated in children)!     //
	            	/////////////////////////////////////////////////////////////////////////////////////////////////////////
	                
	                _calendarVisible: {
	                	type: Boolean
	                }
            	},

                /**
                 * Converts the value from string representation (which is used in editing / comm values) into concrete type of this editor component (Number).
                 */
                convertFromString: function (strValue) {
                    // console.log(moment.localeData().longDateFormat("LT").toLowerCase().indexOf("a"));
                    if (strValue) {
                        var acceptedMoment = moment(strValue.trim(), "L LT", true);
                        if (acceptedMoment.isValid()) {
                            return acceptedMoment.valueOf();
                        } else {
                            throw "The entered date is incorrect."
                        }
                    } else {
                        return null;
                    }
                },

                /**
                 * Converts the value into string representation (which is used in editing / comm values).
                 */
                convertToString: function (value) {
                    if (value === null) {
                        return "";
                    } else {
                        return moment(value).format("L LT");
                    }
                },

                showCalendar: function (e) {
                    this._calendarVisible = !this._calendarVisible;
                    if (this._editingValue) { // TODO should this be "this._editingValue === ''"?
                        var selectedMoment = moment(this._editingValue.trim(), "L LT", true);
                        if (selectedMoment.isValid()) {
                            this.$.datePicker.selectedDate = selectedMoment.valueOf();
                            this.$.datePicker.selectedHour = selectedMoment.hour();
                            this.$.datePicker.selectedMinute = selectedMoment.minute();
                            return;
                        }
                    }
                    this.$.datePicker.selectedDate = null;
                    this.$.datePicker.selectedHour = 0;
                    this.$.datePicker.selectedMinute = 0;
                },
                _acceptDate: function () {
                    this._isAcceptingDateFromPicker = true;
                    this._editingValue = moment(this.$.datePicker.selectedDate)
                        .hour(this.$.datePicker.selectedHour)
                        .minute(this.$.datePicker.selectedMinute)
                        .format("L LT");
                    this.decoratedInput().focus();
                },

                _editingValueChanged: function (newValue, oldValue) {
                	Polymer.TgBehaviors.TgEditorBehavior._editingValueChanged.call(this, newValue, oldValue);
                	
                    if (this._isAcceptingDateFromPicker) {
                        this._isAcceptingDateFromPicker = false;

                        this.commit();
                    }
                },

                _cancelDate: function () {
                    this.decoratedInput().focus();
                }
            });
        })();
    </script>