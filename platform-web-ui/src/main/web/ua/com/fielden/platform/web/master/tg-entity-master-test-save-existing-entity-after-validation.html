<!doctype html>
<html>

<head>
    <title>entity-master</title>

    <script src="/resources/polymer/webcomponentsjs/webcomponents.js"></script>
    <link rel="import" href="/resources/polymer/polymer-test-tools/tools.html">
    <script src="/resources/polymer/polymer-test-tools/htmltest.js"></script>

    <link rel="import" href="/resources/master/tg-entity-master.html">
</head>

<body unresolved>
    <tg-entity-master id="master" entitytype="ua.com.fielden.platform.sample.domain.TgPersistentEntityWithProperties" entityid="new"></tg-entity-master>

    <script>
        document.addEventListener('polymer-ready', function() {
            var master = document.querySelector('#master');
            var self = this;
            var onSavedFirst = true;

            master.onSavedComplete = function() {   
                if (onSavedFirst === true) {
                    onSavedFirst = false;
                    master.validate(); 
                }
            };

            master.onSaved = function(potentiallySavedEntity, bindingEntity) {   
                if (onSavedFirst === true) {
                    assert.isNotNull(potentiallySavedEntity.id, "Entity id should be not null.");
                    assert.strictEqual(potentiallySavedEntity.version, 0, "Entity version should be 0.");
             
                    // value ok?
                    assert.ok(potentiallySavedEntity.get("stringProp"), "Property value should be initialised.");                
                    assert.strictEqual(potentiallySavedEntity.get("stringProp"), "ok", "Property value should be correct.");

                    // value is changed?
                    assert.strictEqual(potentiallySavedEntity.prop("stringProp").isChangedFromOriginal(), false, "Instance meta-prop should be changedFromOriginal.");

                    // value validationresult?
                    assert.strictEqual(potentiallySavedEntity.prop("stringProp").validationResult(), null, "Instance meta-prop should have empty (successful) validation result.");

                    // binding value ok?
                    assert.ok(bindingEntity.get("stringProp"), "Binding property should be initialised.");                
                    assert.strictEqual(bindingEntity.get("stringProp"), "ok", "Binding property should be correct number.");

                    // ACTUAL PROPERTY CHANGE                
                    bindingEntity.set("stringProp", "okok");
                } else {
                    assert.isNotNull(potentiallySavedEntity.id, "Entity id should remain not null.");
                    assert.strictEqual(potentiallySavedEntity.version, 1, "Entity version should be increased.");
             
                    // value ok?
                    assert.ok(potentiallySavedEntity.get("stringProp"), "Property value should be initialised.");                
                    assert.strictEqual(potentiallySavedEntity.get("stringProp"), "okok", "Property value should be correct.");

                    // value is changed?
                    assert.strictEqual(potentiallySavedEntity.prop("stringProp").isChangedFromOriginal(), false, "Instance meta-prop should be changedFromOriginal.");

                    // value validationresult?
                    assert.strictEqual(potentiallySavedEntity.prop("stringProp").validationResult(), null, "Instance meta-prop should have empty (successful) validation result.");

                    // binding value ok?
                    assert.ok(bindingEntity.get("stringProp"), "Binding property should be initialised.");                
                    assert.strictEqual(bindingEntity.get("stringProp"), "okok", "Binding property should be correct number.");

                    done();                   
                }
            };

            master.postValidated = function(validatedEntity, newBindingEntity, customObject) {
                master.save(); 
            };

            master.postRetrieved = function(entity, bindingEntity, customObject) {
                // ACTUAL PROPERTY CHANGE                
                bindingEntity.set("stringProp", "ok");
                bindingEntity.set("requiredValidatedProp", 30);
                bindingEntity.set("key", "KEY_" + (new Date()).getTime());

                master.save(); 
            };

            master.retrieve();
        });
    </script>

</body>

</html>
