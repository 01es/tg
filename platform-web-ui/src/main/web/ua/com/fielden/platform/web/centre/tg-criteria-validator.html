<link rel="import" href="/resources/polymer/polymer/polymer.html">
<link rel="import" href="/resources/polymer/core-ajax/core-ajax.html">
<link rel="import" href="/resources/serialisation/tg-serialiser.html">

<polymer-element name="tg-criteria-validator" attributes="mitype postValidatedDefault postValidatedDefaultError processResponse" hidden>
    <template>        
        <tg-serialiser id="serialiser"></tg-serialiser>
        <core-ajax id="ajaxSender" url="/criteria/{{mitype}}" method="POST" handleas="json"></core-ajax> 
    </template>
    <script>
        (function () {
            Polymer({
                ready: function() { 
                    var self = this;
                    
                    self.$.ajaxSender.addEventListener('core-response', function(e) {
                    	self.processResponse(e, "criteria validate", function (entityAndCustomObject) {
                            self.postValidatedDefault(entityAndCustomObject);
                    	}, function (errorResult) {
                    		self.postValidatedDefaultError(errorResult);
                    	});
                    });
                },

                /**
                 * Starts the process of entity validation.
                 *
                 * @param modifiedPropertiesHolder -- the entity with modified properties
                 */
                validate: function (modifiedPropertiesHolder) {
                    // console.log("validate: modifiedPropertiesHolder", modifiedPropertiesHolder);
                    var ser = this.$.serialiser.serialise(modifiedPropertiesHolder);
                    // console.log("validate: serialised modifiedPropertiesHolder", ser);
                    this.$.ajaxSender.body = JSON.stringify(ser);
                    this.$.ajaxSender.generateRequest();
                },

                /**
                 * Cancels any unfinished validation that was requested earlier (if any).
                 */
                abortValidationIfAny: function() {
                	var reflector = this.$.serialiser.$.reflector;
                	var numberOfAbortedRequests = reflector.discardAllRequests(this.$.ajaxSender);
                	console.warn("abortValidationIfAny: number of aborted requests =", numberOfAbortedRequests);
                }
            });
        })();
    </script>
</polymer-element>