<!doctype html>
<!--
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>

<head>
    <title>serialisation-integration</title>

    <script src="/resources/polymer/webcomponentsjs/webcomponents.js"></script>
    <link rel="import" href="/resources/polymer/polymer-test-tools/tools.html">
    <script src="/resources/polymer/polymer-test-tools/htmltest.js"></script>

    <link rel="import" href="/resources/serialisation/tg-serialiser.html">
    <link rel="import" href="/resources/polymer/core-ajax/core-ajax.html">
</head>

<body unresolved>
    <core-ajax id="entities_retriever" url="/test/serialisation" handleas="json" auto></core-ajax>
    <core-ajax id="entities_sender" url="/test/serialisation" method="POST" handleas="json"></core-ajax>

    <tg-serialiser id="serialiser"></tg-serialiser>

    <script>
        document.addEventListener('polymer-ready', function() {
            var entityRetriever = document.querySelector('#entities_retriever'),
                entitySender = document.querySelector('#entities_sender'),
                serialiser = document.querySelector('#serialiser'),
                onError = function(e, detail, sender) {
                    assert.fail(null, null, "The error has happened.");
                    done();
                },
                find = function(entities, simpleTypeName) {
                    for (var i = 0; i < entities.length; i++) {
                        var entity = entities[i];
                        if (entity && entity.type().fullClassName().indexOf(simpleTypeName) > -1) {
                            return entity;
                        }
                    }
                    return null;
                };

            entityRetriever.addEventListener('core-response', function(e) {
                // console.log("not deserialised: ", JSON.stringify(e.detail.response));
                var resultWithEntities = serialiser.deserialise(e.detail.response);

                var entities = resultWithEntities.instance;

                // check EntityType properties
                assert.deepEqual(find(entities, "EmptyEntity").type().isCompositeEntity(), false, "EmptyEntity should not be composite.");
                assert.deepEqual(find(entities, "EntityWithCompositeKey").type().isCompositeEntity(), true, "EntityWithCompositeKey should be composite.");
                assert.deepEqual(find(entities, "EntityWithCompositeKey").type().compositeKeyNames(), ["key1", "key2"], "EntityWithCompositeKey has incorrect composite names.");
                assert.deepEqual(find(entities, "EntityWithCompositeKey").type().compositeKeySeparator(), " :: ", "EntityWithCompositeKey has incorrect composite key separator.");

                assert.deepEqual(find(entities, "EmptyEntity").type().entityTitle(), "Empty entity", "EmptyEntity has incorrect title.");
                assert.deepEqual(find(entities, "EmptyEntity").type().entityDesc(), "The entity without any properties for testing", "EmptyEntity has incorrect desc.");
                assert.deepEqual(find(entities, "EntityWithInteger").type().entityTitle(), "Entity With Integer", "EntityWithInteger has incorrect title.");
                assert.deepEqual(find(entities, "EntityWithInteger").type().entityDesc(), "Entity With Integer entity", "EntityWithInteger has incorrect desc.");

                assert.deepEqual(find(entities, "EntityWithBigDecimal").type().prop("prop").isSecrete(), true, "EntityWithBigDecimal property should be secrete.");
                assert.deepEqual(find(entities, "EntityWithInteger").type().prop("prop").isSecrete(), false, "EntityWithInteger property should not be secrete.");

                assert.deepEqual(find(entities, "EntityWithString").type().prop("prop").isUpperCase(), true, "EntityWithString property should be upperCase.");
                assert.deepEqual(find(entities, "EntityWithInteger").type().prop("prop").isUpperCase(), false, "EntityWithInteger property should not be upperCase.");
                assert.deepEqual(find(entities, "EntityWithString").type().prop("key").isUpperCase(), true, "EntityWithString property 'key' should be upperCase.");
                assert.deepEqual(find(entities, "EntityWithString").type().prop("desc").isUpperCase(), false, "EntityWithString property 'desc' should not be upperCase.");

                assert.deepEqual(find(entities, "EntityWithString").type().prop("prop").title(), "Special Prop", "EntityWithString property has incorrect title.");
                assert.deepEqual(find(entities, "EntityWithString").type().prop("prop").desc(), "Special Prop desc", "EntityWithString property has incorrect desc.");
                assert.deepEqual(find(entities, "EntityWithString").type().prop("key").title(), "Special Key", "EntityWithString property 'key' has incorrect title.");
                assert.deepEqual(find(entities, "EntityWithString").type().prop("key").desc(), "Special Key desc", "EntityWithString property 'key' has incorrect desc.");
                assert.deepEqual(find(entities, "EntityWithString").type().prop("desc").title(), "Special Desc", "EntityWithString property 'desc' has incorrect title.");
                assert.deepEqual(find(entities, "EntityWithString").type().prop("desc").desc(), "Special Desc desc", "EntityWithString property 'desc' has incorrect desc.");

                assert.deepEqual(find(entities, "EntityWithDate").type().prop("prop").isCritOnly(), true, "EntityWithDate property has incorrect critOnly.");
                assert.deepEqual(find(entities, "EntityWithString").type().prop("prop").isCritOnly(), false, "EntityWithString property has incorrect critOnly.");
                assert.deepEqual(find(entities, "EntityWithInteger").type().prop("prop").isResultOnly(), true, "EntityWithInteger property has incorrect resultOnly.");
                assert.deepEqual(find(entities, "EntityWithString").type().prop("prop").isResultOnly(), false, "EntityWithString property has incorrect resultOnly.");
                assert.deepEqual(find(entities, "EntityWithMoney").type().prop("prop").isIgnore(), true, "EntityWithMoney property has incorrect 'ignore'.");
                assert.deepEqual(find(entities, "EntityWithString").type().prop("prop").isIgnore(), false, "EntityWithString property has incorrect 'ignore'.");

                assert.deepEqual(find(entities, "EntityWithBigDecimal").type().prop("prop").length(), 10, "EntityWithBigDecimal property has incorrect length.");
                assert.deepEqual(find(entities, "EntityWithString").type().prop("prop").length(), 0, "EntityWithString property has incorrect length.");
                assert.deepEqual(find(entities, "EntityWithBigDecimal").type().prop("prop").precision(), 10, "EntityWithBigDecimal property has incorrect precision.");
                assert.deepEqual(find(entities, "EntityWithString").type().prop("prop").precision(), -1, "EntityWithString property has incorrect precision.");
                assert.deepEqual(find(entities, "EntityWithBigDecimal").type().prop("prop").scale(), 3, "EntityWithBigDecimal property has incorrect scale.");
                assert.deepEqual(find(entities, "EntityWithString").type().prop("prop").scale(), -1, "EntityWithString property has incorrect scale.");


                // console.log("deserialised with tg-serialiser: ", JSON.stringify(resultWithEntities));
                entitySender.body = JSON.stringify(serialiser.serialise(resultWithEntities));
                // console.log("serialised with tg-serialiser: ", entitySender.body);
                entitySender.go();
            });

            entitySender.addEventListener('core-response', function(e) {
                assert.equal(e.detail.response.message, 'okay', "The sended entities are not equal.");
                done();
            });

            entityRetriever.addEventListener('core-error', onError);
            entitySender.addEventListener('core-error', onError);
        });
    </script>

</body>

</html>
