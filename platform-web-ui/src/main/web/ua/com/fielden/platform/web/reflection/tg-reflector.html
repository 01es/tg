<link rel="import" href="/resources/polymer/polymer/polymer.html">

<polymer-element name="tg-reflector" hidden>
    <script>
        (function() {
            ////////////////////////////////////////// THE PROTOTYPE FOR EntityType ////////////////////////////////////////// 
            var EntityType = function(rawObject) { 
                Object.call(this);
                // copy all properties from rawObject after deserialisation
                for (var prop in rawObject) {
                    if (prop === "_props") {
                        var _props = rawObject[prop];

                        for (var p in _props) {
                            if (_props.hasOwnProperty(p)) {
                                var val = _props[p];
                                _props[p] = new EntityTypeProp(val);
                            }
                        }

                        this[prop] = _props;
                    } else {
                        this[prop] = rawObject[prop];
                    }
                }
            };
            EntityType.prototype = Object.create(Object.prototype);
            EntityType.prototype.constructor = EntityType;

            /**
             * Returns the number for the entity type inside the type table.
             * 
            */
            EntityType.prototype.number = function() {
                return this._number;
            }

            /**
             * Returns full Java class name for the entity type.
             * 
            */
            EntityType.prototype.fullClassName = function() {
                return this.key;
            }

            /**
             * Returns full Java class name for the entity type.
             * 
            */
            EntityType.prototype._simpleClassName = function() {
                var ind = this.fullClassName().lastIndexOf(".") + 1;
                return this.fullClassName().substring(ind);
            }

            /**
             * Returns 'true' when the entity type represents composite entity, 'false' otherwise. 
             * 
             * Use compositeKeyNames() function to determine property names for the key members.
            */
            EntityType.prototype.isCompositeEntity = function() {
                return typeof this._compositeKeyNames !== 'undefined' && this._compositeKeyNames && this._compositeKeyNames.length > 0;
            }

            /** 
             * Returns the property names for the key members in case of composite entity, 'undefined' otherwise.
            */
            EntityType.prototype.compositeKeyNames = function() {
                return this._compositeKeyNames;
            }

            /** 
             * Returns the key member separator in case of composite entity, 'undefined' otherwise.
            */
            EntityType.prototype.compositeKeySeparator = function() {
                return typeof this._compositeKeySeparator === 'undefined' ? " " : this._compositeKeySeparator;
            }

            /** 
             * Returns entity title.
            */
            EntityType.prototype.entityTitle = function() {
                return typeof this._entityTitle === 'undefined' ? this._entityTitleDefault() : this._entityTitle;
            }

            /** 
             * Returns entity type property with the specified name.
            */
            EntityType.prototype.prop = function(name) {
                return typeof this._props !== 'undefined' && this._props && this._props[name] ? this._props[name] : null;
            }

            /** 
             * Returns entity description.
            */
            EntityType.prototype.entityDesc = function() {
                return typeof this._entityDesc === 'undefined' ? this._entityDescDefault() : this._entityDesc;
            }

            /** 
             * Returns default entity title.
            */
            EntityType.prototype._entityTitleDefault = function() {
                var title = this._breakToWords(this._simpleClassName());
                return title;
            }

            /** 
             * Returns default entity desc.
            */
            EntityType.prototype._entityDescDefault = function() {
                var title = this._breakToWords(this._simpleClassName());
                return title + " entity";
            }

            /** 
             * Breaks camelCased string onto words and separates it with ' '.
            */
            EntityType.prototype._breakToWords = function(str) { // see http://stackoverflow.com/questions/10425287/convert-string-to-camelcase-with-regular-expression
                return str.replace(/([A-Z])/g, function(match, group) {
                    return " " + group;
                }).trim();
            }

            ////////////////////////////////////////// THE PROTOTYPE FOR EntityTypeProp ////////////////////////////////////////// 
            var EntityTypeProp = function(rawObject) {
                Object.call(this);

                // copy all properties from rawObject after deserialisation
                for (var prop in rawObject) {
                    this[prop] = rawObject[prop];
                }
            };
            EntityTypeProp.prototype = Object.create(Object.prototype);
            EntityTypeProp.prototype.constructor = EntityTypeProp;

            /**
             * Returns 'true' when the type property is secrete, false otherwise.
             * 
             * IMPORTANT: do not use '_secrete' field directly!
            */
            EntityTypeProp.prototype.isSecrete = function() {
                return typeof this._secrete === 'undefined' ? false : this._secrete;
            }

            /**
             * Returns 'true' when the type property is upperCase, false otherwise.
             * 
             * IMPORTANT: do not use '_upperCase' field directly!
            */
            EntityTypeProp.prototype.isUpperCase = function() {
                return typeof this._upperCase === 'undefined' ? false : this._upperCase;
            }

            /** 
             * Returns entity type prop title.
            */
            EntityTypeProp.prototype.title = function() {
                return this._title;
            }

            /** 
             * Returns entity type prop description.
            */
            EntityTypeProp.prototype.desc = function() {
                return this._desc;
            }

            /**
             * Returns 'true' when the type property is critOnly, false otherwise.
             * 
             * IMPORTANT: do not use '_critOnly' field directly!
            */
            EntityTypeProp.prototype.isCritOnly = function() {
                return typeof this._critOnly === 'undefined' ? false : this._critOnly;
            }

            ////////////////////////////////////////// THE PROTOTYPE FOR EntityInstanceProp ////////////////////////////////////////// 
            var EntityInstanceProp = function() {
                Object.call(this);
            };
            EntityInstanceProp.prototype = Object.create(Object.prototype);
            EntityInstanceProp.prototype.constructor = EntityInstanceProp;

            /**
             * Returns 'true' when the instance property is editable, false otherwise.
             * 
             * IMPORTANT: do not use '_editable' field directly!
            */
            EntityInstanceProp.prototype.isEditable = function() {
                return typeof this._editable === 'undefined' ? true : this._editable;
            }

            /**
             * Returns 'true' when the instance property is dirty, false otherwise.
             * 
             * IMPORTANT: do not use '_dirty' field directly!
            */
            EntityInstanceProp.prototype.isDirty = function() {
                return typeof this._dirty === 'undefined' ? false : this._dirty;
            }

            /**
             * Returns 'true' when the instance property is required, false otherwise.
             * 
             * IMPORTANT: do not use '_required' field directly!
            */
            EntityInstanceProp.prototype.isRequired = function() {
                return typeof this._required === 'undefined' ? false : this._required;
            }

            /**
             * Returns 'true' when the instance property is visible, false otherwise.
             * 
             * IMPORTANT: do not use '_visible' field directly!
            */
            EntityInstanceProp.prototype.isVisible = function() {
                return typeof this._visible === 'undefined' ? true : this._visible;
            }

            /**
             * Returns validation result (failure or warning) for the instance property or 'null' if successful without warnings.
             * 
             * IMPORTANT: do not use '_validationResult' field directly!
            */
            EntityInstanceProp.prototype.validationResult = function() {
                return typeof this._validationResult === 'undefined' ? null : this._validationResult;
            }

            ////////////////////////////////////////// THE PROTOTYPE FOR Entity ////////////////////////////////////////// 
            var Entity = function(rawObject) { // rawObject
                Object.call(this);

                if (rawObject) {
                    // copy all properties from rawObject if it is not empty
                    for (var prop in rawObject) { 
                        this[prop] = rawObject[prop];
                    }
                }
            };
            Entity.prototype = Object.create(Object.prototype);
            Entity.prototype.constructor = Entity;

            /**
             * Returns the type for the entity.
             * 
             * IMPORTANT: do not use '_type' field directly!
            */
            Entity.prototype.type = function() {
                return this._type;
            }

            ////////////////////////////////////////// THE PROTOTYPE FOR EntityInstanceProp ////////////////////////////////////////// 
            var providePrototypes = function(typeTable) {
                    for (var key in typeTable) {
                        if (typeTable.hasOwnProperty(key)) {
                            var entityType = typeTable[key];
                            typeTable[key] = new EntityType(entityType);
                            // entityType.prototype = EntityType.prototype;
                            // entityType.__proto__ = EntityType.prototype;
                        }
                    }
                    return typeTable;
                },
                typeTable = providePrototypes(@typeTable);

            console.log("typeTable = ", typeTable);
            // console.log("typeTable['34'].isCompositeEntity() = ", typeTable['34'].isCompositeEntity());

            Polymer({
                getType: function(number) {
                    return typeTable[number];
                },

                getEntityInstancePropType: function() {
                    return EntityInstanceProp;
                },

                getEntityType: function() {
                    return Entity;
                }
            });
        })();
    </script>
</polymer-element>