<link rel="import" href="/resources/polymer/polymer/polymer.html">

<polymer-element name="tg-reflector" hidden>
    <script>
        (function() {
            ////////////////////////////////////////// THE PROTOTYPE FOR EntityType ////////////////////////////////////////// 
            var EntityType = function(rawObject) { 
                Object.call(this);
                // copy all properties from rawObject after deserialisation
                for (var prop in rawObject) {
                    if (prop === "_props") {
                        var _props = rawObject[prop];

                        for (var p in _props) {
                            if (_props.hasOwnProperty(p)) {
                                var val = _props[p];
                                _props[p] = new EntityTypeProp(val);
                            }
                        }

                        this[prop] = _props;
                    } else {
                        this[prop] = rawObject[prop];
                    }
                }
            };
            EntityType.prototype = Object.create(Object.prototype);
            EntityType.prototype.constructor = EntityType;

            /**
             * Returns the number for the entity type inside the type table.
             * 
            */
            EntityType.prototype.number = function() {
                return this._number;
            }

            /**
             * Returns full Java class name for the entity type.
             * 
            */
            EntityType.prototype.fullClassName = function() {
                return this.key;
            }

            /**
             * Returns full Java class name for the entity type.
             * 
            */
            EntityType.prototype._simpleClassName = function() {
                var ind = this.fullClassName().lastIndexOf(".") + 1;
                return this.fullClassName().substring(ind);
            }

            /**
             * Returns 'true' when the entity type represents composite entity, 'false' otherwise. 
             * 
             * Use compositeKeyNames() function to determine property names for the key members.
            */
            EntityType.prototype.isCompositeEntity = function() {
                return typeof this._compositeKeyNames !== 'undefined' && this._compositeKeyNames && this._compositeKeyNames.length > 0;
            }

            /** 
             * Returns the property names for the key members in case of composite entity, 'undefined' otherwise.
            */
            EntityType.prototype.compositeKeyNames = function() {
                return this._compositeKeyNames;
            }

            /** 
             * Returns the key member separator in case of composite entity, 'undefined' otherwise.
            */
            EntityType.prototype.compositeKeySeparator = function() {
                return typeof this._compositeKeySeparator === 'undefined' ? " " : this._compositeKeySeparator;
            }

            /** 
             * Returns entity title.
            */
            EntityType.prototype.entityTitle = function() {
                return typeof this._entityTitle === 'undefined' ? this._entityTitleDefault() : this._entityTitle;
            }

            /** 
             * Returns entity type property with the specified name.
            */
            EntityType.prototype.prop = function(name) {
                return typeof this._props !== 'undefined' && this._props && this._props[name] ? this._props[name] : null;
            }

            /** 
             * Returns entity description.
            */
            EntityType.prototype.entityDesc = function() {
                return typeof this._entityDesc === 'undefined' ? this._entityDescDefault() : this._entityDesc;
            }

            /** 
             * Returns default entity title.
            */
            EntityType.prototype._entityTitleDefault = function() {
                var title = this._breakToWords(this._simpleClassName());
                return title;
            }

            /** 
             * Returns default entity desc.
            */
            EntityType.prototype._entityDescDefault = function() {
                var title = this._breakToWords(this._simpleClassName());
                return title + " entity";
            }

            /** 
             * Breaks camelCased string onto words and separates it with ' '.
            */
            EntityType.prototype._breakToWords = function(str) { // see http://stackoverflow.com/questions/10425287/convert-string-to-camelcase-with-regular-expression
                return str.replace(/([A-Z])/g, function(match, group) {
                    return " " + group;
                }).trim();
            }

            ////////////////////////////////////////// THE PROTOTYPE FOR EntityTypeProp ////////////////////////////////////////// 
            var EntityTypeProp = function(rawObject) {
                Object.call(this);

                // copy all properties from rawObject after deserialisation
                for (var prop in rawObject) {
                    this[prop] = rawObject[prop];
                }
            };
            EntityTypeProp.prototype = Object.create(Object.prototype);
            EntityTypeProp.prototype.constructor = EntityTypeProp;

            /**
             * Returns 'true' when the type property is secrete, false otherwise.
             * 
             * IMPORTANT: do not use '_secrete' field directly!
            */
            EntityTypeProp.prototype.isSecrete = function() {
                return typeof this._secrete === 'undefined' ? false : this._secrete;
            }

            /**
             * Returns 'true' when the type property is upperCase, false otherwise.
             * 
             * IMPORTANT: do not use '_upperCase' field directly!
            */
            EntityTypeProp.prototype.isUpperCase = function() {
                return typeof this._upperCase === 'undefined' ? false : this._upperCase;
            }

            /** 
             * Returns entity type prop title.
            */
            EntityTypeProp.prototype.title = function() {
                return this._title;
            }

            /** 
             * Returns entity type prop description.
            */
            EntityTypeProp.prototype.desc = function() {
                return this._desc;
            }

            /**
             * Returns 'true' when the type property is critOnly, false otherwise.
             * 
             * IMPORTANT: do not use '_critOnly' field directly!
            */
            EntityTypeProp.prototype.isCritOnly = function() {
                return typeof this._critOnly === 'undefined' ? false : this._critOnly;
            }

            /**
             * Returns 'true' when the type property is resultOnly, false otherwise.
             * 
             * IMPORTANT: do not use '_resultOnly' field directly!
            */
            EntityTypeProp.prototype.isResultOnly = function() {
                return typeof this._resultOnly === 'undefined' ? false : this._resultOnly;
            }

            /**
             * Returns 'true' when the type property is 'ignore', false otherwise.
             * 
             * IMPORTANT: do not use '_ignore' field directly!
            */
            EntityTypeProp.prototype.isIgnore = function() {
                return typeof this._ignore === 'undefined' ? false : this._ignore;
            }

            /** 
             * Returns entity type prop length.
            */
            EntityTypeProp.prototype.length = function() {
                return typeof this._length === 'undefined' ? 0 : this._length;
            }

            /** 
             * Returns entity type prop precision.
            */
            EntityTypeProp.prototype.precision = function() {
                return typeof this._precision === 'undefined' ? -1 : this._precision;
            }

            /** 
             * Returns entity type prop scale.
            */
            EntityTypeProp.prototype.scale = function() {
                return typeof this._scale === 'undefined' ? -1 : this._scale;
            }
            ////////////////////////////////////////// THE PROTOTYPE FOR EntityInstanceProp ////////////////////////////////////////// 
            var EntityInstanceProp = function() {
                Object.call(this);
            };
            EntityInstanceProp.prototype = Object.create(Object.prototype);
            EntityInstanceProp.prototype.constructor = EntityInstanceProp;

            /**
             * Returns 'true' when the instance property is editable, false otherwise.
             * 
             * IMPORTANT: do not use '_editable' field directly!
            */
            EntityInstanceProp.prototype.isEditable = function() {
                return typeof this._editable === 'undefined' ? true : this._editable;
            }

            /**
             * Returns 'true' when the instance property is changed from original, false otherwise.
             * 
             * IMPORTANT: do not use '_cfo' field directly!
            */
            EntityInstanceProp.prototype.isChangedFromOriginal = function() {
                return typeof this._cfo === 'undefined' ? false : this._cfo;
            }

            /**
             * Returns 'true' when the instance property is required, false otherwise.
             * 
             * IMPORTANT: do not use '_required' field directly!
            */
            EntityInstanceProp.prototype.isRequired = function() {
                return typeof this._required === 'undefined' ? false : this._required;
            }

            /**
             * Returns 'true' when the instance property is visible, false otherwise.
             * 
             * IMPORTANT: do not use '_visible' field directly!
            */
            EntityInstanceProp.prototype.isVisible = function() {
                return typeof this._visible === 'undefined' ? true : this._visible;
            }

            /**
             * Returns validation result (failure or warning) for the instance property or 'null' if successful without warnings.
             * 
             * IMPORTANT: do not use '_validationResult' field directly!
            */
            EntityInstanceProp.prototype.validationResult = function() {
                return typeof this._validationResult === 'undefined' ? null : this._validationResult;
            }

            /**
             * Returns the max possible length in case of string property, 'undefined' otherwise.
             * 
             * IMPORTANT: do not use '_max' field directly!
            */
            EntityInstanceProp.prototype.stringLength = function() {
                // if (this._isString()) { 
                return typeof this._max === 'undefined' ? 0 : this._max;
                // }
                // return undefined;
            }

            /**
             * Returns the max possible integer value in case of integer property (null means unlimited), 'undefined' otherwise.
             * 
             * IMPORTANT: do not use '_max' field directly!
            */
            EntityInstanceProp.prototype.integerMax = function() {
                // if (!this._isString()) {
                return typeof this._max === 'undefined' ? null : this._max;
                // }
                // return undefined;
            }

            /**
             * Returns the min possible integer value in case of integer property (null means unlimited), 'undefined' otherwise.
             * 
             * IMPORTANT: do not use '_min' field directly!
            */
            EntityInstanceProp.prototype.integerMin = function() {
                // if (!this._isString()) {
                return typeof this._min === 'undefined' ? null : this._min;
                // }
                // return undefined;
            }

            ////////////////////////////////////////// THE PROTOTYPE FOR Entity ////////////////////////////////////////// 
            var Entity = function(rawObject) { // rawObject
                Object.call(this);

                if (rawObject) {
                    // copy all properties from rawObject if it is not empty
                    for (var prop in rawObject) { 
                        this[prop] = rawObject[prop];
                    }
                }
            };
            Entity.prototype = Object.create(Object.prototype);
            Entity.prototype.constructor = Entity;

            /**
             * Returns the type for the entity.
             * 
             * IMPORTANT: do not use '_type' field directly!
            */
            Entity.prototype.type = function() {
                return this._type;
            }

            /**
             * Returns the instance prop for the entity.
             * 
             * IMPORTANT: do not use '@prop' field directly!
            */
            Entity.prototype.prop = function(name) {
                this.get(name); // ensures that the instance prop of the 'fetched' property is accessed
                if (this._isObjectUndefined("@" + name)) {
                    this["@" + name] = new EntityInstanceProp(); // lazily initialise entity instance prop in case when it was not JSON-serialised (all information was 'default')
                }                
                return this["@" + name];
            }

            /**
             * Returns the property value for the entity.
             * 
             * IMPORTANT: do not use property field directly!
            */
            Entity.prototype.get = function(name) {
                if (this._isObjectUndefined(name)) {
                    throw new StrictProxyException(name, this.type()._simpleClassName());
                }
                return this[name];
            }

            /**
             * Returns 'true' if there is an object member defined (not a function!) with a specified name, 'false' otherwise.
             * 
            */
            Entity.prototype._isObjectUndefined = function(name) {
                return (typeof this[name] === 'undefined') || (typeof this[name] === 'function');
            }

            /**
             * Sets the property value for the entity.
             * 
             * IMPORTANT: do not use property field directly!
            */
            Entity.prototype.set = function(name, value) {
                this.get(name); // ensures that the instance prop of the 'fetched' property is accessed
                return this[name] = value;
            }

            /**
             * Traverses all fetched properties in entity. It does not include 'id', 'version', '_type' and '@prop' instance meta-props.
             * 
             * @param propertyCallback -- function(propertyName) to be called on each property
            */
            Entity.prototype.traverseProperties = function(propertyCallback) {
                var entity = this;
                for (var membName in entity) {
                    if (entity.hasOwnProperty(membName) && membName[0] !== "@" && membName !== "_type" && membName !== "id" && membName !== "version") {
                        propertyCallback(membName);
                    }
                }
            }

            var StrictProxyException = function(propName, simpleClassName) { // rawObject
                Object.call(this);

                this.message = "Strict proxy exception: the property [" + propName + "] does not exist in the entity of type [" + simpleClassName + "]. Please, check the fetch strategy or construction strategy of the entity object.";
            };
            StrictProxyException.prototype = Object.create(Object.prototype);
            StrictProxyException.prototype.constructor = StrictProxyException;     

            /**
             * Overridden toString method to represent this exception more meaningfully than '[Object object]'.
             * 
            */
            StrictProxyException.prototype.toString = function() {
                return this.message;
            }

            ////////////////////////////////////////// THE PROTOTYPE FOR EntityInstanceProp ////////////////////////////////////////// 
            var providePrototypes = function(typeTable) {
                    for (var key in typeTable) {
                        if (typeTable.hasOwnProperty(key)) {
                            var entityType = typeTable[key];
                            typeTable[key] = new EntityType(entityType);
                            // entityType.prototype = EntityType.prototype;
                            // entityType.__proto__ = EntityType.prototype;
                        }
                    }
                    return typeTable;
                },
                typeTable = providePrototypes(@typeTable);

            // console.log("typeTable = ", typeTable);

            Polymer({
                getType: function(number) {
                    return typeTable[number];
                },

                findTypeByName: function(typeName) {
                    for (var key in typeTable) {
                        if (typeTable.hasOwnProperty(key)) {
                            var entityType = typeTable[key];
                            if (entityType.fullClassName() === typeName) {
                                return entityType;
                            }
                        }
                    }
                    return null;
                },

                getEntityInstancePropType: function() {
                    return EntityInstanceProp;
                },

                getEntityType: function() {
                    return Entity;
                },

                getStrictProxyExceptionType: function() {
                    return StrictProxyException;
                },

                /**
                 * Returns 'true' if the regular values are equal, 'false' otherwise.
                 */
                equalsEx: function(value1, value2) {
                    // if (value1) {
                    //     if (!value2) {
                    //         return false;
                    //     } else {
                    //         return ...
                    //     }
                    // }

                    // TODO rectify whether this implementation is good:
                    return value1 === value2;
                }
            });
        })();
    </script>
</polymer-element>